<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title> Panel del Cajero - Saki Sushi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- FUNCIÓN HACER LOGIN DEFINIDA INMEDIATAMENTE -->
    <script>
        // Definir función global ANTES de que el HTML la use
        window.hacerLogin = async function() {
            console.log('✅ Función hacerLogin ejecutándose');
            
            const username = document.getElementById('username')?.value;
            const password = document.getElementById('password')?.value;
            
            if (!username || !password) {
                if (window.mostrarToast) window.mostrarToast('Ingresa usuario y contraseña', 'error');
                else alert('Ingresa usuario y contraseña');
                return;
            }
            
            try {
                if (!window.supabaseClient) {
                    if (window.mostrarToast) window.mostrarToast('Error: Cliente Supabase no inicializado', 'error');
                    else alert('Error: Cliente Supabase no inicializado');
                    return;
                }
                
                const { data, error } = await window.supabaseClient
                    .from('usuarios')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .eq('activo', true)
                    .maybeSingle();
                    
                if (error) {
                    console.error('Error en consulta:', error);
                    if (window.mostrarToast) window.mostrarToast('Error al conectar con la base de datos', 'error');
                    else alert('Error al conectar con la base de datos');
                    return;
                }
                
                if (!data) {
                    if (window.mostrarToast) window.mostrarToast('Credenciales inválidas', 'error');
                    else alert('Credenciales inválidas');
                    return;
                }
                
                window.currentUser = data;
                sessionStorage.setItem('cajero_user', JSON.stringify(data));
                
                if (window.mostrarToast) window.mostrarToast('✅ Login exitoso', 'success');
                
                // Esperar un momento y luego mostrar el panel
                setTimeout(() => {
                    if (window.mostrarPanel) window.mostrarPanel();
                }, 500);
                
            } catch (error) {
                console.error('Error en login:', error);
                if (window.mostrarToast) window.mostrarToast('Error al conectar: ' + (error.message || 'Error desconocido'), 'error');
                else alert('Error al conectar: ' + (error.message || 'Error desconocido'));
            }
        };
    </script>
    
    <style>
        :root{--primary:#D32F2F;--secondary:#212121;--accent:#FF9800;--light:#F5F5F5;--dark:#121212;--warm:#FFC107;--success:#388E3C;--info:#1976D2;--warning:#F57C00;--danger:#ef4444;--propina:#9C27B0;--delivery:#00ACC1;--condonar:#FF6B6B;--favordecaja:#4ECDC4;--shadow:rgba(0,0,0,.15);--transition:all .3s ease}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto','Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        body{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);min-height:100vh;padding:20px;color:#fff}
        .login-container{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,var(--primary),var(--secondary));position:fixed;top:0;left:0;right:0;bottom:0;z-index:10000}
        .login-container.hidden{display:none}
        .login-box{background:rgba(255,255,255,.95);padding:2.5rem;border-radius:15px;box-shadow:0 20px 60px rgba(0,0,0,.3);width:100%;max-width:400px;text-align:center}
        .login-box h2{color:var(--primary);margin-bottom:1.5rem;font-family:'Montserrat',sans-serif;font-weight:700;font-size:2rem}
        .login-form input{width:100%;padding:1rem;margin-bottom:1rem;border:2px solid #e0e0e0;border-radius:10px;font-size:1rem;transition:var(--transition)}
        .login-form input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(211,47,47,.2)}
        .login-form button{width:100%;padding:1rem;background:linear-gradient(135deg,var(--primary),#b71c1c);color:white;border:none;border-radius:10px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:var(--transition);font-family:'Montserrat',sans-serif}
        .login-form button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(211,47,47,.4)}
        .container{max-width:1400px;margin:0 auto;background:rgba(255,255,255,.05);border-radius:15px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1)}
        .container.hidden{display:none}
        .header{background:linear-gradient(135deg,var(--primary),#B71C1C);color:white;padding:25px 30px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:20px}
        .header-left h1{font-size:2.5em;font-family:'Montserrat',sans-serif;font-weight:800;margin-bottom:5px}
        .header-left p{opacity:.9;font-size:1.1em}
        .header-right{display:flex;align-items:center;gap:20px}
        .nav-tabs{background:rgba(0,0,0,.3);display:flex;padding:0 30px;gap:10px;overflow-x:auto}
        .nav-tab{background:transparent;color:#fff;border:none;padding:20px 30px;font-size:1em;cursor:pointer;transition:var(--transition);font-family:'Montserrat',sans-serif;font-weight:500;border-bottom:3px solid transparent;white-space:nowrap}
        .nav-tab:hover{background:rgba(255,255,255,.1)}
        .nav-tab.active{border-bottom-color:var(--accent);color:var(--accent)}
        .content{padding:30px}
        .section{display:none}
        .section.active{display:block}
        .section-title{font-size:2em;color:#fff;margin-bottom:25px;display:flex;align-items:center;gap:15px;font-family:'Montserrat',sans-serif;font-weight:700}
        .section-title .badge{background:var(--primary);color:white;padding:5px 15px;border-radius:20px;font-size:1rem}
        .stats-grid-modern{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:30px}
        @media (max-width:768px){.stats-grid-modern{grid-template-columns:repeat(2,1fr);gap:12px}}
        @media (min-width:769px) and (max-width:1024px){.stats-grid-modern{grid-template-columns:repeat(3,1fr);gap:15px}}
        @media (min-width:1400px){.stats-grid-modern{grid-template-columns:repeat(6,1fr)}}
        .stat-button{position:relative;background:rgba(255,255,255,.1);padding:25px 15px;border-radius:12px;box-shadow:0 5px 20px var(--shadow);text-align:center;transition:var(--transition);border:2px solid transparent;cursor:pointer;backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);overflow:hidden;z-index:1;display:flex;flex-direction:column;align-items:center;gap:10px;width:100%;font-family:inherit;color:#fff}
        .stat-button::after{content:"";width:1px;height:1px;background:none;position:absolute;z-index:-1;top:50%;left:50%;transition:.3s ease-in-out all;border-radius:100px;transform-origin:center;transform:translate(-50%,-50%)}
        .stat-button:hover::after{transform:scale(400);background:var(--primary)}
        .stat-button:hover{border-color:var(--accent);transform:translateY(-5px)}
        .stat-button .stat-icon{width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5em;color:white;margin:0;background:transparent;position:relative;z-index:2}
        .stat-button .stat-icon.pendientes{background:var(--warning)}
        .stat-button .stat-icon.cobrados{background:var(--success)}
        .stat-button .stat-icon.ventas{background:var(--info)}
        .stat-button .stat-icon.platillos{background:var(--primary)}
        .stat-button .stat-icon.propinas{background:var(--propina)}
        .stat-button .stat-icon.delivery-total{background:var(--delivery)}
        .stat-button .stat-value{font-size:2.2em;font-weight:800;color:#fff;font-family:'Montserrat',sans-serif;line-height:1.2;position:relative;z-index:2}
        .stat-button .stat-label{color:rgba(255,255,255,.8);font-size:.9rem;font-weight:500;text-transform:uppercase;letter-spacing:0.5px;position:relative;z-index:2}
        .pedidos-columns{display:grid;gap:20px;margin:20px 0 30px 0}
        @media (max-width:768px){.pedidos-columns{grid-template-columns:1fr}}
        @media (min-width:769px) and (max-width:1199px){.pedidos-columns{grid-template-columns:repeat(2,1fr)}}
        @media (min-width:1200px){.pedidos-columns{grid-template-columns:repeat(3,1fr)}}
        .pedidos-column{background:rgba(255,255,255,.1);border-radius:12px;overflow:hidden;box-shadow:0 5px 20px var(--shadow);height:fit-content;max-height:600px;display:flex;flex-direction:column;backdrop-filter:blur(5px)}
        .column-header{padding:10px 15px;color:white;font-weight:700;font-size:1rem;display:flex;align-items:center;justify-content:space-between;font-family:'Montserrat',sans-serif}
        .column-header.mesa{background:linear-gradient(135deg,var(--info),#1565C0)}
        .column-header.delivery{background:linear-gradient(135deg,var(--success),#2E7D32)}
        .column-header.reserva{background:linear-gradient(135deg,#9c27b0,#7b1fa2)}
        .column-header.delivery-stats{background:linear-gradient(135deg,var(--delivery),#00838F)}
        .column-header .count-badge{background:rgba(255,255,255,.3);padding:3px 10px;border-radius:20px;font-size:.8rem}
        .column-content{padding:10px;overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:8px;max-height:500px}
        .order-card-compact{background:rgba(0,0,0,.3);border-radius:6px;padding:8px;border-left:4px solid;font-size:.75rem;line-height:1.2;transition:var(--transition);color:#fff}
        .order-card-compact:hover{transform:translateX(-2px);box-shadow:0 3px 8px rgba(0,0,0,.2)}
        .order-card-compact.pendiente{border-left-color:var(--warning)}
        .order-card-compact.en_cocina{border-left-color:var(--info)}
        .order-card-compact.en_camino{border-left-color:var(--success)}
        .order-card-compact.reserva_pendiente{border-left-color:#9c27b0}
        .order-card-compact.reserva_atendida{border-left-color:#ff5722}
        .order-header-compact{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;font-size:.7rem}
        .order-time-compact{color:rgba(255,255,255,.7);background:rgba(255,255,255,.1);padding:2px 6px;border-radius:10px;display:inline-flex;align-items:center;gap:3px}
        .order-info-compact{margin-bottom:4px;padding:3px;background:rgba(0,0,0,.2);border-radius:4px;font-size:.7rem}
        .order-info-compact i{width:12px;color:var(--accent);margin-right:2px}
        .order-items-compact{margin-bottom:4px;padding:3px;background:rgba(0,0,0,.2);border-radius:4px}
        .order-item-row-compact{display:flex;justify-content:space-between;padding:2px 0;font-size:.7rem;border-bottom:1px dashed rgba(255,255,255,.1)}
        .order-item-row-compact:last-child{border-bottom:none}
        .item-name-compact{font-weight:500}
        .item-price-compact{font-weight:600;color:var(--accent)}
        .order-total-compact{font-weight:700;color:var(--accent);text-align:right;margin:4px 0;padding-top:3px;border-top:1px dashed rgba(255,255,255,.1);font-size:.75rem}
        .comprobante-thumbnail{margin:4px 0;cursor:pointer;border:1px solid rgba(255,255,255,.2);border-radius:3px;overflow:hidden;max-width:60px}
        .comprobante-thumbnail img{width:100%;height:auto;display:block}
        .order-actions-compact{display:flex;gap:4px;margin-top:5px}
        .btn-compact{flex:1;padding:4px;border:none;border-radius:3px;font-size:.65rem;font-weight:600;cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;justify-content:center;gap:2px}
        .btn-cobrar-compact{background:linear-gradient(135deg,var(--success),#2E7D32);color:white}
        .btn-rechazar-compact{background:linear-gradient(135deg,var(--danger),#B71C1C);color:white}
        .btn-entregar-compact{background:linear-gradient(135deg,var(--info),#1565C0);color:white}
        .btn-enviar-compact{background:linear-gradient(135deg,var(--success),#2E7D32);color:white}
        .btn-confirmar-compact{background:linear-gradient(135deg,#9c27b0,#7b1fa2);color:white}
        .btn-propina-compact{background:linear-gradient(135deg,var(--propina),#7B1FA2);color:white}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);z-index:3000;display:none;justify-content:center;align-items:center;padding:20px;backdrop-filter:blur(10px)}
        .modal-overlay.active{display:flex}
        .modal-content{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);border-radius:20px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto;animation:slideUp .3s ease;border:1px solid rgba(255,255,255,.1)}
        @keyframes slideUp{from{transform:translateY(50px);opacity:0}to{transform:translateY(0);opacity:1}}
        .modal-header{background:linear-gradient(135deg,var(--primary),#B71C1C);color:white;padding:20px 25px;display:flex;justify-content:space-between;align-items:center}
        .modal-header.propina{background:linear-gradient(135deg,var(--propina),#7B1FA2)}
        .modal-header.delivery{background:linear-gradient(135deg,var(--delivery),#00838F)}
        .modal-header.condonar{background:linear-gradient(135deg,var(--condonar),#c92a2a)}
        .modal-header.favor{background:linear-gradient(135deg,var(--favordecaja),#1e7e7e)}
        .modal-header h2{font-family:'Montserrat',sans-serif;font-size:1.3rem;display:flex;align-items:center;gap:10px}
        .modal-close{background:rgba(255,255,255,.2);border:none;color:white;font-size:1.3rem;cursor:pointer;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
        .modal-close:hover{background:rgba(255,255,255,.3);transform:scale(1.1)}
        .modal-body{padding:25px;color:#fff}
        .modal-footer{padding:20px 25px;border-top:2px solid rgba(255,255,255,.1);display:flex;gap:15px}
        .payment-mix-container{margin-bottom:20px}
        .pago-item{background:rgba(0,0,0,.3);border-radius:8px;padding:15px;margin-bottom:15px;border:1px solid rgba(255,255,255,.1);position:relative}
        .pago-item select,.pago-item input{width:100%;padding:8px;margin-bottom:8px;border:1px solid rgba(255,255,255,.2);border-radius:4px;font-size:.9rem;background:rgba(0,0,0,.5);color:#fff}
        .pago-item select:focus,.pago-item input:focus{outline:none;border-color:var(--accent)}
        .pago-item select option{background:#1a1a2e}
        .remove-pago{position:absolute;top:8px;right:8px;background:var(--danger);color:white;border:none;width:24px;height:24px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.8rem;transition:var(--transition)}
        .remove-pago:hover{transform:scale(1.1)}
        .pagos-total{background:rgba(0,0,0,.3);padding:15px;border-radius:8px;margin:15px 0}
        .pagos-resumen{display:flex;justify-content:space-between;padding:5px 0;font-size:.95rem}
        .pagos-resumen-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
        .pagos-resumen-row .input-group{display:flex;flex-direction:column}
        .pagos-resumen-row .input-group label{font-size:.8rem;color:var(--gray-400);margin-bottom:3px}
        .pagos-resumen-row .input-group input{padding:6px;border:1px solid rgba(255,255,255,.2);border-radius:4px;background:rgba(0,0,0,.5);color:#fff}
        .pagos-checkbox{display:flex;align-items:center;gap:8px;margin:10px 0;padding:10px;background:rgba(0,0,0,.2);border-radius:6px}
        .pagos-checkbox input[type="checkbox"]{width:18px;height:18px}
        .pagos-checkbox label{font-size:.9rem;color:#fff}
        .pagos-checkbox .badge{background:var(--condonar);color:white;padding:2px 8px;border-radius:12px;font-size:.7rem;margin-left:10px}
        .pagos-checkbox .badge.favor{background:var(--favordecaja)}
        .detail-item-compact{background:rgba(0,0,0,.3);border-radius:6px;padding:10px;margin-bottom:10px;border-left:3px solid var(--info);font-size:.8rem;line-height:1.2}
        .detail-header-compact{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;color:rgba(255,255,255,.7);font-weight:500}
        .detail-time-compact{background:rgba(255,255,255,.1);padding:2px 6px;border-radius:10px;font-size:.7rem}
        .detail-items-compact{margin:5px 0;padding-left:5px}
        .detail-item-row-compact{display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px dotted rgba(255,255,255,.1)}
        .detail-item-row-compact:last-child{border-bottom:none}
        .detail-total-compact{font-weight:700;color:var(--accent);text-align:right;margin-top:5px;padding-top:3px;border-top:1px dashed rgba(255,255,255,.1);font-size:.85rem}
        .detail-metodo-tag{background:rgba(56,142,60,.2);color:var(--success);padding:2px 6px;border-radius:12px;font-size:.7rem;font-weight:600;display:inline-flex;align-items:center;gap:3px;margin-right:4px}
        .propina-tag{background:rgba(156,39,176,.2);color:var(--propina);padding:2px 8px;border-radius:12px;font-size:.7rem;font-weight:600;display:inline-flex;align-items:center;gap:3px}
        .delivery-tag{background:rgba(0,172,193,.2);color:var(--delivery);padding:2px 8px;border-radius:12px;font-size:.7rem;font-weight:600;display:inline-flex;align-items:center;gap:3px}
        .condonar-tag{background:rgba(255,107,107,.2);color:var(--condonar);padding:2px 8px;border-radius:12px;font-size:.7rem;font-weight:600;display:inline-flex;align-items:center;gap:3px}
        .favor-tag{background:rgba(78,205,196,.2);color:var(--favordecaja);padding:2px 8px;border-radius:12px;font-size:.7rem;font-weight:600;display:inline-flex;align-items:center;gap:3px}
        .ranking-bar{display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid rgba(255,255,255,.1)}
        .ranking-position{width:26px;height:26px;background:var(--accent);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem}
        .ranking-info{flex:1}
        .ranking-name{font-weight:600;font-size:.9rem}
        .ranking-cantidad{color:rgba(255,255,255,.6);font-size:.8rem}
        .ranking-bar-container{width:80px;height:6px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden}
        .ranking-bar-fill{height:100%;background:var(--primary);border-radius:4px}
        .mesa-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;margin-top:15px}
        .mesa-btn{background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);border-radius:8px;padding:12px 5px;cursor:pointer;font-size:.9rem;font-weight:600;color:#fff;transition:var(--transition);display:flex;flex-direction:column;align-items:center;gap:5px}
        .mesa-btn:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
        .mesa-btn i{font-size:1.5rem;color:var(--accent)}
        .menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px}
        .menu-card{background:rgba(255,255,255,.1);border-radius:10px;overflow:hidden;box-shadow:0 5px 20px var(--shadow);backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1)}
        .menu-card-image{height:140px;background-size:cover;background-position:center;background-color:rgba(0,0,0,.5)}
        .menu-card-content{padding:15px}
        .menu-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .menu-card-title{font-weight:700;font-size:1rem;color:#fff}
        .menu-card-price{font-weight:700;color:var(--accent)}
        .menu-card-stock{font-size:.8rem;padding:.25rem .5rem;border-radius:4px;background:rgba(0,0,0,.3);display:inline-block;margin-top:5px}
        .menu-card-stock.available{color:var(--success)}
        .menu-card-stock.low{color:var(--warning)}
        .menu-card-stock.sold-out{color:var(--danger)}
        .empty-state{text-align:center;padding:30px 15px;color:rgba(255,255,255,.5);font-size:.9rem}
        .empty-state i{font-size:2.5em;margin-bottom:10px}
        .toast{position:fixed;top:80px;right:20px;background:linear-gradient(135deg,#1a1a2e,#16213e);padding:15px 20px;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,.3);display:none;align-items:center;gap:12px;z-index:5000;animation:slideIn .3s ease;border-left:4px solid var(--success);border:1px solid rgba(255,255,255,.1);color:#fff}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0%);opacity:1}}
        .toast.show{display:flex}
        .loading-spinner{display:inline-block;width:30px;height:30px;border:3px solid rgba(211,47,47,.2);border-radius:50%;border-top-color:var(--primary);animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-container{text-align:center;padding:2rem}
        .keyboard-hint{background:rgba(0,0,0,.3);padding:10px 15px;border-radius:8px;font-size:.8rem;color:rgba(255,255,255,.7);margin-top:15px;display:flex;justify-content:center;gap:20px}
        .keyboard-hint kbd{background:rgba(255,255,255,.1);padding:3px 6px;border-radius:4px;border:1px solid rgba(255,255,255,.2);font-family:monospace;color:#fff}
        .text-center{text-align:center}
        .mt-2{margin-top:.5rem}
        .mb-2{margin-bottom:.5rem}
        .mesonero-selector{margin-bottom:20px}
        .mesonero-selector label{display:block;margin-bottom:8px;font-weight:600;color:#fff}
        .mesonero-selector select{width:100%;padding:10px;border:2px solid rgba(255,255,255,.2);border-radius:8px;font-size:1rem;background:rgba(0,0,0,.5);color:#fff}
        .mesonero-selector select option{background:#1a1a2e}
        .delivery-selector{margin-bottom:20px}
        .delivery-selector label{display:block;margin-bottom:8px;font-weight:600;color:#fff}
        .delivery-selector select{width:100%;padding:10px;border:2px solid rgba(255,255,255,.2);border-radius:8px;font-size:1rem;background:rgba(0,0,0,.5);color:#fff}
        .delivery-selector select option{background:#1a1a2e}
        .propina-monto-group{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px}
        .propina-monto-group input{width:100%;padding:10px;border:2px solid rgba(255,255,255,.2);border-radius:8px;font-size:1rem;background:rgba(0,0,0,.5);color:#fff}
        .propina-monto-group input:focus{outline:none;border-color:var(--accent)}
        .referencia-input{display:flex;gap:8px;justify-content:center;margin-bottom:20px}
        .referencia-input input{width:45px;height:45px;text-align:center;font-size:1.3rem;border:2px solid rgba(255,255,255,.2);border-radius:8px;background:rgba(0,0,0,.5);color:#fff}
        .referencia-input input:focus{border-color:var(--accent);outline:none}
        .btn-primary{background:linear-gradient(135deg,var(--primary),#b71c1c);color:white;border:none;padding:.75rem 1.5rem;border-radius:8px;font-weight:600;cursor:pointer;transition:var(--transition)}
        .btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 5px 15px rgba(211,47,47,.4)}
        .btn-primary:disabled{opacity:.5;cursor:not-allowed}
        .btn-secondary{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);padding:.75rem 1.5rem;border-radius:8px;font-weight:600;cursor:pointer;transition:var(--transition)}
        .btn-secondary:hover{background:rgba(255,255,255,.2)}
        .btn-condonar{background:linear-gradient(135deg,var(--condonar),#c92a2a);color:white;border:none;padding:.75rem 1.5rem;border-radius:8px;font-weight:600;cursor:pointer;transition:var(--transition)}
        .btn-condonar:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 5px 15px rgba(255,107,107,.4)}
        .btn-favor{background:linear-gradient(135deg,var(--favordecaja),#1e7e7e);color:white;border:none;padding:.75rem 1.5rem;border-radius:8px;font-weight:600;cursor:pointer;transition:var(--transition)}
        .btn-favor:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 5px 15px rgba(78,205,196,.4)}
        .motorizados-list{display:flex;flex-direction:column;gap:10px;margin-top:15px}
        .motorizado-item{display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,.3);padding:12px;border-radius:8px;border-left:4px solid var(--delivery)}
        .motorizado-nombre{font-weight:600;color:#fff}
        .motorizado-monto{font-weight:700;color:var(--accent)}
        .categorias-wrapper{position:relative;width:100%;overflow-x:auto;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;scrollbar-width:none;-ms-overflow-style:none}
        .categorias-wrapper::-webkit-scrollbar{display:none}
        .category-list{display:flex;gap:10px;padding:10px 0;list-style:none;margin:0;white-space:nowrap}
        .category-item{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;background:rgba(255,255,255,.1);border-radius:30px;cursor:pointer;transition:var(--transition);border:1px solid rgba(255,255,255,.1);color:#fff;font-weight:500}
        .category-item:hover{background:var(--primary);transform:translateY(-2px)}
        .category-item.active{background:var(--accent);color:var(--secondary);border-color:var(--accent)}
        .category-item i{font-size:1rem}
        .swipe-hint{display:flex;align-items:center;justify-content:center;gap:10px;margin:10px 0;color:var(--gray-400);font-size:.8rem}
        .swipe-hint i{animation:slideHint 1.5s infinite}
        @keyframes slideHint{0%,100%{transform:translateX(0)}50%{transform:translateX(5px)}}
    </style>
</head>
<body>
    <audio id="alarmaSonido" loop preload="auto"><source src="https://iqwwoihiiyrtypyqzhgy.supabase.co/storage/v1/object/public/alarma/Alarm%20Clock%20Effect%20Sound%20HD%20-%20Despertador%20Efecto%20D'%20Sonido.mp3" type="audio/mpeg"></audio>
    
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h2><i class="fas fa-cash-register"></i> Cajero Saki Sushi</h2>
            <form class="login-form" id="loginForm" onsubmit="event.preventDefault(); window.hacerLogin()">
                <input type="text" id="username" placeholder="Usuario" value="cajero1" required autofocus>
                <input type="password" id="password" placeholder="Contraseña" value="123456" required>
                <button type="submit">Iniciar Sesión</button>
            </form>
        </div>
    </div>
    
    <div class="container hidden" id="panelContainer">
        <div class="header">
            <div class="header-left">
                <h1><i class="fas fa-cash-register"></i> Panel del Cajero</h1>
                <p>Saki Sushi - Gestión de pedidos y cobros</p>
            </div>
            <div class="header-right">
                <button class="btn btn-primary" onclick="window.abrirSelectorMesa()" style="padding:12px 25px"><i class="fas fa-utensils"></i> Menú Cliente</button>
                <button class="btn btn-secondary" onclick="window.cerrarSesion()" style="padding:12px 25px"><i class="fas fa-sign-out-alt"></i> Salir</button>
            </div>
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="window.showSection('pedidos')"><i class="fas fa-clipboard-list"></i> Pedidos</button>
            <button class="nav-tab" onclick="window.showSection('menu')"><i class="fas fa-utensils"></i> Ver Menú</button>
            <button class="nav-tab" onclick="window.showSection('propinas')"><i class="fas fa-hand-holding-heart"></i> Propinas</button>
            <button class="nav-tab" onclick="window.showSection('deliverys')"><i class="fas fa-motorcycle"></i> Deliverys</button>
        </div>
        <div class="content">
            <div class="section active" id="section-pedidos">
                <h2 class="section-title"><i class="fas fa-clipboard-list"></i> Pedidos del Día</h2>
                <div class="stats-grid-modern">
                    <button class="stat-button cuatro" onclick="window.abrirModalDetalle('preparacion')"><span class="stat-icon pendientes"><i class="fas fa-fire"></i></span><span class="stat-value" id="statPreparacion">0</span><span class="stat-label">En Preparación</span></button>
                    <button class="stat-button cuatro" onclick="window.abrirModalDetalle('cobrados')"><span class="stat-icon cobrados"><i class="fas fa-check-circle"></i></span><span class="stat-value" id="statCobrados">0</span><span class="stat-label">Cobrados Hoy</span></button>
                    <button class="stat-button cuatro" onclick="window.abrirModalDetalle('ventas')"><span class="stat-icon ventas"><i class="fas fa-dollar-sign"></i></span><span class="stat-value" id="statVentas">Bs. 0</span><span class="stat-label">Ventas Totales</span></button>
                    <button class="stat-button cuatro" onclick="window.abrirModalDetalle('platillos')"><span class="stat-icon platillos"><i class="fas fa-utensils"></i></span><span class="stat-value" id="statPlatillos">0</span><span class="stat-label">Platillos Vend.</span></button>
                    <button class="stat-button cuatro" onclick="window.abrirModalDetalle('propinas')"><span class="stat-icon propinas"><i class="fas fa-hand-holding-heart"></i></span><span class="stat-value" id="statPropinas">Bs. 0</span><span class="stat-label">Propinas Hoy</span></button>
                    <button class="stat-button cuatro" onclick="window.abrirModalDeliverys()"><span class="stat-icon delivery-total"><i class="fas fa-motorcycle"></i></span><span class="stat-value" id="statDeliverysTotal">Bs. 0</span><span class="stat-label">Deliverys</span></button>
                </div>
                <div style="margin:30px 0 20px 0"><h3 style="font-size:1.5rem;color:#fff;display:flex;align-items:center;gap:10px"><i class="fas fa-clock" style="color:var(--warning)"></i> Pedidos Pendientes<span class="badge" style="background:var(--warning)" id="totalPendientesBadge">0</span></h3></div>
                <div class="pedidos-columns">
                    <div class="pedidos-column"><div class="column-header mesa"><span><i class="fas fa-store"></i> MESA</span><span class="count-badge" id="mesaPendientesCount">0</span></div><div class="column-content" id="mesaPendientesContainer"></div></div>
                    <div class="pedidos-column"><div class="column-header delivery"><span><i class="fas fa-motorcycle"></i> DELIVERY</span><span class="count-badge" id="deliveryPendientesCount">0</span></div><div class="column-content" id="deliveryPendientesContainer"></div></div>
                    <div class="pedidos-column"><div class="column-header reserva"><span><i class="fas fa-calendar-check"></i> RESERVA</span><span class="count-badge" id="reservaPendientesCount">0</span></div><div class="column-content" id="reservaPendientesContainer"></div></div>
                </div>
                <div style="margin:40px 0 20px 0"><h3 style="font-size:1.5rem;color:#fff;display:flex;align-items:center;gap:10px"><i class="fas fa-fire" style="color:var(--warning)"></i> Pedidos en Preparación<span class="badge" style="background:var(--warning)" id="totalPreparacionBadge">0</span></h3></div>
                <div class="pedidos-columns">
                    <div class="pedidos-column"><div class="column-header mesa"><span><i class="fas fa-fire"></i> MESA EN COCINA</span><span class="count-badge" id="mesaCocinaCount">0</span></div><div class="column-content" id="mesaCocinaContainer"></div></div>
                    <div class="pedidos-column"><div class="column-header delivery"><span><i class="fas fa-truck"></i> DELIVERY EN CAMINO</span><span class="count-badge" id="deliveryCaminoCount">0</span></div><div class="column-content" id="deliveryCaminoContainer"></div></div>
                    <div class="pedidos-column"><div class="column-header reserva"><span><i class="fas fa-clock"></i> RESERVAS PENDIENTES</span><span class="count-badge" id="reservaProcesoCount">0</span></div><div class="column-content" id="reservaProcesoContainer"></div></div>
                </div>
            </div>
            <div class="section" id="section-menu">
                <h2 class="section-title"><i class="fas fa-utensils"></i> Menú Actual</h2>
                <div class="categorias-wrapper" id="categoriasWrapper">
                    <ul class="category-list" id="categoryList"></ul>
                </div>
                <div class="swipe-hint"><i class="fas fa-chevron-left"></i> Desliza para ver más categorías <i class="fas fa-chevron-right"></i></div>
                <div class="menu-grid" id="menuGrid"><div class="loading-container"><div class="loading-spinner"></div><p>Cargando menú...</p></div></div>
            </div>
            <div class="section" id="section-propinas">
                <h2 class="section-title"><i class="fas fa-hand-holding-heart"></i> Propinas del Día</h2>
                <div class="stats-grid-modern" style="margin-bottom:30px">
                    <button class="stat-button cuatro" onclick="window.abrirModalDetalle('propinasDetalle')"><span class="stat-icon propinas"><i class="fas fa-hand-holding-heart"></i></span><span class="stat-value" id="propinasTotal">Bs. 0</span><span class="stat-label">Total Propinas</span></button>
                    <button class="stat-button cuatro" onclick="window.abrirModalDetalle('propinasCantidad')"><span class="stat-icon propinas"><i class="fas fa-hashtag"></i></span><span class="stat-value" id="propinasCantidad">0</span><span class="stat-label">Cantidad</span></button>
                    <button class="stat-button cuatro" onclick="window.abrirModalDetalle('propinasPromedio')"><span class="stat-icon propinas"><i class="fas fa-chart-line"></i></span><span class="stat-value" id="propinasPromedio">Bs. 0</span><span class="stat-label">Promedio</span></button>
                </div>
                <div id="propinasContainer" class="pedidos-columns" style="grid-template-columns:1fr"><div class="pedidos-column" style="max-height:500px"><div class="column-header propina"><span><i class="fas fa-clock"></i> Últimas Propinas</span><span class="count-badge" id="propinasListCount">0</span></div><div class="column-content" id="propinasListContainer"></div></div></div>
            </div>
            <div class="section" id="section-deliverys">
                <h2 class="section-title"><i class="fas fa-motorcycle" style="color:var(--delivery)"></i> Estadísticas de Deliverys</h2>
                <div class="stats-grid-modern" style="margin-bottom:30px">
                    <button class="stat-button cuatro" onclick="window.abrirModalDetalle('deliverysTotal')"><span class="stat-icon delivery-total"><i class="fas fa-motorcycle"></i></span><span class="stat-value" id="deliverysTotalStats">Bs. 0</span><span class="stat-label">Total Deliverys</span></button>
                    <button class="stat-button cuatro" onclick="window.abrirModalDetalle('deliverysCantidad')"><span class="stat-icon delivery-total"><i class="fas fa-hashtag"></i></span><span class="stat-value" id="deliverysCantidadStats">0</span><span class="stat-label">Entregas Hoy</span></button>
                    <button class="stat-button cuatro" onclick="window.abrirModalDetalle('deliverysPromedio')"><span class="stat-icon delivery-total"><i class="fas fa-chart-line"></i></span><span class="stat-value" id="deliverysPromedioStats">Bs. 0</span><span class="stat-label">Promedio por entrega</span></button>
                </div>
                <div id="deliverysContainer" class="pedidos-columns" style="grid-template-columns:1fr">
                    <div class="pedidos-column" style="max-height:500px">
                        <div class="column-header delivery-stats"><span><i class="fas fa-clock"></i> Últimas Entregas</span><span class="count-badge" id="deliverysListCount">0</span></div>
                        <div class="column-content" id="deliverysListContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="cobroModal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-cash-register"></i> Procesar Cobro</h2><button class="modal-close" onclick="window.cerrarCobroModal()"><i class="fas fa-times"></i></button></div><div class="modal-body" id="cobroModalBody"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="window.cerrarCobroModal()">Cancelar (ESC)</button><button class="btn btn-primary" id="confirmCobroBtn" onclick="window.confirmarCobro()" disabled>Confirmar Cobro (ENTER)</button></div></div></div>
    <div class="modal-overlay" id="propinaModal"><div class="modal-content"><div class="modal-header propina"><h2><i class="fas fa-hand-holding-heart"></i> Registrar Propina</h2><button class="modal-close" onclick="window.cerrarPropinaModal()"><i class="fas fa-times"></i></button></div><div class="modal-body" id="propinaModalBody"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="window.cerrarPropinaModal()">Cancelar (ESC)</button><button class="btn btn-primary" id="confirmPropinaBtn" style="background:linear-gradient(135deg,var(--propina),#7B1FA2)" onclick="window.confirmarPropina()" disabled>Guardar Propina</button></div></div></div>
    <div class="modal-overlay" id="confirmModal"><div class="modal-content"><div class="modal-header" id="confirmModalHeader"><h2 id="confirmModalTitle"><i class="fas fa-check-circle"></i> Confirmar Acción</h2><button class="modal-close" onclick="window.cerrarModal('confirmModal')"><i class="fas fa-times"></i></button></div><div class="modal-body" id="confirmModalBody"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="window.cerrarModal('confirmModal')">Cancelar (ESC)</button><button class="btn btn-primary" id="confirmActionBtn" onclick="window.ejecutarConfirmacion()">Confirmar (ENTER)</button></div></div></div>
    <div class="modal-overlay" id="rechazoModal"><div class="modal-content"><div class="modal-header" style="background:linear-gradient(135deg,var(--danger),#B71C1C)"><h2><i class="fas fa-times-circle"></i> Rechazar Pedido</h2><button class="modal-close" onclick="window.cerrarModal('rechazoModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><p style="margin-bottom:20px;color:#fff">Selecciona la razón del rechazo:</p><div style="display:flex;flex-direction:column;gap:10px"><label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;cursor:pointer"><input type="radio" name="rejectionReason" value="referencia_invalida" style="width:18px;height:18px"><span>Referencia de pago inválida o falsa</span></label><label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;cursor:pointer"><input type="radio" name="rejectionReason" value="monto_insuficiente" style="width:18px;height:18px"><span>Monto insuficiente</span></label><label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;cursor:pointer"><input type="radio" name="rejectionReason" value="datos_incorrectos" style="width:18px;height:18px"><span>Datos de contacto/dirección incorrectos</span></label><label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;cursor:pointer"><input type="radio" name="rejectionReason" value="no_disponible" style="width:18px;height:18px"><span>Producto no disponible</span></label><label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;cursor:pointer"><input type="radio" name="rejectionReason" value="fuera_horario" style="width:18px;height:18px"><span>Fuera de horario de delivery</span></label></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="window.cerrarModal('rechazoModal')">Cancelar</button><button class="btn btn-primary" style="background:linear-gradient(135deg,var(--danger),#B71C1C)" onclick="window.confirmarRechazo()">Confirmar Rechazo</button></div></div></div>
    <div class="modal-overlay" id="detalleModal"><div class="modal-content"><div class="modal-header" style="background:linear-gradient(135deg,var(--info),#1565C0)"><h2 id="detalleModalTitle"><i class="fas fa-chart-bar"></i> Detalle</h2><button class="modal-close" onclick="window.cerrarModal('detalleModal')"><i class="fas fa-times"></i></button></div><div class="modal-body" id="detalleModalBody"></div><div class="modal-footer"><button class="btn btn-primary" onclick="window.cerrarModal('detalleModal')">Cerrar (ESC)</button></div></div></div>
    <div class="modal-overlay" id="mesaModal"><div class="modal-content"><div class="modal-header" style="background:linear-gradient(135deg,var(--info),#1565C0)"><h2><i class="fas fa-chair"></i> Seleccionar Mesa</h2><button class="modal-close" onclick="window.cerrarModal('mesaModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><p style="margin-bottom:20px;color:#fff">Elige la mesa para la cual quieres armar el pedido:</p><div id="mesaList" class="mesa-grid"><div class="loading-container"><div class="loading-spinner"></div><p>Cargando mesas...</p></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="window.cerrarModal('mesaModal')">Cancelar</button></div></div></div>
    <div class="modal-overlay" id="comprobanteModal"><div class="modal-content" style="max-width:500px"><div class="modal-header" style="background:linear-gradient(135deg,var(--info),#1565C0)"><h2><i class="fas fa-receipt"></i> Comprobante de Pago</h2><button class="modal-close" onclick="window.cerrarModal('comprobanteModal')"><i class="fas fa-times"></i></button></div><div class="modal-body text-center" id="comprobanteModalBody"></div><div class="modal-footer"><button class="btn btn-primary" onclick="window.cerrarModal('comprobanteModal')">Cerrar (ESC)</button></div></div></div>
    <div class="modal-overlay" id="deliveryModal"><div class="modal-content"><div class="modal-header delivery"><h2><i class="fas fa-motorcycle"></i> Acumulado Deliverys (Hoy)</h2><button class="modal-close" onclick="window.cerrarModal('deliveryModal')"><i class="fas fa-times"></i></button></div><div class="modal-body" id="deliveryModalBody"></div><div class="modal-footer"><button class="btn btn-primary" onclick="window.cerrarModal('deliveryModal')">Cerrar (ESC)</button></div></div></div>
    <div class="toast" id="toast"><i class="fas fa-check-circle" style="color:var(--success);font-size:1.2rem"></i><div><p id="toastText" style="margin:0;color:#fff">Operación completada</p></div></div>
    
    <script src="../supabase-config.js"></script>
    <script>
        // ==================== VARIABLES GLOBALES ====================
        window.currentUser = null;
        window.pedidos = [];
        window.ventasHoy = [];
        window.propinas = [];
        window.menuItems = [];
        window.inventario = [];
        window.mesas = [];
        window.currentPedido = null;
        window.pedidoParaAccion = null;
        window.accionPendiente = null;
        window.pagosMixtos = [];
        window.tasaEfectiva = 400;
        window.currentPropinaPedido = null;
        window.mesoneros = [];
        window.deliverys = [];
        window.currentPropinaData = { mesonero: '', mesa: 'Delivery', metodo: 'efectivo_bs', montoBs: 0, montoUsd: 0, referencia: '', tasaAplicada: 400 };
        window.alarmaAudio = document.getElementById('alarmaSonido');
        window.alarmaActiva = false;
        window.enProcesoDeCobro = false;
        window.suscripciones = [];
        window.paginaVisible = true;
        window.reconectando = false;
        window.intervaloVerificacion = null;
        window.ultimaActualizacion = Date.now();

        // ==================== FUNCIONES BÁSICAS ====================
        window.mostrarToast = function(mensaje, tipo = 'success') {
            const toast = document.getElementById('toast');
            const toastText = document.getElementById('toastText');
            if (!toast || !toastText) { alert(mensaje); return; }
            toastText.textContent = mensaje;
            toast.className = 'toast show';
            if (tipo === 'error') {
                toast.querySelector('i').style.color = 'var(--danger)';
                toast.style.borderLeftColor = 'var(--danger)';
            } else {
                toast.querySelector('i').style.color = 'var(--success)';
                toast.style.borderLeftColor = 'var(--success)';
            }
            setTimeout(() => toast.classList.remove('show'), 3000);
        };

        window.formatBs = function(m) {
            return new Intl.NumberFormat('es-VE', { style: 'currency', currency: 'VES', minimumFractionDigits: 2 }).format(m).replace('VES', 'Bs.');
        };

        window.formatUSD = function(m) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(m);
        };

        window.usdToBs = function(u) {
            return u * (window.tasaEfectiva || 400);
        };

        window.cerrarModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('active');
            if (modalId === 'confirmModal') { window.pedidoParaAccion = null; window.accionPendiente = null; }
        };

        window.mostrarLogin = function() {
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('panelContainer').classList.add('hidden');
            window.detenerAlarma();
        };

        window.mostrarPanel = function() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('panelContainer').classList.remove('hidden');
            window.setupEventListeners();
            window.setupRealtimeSubscriptions();
            setTimeout(() => window.verificarYControlarAlarma(true), 100);
        };

        window.cerrarSesion = function() {
            sessionStorage.removeItem('cajero_user');
            window.currentUser = null;
            window.detenerAlarma();
            window.mostrarLogin();
        };

        window.detenerAlarma = function() {
            if (window.alarmaActiva && window.alarmaAudio) { window.alarmaAudio.pause(); window.alarmaAudio.currentTime = 0; window.alarmaActiva = false; }
        };

        window.verificarYControlarAlarma = function(forzar = false) {
            const pendientes = (window.pedidos || []).filter(p => p.estado === 'pendiente').length;
            if (pendientes > 0 && !window.enProcesoDeCobro) {
                if (!window.alarmaActiva && window.alarmaAudio) { window.alarmaAudio.play().then(() => { window.alarmaActiva = true; }).catch(() => {}); }
            } else if (window.alarmaActiva && window.alarmaAudio && (pendientes === 0 || window.enProcesoDeCobro)) {
                window.alarmaAudio.pause(); window.alarmaAudio.currentTime = 0; window.alarmaActiva = false;
            }
        };

        window.showSection = function(sectionName) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`section-${sectionName}`).classList.add('active');
            event.target.classList.add('active');
            if (sectionName === 'pedidos') window.renderizarPedidos();
            else if (sectionName === 'menu') window.renderizarMenu();
            else if (sectionName === 'propinas') window.renderizarPropinas();
            else if (sectionName === 'deliverys') window.renderizarDeliverysStats();
        };

        window.abrirSelectorMesa = async function() {
            await window.cargarMesas();
            const modal = document.getElementById('mesaModal');
            const lista = document.getElementById('mesaList');
            lista.innerHTML = (window.mesas || []).length ? window.mesas.map(m => `<button class="mesa-btn" onclick="window.abrirMesa('${m.nombre}')"><i class="fas fa-chair"></i>${m.nombre}</button>`).join('') : '<p class="text-center">No hay mesas</p>';
            modal.classList.add('active');
        };

        window.abrirMesa = function(n) {
            window.open(`${window.location.origin}/Cliente/index.html?mesa=${encodeURIComponent(n)}`, '_blank');
            window.cerrarModal('mesaModal');
        };

        window.abrirModalDeliverys = async function() {
            const acumulado = await window.obtenerAcumuladoDeliverysHoy();
            const modal = document.getElementById('deliveryModal');
            const body = document.getElementById('deliveryModalBody');
            let contenido = '<h3 style="margin-bottom:20px">Acumulado por motorizado (Hoy)</h3>';
            if (!window.deliverys || window.deliverys.length === 0) contenido += '<div class="empty-state"><i class="fas fa-motorcycle"></i><p>No hay motorizados registrados</p></div>';
            else {
                contenido += '<div class="motorizados-list">';
                window.deliverys.forEach(d => { const monto = acumulado[d.id] || 0; contenido += `<div class="motorizado-item"><span class="motorizado-nombre">${d.nombre}</span><span class="motorizado-monto">${window.formatBs(monto)}</span></div>`; });
                contenido += '</div>';
            }
            body.innerHTML = contenido;
            modal.classList.add('active');
        };

        window.abrirModalDetalle = async function(tipo) {
            await window.cargarVentasHoy();
            await window.cargarPropinas();
            const modal = document.getElementById('detalleModal');
            const title = document.getElementById('detalleModalTitle');
            const body = document.getElementById('detalleModalBody');
            let contenido = '';
            
            switch (tipo) {
                case 'preparacion':
                    title.innerHTML = '<i class="fas fa-fire"></i> Pedidos en Preparación';
                    const enPreparacion = (window.pedidos || []).filter(p => ['en_cocina','en_camino','reserva_pendiente','reserva_atendida'].includes(p.estado));
                    contenido = enPreparacion.length ? enPreparacion.map(p => window.crearDetallePedidoCompacto(p)).join('') : '<div class="empty-state"><i class="fas fa-inbox"></i><p>No hay pedidos en preparación</p></div>';
                    break;
                case 'cobrados':
                    title.innerHTML = '<i class="fas fa-check-circle"></i> Cobrados Hoy';
                    if (!window.ventasHoy || window.ventasHoy.length === 0) contenido = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No hay cobros registrados hoy</p></div>';
                    else contenido = window.ventasHoy.map(v => { const p = (window.pedidos || []).find(p => p.id === v.pedido_id); return window.crearDetalleVentaCompacto(v, p); }).join('');
                    break;
                case 'ventas':
                    title.innerHTML = '<i class="fas fa-dollar-sign"></i> Ventas Totales (Platillos)';
                    const totalBs = (window.ventasHoy || []).reduce((s, v) => s + (v.subtotal_platillos || 0), 0);
                    let efBs = 0, efUSD = 0, pm = 0, pv = 0, condonado = 0, favor = 0;
                    (window.ventasHoy || []).forEach(v => {
                        const ped = (window.pedidos || []).find(p => p.id === v.pedido_id);
                        if (ped?.condonado) condonado += ped.condonado;
                        if (ped?.a_favor_caja) favor += ped.a_favor_caja;
                        if (ped?.metodo_pago) {
                            if (ped.metodo_pago === 'efectivo_bs') efBs += v.subtotal_platillos || 0;
                            else if (ped.metodo_pago === 'efectivo_usd') efUSD += v.subtotal_platillos || 0;
                            else if (ped.metodo_pago === 'pago_movil') pm += v.subtotal_platillos || 0;
                            else if (ped.metodo_pago === 'punto_venta') pv += v.subtotal_platillos || 0;
                        }
                    });
                    contenido = `<p><strong>Total del día (platillos):</strong> ${window.formatBs(totalBs)}</p><p><strong>Cantidad de ventas:</strong> ${window.ventasHoy.length}</p>${condonado>0?`<p><strong class="condonar-tag">Condonado:</strong> ${window.formatBs(condonado)}</p>`:''}${favor>0?`<p><strong class="favor-tag">A favor de caja:</strong> ${window.formatBs(favor)}</p>`:''}<h4>Desglose por método:</h4><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px"><div class="payment-tag" style="justify-content:space-between;padding:6px"><span>Efectivo Bs</span><span>${window.formatBs(efBs)}</span></div><div class="payment-tag" style="justify-content:space-between;padding:6px"><span>Efectivo USD</span><span>${window.formatBs(efUSD)}</span></div><div class="payment-tag" style="justify-content:space-between;padding:6px"><span>Pago Móvil</span><span>${window.formatBs(pm)}</span></div><div class="payment-tag" style="justify-content:space-between;padding:6px"><span>Punto de Venta</span><span>${window.formatBs(pv)}</span></div></div><h4>Ventas del día:</h4>${(window.ventasHoy || []).map(v => { const p = (window.pedidos || []).find(p => p.id === v.pedido_id); return window.crearDetalleVentaCompacto(v, p); }).join('')}`;
                    break;
                case 'platillos':
                    title.innerHTML = '<i class="fas fa-utensils"></i> Platillos Vendidos';
                    const hoy = new Date().toDateString();
                    const pedHoy = (window.pedidos || []).filter(p => ['cobrado','entregado','enviado','reserva_completada'].includes(p.estado) && new Date(p.timestamp).toDateString() === hoy);
                    const conteo = {};
                    let total = 0;
                    pedHoy.forEach(p => { p.items?.forEach(i => { const c = i.cantidad || 1; conteo[i.nombre] = (conteo[i.nombre] || 0) + c; total += c; }); });
                    const ranking = Object.entries(conteo).sort((a,b)=>b[1]-a[1]);
                    const max = ranking[0]?.[1] || 0;
                    if (!ranking.length) contenido = '<div class="empty-state"><i class="fas fa-utensils"></i><p>No hay platillos vendidos hoy</p></div>';
                    else contenido = `<p><strong>Total unidades:</strong> ${total}</p><div style="max-height:400px;overflow-y:auto">${ranking.map(([n,c],i)=>`<div class="ranking-bar"><div class="ranking-position">${i+1}</div><div class="ranking-info"><div class="ranking-name">${n}</div><div class="ranking-cantidad">${c} vendido(s)</div></div><div class="ranking-bar-container"><div class="ranking-bar-fill" style="width:${(c/max)*100}%"></div></div></div>`).join('')}</div>`;
                    break;
                default:
                    contenido = '<p>Selecciona una opción válida</p>';
            }
            body.innerHTML = contenido;
            modal.classList.add('active');
        };

        window.cerrarCobroModal = function() {
            document.getElementById('cobroModal').classList.remove('active');
            window.enProcesoDeCobro = false;
            window.currentPedido = null;
            window.pagosMixtos = [];
            setTimeout(() => window.verificarYControlarAlarma(true), 100);
        };

        window.cerrarPropinaModal = function() {
            document.getElementById('propinaModal').classList.remove('active');
            window.currentPropinaPedido = null;
        };

        window.crearDetalleVentaCompacto = function(venta, pedido) {
            if (!pedido) return '';
            const hora = new Date(pedido.timestamp).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
            const items = (pedido.items||[]).map(i=>`<div class="detail-item-row-compact"><span>${i.cantidad||1}x ${i.nombre}</span><span>${window.formatBs(window.usdToBs((i.precioUnitarioUSD||0)*(i.cantidad||1)))}</span></div>`).join('');
            return `<div class="detail-item-compact"><div class="detail-header-compact"><span>${hora}</span><span class="detail-metodo-tag">${venta.tipo}</span></div><div class="detail-items-compact">${items}</div><div class="detail-total-compact">Total: ${window.formatBs(venta.subtotal_platillos||(venta.total*window.tasaEfectiva))}</div></div>`;
        };

        window.crearDetallePedidoCompacto = function(pedido) {
            const hora = new Date(pedido.timestamp).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
            const items = (pedido.items||[]).map(i=>`<div class="detail-item-row-compact"><span>${i.cantidad||1}x ${i.nombre}</span><span>${window.formatBs(window.usdToBs((i.precioUnitarioUSD||0)*(i.cantidad||1)))}</span></div>`).join('');
            return `<div class="detail-item-compact"><div class="detail-header-compact"><span>${hora}</span><span class="detail-metodo-tag">${pedido.tipo}</span></div><div class="detail-items-compact">${items}</div><div class="detail-total-compact">Total: ${window.formatBs(window.usdToBs(pedido.total||0))}</div></div>`;
        };

        window.crearDetallePedidoHTML = function(pedido) {
            return `<div class="detail-item"><div class="detail-row"><span class="detail-label">Cliente:</span><span class="detail-value">${pedido.cliente_nombre||'N/A'}</span></div><div class="detail-row"><span class="detail-label">Tipo:</span><span class="detail-value">${pedido.tipo}</span></div>${pedido.tipo==='mesa'?`<div class="detail-row"><span class="detail-label">Mesa:</span><span class="detail-value">${pedido.mesa}</span></div>`:''}${pedido.tipo==='delivery'?`<div class="detail-row"><span class="detail-label">Dirección:</span><span class="detail-value">${pedido.direccion}</span></div><div class="detail-row"><span class="detail-label">Teléfono:</span><span class="detail-value">${pedido.telefono}</span></div>`:''}<div class="detail-row"><span class="detail-label">Items:</span></div>${(pedido.items||[]).map(i=>`<div class="detail-row"><span>${i.cantidad||1}x ${i.nombre}</span><span>${window.formatBs(window.usdToBs(i.precioUnitarioUSD*(i.cantidad||1)))}</span></div>`).join('')}<div class="detail-row" style="font-weight:700"><span>TOTAL</span><span>${window.formatBs(window.usdToBs(pedido.total||0))}</span></div></div>`;
        };

        window.renderizarPedidos = function() {
            const pMesa = (window.pedidos || []).filter(p=>p.tipo==='mesa'&&p.estado==='pendiente');
            const pDel = (window.pedidos || []).filter(p=>p.tipo==='delivery'&&p.estado==='pendiente');
            const pRes = (window.pedidos || []).filter(p=>p.tipo==='reserva'&&p.estado==='pendiente');
            const cMesa = (window.pedidos || []).filter(p=>p.tipo==='mesa'&&p.estado==='en_cocina');
            const cDel = (window.pedidos || []).filter(p=>p.tipo==='delivery'&&p.estado==='en_camino');
            const rPen = (window.pedidos || []).filter(p=>p.tipo==='reserva'&&p.estado==='reserva_pendiente');
            const rAte = (window.pedidos || []).filter(p=>p.tipo==='reserva'&&p.estado==='reserva_atendida');
            
            document.getElementById('mesaPendientesCount').textContent = pMesa.length;
            document.getElementById('deliveryPendientesCount').textContent = pDel.length;
            document.getElementById('reservaPendientesCount').textContent = pRes.length;
            document.getElementById('totalPendientesBadge').textContent = pMesa.length+pDel.length+pRes.length;
            document.getElementById('mesaCocinaCount').textContent = cMesa.length;
            document.getElementById('deliveryCaminoCount').textContent = cDel.length;
            document.getElementById('reservaProcesoCount').textContent = rPen.length+rAte.length;
            document.getElementById('totalPreparacionBadge').textContent = cMesa.length+cDel.length+rPen.length+rAte.length;
            
            document.getElementById('mesaPendientesContainer').innerHTML = pMesa.length?pMesa.map(p=>window.crearTarjetaPedidoCompacta(p,'pendiente')).join(''):'<div class="empty-state"><i class="fas fa-store"></i><p>No hay pedidos en mesa</p></div>';
            document.getElementById('deliveryPendientesContainer').innerHTML = pDel.length?pDel.map(p=>window.crearTarjetaPedidoCompacta(p,'pendiente')).join(''):'<div class="empty-state"><i class="fas fa-motorcycle"></i><p>No hay pedidos delivery</p></div>';
            document.getElementById('reservaPendientesContainer').innerHTML = pRes.length?pRes.map(p=>window.crearTarjetaPedidoCompacta(p,'pendiente')).join(''):'<div class="empty-state"><i class="fas fa-calendar-check"></i><p>No hay reservas</p></div>';
            document.getElementById('mesaCocinaContainer').innerHTML = cMesa.length?cMesa.map(p=>window.crearTarjetaPedidoCompacta(p,'preparacion')).join(''):'<div class="empty-state"><i class="fas fa-fire"></i><p>No hay pedidos en cocina</p></div>';
            document.getElementById('deliveryCaminoContainer').innerHTML = cDel.length?cDel.map(p=>window.crearTarjetaPedidoCompacta(p,'preparacion')).join(''):'<div class="empty-state"><i class="fas fa-truck"></i><p>No hay deliveries en camino</p></div>';
            document.getElementById('reservaProcesoContainer').innerHTML = (rPen.length+rAte.length)?[...rPen,...rAte].map(p=>window.crearTarjetaPedidoCompacta(p,'preparacion')).join(''):'<div class="empty-state"><i class="fas fa-clock"></i><p>No hay reservas pendientes</p></div>';
        };

        window.crearTarjetaPedidoCompacta = function(pedido, tipoSeccion) {
            const hora = new Date(pedido.timestamp).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
            let info = '';
            if (pedido.tipo === 'mesa') info = `<div class="order-info-compact"><i class="fas fa-chair"></i> Mesa #${pedido.mesa||'N/A'}</div>`;
            else if (pedido.tipo === 'delivery') info = `<div class="order-info-compact"><div><i class="fas fa-map-marker-alt"></i> ${(pedido.direccion||'').substring(0,20)}...</div><div><i class="fas fa-phone"></i> ${pedido.telefono||'N/A'}</div></div>`;
            else info = `<div class="order-info-compact"><div><i class="fas fa-user"></i> ${pedido.cliente_nombre||'Cliente'}</div><div><i class="fas fa-calendar"></i> ${pedido.fecha_reserva?new Date(pedido.fecha_reserva).toLocaleDateString():'N/A'}</div></div>`;
            
            const items = (pedido.items||[]).slice(0,2).map(i=>`<div class="order-item-row-compact"><span class="item-name-compact">${i.cantidad||1}x ${i.nombre}</span><span class="item-price-compact">${window.formatBs(window.usdToBs((i.precioUnitarioUSD||0)*(i.cantidad||1)))}</span></div>`).join('');
            const itemsCount = (pedido.items||[]).length;
            const moreItems = itemsCount>2?`<div class="order-item-row-compact" style="justify-content:center;color:var(--gray-400)">+${itemsCount-2} más</div>`:'';
            const total = window.formatBs(window.usdToBs(pedido.total||0));
            
            let botones = '';
            if (tipoSeccion === 'pendiente') botones = `<button class="btn-compact btn-cobrar-compact" onclick="window.mostrarCobro('${pedido.id}')">Cobrar</button><button class="btn-compact btn-rechazar-compact" onclick="window.mostrarRechazo('${pedido.id}')">Rechazar</button>`;
            
            return `<div class="order-card-compact ${pedido.estado}"><div class="order-header-compact"><span class="order-time-compact"><i class="far fa-clock"></i> ${hora}</span><span style="font-weight:600;color:var(--${pedido.tipo==='mesa'?'info':pedido.tipo==='delivery'?'success':'accent'});font-size:.7rem;text-transform:uppercase">${pedido.tipo}</span></div>${info}<div class="order-items-compact">${items}${moreItems}</div><div class="order-total-compact">${total}</div><div class="order-actions-compact">${botones}</div></div>`;
        };

        window.mostrarCobro = function(pedidoId) {
            window.currentPedido = (window.pedidos || []).find(p=>p.id===pedidoId);
            if (!window.currentPedido) return;
            window.enProcesoDeCobro = true;
            if (window.alarmaActiva) { window.alarmaAudio.pause(); window.alarmaAudio.currentTime = 0; window.alarmaActiva = false; }
            window.pagosMixtos = [];
            const body = document.getElementById('cobroModalBody');
            const items = (window.currentPedido.items||[]).map(i=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.1)"><span>${i.cantidad||1}x ${i.nombre}</span><span style="font-weight:600">${window.formatBs(window.usdToBs((i.precioUnitarioUSD||0)*(i.cantidad||1)))}</span></div>`).join('');
            const totalAPagar = window.usdToBs(window.currentPedido.total||0);
            body.innerHTML = `<div style="background:rgba(0,0,0,.3);padding:15px;border-radius:8px;margin-bottom:20px"><h4>Resumen del Pedido</h4>${items}<div style="display:flex;justify-content:space-between;margin-top:15px;padding-top:15px;border-top:2px solid var(--primary);font-weight:700"><span>Total a pagar:</span><span style="color:var(--accent)">${window.formatBs(totalAPagar)}</span></div></div><div class="keyboard-hint"><span><kbd>ENTER</kbd> confirmar</span><span><kbd>ESC</kbd> cancelar</span></div>`;
            document.getElementById('cobroModal').classList.add('active');
        };

        window.mostrarRechazo = function(pedidoId) {
            window.pedidoParaAccion = (window.pedidos || []).find(p=>p.id===pedidoId);
            if (window.pedidoParaAccion) document.getElementById('rechazoModal').classList.add('active');
        };

        window.confirmarRechazo = async function() {
            if (!window.pedidoParaAccion) return;
            window.cerrarModal('rechazoModal');
            window.mostrarToast('🗑️ Pedido rechazado');
        };

        window.verificarUsuarios = async function() {
            try {
                const { data, error } = await window.supabaseClient.from('usuarios').select('*').limit(1);
                if (error) throw error;
                if (!data || data.length === 0) {
                    const usuariosPorDefecto = [
                        { id: 'user_' + Date.now() + '_1', nombre: 'Cajero Principal', username: 'cajero1', password: '123456', rol: 'cajero', activo: true },
                        { id: 'user_' + Date.now() + '_2', nombre: 'Cajero Secundario', username: 'cajero2', password: '123456', rol: 'cajero', activo: true }
                    ];
                    const { error: insertError } = await window.supabaseClient.from('usuarios').insert(usuariosPorDefecto);
                    if (insertError) throw insertError;
                    window.mostrarToast('Usuarios creados: cajero1 / 123456', 'success');
                }
            } catch (error) { console.error('Error verificando usuarios:', error); }
        };

        window.cargarDatosIniciales = async function() {
            await window.cargarConfiguracion();
            await window.verificarUsuarios();
            window.tasaEfectiva = (window.configGlobal && window.configGlobal.tasa_efectiva) || 400;
            window.mostrarToast('Datos cargados correctamente', 'success');
        };

        window.cargarPedidos = async function() { window.pedidos = []; };
        window.cargarVentasHoy = async function() { window.ventasHoy = []; };
        window.cargarPropinas = async function() { window.propinas = []; };
        window.cargarMenu = async function() { window.menuItems = []; };
        window.cargarInventario = async function() { window.inventario = []; };
        window.cargarMesas = async function() { window.mesas = []; };
        window.cargarMesoneros = async function() { window.mesoneros = []; };
        window.cargarDeliverys = async function() { window.deliverys = []; };
        window.obtenerAcumuladoDeliverysHoy = async function() { return {}; };
        window.renderizarPropinas = function() { document.getElementById('propinasListContainer').innerHTML = '<div class="empty-state"><i class="fas fa-hand-holding-heart"></i><p>No hay propinas hoy</p></div>'; };
        window.renderizarDeliverysStats = function() { 
            document.getElementById('deliverysTotalStats').textContent = 'Bs. 0';
            document.getElementById('deliverysCantidadStats').textContent = '0';
            document.getElementById('deliverysPromedioStats').textContent = 'Bs. 0';
            document.getElementById('deliverysListContainer').innerHTML = '<div class="empty-state"><i class="fas fa-motorcycle"></i><p>No hay entregas hoy</p></div>';
        };
        window.renderizarMenu = function() { document.getElementById('menuGrid').innerHTML = '<div class="empty-state"><i class="fas fa-utensils"></i><p>No hay platillos disponibles</p></div>'; };
        window.setupRealtimeSubscriptions = function() {};
        window.setupEventListeners = function() {};

        // ==================== INICIALIZACIÓN ====================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM cargado, verificando sesión...');
            const savedUser = sessionStorage.getItem('cajero_user');
            if (savedUser) {
                try { window.currentUser = JSON.parse(savedUser); await window.cargarDatosIniciales(); window.mostrarPanel(); }
                catch { window.mostrarLogin(); }
            } else { window.mostrarLogin(); }
        });
    </script>
</body>
</html>