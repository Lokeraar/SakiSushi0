<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title> Panel del Cajero - Saki Sushi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root{--primary:#D32F2F;--secondary:#212121;--accent:#FF9800;--light:#F5F5F5;--dark:#121212;--warm:#FFC107;--success:#388E3C;--info:#1976D2;--warning:#F57C00;--danger:#ef4444;--propina:#9C27B0;--delivery:#00ACC1;--condonacion:#FFB300;--favoreaja:#7CB342;--shadow:rgba(0,0,0,.15);--transition:all .3s ease}
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto','Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        body{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);min-height:100vh;padding:20px;color:#fff}
        .login-container{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,var(--primary),var(--secondary));position:fixed;top:0;left:0;right:0;bottom:0;z-index:10000}
        .login-container.hidden{display:none}
        .login-box{background:rgba(255,255,255,.95);padding:2.5rem;border-radius:15px;box-shadow:0 20px 60px rgba(0,0,0,.3);width:100%;max-width:400px;text-align:center}
        .login-box h2{color:var(--primary);margin-bottom:1.5rem;font-family:'Montserrat',sans-serif;font-weight:700;font-size:2rem}
        .login-form input{width:100%;padding:1rem;margin-bottom:1rem;border:2px solid #e0e0e0;border-radius:10px;font-size:1rem;transition:var(--transition)}
        .login-form input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(211,47,47,.2)}
        .login-form button{width:100%;padding:1rem;background:linear-gradient(135deg,var(--primary),#b71c1c);color:white;border:none;border-radius:10px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:var(--transition);font-family:'Montserrat',sans-serif}
        .login-form button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(211,47,47,.4)}
        .container{max-width:1400px;margin:0 auto;background:rgba(255,255,255,.05);border-radius:15px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1)}
        .container.hidden{display:none}
        .header{background:linear-gradient(135deg,var(--primary),#B71C1C);color:white;padding:25px 30px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:20px}
        .header-left h1{font-size:2.5em;font-family:'Montserrat',sans-serif;font-weight:800;margin-bottom:5px}
        .header-left p{opacity:.9;font-size:1.1em}
        .header-right{display:flex;align-items:center;gap:20px}
        .nav-tabs{background:rgba(0,0,0,.3);display:flex;padding:0 30px;gap:10px;overflow-x:auto;scroll-behavior:smooth;-webkit-overflow-scrolling:touch}
        .nav-tab{background:transparent;color:#fff;border:none;padding:20px 30px;font-size:1em;cursor:pointer;transition:var(--transition);font-family:'Montserrat',sans-serif;font-weight:500;border-bottom:3px solid transparent;white-space:nowrap}
        .nav-tab:hover{background:rgba(255,255,255,.1)}
        .nav-tab.active{border-bottom-color:var(--accent);color:var(--accent)}
        .nav-tabs::-webkit-scrollbar{display:none}
        .nav-tabs{scrollbar-width:none;-ms-overflow-style:none}
        .content{padding:30px}
        .section{display:none}
        .section.active{display:block}
        .section-title{font-size:2em;color:#fff;margin-bottom:25px;display:flex;align-items:center;gap:15px;font-family:'Montserrat',sans-serif;font-weight:700}
        .section-title .badge{background:var(--primary);color:white;padding:5px 15px;border-radius:20px;font-size:1rem}
        .stats-grid-modern{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:30px}
        @media (max-width:768px){.stats-grid-modern{grid-template-columns:repeat(2,1fr);gap:12px}}
        @media (min-width:769px) and (max-width:1024px){.stats-grid-modern{grid-template-columns:repeat(3,1fr);gap:15px}}
        @media (min-width:1400px){.stats-grid-modern{grid-template-columns:repeat(6,1fr)}}
        .stat-button{position:relative;background:rgba(255,255,255,.1);padding:25px 15px;border-radius:12px;box-shadow:0 5px 20px var(--shadow);text-align:center;transition:var(--transition);border:2px solid transparent;cursor:pointer;backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);overflow:hidden;z-index:1;display:flex;flex-direction:column;align-items:center;gap:10px;width:100%;font-family:inherit;color:#fff}
        .stat-button::after{content:"";width:1px;height:1px;background:none;position:absolute;z-index:-1;top:50%;left:50%;transition:.3s ease-in-out all;border-radius:100px;transform-origin:center;transform:translate(-50%,-50%)}
        .stat-button:hover::after{transform:scale(400);background:var(--primary)}
        .stat-button:hover{border-color:var(--accent);transform:translateY(-5px)}
        .stat-button .stat-icon{width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5em;color:white;margin:0;background:transparent;position:relative;z-index:2}
        .stat-button .stat-icon.pendientes{background:var(--warning)}
        .stat-button .stat-icon.cobrados{background:var(--success)}
        .stat-button .stat-icon.ventas{background:var(--info)}
        .stat-button .stat-icon.platillos{background:var(--primary)}
        .stat-button .stat-icon.propinas{background:var(--propina)}
        .stat-button .stat-icon.delivery-total{background:var(--delivery)}
        .stat-button .stat-value{font-size:2.2em;font-weight:800;color:#fff;font-family:'Montserrat',sans-serif;line-height:1.2;position:relative;z-index:2}
        .stat-button .stat-label{color:rgba(255,255,255,.8);font-size:.9rem;font-weight:500;text-transform:uppercase;letter-spacing:0.5px;position:relative;z-index:2}
        @media (max-width:768px){.stat-button{padding:18px 10px}.stat-button .stat-icon{width:45px;height:45px;font-size:1.2em}.stat-button .stat-value{font-size:1.6em}.stat-button .stat-label{font-size:.75rem}}
        .pedidos-columns{display:grid;gap:20px;margin:20px 0 30px 0}
        @media (max-width:768px){.pedidos-columns{grid-template-columns:1fr}}
        @media (min-width:769px) and (max-width:1199px){.pedidos-columns{grid-template-columns:repeat(2,1fr)}}
        @media (min-width:1200px){.pedidos-columns{grid-template-columns:repeat(3,1fr)}}
        .pedidos-column{background:rgba(255,255,255,.1);border-radius:12px;overflow:hidden;box-shadow:0 5px 20px var(--shadow);height:fit-content;max-height:600px;display:flex;flex-direction:column;backdrop-filter:blur(5px)}
        .column-header{padding:10px 15px;color:white;font-weight:700;font-size:1rem;display:flex;align-items:center;justify-content:space-between;font-family:'Montserrat',sans-serif}
        .column-header.mesa{background:linear-gradient(135deg,var(--info),#1565C0)}
        .column-header.delivery{background:linear-gradient(135deg,var(--success),#2E7D32)}
        .column-header.reserva{background:linear-gradient(135deg,#9c27b0,#7b1fa2)}
        .column-header .count-badge{background:rgba(255,255,255,.3);padding:3px 10px;border-radius:20px;font-size:.8rem}
        .column-content{padding:10px;overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:8px;max-height:500px}
        .order-card-compact{background:rgba(0,0,0,.3);border-radius:6px;padding:8px;border-left:4px solid;font-size:.75rem;line-height:1.2;transition:var(--transition);color:#fff}
        .order-card-compact:hover{transform:translateX(-2px);box-shadow:0 3px 8px rgba(0,0,0,.2)}
        .order-card-compact.pendiente{border-left-color:var(--warning)}
        .order-card-compact.en_cocina{border-left-color:var(--info)}
        .order-card-compact.en_camino{border-left-color:var(--success)}
        .order-card-compact.reserva_pendiente{border-left-color:#9c27b0}
        .order-card-compact.reserva_atendida{border-left-color:#ff5722}
        .order-header-compact{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;font-size:.7rem}
        .order-time-compact{color:rgba(255,255,255,.7);background:rgba(255,255,255,.1);padding:2px 6px;border-radius:10px;display:inline-flex;align-items:center;gap:3px}
        .order-info-compact{margin-bottom:4px;padding:3px;background:rgba(0,0,0,.2);border-radius:4px;font-size:.7rem}
        .order-info-compact i{width:12px;color:var(--accent);margin-right:2px}
        .order-items-compact{margin-bottom:4px;padding:3px;background:rgba(0,0,0,.2);border-radius:4px}
        .order-item-row-compact{display:flex;justify-content:space-between;padding:2px 0;font-size:.7rem;border-bottom:1px dashed rgba(255,255,255,.1)}
        .order-item-row-compact:last-child{border-bottom:none}
        .item-name-compact{font-weight:500}
        .item-price-compact{font-weight:600;color:var(--accent)}
        .order-total-compact{font-weight:700;color:var(--accent);text-align:right;margin:4px 0;padding-top:3px;border-top:1px dashed rgba(255,255,255,.1);font-size:.75rem}
        .comprobante-thumbnail{margin:4px 0;cursor:pointer;border:1px solid rgba(255,255,255,.2);border-radius:3px;overflow:hidden;max-width:60px}
        .comprobante-thumbnail img{width:100%;height:auto;display:block}
        .order-actions-compact{display:flex;gap:4px;margin-top:5px}
        .btn-compact{flex:1;padding:4px;border:none;border-radius:3px;font-size:.65rem;font-weight:600;cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;justify-content:center;gap:2px}
        .btn-cobrar-compact{background:linear-gradient(135deg,var(--success),#2E7D32);color:white}
        .btn-rechazar-compact{background:linear-gradient(135deg,var(--danger),#B71C1C);color:white}
        .btn-entregar-compact{background:linear-gradient(135deg,var(--info),#1565C0);color:white}
        .btn-enviar-compact{background:linear-gradient(135deg,var(--success),#2E7D32);color:white}
        .btn-confirmar-compact{background:linear-gradient(135deg,#9c27b0,#7b1fa2);color:white}
        .btn-propina-compact{background:linear-gradient(135deg,var(--propina),#7B1FA2);color:white}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);z-index:3000;display:none;justify-content:center;align-items:center;padding:20px;backdrop-filter:blur(10px)}
        .modal-overlay.active{display:flex}
        .modal-content{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);border-radius:20px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto;animation:slideUp .3s ease;border:1px solid rgba(255,255,255,.1)}
        @keyframes slideUp{from{transform:translateY(50px);opacity:0}to{transform:translateY(0);opacity:1}}
        .modal-header{background:linear-gradient(135deg,var(--primary),#B71C1C);color:white;padding:20px 25px;display:flex;justify-content:space-between;align-items:center}
        .modal-header.propina{background:linear-gradient(135deg,var(--propina),#7B1FA2)}
        .modal-header.delivery{background:linear-gradient(135deg,var(--delivery),#00838F)}
        .modal-header h2{font-family:'Montserrat',sans-serif;font-size:1.3rem;display:flex;align-items:center;gap:10px}
        .modal-close{background:rgba(255,255,255,.2);border:none;color:white;font-size:1.3rem;cursor:pointer;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
        .modal-close:hover{background:rgba(255,255,255,.3);transform:scale(1.1)}
        .modal-body{padding:25px;color:#fff}
        .modal-footer{padding:20px 25px;border-top:2px solid rgba(255,255,255,.1);display:flex;gap:15px;flex-wrap:wrap}
        .payment-mix-container{margin-bottom:20px}
        .pago-item{background:rgba(0,0,0,.3);border-radius:8px;padding:15px;margin-bottom:15px;border:1px solid rgba(255,255,255,.1);position:relative}
        .pago-item select,.pago-item input{width:100%;padding:8px;margin-bottom:8px;border:1px solid rgba(255,255,255,.2);border-radius:4px;font-size:.9rem;background:rgba(0,0,0,.5);color:#fff}
        .pago-item select:focus,.pago-item input:focus{outline:none;border-color:var(--accent)}
        .pago-item select option{background:#1a1a2e}
        .remove-pago{position:absolute;top:8px;right:8px;background:var(--danger);color:white;border:none;width:24px;height:24px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.8rem;transition:var(--transition)}
        .remove-pago:hover{transform:scale(1.1)}
        .pagos-total{background:rgba(0,0,0,.3);padding:15px;border-radius:8px;margin:15px 0}
        .pagos-resumen{display:flex;justify-content:space-between;padding:5px 0;font-size:.95rem}
        .pagos-resumen.total-pagar{font-weight:700;border-top:2px solid rgba(255,255,255,.1);padding-top:10px;margin-top:5px}
        .pagos-resumen.condonacion{color:var(--condonacion)}
        .pagos-resumen.favor-caja{color:var(--favoreaja)}
        .pagos-resumen.vuelto{color:var(--info)}
        .checkbox-extra{background:rgba(0,0,0,.3);border-radius:8px;padding:15px;margin:15px 0;display:flex;flex-direction:column;gap:15px}
        .checkbox-item{display:flex;align-items:center;gap:10px;color:#fff}
        .checkbox-item input[type=checkbox]{width:20px;height:20px;cursor:pointer}
        .checkbox-item label{font-weight:500;cursor:pointer}
        .vuelto-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
        .detail-item-compact{background:rgba(0,0,0,.3);border-radius:6px;padding:10px;margin-bottom:10px;border-left:3px solid var(--info);font-size:.8rem;line-height:1.2}
        .detail-header-compact{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;color:rgba(255,255,255,.7);font-weight:500}
        .detail-time-compact{background:rgba(255,255,255,.1);padding:2px 6px;border-radius:10px;font-size:.7rem}
        .detail-items-compact{margin:5px 0;padding-left:5px}
        .detail-item-row-compact{display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px dotted rgba(255,255,255,.1)}
        .detail-item-row-compact:last-child{border-bottom:none}
        .detail-total-compact{font-weight:700;color:var(--accent);text-align:right;margin-top:5px;padding-top:3px;border-top:1px dashed rgba(255,255,255,.1);font-size:.85rem}
        .detail-metodo-tag{background:rgba(56,142,60,.2);color:var(--success);padding:2px 6px;border-radius:12px;font-size:.7rem;font-weight:600;display:inline-flex;align-items:center;gap:3px;margin-right:4px}
        .propina-tag{background:rgba(156,39,176,.2);color:var(--propina);padding:2px 8px;border-radius:12px;font-size:.7rem;font-weight:600;display:inline-flex;align-items:center;gap:3px}
        .delivery-tag{background:rgba(0,172,193,.2);color:var(--delivery);padding:2px 8px;border-radius:12px;font-size:.7rem;font-weight:600;display:inline-flex;align-items:center;gap:3px}
        .ranking-bar{display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid rgba(255,255,255,.1)}
        .ranking-position{width:26px;height:26px;background:var(--accent);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem}
        .ranking-info{flex:1}
        .ranking-name{font-weight:600;font-size:.9rem}
        .ranking-cantidad{color:rgba(255,255,255,.6);font-size:.8rem}
        .ranking-bar-container{width:80px;height:6px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden}
        .ranking-bar-fill{height:100%;background:var(--primary);border-radius:4px}
        .mesa-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;margin-top:15px}
        .mesa-btn{background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);border-radius:8px;padding:12px 5px;cursor:pointer;font-size:.9rem;font-weight:600;color:#fff;transition:var(--transition);display:flex;flex-direction:column;align-items:center;gap:5px}
        .mesa-btn:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
        .mesa-btn i{font-size:1.5rem;color:var(--accent)}
        .menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px}
        .menu-card{background:rgba(255,255,255,.1);border-radius:10px;overflow:hidden;box-shadow:0 5px 20px var(--shadow);backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1)}
        .menu-card-image{height:140px;background-size:cover;background-position:center;background-color:rgba(0,0,0,.5)}
        .menu-card-content{padding:15px}
        .menu-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .menu-card-title{font-weight:700;font-size:1rem;color:#fff}
        .menu-card-price{font-weight:700;color:var(--accent)}
        .menu-card-stock{font-size:.8rem;padding:.25rem .5rem;border-radius:4px;background:rgba(0,0,0,.3);display:inline-block;margin-top:5px}
        .menu-card-stock.available{color:var(--success)}
        .menu-card-stock.low{color:var(--warning)}
        .menu-card-stock.sold-out{color:var(--danger)}
        .empty-state{text-align:center;padding:30px 15px;color:rgba(255,255,255,.5);font-size:.9rem}
        .empty-state i{font-size:2.5em;margin-bottom:10px}
        .toast{position:fixed;top:80px;right:20px;background:linear-gradient(135deg,#1a1a2e,#16213e);padding:15px 20px;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,.3);display:none;align-items:center;gap:12px;z-index:5000;animation:slideIn .3s ease;border-left:4px solid var(--success);border:1px solid rgba(255,255,255,.1);color:#fff}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0%);opacity:1}}
        .toast.show{display:flex}
        .loading-spinner{display:inline-block;width:30px;height:30px;border:3px solid rgba(211,47,47,.2);border-radius:50%;border-top-color:var(--primary);animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-container{text-align:center;padding:2rem}
        .keyboard-hint{background:rgba(0,0,0,.3);padding:10px 15px;border-radius:8px;font-size:.8rem;color:rgba(255,255,255,.7);margin-top:15px;display:flex;justify-content:center;gap:20px}
        .keyboard-hint kbd{background:rgba(255,255,255,.1);padding:3px 6px;border-radius:4px;border:1px solid rgba(255,255,255,.2);font-family:monospace;color:#fff}
        .text-center{text-align:center}
        .mt-2{margin-top:.5rem}
        .mb-2{margin-bottom:.5rem}
        .mesonero-selector{margin-bottom:20px}
        .mesonero-selector label,.delivery-selector label{display:block;margin-bottom:8px;font-weight:600;color:#fff}
        .mesonero-selector select,.delivery-selector select{width:100%;padding:10px;border:2px solid rgba(255,255,255,.2);border-radius:8px;font-size:1rem;background:rgba(0,0,0,.5);color:#fff}
        .mesonero-selector select option,.delivery-selector select option{background:#1a1a2e}
        .propina-monto-group{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px}
        .propina-monto-group input{width:100%;padding:10px;border:2px solid rgba(255,255,255,.2);border-radius:8px;font-size:1rem;background:rgba(0,0,0,.5);color:#fff}
        .propina-monto-group input:focus{outline:none;border-color:var(--accent)}
        .referencia-input{display:flex;gap:8px;justify-content:center;margin-bottom:20px}
        .referencia-input input{width:45px;height:45px;text-align:center;font-size:1.3rem;border:2px solid rgba(255,255,255,.2);border-radius:8px;background:rgba(0,0,0,.5);color:#fff}
        .referencia-input input:focus{border-color:var(--accent);outline:none}
        .btn-primary{background:linear-gradient(135deg,var(--primary),#b71c1c);color:white;border:none;padding:.75rem 1.5rem;border-radius:8px;font-weight:600;cursor:pointer;transition:var(--transition)}
        .btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 5px 15px rgba(211,47,47,.4)}
        .btn-primary:disabled{opacity:.5;cursor:not-allowed}
        .btn-secondary{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);padding:.75rem 1.5rem;border-radius:8px;font-weight:600;cursor:pointer;transition:var(--transition)}
        .btn-secondary:hover{background:rgba(255,255,255,.2)}
        .btn-success{background:linear-gradient(135deg,var(--success),#2E7D32);color:white;border:none;padding:.75rem 1.5rem;border-radius:8px;font-weight:600;cursor:pointer;transition:var(--transition)}
        .btn-success:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(56,142,60,.4)}
        .motorizados-list{display:flex;flex-direction:column;gap:10px;margin-top:15px}
        .motorizado-item{display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,.3);padding:12px;border-radius:8px;border-left:4px solid var(--delivery)}
        .motorizado-nombre{font-weight:600;color:#fff}
        .motorizado-monto{font-weight:700;color:var(--accent)}
        .registros-acumulados{background:rgba(0,0,0,.3);border-radius:8px;padding:15px;margin-top:15px}
        .registros-acumulados h4{color:var(--accent);margin-bottom:10px;font-size:1rem}
        .registro-item{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.1);font-size:.8rem}
        .registro-item:last-child{border-bottom:none}
    </style>
</head>
<body>
    <audio id="alarmaSonido" loop preload="auto"><source src="https://iqwwoihiiyrtypyqzhgy.supabase.co/storage/v1/object/public/alarma/Alarm%20Clock%20Effect%20Sound%20HD%20-%20Despertador%20Efecto%20D'%20Sonido.mp3" type="audio/mpeg"></audio>
    <div class="login-container" id="loginContainer"><div class="login-box"><h2><i class="fas fa-cash-register"></i> Cajero Saki Sushi</h2><form class="login-form" id="loginForm" onsubmit="event.preventDefault();hacerLogin()"><input type="text" id="username" placeholder="Usuario" required autofocus><input type="password" id="password" placeholder="Contrase침a" required><button type="submit">Iniciar Sesi칩n</button></form></div></div>
    <div class="container hidden" id="panelContainer">
        <div class="header"><div class="header-left"><h1><i class="fas fa-cash-register"></i> Panel del Cajero</h1><p>Saki Sushi - Gesti칩n de pedidos y cobros</p></div><div class="header-right"><button class="btn btn-primary" onclick="abrirSelectorMesa()" style="padding:12px 25px"><i class="fas fa-utensils"></i> Men칰 Cliente</button><button class="btn btn-secondary" onclick="cerrarSesion()" style="padding:12px 25px"><i class="fas fa-sign-out-alt"></i> Salir</button></div></div>
        <div class="nav-tabs" id="navTabs"><button class="nav-tab active" onclick="showSection('pedidos')"><i class="fas fa-clipboard-list"></i> Pedidos</button><button class="nav-tab" onclick="showSection('menu')"><i class="fas fa-utensils"></i> Ver Men칰</button><button class="nav-tab" onclick="showSection('propinas')"><i class="fas fa-hand-holding-heart"></i> Propinas</button><button class="nav-tab" onclick="showSection('deliverys')"><i class="fas fa-motorcycle"></i> Deliverys</button></div>
        <div class="content">
            <div class="section active" id="section-pedidos">
                <h2 class="section-title"><i class="fas fa-clipboard-list"></i> Pedidos del D칤a</h2>
                <div class="stats-grid-modern">
                    <button class="stat-button" onclick="abrirModalDetalle('preparacion')"><span class="stat-icon pendientes"><i class="fas fa-fire"></i></span><span class="stat-value" id="statPreparacion">0</span><span class="stat-label">En Preparaci칩n</span></button>
                    <button class="stat-button" onclick="abrirModalDetalle('cobrados')"><span class="stat-icon cobrados"><i class="fas fa-check-circle"></i></span><span class="stat-value" id="statCobrados">0</span><span class="stat-label">Cobrados Hoy</span></button>
                    <button class="stat-button" onclick="abrirModalDetalle('ventas')"><span class="stat-icon ventas"><i class="fas fa-dollar-sign"></i></span><span class="stat-value" id="statVentas">Bs. 0</span><span class="stat-label">Ventas Totales</span></button>
                    <button class="stat-button" onclick="abrirModalDetalle('platillos')"><span class="stat-icon platillos"><i class="fas fa-utensils"></i></span><span class="stat-value" id="statPlatillos">0</span><span class="stat-label">Platillos Vend.</span></button>
                    <button class="stat-button" onclick="abrirModalDetalle('propinas')"><span class="stat-icon propinas"><i class="fas fa-hand-holding-heart"></i></span><span class="stat-value" id="statPropinas">Bs. 0</span><span class="stat-label">Propinas Hoy</span></button>
                    <button class="stat-button" onclick="abrirModalDeliverys()"><span class="stat-icon delivery-total"><i class="fas fa-motorcycle"></i></span><span class="stat-value" id="statDeliverysTotal">Bs. 0</span><span class="stat-label">Deliverys</span></button>
                </div>
                <div style="margin:30px 0 20px 0"><h3 style="font-size:1.5rem;color:#fff;display:flex;align-items:center;gap:10px"><i class="fas fa-clock" style="color:var(--warning)"></i> Pedidos Pendientes<span class="badge" style="background:var(--warning)" id="totalPendientesBadge">0</span></h3></div>
                <div class="pedidos-columns">
                    <div class="pedidos-column"><div class="column-header mesa"><span><i class="fas fa-store"></i> MESA</span><span class="count-badge" id="mesaPendientesCount">0</span></div><div class="column-content" id="mesaPendientesContainer"></div></div>
                    <div class="pedidos-column"><div class="column-header delivery"><span><i class="fas fa-motorcycle"></i> DELIVERY</span><span class="count-badge" id="deliveryPendientesCount">0</span></div><div class="column-content" id="deliveryPendientesContainer"></div></div>
                    <div class="pedidos-column"><div class="column-header reserva"><span><i class="fas fa-calendar-check"></i> RESERVA</span><span class="count-badge" id="reservaPendientesCount">0</span></div><div class="column-content" id="reservaPendientesContainer"></div></div>
                </div>
                <div style="margin:40px 0 20px 0"><h3 style="font-size:1.5rem;color:#fff;display:flex;align-items:center;gap:10px"><i class="fas fa-fire" style="color:var(--warning)"></i> Pedidos en Preparaci칩n<span class="badge" style="background:var(--warning)" id="totalPreparacionBadge">0</span></h3></div>
                <div class="pedidos-columns">
                    <div class="pedidos-column"><div class="column-header mesa"><span><i class="fas fa-fire"></i> MESA EN COCINA</span><span class="count-badge" id="mesaCocinaCount">0</span></div><div class="column-content" id="mesaCocinaContainer"></div></div>
                    <div class="pedidos-column"><div class="column-header delivery"><span><i class="fas fa-truck"></i> DELIVERY EN CAMINO</span><span class="count-badge" id="deliveryCaminoCount">0</span></div><div class="column-content" id="deliveryCaminoContainer"></div></div>
                    <div class="pedidos-column"><div class="column-header reserva"><span><i class="fas fa-clock"></i> RESERVAS PENDIENTES</span><span class="count-badge" id="reservaProcesoCount">0</span></div><div class="column-content" id="reservaProcesoContainer"></div></div>
                </div>
            </div>
            <div class="section" id="section-menu"><h2 class="section-title"><i class="fas fa-utensils"></i> Men칰 Actual</h2><div class="menu-grid" id="menuGrid"><div class="loading-container"><div class="loading-spinner"></div><p>Cargando men칰...</p></div></div></div>
            <div class="section" id="section-propinas">
                <h2 class="section-title"><i class="fas fa-hand-holding-heart"></i> Propinas del D칤a</h2>
                <div class="stats-grid-modern" style="margin-bottom:30px">
                    <button class="stat-button" onclick="abrirModalDetalle('propinasDetalle')"><span class="stat-icon propinas"><i class="fas fa-hand-holding-heart"></i></span><span class="stat-value" id="propinasTotal">Bs. 0</span><span class="stat-label">Total Propinas</span></button>
                    <button class="stat-button" onclick="abrirModalDetalle('propinasCantidad')"><span class="stat-icon propinas"><i class="fas fa-hashtag"></i></span><span class="stat-value" id="propinasCantidad">0</span><span class="stat-label">Cantidad</span></button>
                    <button class="stat-button" onclick="abrirModalDetalle('propinasPromedio')"><span class="stat-icon propinas"><i class="fas fa-chart-line"></i></span><span class="stat-value" id="propinasPromedio">Bs. 0</span><span class="stat-label">Promedio</span></button>
                </div>
                <div id="propinasContainer" class="pedidos-columns" style="grid-template-columns:1fr"><div class="pedidos-column" style="max-height:500px"><div class="column-header propina"><span><i class="fas fa-clock"></i> 칔ltimas Propinas</span><span class="count-badge" id="propinasListCount">0</span></div><div class="column-content" id="propinasListContainer"></div></div></div>
            </div>
            <div class="section" id="section-deliverys">
                <h2 class="section-title"><i class="fas fa-motorcycle" style="color:var(--delivery)"></i> Deliverys del D칤a</h2>
                <div class="stats-grid-modern" style="margin-bottom:30px">
                    <button class="stat-button" onclick="abrirModalDetalle('deliverysResumen')"><span class="stat-icon delivery-total"><i class="fas fa-motorcycle"></i></span><span class="stat-value" id="deliverysTotalDia">Bs. 0</span><span class="stat-label">Total Deliverys</span></button>
                    <button class="stat-button" onclick="abrirModalDetalle('deliverysCantidad')"><span class="stat-icon delivery-total"><i class="fas fa-hashtag"></i></span><span class="stat-value" id="deliverysCantidadDia">0</span><span class="stat-label">Entregas Hoy</span></button>
                    <button class="stat-button" onclick="abrirModalDetalle('deliverysPromedio')"><span class="stat-icon delivery-total"><i class="fas fa-chart-line"></i></span><span class="stat-value" id="deliverysPromedioDia">Bs. 0</span><span class="stat-label">Promedio</span></button>
                </div>
                <div id="deliverysContainer" class="pedidos-columns" style="grid-template-columns:1fr"><div class="pedidos-column" style="max-height:500px"><div class="column-header delivery"><span><i class="fas fa-clock"></i> Entregas del D칤a</span><span class="count-badge" id="deliverysListCount">0</span></div><div class="column-content" id="deliverysListContainer"></div></div></div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="cobroModal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-cash-register"></i> Procesar Cobro</h2><button class="modal-close" onclick="cerrarCobroModal()"><i class="fas fa-times"></i></button></div><div class="modal-body" id="cobroModalBody"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarCobroModal()">Cancelar (ESC)</button><button class="btn btn-primary" id="confirmCobroBtn" onclick="confirmarCobro()" disabled>Confirmar Cobro (ENTER)</button></div></div></div>
    <div class="modal-overlay" id="propinaModal"><div class="modal-content"><div class="modal-header propina"><h2><i class="fas fa-hand-holding-heart"></i> Registrar Propina</h2><button class="modal-close" onclick="cerrarPropinaModal()"><i class="fas fa-times"></i></button></div><div class="modal-body" id="propinaModalBody"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarPropinaModal()">Cancelar (ESC)</button><button class="btn btn-primary" id="confirmPropinaBtn" style="background:linear-gradient(135deg,var(--propina),#7B1FA2)" onclick="confirmarPropina()" disabled>Guardar Propina</button></div></div></div>
    <div class="modal-overlay" id="confirmModal"><div class="modal-content"><div class="modal-header" id="confirmModalHeader"><h2 id="confirmModalTitle"><i class="fas fa-check-circle"></i> Confirmar Acci칩n</h2><button class="modal-close" onclick="cerrarModal('confirmModal')"><i class="fas fa-times"></i></button></div><div class="modal-body" id="confirmModalBody"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModal('confirmModal')">Cancelar (ESC)</button><button class="btn btn-primary" id="confirmActionBtn" onclick="ejecutarConfirmacion()">Confirmar (ENTER)</button></div></div></div>
    <div class="modal-overlay" id="rechazoModal"><div class="modal-content"><div class="modal-header" style="background:linear-gradient(135deg,var(--danger),#B71C1C)"><h2><i class="fas fa-times-circle"></i> Rechazar Pedido</h2><button class="modal-close" onclick="cerrarModal('rechazoModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><p style="margin-bottom:20px;color:#fff">Selecciona la raz칩n del rechazo:</p><div style="display:flex;flex-direction:column;gap:10px"><label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;cursor:pointer"><input type="radio" name="rejectionReason" value="referencia_invalida" style="width:18px;height:18px"><span>Referencia de pago inv치lida o falsa</span></label><label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;cursor:pointer"><input type="radio" name="rejectionReason" value="monto_insuficiente" style="width:18px;height:18px"><span>Monto insuficiente</span></label><label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;cursor:pointer"><input type="radio" name="rejectionReason" value="datos_incorrectos" style="width:18px;height:18px"><span>Datos de contacto/direcci칩n incorrectos</span></label><label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;cursor:pointer"><input type="radio" name="rejectionReason" value="no_disponible" style="width:18px;height:18px"><span>Producto no disponible</span></label><label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;cursor:pointer"><input type="radio" name="rejectionReason" value="fuera_horario" style="width:18px;height:18px"><span>Fuera de horario de delivery</span></label></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModal('rechazoModal')">Cancelar</button><button class="btn btn-primary" style="background:linear-gradient(135deg,var(--danger),#B71C1C)" onclick="confirmarRechazo()">Rechazar</button></div></div></div>
    <div class="modal-overlay" id="detalleModal"><div class="modal-content"><div class="modal-header" style="background:linear-gradient(135deg,var(--info),#1565C0)"><h2 id="detalleModalTitle"><i class="fas fa-chart-bar"></i> Detalle</h2><button class="modal-close" onclick="cerrarModal('detalleModal')"><i class="fas fa-times"></i></button></div><div class="modal-body" id="detalleModalBody"></div><div class="modal-footer"><button class="btn btn-primary" onclick="cerrarModal('detalleModal')">Cerrar (ESC)</button></div></div></div>
    <div class="modal-overlay" id="mesaModal"><div class="modal-content"><div class="modal-header" style="background:linear-gradient(135deg,var(--info),#1565C0)"><h2><i class="fas fa-chair"></i> Seleccionar Mesa</h2><button class="modal-close" onclick="cerrarModal('mesaModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><p style="margin-bottom:20px;color:#fff">Elige la mesa para la cual quieres armar el pedido:</p><div id="mesaList" class="mesa-grid"><div class="loading-container"><div class="loading-spinner"></div><p>Cargando mesas...</p></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="cerrarModal('mesaModal')">Cancelar</button></div></div></div>
    <div class="modal-overlay" id="comprobanteModal"><div class="modal-content" style="max-width:500px"><div class="modal-header" style="background:linear-gradient(135deg,var(--info),#1565C0)"><h2><i class="fas fa-receipt"></i> Comprobante de Pago</h2><button class="modal-close" onclick="cerrarModal('comprobanteModal')"><i class="fas fa-times"></i></button></div><div class="modal-body text-center" id="comprobanteModalBody"></div><div class="modal-footer"><button class="btn btn-primary" onclick="cerrarModal('comprobanteModal')">Cerrar (ESC)</button></div></div></div>
    <div class="modal-overlay" id="deliveryModal"><div class="modal-content"><div class="modal-header delivery"><h2><i class="fas fa-motorcycle"></i> Acumulado Deliverys (Hoy)</h2><button class="modal-close" onclick="cerrarModal('deliveryModal')"><i class="fas fa-times"></i></button></div><div class="modal-body" id="deliveryModalBody"></div><div class="modal-footer"><button class="btn btn-primary" onclick="cerrarModal('deliveryModal')">Cerrar (ESC)</button></div></div></div>
    <div class="toast" id="toast"><i class="fas fa-check-circle" style="color:var(--success);font-size:1.2rem"></i><div><p id="toastText" style="margin:0;color:#fff">Operaci칩n completada</p></div></div>
    <script src="../supabase-config.js"></script>
    <script>
        let currentUser=null,pedidos=[],ventasHoy=[],propinas=[],menuItems=[],inventario=[],mesas=[],currentPedido=null,pedidoParaAccion=null,accionPendiente=null,pagosMixtos=[],tasaEfectiva=400,currentPropinaPedido=null,mesoneros=[],deliverys=[],currentPropinaData={mesonero:'',mesa:'Delivery',metodo:'efectivo_bs',montoBs:0,montoUsd:0,referencia:'',tasaAplicada:400},condonacionActual=0,favorCajaActual=0,vueltoEntregadoActual=0,registrosCondonacion=[],registrosFavorCaja=[],stockCache={data:{},lastUpdate:0,duration:5e3,get:function(id){let ahora=Date.now();if(ahora-this.lastUpdate>this.duration)this.clear();return this.data[id]},set:function(id,val){this.data[id]=val;this.lastUpdate=Date.now()},clear:function(){this.data={};this.lastUpdate=Date.now()},invalidate:function(){this.data={};this.lastUpdate=0}};let alarmaAudio=document.getElementById('alarmaSonido'),alarmaActiva=!1,enProcesoDeCobro=!1,suscripciones=[],paginaVisible=!0,reconectando=!1,intervaloVerificacion=null,ultimaActualizacion=Date.now();document.addEventListener('DOMContentLoaded',async()=>{let savedUser=sessionStorage.getItem('cajero_user');if(savedUser)try{currentUser=JSON.parse(savedUser),await cargarDatosIniciales(),mostrarPanel()}catch{mostrarLogin()}else mostrarLogin();document.addEventListener('visibilitychange',function(){document.hidden?paginaVisible=!1:(paginaVisible=!0,verificarCambiosPedidos())})});window.hacerLogin=async function(){let username=document.getElementById('username').value,password=document.getElementById('password').value;if(!username||!password)return mostrarToast('Ingresa usuario y contrase침a','error');try{let{data,error}=await window.supabaseClient.from('usuarios').select('*').eq('username',username).eq('password',password).eq('activo',!0).maybeSingle();if(error)throw error;if(!data)return mostrarToast('Credenciales inv치lidas','error');currentUser=data,sessionStorage.setItem('cajero_user',JSON.stringify(data)),await cargarDatosIniciales(),mostrarPanel()}catch(error){console.error('Error en login:',error),mostrarToast('Error al conectar: '+error.message,'error')}};async function verificarCambiosPedidos(){if(reconectando||enProcesoDeCobro)return;try{let hoy=new Date;hoy.setHours(0,0,0,0);let manana=new Date(hoy);manana.setDate(manana.getDate()+2);let{data,error}=await window.supabaseClient.from('pedidos').select('id, estado, timestamp').gte('timestamp',hoy.toISOString()).lt('timestamp',manana.toISOString());if(error)throw error;if(data){let hayCambios=!1;if(data.length!==pedidos.length)hayCambios=!0;else{let mapaActual=new Map(pedidos.map(p=>[p.id,p.estado]));for(let p of data)if(mapaActual.get(p.id)!==p.estado){hayCambios=!0;break}}hayCambios&&(console.log('游닍 Cambios detectados en pedidos, recargando...'),await recargarPedidosCompletos(),ultimaActualizacion=Date.now())}}catch(error){console.error('Error verificando cambios:',error)}}async function recargarPedidosCompletos(){try{await cargarPedidos(),await cargarVentasHoy(),actualizarEstadisticas(),renderizarPedidos(),verificarYControlarAlarma(!0)}catch(error){console.error('Error recargando pedidos:',error)}}function iniciarVerificacionPeriodica(){intervaloVerificacion&&clearInterval(intervaloVerificacion),intervaloVerificacion=setInterval(async()=>{paginaVisible&&!enProcesoDeCobro&&await verificarCambiosPedidos()},3e3)}async function cargarDatosIniciales(){await cargarConfiguracion(),tasaEfectiva=configGlobal.tasa_efectiva||400,await cargarPedidos(),await cargarVentasHoy(),await cargarPropinas(),await cargarMenu(),await cargarInventario(),await cargarMesas(),await cargarMesoneros(),await cargarDeliverys(),actualizarEstadisticas(),renderizarPedidos(),renderizarPropinas(),renderizarDeliverys(),iniciarVerificacionPeriodica()}async function getStockDisponible(ingredienteId){try{let cache=stockCache.get(ingredienteId);if(cache!==void 0)return cache;let ingrediente=inventario.find(i=>i.id===ingredienteId);if(!ingrediente)return 0;let disponible=(ingrediente.stock||0)-(ingrediente.reservado||0);return stockCache.set(ingredienteId,disponible),disponible}catch(error){return console.error('Error obteniendo stock:',error),0}}async function calcularStockPlatillo(platillo){let stockDisponible=1/0;if(platillo.ingredientes&&Object.keys(platillo.ingredientes).length>0)for(let[ingId,ingInfo]of Object.entries(platillo.ingredientes)){let stockDisp=await getStockDisponible(ingId),cantidadNecesaria=ingInfo.cantidad||1,posible=Math.floor(stockDisp/cantidadNecesaria);stockDisponible=Math.min(stockDisponible,posible)}else stockDisponible=platillo.stock_maximo||999;return stockDisponible}async function cargarPedidos(){try{let hoy=new Date;hoy.setHours(0,0,0,0);let manana=new Date(hoy);manana.setDate(manana.getDate()+2);let{data,error}=await window.supabaseClient.from('pedidos').select('*').gte('timestamp',hoy.toISOString()).lt('timestamp',manana.toISOString()).order('timestamp',{ascending:!1});if(error)throw error;pedidos=data||[]}catch(error){console.error('Error cargando pedidos:',error),mostrarToast('Error cargando pedidos','error')}}async function cargarPropinas(){try{let hoy=new Date;hoy.setHours(0,0,0,0);let manana=new Date(hoy);manana.setDate(manana.getDate()+1);let{data,error}=await window.supabaseClient.from('propinas').select('*, pedidos(*)').gte('fecha',hoy.toISOString()).lt('fecha',manana.toISOString()).order('fecha',{ascending:!1});if(error)throw error;propinas=data||[]}catch(error){console.error('Error cargando propinas:',error)}}async function cargarMesoneros(){try{let{data,error}=await window.supabaseClient.from('mesoneros').select('*').eq('activo',!0).order('nombre');if(error)throw error;mesoneros=data||[]}catch(error){console.error('Error cargando mesoneros:',error)}}async function cargarDeliverys(){try{let{data,error}=await window.supabaseClient.from('deliverys').select('*').eq('activo',!0).order('nombre');if(error)throw error;deliverys=data||[]}catch(error){console.error('Error cargando deliverys:',error)}}async function cargarVentasHoy(){try{let hoy=new Date;hoy.setHours(0,0,0,0);let manana=new Date(hoy);manana.setDate(manana.getDate()+1);let{data,error}=await window.supabaseClient.from('ventas').select('*').gte('fecha',hoy.toISOString()).lt('fecha',manana.toISOString()).order('fecha',{ascending:!1});if(error)throw error;ventasHoy=data||[]}catch(error){console.error('Error cargando ventas:',error)}}async function cargarMenu(){try{let{data,error}=await window.supabaseClient.from('menu').select('*').eq('disponible',!0);if(error)throw error;menuItems=data||[],renderizarMenu()}catch(error){console.error('Error cargando men칰:',error)}}async function cargarInventario(){try{let{data,error}=await window.supabaseClient.from('inventario').select('*');if(error)throw error;inventario=data||[],stockCache.invalidate(),renderizarMenu()}catch(error){console.error('Error cargando inventario:',error)}}async function cargarMesas(){try{let{data,error}=await window.supabaseClient.from('codigos_qr').select('*').order('nombre');if(error)throw error;mesas=data||[]}catch(error){console.error('Error cargando mesas:',error)}}function mostrarToast(mensaje,tipo='success'){let toast=document.getElementById('toast');document.getElementById('toastText').textContent=mensaje,toast.className='toast show',tipo==='error'?(toast.querySelector('i').style.color='var(--danger)',toast.style.borderLeftColor='var(--danger)'):(toast.querySelector('i').style.color='var(--success)',toast.style.borderLeftColor='var(--success)'),setTimeout(()=>toast.classList.remove('show'),3e3)}function cerrarModal(modalId){document.getElementById(modalId).classList.remove('active'),modalId==='confirmModal'&&(pedidoParaAccion=null,accionPendiente=null)}function cerrarCobroModal(){document.getElementById('cobroModal').classList.remove('active'),enProcesoDeCobro=!1,currentPedido=null,pagosMixtos=[],condonacionActual=0,favorCajaActual=0,vueltoEntregadoActual=0,setTimeout(()=>verificarYControlarAlarma(!0),100)}function cerrarPropinaModal(){document.getElementById('propinaModal').classList.remove('active'),currentPropinaPedido=null}function showSection(sectionName){document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')),document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active')),document.getElementById(`section-${sectionName}`).classList.add('active'),event.target.classList.add('active'),sectionName==='pedidos'?renderizarPedidos():sectionName==='menu'?renderizarMenu():sectionName==='propinas'?renderizarPropinas():sectionName==='deliverys'&&renderizarDeliverys()}function cerrarSesion(){sessionStorage.removeItem('cajero_user'),currentUser=null,detenerAlarma(),document.getElementById('loginContainer').classList.remove('hidden'),document.getElementById('panelContainer').classList.add('hidden')}function mostrarLogin(){document.getElementById('loginContainer').classList.remove('hidden'),document.getElementById('panelContainer').classList.add('hidden'),detenerAlarma()}function mostrarPanel(){document.getElementById('loginContainer').classList.add('hidden'),document.getElementById('panelContainer').classList.remove('hidden'),setupEventListeners(),setupRealtimeSubscriptions(),setTimeout(()=>verificarYControlarAlarma(!0),100)}function detenerAlarma(){alarmaActiva&&alarmaAudio&&(alarmaAudio.pause(),alarmaAudio.currentTime=0,alarmaActiva=!1)}function verificarYControlarAlarma(forzar=!1){let pendientes=pedidos.filter(p=>p.estado==='pendiente').length;pendientes>0&&!enProcesoDeCobro?!alarmaActiva&&alarmaAudio&&(alarmaAudio.play().then(()=>{alarmaActiva=!0}).catch(()=>{})):alarmaActiva&&alarmaAudio&&(pendientes===0||enProcesoDeCobro)&&(alarmaAudio.pause(),alarmaAudio.currentTime=0,alarmaActiva=!1)}function calcularTotalDeliverysHoy(){let hoy=new Date;hoy.setHours(0,0,0,0);let manana=new Date(hoy);return manana.setDate(manana.getDate()+1),pedidos.filter(p=>p.tipo==='delivery'&&p.estado==='enviado'&&new Date(p.timestamp)>=hoy&&new Date(p.timestamp)<manana).reduce((sum,p)=>sum+(p.costo_delivery_bs||0),0)}async function obtenerAcumuladoDeliverysHoy(){try{let hoy=new Date;hoy.setHours(0,0,0,0);let manana=new Date(hoy);manana.setDate(manana.getDate()+1);let{data,error}=await window.supabaseClient.from('entregas_delivery').select('delivery_id, monto_bs').gte('fecha_entrega',hoy.toISOString()).lt('fecha_entrega',manana.toISOString());if(error)throw error;let acumulado={};return(data||[]).forEach(entrega=>{acumulado[entrega.delivery_id]=(acumulado[entrega.delivery_id]||0)+entrega.monto_bs}),acumulado}catch(error){return console.error('Error obteniendo acumulado deliverys:',error),{}}}function actualizarEstadisticas(){let enPreparacion=pedidos.filter(p=>['en_cocina','en_camino','reserva_pendiente','reserva_atendida'].includes(p.estado)).length,cobradosHoy=ventasHoy.length,totalVentasBs=ventasHoy.reduce((s,v)=>s+(v.subtotal_platillos||0),0),platillosVendidos=ventasHoy.reduce((s,v)=>s+(v.items||0),0),totalPropinas=propinas.reduce((s,p)=>s+(p.monto||0),0),totalDeliverysHoy=calcularTotalDeliverysHoy();document.getElementById('statPreparacion').textContent=enPreparacion,document.getElementById('statCobrados').textContent=cobradosHoy,document.getElementById('statVentas').textContent=formatBs(totalVentasBs),document.getElementById('statPlatillos').textContent=platillosVendidos,document.getElementById('statPropinas').textContent=formatBs(totalPropinas),document.getElementById('statDeliverysTotal').textContent=formatBs(totalDeliverysHoy)}function renderizarPropinas(){let total=propinas.reduce((s,p)=>s+(p.monto||0),0),cantidad=propinas.length,promedio=cantidad>0?total/cantidad:0;document.getElementById('propinasTotal').textContent=formatBs(total),document.getElementById('propinasCantidad').textContent=cantidad,document.getElementById('propinasPromedio').textContent=formatBs(promedio),document.getElementById('propinasListCount').textContent=cantidad,document.getElementById('propinasListContainer').innerHTML=cantidad?propinas.map(p=>crearTarjetaPropina(p)).join(''):'<div class="empty-state"><i class="fas fa-hand-holding-heart"></i><p>No hay propinas hoy</p></div>'}function crearTarjetaPropina(propina){let fecha=new Date(propina.fecha),hora=fecha.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}),pedido=propina.pedidos||{},tipo=pedido.tipo||'mesa',referencia=pedido.mesa||pedido.cliente_nombre||'Cliente';return`<div class="order-card-compact" style="border-left-color:var(--propina)"><div class="order-header-compact"><span class="order-time-compact"><i class="far fa-clock"></i> ${hora}</span><span class="propina-tag"><i class="fas fa-hand-holding-heart"></i> Propina</span></div><div class="order-info-compact"><div><i class="fas fa-${tipo==='mesa'?'store':tipo==='delivery'?'motorcycle':'calendar-check'}"></i> ${tipo.toUpperCase()} - ${referencia}</div><div><i class="fas fa-user"></i> ${propina.cajero||'Cajero'}</div><div><i class="fas fa-${propina.metodo==='efectivo_bs'?'money-bill-wave':propina.metodo==='efectivo_usd'?'dollar-sign':propina.metodo==='pago_movil'?'mobile-alt':'credit-card'}"></i> ${propina.metodo}</div><div><i class="fas fa-chair"></i> Mesa: ${propina.mesa||'N/A'}</div></div><div class="order-total-compact" style="color:var(--propina)">${formatBs(propina.monto_bs||propina.monto)}</div></div>`}function renderizarDeliverys(){let totalDeliverys=calcularTotalDeliverysHoy(),cantidadEntregas=pedidos.filter(p=>p.tipo==='delivery'&&p.estado==='enviado'&&new Date(p.timestamp).toDateString()===new Date().toDateString()).length,promedio=cantidadEntregas>0?totalDeliverys/cantidadEntregas:0;document.getElementById('deliverysTotalDia').textContent=formatBs(totalDeliverys),document.getElementById('deliverysCantidadDia').textContent=cantidadEntregas,document.getElementById('deliverysPromedioDia').textContent=formatBs(promedio),document.getElementById('deliverysListCount').textContent=cantidadEntregas;let container=document.getElementById('deliverysListContainer'),entregasHoy=pedidos.filter(p=>p.tipo==='delivery'&&p.estado==='enviado'&&new Date(p.timestamp).toDateString()===new Date().toDateString());container.innerHTML=entregasHoy.length?entregasHoy.map(p=>`<div class="order-card-compact" style="border-left-color:var(--delivery)"><div class="order-header-compact"><span class="order-time-compact"><i class="far fa-clock"></i> ${new Date(p.timestamp).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}</span><span class="delivery-tag"><i class="fas fa-motorcycle"></i> Delivery</span></div><div class="order-info-compact"><div><i class="fas fa-map-marker-alt"></i> ${(p.direccion||'').substring(0,20)}...</div><div><i class="fas fa-phone"></i> ${p.telefono||'N/A'}</div></div><div class="order-total-compact">${formatBs(p.costo_delivery_bs||0)}</div></div>`).join(''):'<div class="empty-state"><i class="fas fa-motorcycle"></i><p>No hay entregas hoy</p></div>'}async function renderizarMenu(){let grid=document.getElementById('menuGrid');if(!menuItems.length)return grid.innerHTML='<div class="empty-state"><i class="fas fa-utensils"></i><p>No hay platillos disponibles</p></div>';let itemsConStock=await Promise.all(menuItems.map(async item=>{let stock=await calcularStockPlatillo(item),stockClass='available',stockText='Disponible';return stock<=0?(stockClass='sold-out',stockText='Agotado'):stock<5?(stockClass='low',stockText=`칔ltimas ${stock} unidades`):stockText=`${stock} disponibles`,{...item,stock,stockClass,stockText}}));grid.innerHTML=itemsConStock.map(i=>`<div class="menu-card"><div class="menu-card-image" style="background-image:url('${i.imagen||'https://via.placeholder.com/300x150?text=Saki+Sushi'}')"></div><div class="menu-card-content"><div class="menu-card-header"><span class="menu-card-title">${i.nombre}</span><span class="menu-card-price">${formatBs(usdToBs(i.precio||0))}</span></div><p style="font-size:.85rem;color:rgba(255,255,255,.6);margin-bottom:.5rem">${i.descripcion||''}</p><div class="menu-card-stock ${i.stockClass}"><i class="fas fa-box"></i> ${i.stockText}</div></div></div>`).join('')}function renderizarPedidos(){let pMesa=pedidos.filter(p=>p.tipo==='mesa'&&p.estado==='pendiente'),pDel=pedidos.filter(p=>p.tipo==='delivery'&&p.estado==='pendiente'),pRes=pedidos.filter(p=>p.tipo==='reserva'&&p.estado==='pendiente'),cMesa=pedidos.filter(p=>p.tipo==='mesa'&&p.estado==='en_cocina'),cDel=pedidos.filter(p=>p.tipo==='delivery'&&p.estado==='en_camino'),rPen=pedidos.filter(p=>p.tipo==='reserva'&&p.estado==='reserva_pendiente'),rAte=pedidos.filter(p=>p.tipo==='reserva'&&p.estado==='reserva_atendida');document.getElementById('mesaPendientesCount').textContent=pMesa.length,document.getElementById('deliveryPendientesCount').textContent=pDel.length,document.getElementById('reservaPendientesCount').textContent=pRes.length,document.getElementById('totalPendientesBadge').textContent=pMesa.length+pDel.length+pRes.length,document.getElementById('mesaCocinaCount').textContent=cMesa.length,document.getElementById('deliveryCaminoCount').textContent=cDel.length,document.getElementById('reservaProcesoCount').textContent=rPen.length+rAte.length,document.getElementById('totalPreparacionBadge').textContent=cMesa.length+cDel.length+rPen.length+rAte.length,document.getElementById('mesaPendientesContainer').innerHTML=pMesa.length?pMesa.map(p=>crearTarjetaPedidoCompacta(p,'pendiente')).join(''):'<div class="empty-state"><i class="fas fa-store"></i><p>No hay pedidos en mesa</p></div>',document.getElementById('deliveryPendientesContainer').innerHTML=pDel.length?pDel.map(p=>crearTarjetaPedidoCompacta(p,'pendiente')).join(''):'<div class="empty-state"><i class="fas fa-motorcycle"></i><p>No hay pedidos delivery</p></div>',document.getElementById('reservaPendientesContainer').innerHTML=pRes.length?pRes.map(p=>crearTarjetaPedidoCompacta(p,'pendiente')).join(''):'<div class="empty-state"><i class="fas fa-calendar-check"></i><p>No hay reservas</p></div>',document.getElementById('mesaCocinaContainer').innerHTML=cMesa.length?cMesa.map(p=>crearTarjetaPedidoCompacta(p,'preparacion')).join(''):'<div class="empty-state"><i class="fas fa-fire"></i><p>No hay pedidos en cocina</p></div>',document.getElementById('deliveryCaminoContainer').innerHTML=cDel.length?cDel.map(p=>crearTarjetaPedidoCompacta(p,'preparacion')).join(''):'<div class="empty-state"><i class="fas fa-truck"></i><p>No hay deliveries en camino</p></div>',document.getElementById('reservaProcesoContainer').innerHTML=rPen.length+rAte.length?[...rPen,...rAte].map(p=>crearTarjetaPedidoCompacta(p,'preparacion')).join(''):'<div class="empty-state"><i class="fas fa-clock"></i><p>No hay reservas pendientes</p></div>'}function crearTarjetaPedidoCompacta(pedido,tipoSeccion){let hora=new Date(pedido.timestamp).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}),info='';pedido.tipo==='mesa'?info=`<div class="order-info-compact"><i class="fas fa-chair"></i> Mesa #${pedido.mesa||'N/A'}</div>`:pedido.tipo==='delivery'?info=`<div class="order-info-compact"><div><i class="fas fa-map-marker-alt"></i> ${(pedido.direccion||'').substring(0,20)}...</div><div><i class="fas fa-phone"></i> ${pedido.telefono||'N/A'}</div>${pedido.costo_delivery_bs?`<div><i class="fas fa-truck"></i> Delivery: ${formatBs(pedido.costo_delivery_bs)}</div>`:''}</div>`:info=`<div class="order-info-compact"><div><i class="fas fa-user"></i> ${pedido.cliente_nombre||'Cliente'}</div><div><i class="fas fa-calendar"></i> ${pedido.fecha_reserva?new Date(pedido.fecha_reserva).toLocaleDateString():'N/A'}</div></div>`;let items=(pedido.items||[]).slice(0,2).map(i=>`<div class="order-item-row-compact"><span class="item-name-compact">${i.cantidad||1}x ${i.nombre}</span><span class="item-price-compact">${formatBs(usdToBs((i.precioUnitarioUSD||0)*(i.cantidad||1)))}</span></div>`).join(''),itemsCount=(pedido.items||[]).length,moreItems=itemsCount>2?`<div class="order-item-row-compact" style="justify-content:center;color:var(--gray-400)">+${itemsCount-2} m치s</div>`:'',total=formatBs(usdToBs(pedido.total||0)),comprobante=pedido.comprobante_url&&(pedido.tipo==='delivery'||pedido.tipo==='reserva')?`<div class="comprobante-thumbnail" onclick="verComprobante('${pedido.id}')"><img src="${pedido.comprobante_url}" style="max-width:100%;cursor:pointer"></div>`:'',botones='';return tipoSeccion==='pendiente'?botones=`<button class="btn-compact btn-cobrar-compact" onclick="mostrarCobro('${pedido.id}')"><i class="fas fa-cash-register"></i> Cobrar</button><button class="btn-compact btn-rechazar-compact" onclick="mostrarRechazo('${pedido.id}')"><i class="fas fa-times"></i> Rechazar</button>`:pedido.tipo==='mesa'&&pedido.estado==='en_cocina'?botones=`<button class="btn-compact btn-entregar-compact" onclick="mostrarConfirmacion('${pedido.id}','entregado')"><i class="fas fa-check"></i> Entregado</button>`:pedido.tipo==='delivery'&&pedido.estado==='en_camino'?botones=`<button class="btn-compact btn-enviar-compact" onclick="mostrarConfirmacionDelivery('${pedido.id}')"><i class="fas fa-truck"></i> Enviar</button>`:pedido.tipo==='reserva'&&pedido.estado==='reserva_pendiente'?botones=`<button class="btn-compact btn-confirmar-compact" onclick="mostrarConfirmacion('${pedido.id}','reserva_atendida')"><i class="fas fa-user-check"></i> Confirmar</button>`:pedido.tipo==='reserva'&&pedido.estado==='reserva_atendida'&&(botones=`<button class="btn-compact btn-entregar-compact" onclick="mostrarConfirmacion('${pedido.id}','reserva_completada')"><i class="fas fa-check"></i> Entregado</button>`),`<div class="order-card-compact ${pedido.estado}"><div class="order-header-compact"><span class="order-time-compact"><i class="far fa-clock"></i> ${hora}</span><span style="font-weight:600;color:var(--${pedido.tipo==='mesa'?'info':pedido.tipo==='delivery'?'success':'accent'});font-size:.7rem;text-transform:uppercase">${pedido.tipo}</span></div>${info}<div class="order-items-compact">${items}${moreItems}</div><div class="order-total-compact">${total}</div>${comprobante}<div class="order-actions-compact">${botones}</div></div>`}function mostrarConfirmacionDelivery(pedidoId){let pedido=pedidos.find(p=>p.id===pedidoId);if(!pedido)return;pedidoParaAccion=pedido;let modal=document.getElementById('confirmModal'),title=document.getElementById('confirmModalTitle'),body=document.getElementById('confirmModalBody'),header=document.getElementById('confirmModalHeader');title.innerHTML='<i class="fas fa-truck"></i> Asignar Delivery',header.style.background='linear-gradient(135deg,var(--delivery),#00838F)';let deliveryOptions=deliverys.map(d=>`<option value="${d.id}">${d.nombre}</option>`).join('');body.innerHTML=`<p>Selecciona el motorizado que realizar치 el env칤o:</p><div class="delivery-selector" style="margin:20px 0"><select id="deliverySelector" style="width:100%;padding:10px;background:rgba(0,0,0,.5);color:#fff;border:2px solid rgba(255,255,255,.2);border-radius:8px;"><option value="">-- Seleccionar motorizado --</option>${deliveryOptions}</select></div>${crearDetallePedidoHTML(pedido)}<div class="keyboard-hint" style="margin-top:20px"><span><kbd>ENTER</kbd> confirmar</span><span><kbd>ESC</kbd> cancelar</span></div>`,document.getElementById('confirmActionBtn').disabled=!0,setTimeout(()=>{let selector=document.getElementById('deliverySelector');selector&&selector.addEventListener('change',function(){document.getElementById('confirmActionBtn').disabled=!this.value})},100),modal.classList.add('active')}function mostrarCobro(pedidoId){currentPedido=pedidos.find(p=>p.id===pedidoId);if(!currentPedido)return;enProcesoDeCobro=!0,alarmaActiva&&(alarmaAudio.pause(),alarmaAudio.currentTime=0,alarmaActiva=!1),pagosMixtos=[],condonacionActual=0,favorCajaActual=0,vueltoEntregadoActual=0;let totalAPagar=usdToBs(currentPedido.total||0),body=document.getElementById('cobroModalBody'),items=(currentPedido.items||[]).map(i=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.1)"><span>${i.cantidad||1}x ${i.nombre}</span><span style="font-weight:600">${formatBs(usdToBs((i.precioUnitarioUSD||0)*(i.cantidad||1)))}</span></div>`).join('');body.innerHTML=`<div style="background:rgba(0,0,0,.3);padding:15px;border-radius:8px;margin-bottom:20px"><h4>Resumen del Pedido</h4>${items}${currentPedido.costo_delivery_bs?`<div style="display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:2px solid rgba(255,255,255,.1)"><span>Costo delivery:</span><span>${formatBs(currentPedido.costo_delivery_bs)}</span></div>`:''}<div style="display:flex;justify-content:space-between;margin-top:15px;padding-top:15px;border-top:2px solid var(--primary);font-weight:700"><span>Total a pagar:</span><span id="totalPagarDisplay" style="color:var(--accent)">${formatBs(totalAPagar)}</span></div></div><div style="margin-bottom:20px;padding:12px;background:rgba(245,124,0,.1);border-left:4px solid var(--warning)"><label style="display:flex;align-items:center;gap:10px;color:#fff"><input type="checkbox" id="invitacionCheck" style="width:18px;height:18px"><strong>Por parte de la casa (invitaci칩n)</strong></label></div><div id="pagosSection"><h4>Pagos Mixtos</h4><div id="pagosContainer" class="payment-mix-container"></div><button class="btn btn-secondary" onclick="agregarMetodoPago()" style="width:100%;margin-bottom:20px"><i class="fas fa-plus"></i> Agregar M칠todo de Pago</button><div class="pagos-total"><div class="pagos-resumen"><span>Total recibido:</span><span id="totalRecibido">Bs. 0.00</span></div><div class="pagos-resumen"><span>Pendiente:</span><span id="pendiente" style="color:var(--danger)">Bs. 0.00</span></div><div class="pagos-resumen"><span>Sobrante:</span><span id="sobrante" style="color:var(--success)">Bs. 0.00</span></div><div class="pagos-resumen" id="vueltoRow" style="display:none"><span>Vuelto entregado:</span><span id="vueltoEntregadoDisplay">Bs. 0.00</span></div><div class="pagos-resumen" id="condonacionRow" style="display:none;color:var(--condonacion)"><span>Condonado:</span><span id="condonacionDisplay">Bs. 0.00</span></div><div class="pagos-resumen" id="favorCajaRow" style="display:none;color:var(--favoreaja)"><span>A favor de caja:</span><span id="favorCajaDisplay">Bs. 0.00</span></div></div><div class="checkbox-extra" id="extraOptions"><div class="checkbox-item" id="vueltoExtraContainer" style="display:none"><label>Vuelto a entregar:</label><div class="vuelto-row"><input type="text" id="vueltoInput" placeholder="0.00" oninput="this.value=this.value.replace(/[^0-9.]/g,'').replace(/(\..*?)\..*/g,'$1').replace(/(\.\d{2})\d+/g,'$1');validarVuelto()" style="width:100%;padding:10px;border:2px solid var(--info);border-radius:8px;background:rgba(0,0,0,.5);color:#fff"></div></div><div class="checkbox-item"><input type="checkbox" id="condonarCheck" onchange="toggleCondonacion()"><label for="condonarCheck">Condonar monto restante (Bs. <span id="condonarMonto">0.00</span>)</label></div><div class="checkbox-item"><input type="checkbox" id="favorCajaCheck" onchange="toggleFavorCaja()"><label for="favorCajaCheck">A favor de caja (Bs. <span id="favorCajaMonto">0.00</span>)</label></div></div></div><div class="keyboard-hint"><span><kbd>ENTER</kbd> confirmar</span><span><kbd>ESC</kbd> cancelar</span></div>`,document.getElementById('invitacionCheck').addEventListener('change',function(e){let seccion=document.getElementById('pagosSection');seccion.style.opacity=e.target.checked?'0.5':'1',seccion.style.pointerEvents=e.target.checked?'none':'auto',document.getElementById('confirmCobroBtn').disabled=!e.target.checked&&pagosMixtos.length===0}),document.getElementById('cobroModal').classList.add('active'),agregarMetodoPago(!0),recalcularTotales()}function agregarMetodoPago(primerMetodo=!1){let metodoPredeterminado='efectivo_bs';currentPedido&&(currentPedido.tipo==='delivery'||currentPedido.tipo==='reserva')&&(metodoPredeterminado='pago_movil'),pagosMixtos.push({id:Date.now()+Math.random(),metodo:primerMetodo?metodoPredeterminado:'efectivo_bs',monto:0,referencia:''}),renderizarPagosMixtos(),recalcularTotales()}function renderizarPagosMixtos(){let c=document.getElementById('pagosContainer');if(!c)return;c.innerHTML=pagosMixtos.map((p,i)=>`<div class="pago-item" data-id="${p.id}">${pagosMixtos.length>1?`<button class="remove-pago" onclick="eliminarMetodoPago('${p.id}')"><i class="fas fa-times"></i></button>`:''}<select onchange="actualizarPago('${p.id}','metodo',this.value)"><option value="efectivo_bs" ${p.metodo==='efectivo_bs'?'selected':''}>Efectivo Bs</option><option value="efectivo_usd" ${p.metodo==='efectivo_usd'?'selected':''}>Efectivo D칩lar</option><option value="pago_movil" ${p.metodo==='pago_movil'?'selected':''}>Pago M칩vil</option><option value="punto_venta" ${p.metodo==='punto_venta'?'selected':''}>Punto de Venta</option></select><input type="text" placeholder="Monto ${p.metodo==='efectivo_usd'?'en USD':'en Bs'}" value="${p.monto||0}" oninput="this.value=this.value.replace(/[^0-9.]/g,'').replace(/(\..*?)\..*/g,'$1').replace(/(\.\d{2})\d+/g,'$1');actualizarPago('${p.id}','monto',this.value)">${p.metodo==='pago_movil'?`<input type="text" maxlength="6" placeholder="Referencia (6 d칤gitos)" value="${p.referencia||''}" oninput="actualizarPago('${p.id}','referencia',this.value)">`:''}</div>`).join('')}function actualizarPago(id,campo,valor){let p=pagosMixtos.find(p=>p.id==id);if(!p)return;campo==='monto'?p.monto=parseFloat(valor)||0:campo==='metodo'?(p.metodo=valor,valor!=='pago_movil'&&(p.referencia='')):campo==='referencia'&&(p.referencia=valor),renderizarPagosMixtos(),recalcularTotales()}function eliminarMetodoPago(id){pagosMixtos=pagosMixtos.filter(p=>p.id!=id),renderizarPagosMixtos(),recalcularTotales()}function toggleCondonacion(){let condonarCheck=document.getElementById('condonarCheck');condonarCheck.checked?(condonacionActual=parseFloat(document.getElementById('pendiente').textContent.replace('Bs.','').replace(',','').trim())||0,document.getElementById('condonarMonto').textContent=condonacionActual.toFixed(2),document.getElementById('condonacionRow').style.display='flex',document.getElementById('condonacionDisplay').textContent=formatBs(condonacionActual)):(condonacionActual=0,document.getElementById('condonacionRow').style.display='none'),recalcularTotales()}function toggleFavorCaja(){let favorCajaCheck=document.getElementById('favorCajaCheck');if(favorCajaCheck.checked){let pendiente=parseFloat(document.getElementById('pendiente').textContent.replace('Bs.','').replace(',','').trim())||0,sobrante=parseFloat(document.getElementById('sobrante').textContent.replace('Bs.','').replace(',','').trim())||0;favorCajaActual=pendiente>0?pendiente:sobrante>0?sobrante:0,document.getElementById('favorCajaMonto').textContent=favorCajaActual.toFixed(2),document.getElementById('favorCajaRow').style.display='flex',document.getElementById('favorCajaDisplay').textContent=formatBs(favorCajaActual)}else favorCajaActual=0,document.getElementById('favorCajaRow').style.display='none';recalcularTotales()}function validarVuelto(){let vuelto=parseFloat(document.getElementById('vueltoInput').value)||0,sobrante=parseFloat(document.getElementById('sobrante').textContent.replace('Bs.','').replace(',','').trim())||0;if(vuelto>0){if(vuelto<=sobrante)vueltoEntregadoActual=vuelto,document.getElementById('vueltoRow').style.display='flex',document.getElementById('vueltoEntregadoDisplay').textContent=formatBs(vuelto);else if(vuelto>sobrante){let excedente=vuelto-sobrante;vueltoEntregadoActual=sobrante,document.getElementById('vueltoRow').style.display='flex',document.getElementById('vueltoEntregadoDisplay').textContent=formatBs(sobrante),favorCajaActual=excedente,document.getElementById('favorCajaCheck').checked=!0,document.getElementById('favorCajaMonto').textContent=excedente.toFixed(2),document.getElementById('favorCajaRow').style.display='flex',document.getElementById('favorCajaDisplay').textContent=formatBs(excedente)}}else vueltoEntregadoActual=0,document.getElementById('vueltoRow').style.display='none';recalcularTotales()}function recalcularTotales(){let total=usdToBs(currentPedido?.total||0),recibido=pagosMixtos.reduce((s,p)=>s+(p.metodo==='efectivo_usd'?usdToBs(p.monto||0):p.monto||0),0),pendiente=Math.max(0,total-recibido),sobrante=Math.max(0,recibido-total),condonarCheck=document.getElementById('condonarCheck'),favorCajaCheck=document.getElementById('favorCajaCheck');condonarCheck&&condonarCheck.checked&&(pendiente=Math.max(0,pendiente-condonacionActual)),favorCajaCheck&&favorCajaCheck.checked&&(favorCajaActual>0?sobrante>=favorCajaActual?sobrante-=favorCajaActual:pendiente>0?pendiente=Math.max(0,pendiente-favorCajaActual):favorCajaActual>0&&(pendiente=Math.max(0,total-(recibido+favorCajaActual)))):favorCajaActual=0,document.getElementById('totalRecibido').textContent=formatBs(recibido),document.getElementById('pendiente').textContent=formatBs(pendiente),document.getElementById('sobrante').textContent=formatBs(sobrante);let vueltoContainer=document.getElementById('vueltoExtraContainer');vueltoContainer&&(sobrante>0?vueltoContainer.style.display='block':vueltoContainer.style.display='none');let inv=document.getElementById('invitacionCheck');document.getElementById('confirmCobroBtn').disabled=!inv.checked&&(pagosMixtos.length===0||pendiente>0)}async function confirmarCobro(){if(!currentPedido)return;let inv=document.getElementById('invitacionCheck').checked;try{let nuevoEstado,metodoPago,pagos;if(inv)nuevoEstado=currentPedido.tipo==='delivery'?'en_camino':currentPedido.tipo==='reserva'?'reserva_pendiente':'en_cocina',metodoPago='invitacion',pagos=[{metodo:'invitacion',monto:0,montoBs:0}];else{nuevoEstado=currentPedido.tipo==='delivery'?'en_camino':currentPedido.tipo==='reserva'?'reserva_pendiente':'en_cocina',pagos=pagosMixtos.map(p=>({metodo:p.metodo,monto:p.monto,montoBs:p.metodo==='efectivo_usd'?usdToBs(p.monto):p.monto,referencia:p.referencia||null})),metodoPago=pagosMixtos.length===1?pagosMixtos[0].metodo:'mixto';if(condonacionActual>0){let registroCondonacion={pedido_id:currentPedido.id,monto:condonacionActual,fecha:new Date().toISOString(),cajero:currentUser?.nombre||'Cajero'};registrosCondonacion.push(registroCondonacion)}if(favorCajaActual>0){let registroFavorCaja={pedido_id:currentPedido.id,monto:favorCajaActual,fecha:new Date().toISOString(),cajero:currentUser?.nombre||'Cajero'};registrosFavorCaja.push(registroFavorCaja)}}await window.supabaseClient.from('pedidos').update({estado:nuevoEstado,metodo_pago:metodoPago,pagos_mixtos:pagos,cajero:currentUser?.nombre||'Cajero',fecha_cobro:new Date().toISOString(),condonado:condonacionActual,a_favor_caja:favorCajaActual,vuelto_entregado:vueltoEntregadoActual}).eq('id',currentPedido.id);let totalItems=currentPedido.items?.reduce((s,i)=>s+(i.cantidad||1),0)||0,subtotalPlatillosUSD=(currentPedido.items||[]).reduce((s,i)=>s+(i.precioUnitarioUSD||0)*(i.cantidad||1),0),subtotalPlatillosBs=usdToBs(subtotalPlatillosUSD);await window.supabaseClient.from('ventas').insert([{pedido_id:currentPedido.id,total:currentPedido.total,subtotal_platillos:subtotalPlatillosBs,items:totalItems,metodo_pago:metodoPago,tipo:currentPedido.tipo,fecha:new Date().toISOString(),condonado:condonacionActual,a_favor_caja:favorCajaActual}]);let tituloNotif,mensajeNotif;inv?(tituloNotif='游꾸 Pedido por invitaci칩n',mensajeNotif='Tu pedido ha sido procesado. 춰Disfruta!'):currentPedido.tipo==='delivery'?(tituloNotif='九 Pago confirmado',mensajeNotif='Tu delivery est치 en camino'):currentPedido.tipo==='reserva'?(tituloNotif='九 Reserva confirmada',mensajeNotif='Tu reserva ha sido confirmada'):(tituloNotif='九 Pago confirmado',mensajeNotif='Tu pedido est치 en preparaci칩n');await window.supabaseClient.from('notificaciones').insert([{pedido_id:currentPedido.id,tipo:'approved',titulo:tituloNotif,mensaje:mensajeNotif,timestamp:new Date().toISOString(),session_id:currentPedido.session_id,leida:!1}]),document.getElementById('cobroModal').classList.remove('active'),mostrarToast('游눯 Cobro procesado'),enProcesoDeCobro=!1,currentPedido=null,pagosMixtos=[],condonacionActual=0,favorCajaActual=0,vueltoEntregadoActual=0,await recargarPedidosCompletos(),await cargarMenu(),renderizarPropinas(),renderizarDeliverys(),setTimeout(()=>mostrarPropinaModal(currentPedido),500)}catch(error){console.error('Error en cobro:',error),mostrarToast('仇 Error al procesar el cobro','error')}}async function confirmarRechazo(){if(!pedidoParaAccion)return;let razon=document.querySelector('input[name="rejectionReason"]:checked')?.value;if(!razon)return mostrarToast('Selecciona una raz칩n','error');try{await window.supabaseClient.rpc('liberar_ingredientes',{p_pedido_id:pedidoParaAccion.id}),await window.supabaseClient.from('pedidos').update({estado:'rechazado'}).eq('id',pedidoParaAccion.id);let razones={referencia_invalida:'Referencia inv치lida',monto_insuficiente:'Monto insuficiente',datos_incorrectos:'Datos incorrectos',no_disponible:'Producto no disponible',fuera_horario:'Fuera de horario'};await window.supabaseClient.from('notificaciones').insert([{pedido_id:pedidoParaAccion.id,tipo:'rejected',titulo:'仇 Pedido rechazado',mensaje:`Motivo: ${razones[razon]||razon}`,timestamp:new Date().toISOString(),session_id:pedidoParaAccion.session_id,leida:!1}]),cerrarModal('rechazoModal'),mostrarToast('游딈勇 Pedido rechazado'),await recargarPedidosCompletos(),verificarYControlarAlarma(!0)}catch(error){console.error('Error al rechazar:',error),mostrarToast('仇 Error al rechazar','error')}}async function ejecutarConfirmacion(){if(!pedidoParaAccion)return;try{let notifTitulo,notifMensaje;if(accionPendiente==='entregado')notifTitulo='游꽇勇 Pedido entregado',notifMensaje='춰Buen Provecho! Gracias por elegir Saki Sushi';else if(accionPendiente==='enviado'){let deliveryId=document.getElementById('deliverySelector')?.value;if(!deliveryId)return mostrarToast('Selecciona un motorizado','error');let delivery=deliverys.find(d=>d.id===deliveryId);await window.supabaseClient.from('entregas_delivery').insert([{pedido_id:pedidoParaAccion.id,delivery_id:deliveryId,monto_bs:pedidoParaAccion.costo_delivery_bs||0,fecha_entrega:new Date().toISOString()}]),notifTitulo='游뚴 Delivery en camino',notifMensaje=delivery?`Tu pedido est치 siendo entregado por ${delivery.nombre}`:'El repartidor ya sali칩'}else accionPendiente==='reserva_atendida'?(notifTitulo='九 Reserva Confirmada',notifMensaje='En breve tu pedido te ser치 entregado, 춰Gracias por preferirnos!'):accionPendiente==='reserva_completada'?(notifTitulo='游꽇勇 Pedido entregado',notifMensaje='춰Buen Provecho! Gracias por elegir Saki Sushi'):(notifTitulo='游댃 Estado actualizado',notifMensaje='Tu pedido ha sido actualizado');await window.supabaseClient.from('pedidos').update({estado:accionPendiente}).eq('id',pedidoParaAccion.id),await window.supabaseClient.from('notificaciones').insert([{pedido_id:pedidoParaAccion.id,tipo:'approved',titulo:notifTitulo,mensaje:notifMensaje,timestamp:new Date().toISOString(),session_id:pedidoParaAccion.session_id,leida:!1}]),cerrarModal('confirmModal'),mostrarToast('九 Estado actualizado'),await recargarPedidosCompletos(),verificarYControlarAlarma(!0)}catch(error){console.error('Error:',error),mostrarToast('仇 Error','error')}}function mostrarPropinaModal(pedido){if(!pedido)return;currentPropinaPedido=pedido,currentPropinaData={mesonero:'',mesa:pedido.tipo==='mesa'?`Mesa ${pedido.mesa||''}`:pedido.tipo==='delivery'?'Delivery':'Reserva',metodo:'efectivo_bs',montoBs:0,montoUsd:0,referencia:'',tasaAplicada:tasaEfectiva};let body=document.getElementById('propinaModalBody'),mesonerosOptions=mesoneros.map(m=>`<option value="${m.id}">${m.nombre}</option>`).join('');body.innerHTML=`<div style="margin-bottom:20px"><div class="mesonero-selector"><label>游븸꽳릜 Mesonero</label><select id="propinaMesonero"><option value="">Seleccionar mesonero...</option>${mesonerosOptions}</select></div><div class="mesa-selector"><label>游뿜 Mesa Atendida</label><select id="propinaMesa"><option value="Mesa 1">Mesa 1</option><option value="Mesa 2">Mesa 2</option><option value="Mesa 3">Mesa 3</option><option value="Mesa 4">Mesa 4</option><option value="Mesa 5">Mesa 5</option><option value="Mesa 6">Mesa 6</option><option value="Mesa 7">Mesa 7</option><option value="Mesa 8">Mesa 8</option><option value="Mesa 9">Mesa 9</option><option value="Mesa 10">Mesa 10</option><option value="Delivery">Delivery</option><option value="Reserva">Reserva</option></select></div><div style="margin-bottom:20px"><label>游눱 M칠todo de Pago</label><div style="display:flex;gap:10px;margin-top:8px"><label style="flex:1;background:rgba(0,0,0,.3);padding:10px;border-radius:8px;text-align:center;cursor:pointer"><input type="radio" name="propinaMetodo" value="efectivo_bs" checked onchange="cambiarMetodoPropina('efectivo_bs')"> Efectivo Bs</label><label style="flex:1;background:rgba(0,0,0,.3);padding:10px;border-radius:8px;text-align:center;cursor:pointer"><input type="radio" name="propinaMetodo" value="efectivo_usd" onchange="cambiarMetodoPropina('efectivo_usd')"> Efectivo USD</label><label style="flex:1;background:rgba(0,0,0,.3);padding:10px;border-radius:8px;text-align:center;cursor:pointer"><input type="radio" name="propinaMetodo" value="pago_movil" onchange="cambiarMetodoPropina('pago_movil')"> Pago M칩vil</label><label style="flex:1;background:rgba(0,0,0,.3);padding:10px;border-radius:8px;text-align:center;cursor:pointer"><input type="radio" name="propinaMetodo" value="punto_venta" onchange="cambiarMetodoPropina('punto_venta')"> Punto Venta</label></div></div><div class="propina-monto-group" id="propinaMontoGroup"><input type="text" id="propinaMontoBs" placeholder="Monto en Bs" oninput="this.value=this.value.replace(/[^0-9.]/g,'').replace(/(\..*?)\..*/g,'$1').replace(/(\.\d{2})\d+/g,'$1');calcularMontoPropina('bs')"><input type="text" id="propinaMontoUsd" placeholder="Monto en USD" disabled oninput="this.value=this.value.replace(/[^0-9.]/g,'').replace(/(\..*?)\..*/g,'$1').replace(/(\.\d{2})\d+/g,'$1');calcularMontoPropina('usd')"></div><div id="propinaReferenciaGroup" style="display:none;margin-bottom:20px"><label>游댝 Referencia (6 d칤gitos)</label><div class="referencia-input"><input type="text" maxlength="1" class="ref-propina" data-index="0" oninput="moverRefPropina(this,0)"><input type="text" maxlength="1" class="ref-propina" data-index="1" oninput="moverRefPropina(this,1)"><input type="text" maxlength="1" class="ref-propina" data-index="2" oninput="moverRefPropina(this,2)"><input type="text" maxlength="1" class="ref-propina" data-index="3" oninput="moverRefPropina(this,3)"><input type="text" maxlength="1" class="ref-propina" data-index="4" oninput="moverRefPropina(this,4)"><input type="text" maxlength="1" class="ref-propina" data-index="5" oninput="moverRefPropina(this,5)"></div></div><div style="background:rgba(0,0,0,.3);padding:15px;border-radius:8px"><div style="display:flex;justify-content:space-between"><span><strong>Total a registrar:</strong></span><span id="propinaTotalDisplay" style="color:var(--accent);font-size:1.2rem">Bs. 0.00</span></div><div style="font-size:.85rem;color:rgba(255,255,255,.7);margin-top:5px">Tasa aplicada: ${tasaEfectiva} Bs/USD</div></div></div><div class="keyboard-hint"><span><kbd>ENTER</kbd> guardar</span><span><kbd>ESC</kbd> cancelar</span></div>`,document.querySelectorAll('.ref-propina').forEach(input=>{input.addEventListener('input',function(){let ref=Array.from(document.querySelectorAll('.ref-propina')).map(i=>i.value).join('');currentPropinaData.referencia=ref,validarPropina()})}),document.getElementById('propinaModal').classList.add('active')}function cambiarMetodoPropina(metodo){currentPropinaData.metodo=metodo;let bsInput=document.getElementById('propinaMontoBs'),usdInput=document.getElementById('propinaMontoUsd'),refGroup=document.getElementById('propinaReferenciaGroup');metodo==='efectivo_usd'?(bsInput.disabled=!0,usdInput.disabled=!1,refGroup.style.display='none'):metodo==='pago_movil'?(bsInput.disabled=!1,usdInput.disabled=!0,refGroup.style.display='block'):(bsInput.disabled=!1,usdInput.disabled=!0,refGroup.style.display='none'),validarPropina()}function calcularMontoPropina(tipo){tipo==='bs'?(currentPropinaData.montoBs=parseFloat(document.getElementById('propinaMontoBs').value)||0,currentPropinaData.metodo==='efectivo_usd'&&(currentPropinaData.montoUsd=currentPropinaData.montoBs/tasaEfectiva),document.getElementById('propinaTotalDisplay').textContent=formatBs(currentPropinaData.montoBs)):(currentPropinaData.montoUsd=parseFloat(document.getElementById('propinaMontoUsd').value)||0,currentPropinaData.montoBs=currentPropinaData.montoUsd*tasaEfectiva,document.getElementById('propinaTotalDisplay').textContent=formatBs(currentPropinaData.montoBs)),validarPropina()}function moverRefPropina(input,index){input.value.length===1&&index<5&&document.querySelector(`.ref-propina[data-index="${index+1}"]`).focus();let ref=Array.from(document.querySelectorAll('.ref-propina')).map(i=>i.value).join('');currentPropinaData.referencia=ref,validarPropina()}function validarPropina(){let mesonero=document.getElementById('propinaMesonero')?.value,mesa=document.getElementById('propinaMesa')?.value;if(!mesonero||!mesa)return document.getElementById('confirmPropinaBtn').disabled=!0,void 0;if(currentPropinaData.metodo==='pago_movil'){let refValida=currentPropinaData.referencia&&currentPropinaData.referencia.length===6;document.getElementById('confirmPropinaBtn').disabled=!(currentPropinaData.montoBs>0&&refValida)}else currentPropinaData.metodo==='efectivo_usd'?document.getElementById('confirmPropinaBtn').disabled=!(currentPropinaData.montoUsd>0):document.getElementById('confirmPropinaBtn').disabled=!(currentPropinaData.montoBs>0)}async function confirmarPropina(){if(!currentPropinaPedido||!currentUser)return;let mesoneroId=document.getElementById('propinaMesonero').value,mesa=document.getElementById('propinaMesa').value,mesonero=mesoneros.find(m=>m.id===mesoneroId);if(!mesonero)return mostrarToast('Selecciona un mesonero','error');try{let propina={pedido_id:currentPropinaPedido.id,mesonero_id:mesoneroId,mesa:mesa,metodo:currentPropinaData.metodo,monto_original:currentPropinaData.metodo==='efectivo_usd'?currentPropinaData.montoUsd:currentPropinaData.montoBs,moneda_original:currentPropinaData.metodo==='efectivo_usd'?'USD':'Bs',tasa_aplicada:currentPropinaData.metodo==='efectivo_usd'?tasaEfectiva:null,monto_bs:currentPropinaData.montoBs,referencia:currentPropinaData.referencia||null,cajero:currentUser.nombre,fecha:new Date().toISOString(),entregado:!1};await window.supabaseClient.from('propinas').insert([propina]),cerrarPropinaModal(),mostrarToast('游눯 Propina registrada','success'),await cargarPropinas(),actualizarEstadisticas(),renderizarPropinas()}catch(error){console.error('Error:',error),mostrarToast('仇 Error al registrar propina','error')}}function mostrarConfirmacion(pedidoId,accion){let pedido=pedidos.find(p=>p.id===pedidoId);if(!pedido)return;pedidoParaAccion=pedido,accionPendiente=accion;let modal=document.getElementById('confirmModal'),title=document.getElementById('confirmModalTitle'),body=document.getElementById('confirmModalBody'),header=document.getElementById('confirmModalHeader'),titulo,mensaje,notif;accion==='entregado'?(titulo='Confirmar Entrega',mensaje='쯇edido entregado?',header.style.background='linear-gradient(135deg,var(--success),#2E7D32)',notif={titulo:'游꽇勇 춰Que aproveche!',mensaje:'Tu pedido ha sido entregado.'}):accion==='enviado'?(titulo='Confirmar Env칤o',mensaje='쯇edido enviado?',header.style.background='linear-gradient(135deg,var(--info),#1565C0)',notif={titulo:'游뚴 Delivery en camino',mensaje:'El repartidor ya sali칩.'}):accion==='reserva_atendida'?(titulo='Cliente Confirmado',mensaje='쮺liente lleg칩?',header.style.background='linear-gradient(135deg,#9c27b0,#7b1fa2)',notif={titulo:'九 Cliente confirmado',mensaje:'Est치s siendo atendido.'}):(titulo='Confirmar',mensaje='쮺onfirmar acci칩n?',header.style.background='linear-gradient(135deg,var(--success),#2E7D32)',notif={titulo:'九 Completado',mensaje:'Acci칩n confirmada.'}),title.innerHTML=`<i class="fas fa-check-circle"></i> ${titulo}`,body.innerHTML=`<p>${mensaje}</p>${crearDetallePedidoHTML(pedido)}<div style="background:rgba(56,142,60,.1);padding:15px;margin-top:20px"><strong>Notificaci칩n:</strong><br>${notif.titulo}<br>${notif.mensaje}</div><div class="keyboard-hint"><span><kbd>ENTER</kbd> confirmar</span><span><kbd>ESC</kbd> cancelar</span></div>`,modal.classList.add('active')}function mostrarRechazo(pedidoId){pedidoParaAccion=pedidos.find(p=>p.id===pedidoId),pedidoParaAccion&&document.getElementById('rechazoModal').classList.add('active')}async function verComprobante(pedidoId){let pedido=pedidos.find(p=>p.id===pedidoId);if(!pedido||!pedido.comprobante_url)return mostrarToast('No hay comprobante','error');let modal=document.getElementById('comprobanteModal');document.getElementById('comprobanteModalBody').innerHTML=`<div style="text-align:center"><img src="${pedido.comprobante_url}" style="max-width:100%;max-height:400px;border-radius:8px;margin-bottom:15px"><p><strong>Referencia:</strong> ${pedido.referencia||'N/A'}</p><p><strong>Tel칠fono:</strong> ${pedido.telefono||'N/A'}</p><p><strong>Total:</strong> ${formatBs(usdToBs(pedido.total||0))}</p></div><div class="keyboard-hint"><span><kbd>ESC</kbd> cerrar</span></div>`,modal.classList.add('active')}async function abrirSelectorMesa(){await cargarMesas();let modal=document.getElementById('mesaModal'),lista=document.getElementById('mesaList');lista.innerHTML=mesas.length?mesas.map(m=>`<button class="mesa-btn" onclick="abrirMesa('${m.nombre}')"><i class="fas fa-chair"></i>${m.nombre}</button>`).join(''):'<p class="text-center">No hay mesas</p>',modal.classList.add('active')}function abrirMesa(n){window.open(`${window.location.origin}/Cliente/index.html?mesa=${encodeURIComponent(n)}`,'_blank'),cerrarModal('mesaModal')}function abrirModalDeliverys(){let modal=document.getElementById('deliveryModal'),body=document.getElementById('deliveryModalBody');obtenerAcumuladoDeliverysHoy().then(acumulado=>{let contenido='<h3 style="margin-bottom:20px">Acumulado por motorizado (Hoy)</h3>';deliverys.length===0?contenido+='<div class="empty-state"><i class="fas fa-motorcycle"></i><p>No hay motorizados registrados</p></div>':(contenido+='<div class="motorizados-list">',deliverys.forEach(d=>{let monto=acumulado[d.id]||0;contenido+=`<div class="motorizado-item"><span class="motorizado-nombre">${d.nombre}</span><span class="motorizado-monto">${formatBs(monto)}</span></div>`}),contenido+='</div>',contenido+=`<div class="registros-acumulados"><h4>Resumen del d칤a</h4><div class="registro-item"><span>Total entregas:</span><span>${Object.keys(acumulado).length}</span></div><div class="registro-item"><span>Monto total:</span><span>${formatBs(Object.values(acumulado).reduce((a,b)=>a+b,0))}</span></div></div>`),body.innerHTML=contenido,modal.classList.add('active')})}async function abrirModalDetalle(tipo){await cargarVentasHoy(),await cargarPropinas();let modal=document.getElementById('detalleModal'),title=document.getElementById('detalleModalTitle'),body=document.getElementById('detalleModalBody'),contenido='';switch(tipo){case'preparacion':title.innerHTML='<i class="fas fa-fire"></i> Pedidos en Preparaci칩n';let enPreparacion=pedidos.filter(p=>['en_cocina','en_camino','reserva_pendiente','reserva_atendida'].includes(p.estado));contenido=enPreparacion.length?enPreparacion.map(p=>crearDetallePedidoCompacto(p)).join(''):'<div class="empty-state"><i class="fas fa-inbox"></i><p>No hay pedidos en preparaci칩n</p></div>';break;case'cobrados':title.innerHTML='<i class="fas fa-check-circle"></i> Cobrados Hoy';if(!ventasHoy.length)contenido='<div class="empty-state"><i class="fas fa-inbox"></i><p>No hay cobros registrados hoy</p></div>';else contenido=ventasHoy.map(v=>{let p=pedidos.find(p=>p.id===v.pedido_id);return crearDetalleVentaCompacto(v,p)}).join('');break;case'ventas':title.innerHTML='<i class="fas fa-dollar-sign"></i> Ventas Totales (Platillos)';let totalUSD=ventasHoy.reduce((s,v)=>s+(v.subtotal_platillos||0),0)/(tasaEfectiva||400),totalBs=ventasHoy.reduce((s,v)=>s+(v.subtotal_platillos||0),0),efBs=0,efUSD=0,pm=0,pv=0;ventasHoy.forEach(v=>{let ped=pedidos.find(p=>p.id===v.pedido_id);ped?.metodo_pago&&(ped.metodo_pago==='efectivo_bs'?efBs+=v.subtotal_platillos||0:ped.metodo_pago==='efectivo_usd'?efUSD+=v.subtotal_platillos||0:ped.metodo_pago==='pago_movil'?pm+=v.subtotal_platillos||0:ped.metodo_pago==='punto_venta'&&(pv+=v.subtotal_platillos||0))}),contenido=`<p><strong>Total del d칤a (platillos):</strong> ${formatBs(totalBs)}</p><p><strong>Cantidad de ventas:</strong> ${ventasHoy.length}</p><h4>Desglose por m칠todo:</h4><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px"><div class="payment-tag" style="justify-content:space-between;padding:6px"><span>Efectivo Bs</span><span>${formatBs(efBs)}</span></div><div class="payment-tag" style="justify-content:space-between;padding:6px"><span>Efectivo USD</span><span>${formatBs(efUSD)}</span></div><div class="payment-tag" style="justify-content:space-between;padding:6px"><span>Pago M칩vil</span><span>${formatBs(pm)}</span></div><div class="payment-tag" style="justify-content:space-between;padding:6px"><span>Punto de Venta</span><span>${formatBs(pv)}</span></div></div><h4>Ventas del d칤a:</h4>${ventasHoy.map(v=>{let p=pedidos.find(p=>p.id===v.pedido_id);return crearDetalleVentaCompacto(v,p)}).join('')}`;break;case'platillos':title.innerHTML='<i class="fas fa-utensils"></i> Platillos Vendidos';let hoy=new Date().toDateString(),pedHoy=pedidos.filter(p=>['cobrado','entregado','enviado','reserva_completada'].includes(p.estado)&&new Date(p.timestamp).toDateString()===hoy),conteo={},total=0;pedHoy.forEach(p=>{p.items?.forEach(i=>{let c=i.cantidad||1;conteo[i.nombre]=(conteo[i.nombre]||0)+c,total+=c})});let ranking=Object.entries(conteo).sort((a,b)=>b[1]-a[1]),max=ranking[0]?.[1]||0;ranking.length?contenido=`<p><strong>Total unidades:</strong> ${total}</p><div style="max-height:400px;overflow-y:auto">${ranking.map(([n,c],i)=>`<div class="ranking-bar"><div class="ranking-position">${i+1}</div><div class="ranking-info"><div class="ranking-name">${n}</div><div class="ranking-cantidad">${c} vendido(s)</div></div><div class="ranking-bar-container"><div class="ranking-bar-fill" style="width:${c/max*100}%"></div></div></div>`).join('')}</div>`:contenido='<div class="empty-state"><i class="fas fa-utensils"></i><p>No hay platillos vendidos hoy</p></div>';break;case'propinas':case'propinasDetalle':title.innerHTML='<i class="fas fa-hand-holding-heart"></i> Propinas del D칤a';let totalProp=propinas.reduce((s,p)=>s+(p.monto_bs||p.monto||0),0),cantidadProp=propinas.length,promedioProp=cantidadProp>0?totalProp/cantidadProp:0;contenido=`<p><strong>Total propinas:</strong> ${formatBs(totalProp)}</p><p><strong>Cantidad:</strong> ${cantidadProp}</p><p><strong>Promedio:</strong> ${formatBs(promedioProp)}</p><h4>Detalle por propina:</h4>${propinas.length?propinas.map(p=>`<div class="detail-item-compact"><div class="detail-header-compact"><span>${new Date(p.fecha).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}</span><span class="propina-tag">${p.metodo}</span></div><div><i class="fas fa-user"></i> ${p.cajero||'Cajero'}</div><div><i class="fas fa-${p.pedidos?.tipo==='mesa'?'store':p.pedidos?.tipo==='delivery'?'motorcycle':'calendar-check'}"></i> ${p.pedidos?.tipo||'Mesa'} - ${p.pedidos?.mesa||p.pedidos?.cliente_nombre||'Cliente'}</div><div><i class="fas fa-chair"></i> Mesa: ${p.mesa||'N/A'}</div><div class="detail-total-compact" style="color:var(--propina)">${formatBs(p.monto_bs||p.monto)}</div></div>`).join(''):'<div class="empty-state"><i class="fas fa-hand-holding-heart"></i><p>No hay propinas hoy</p></div>'}`;break;case'propinasCantidad':title.innerHTML='<i class="fas fa-hashtag"></i> Cantidad de Propinas',contenido=`<p style="font-size:2em;text-align:center;color:var(--propina)">${propinas.length}</p><p style="text-align:center">propinas recibidas hoy</p>`;break;case'propinasPromedio':title.innerHTML='<i class="fas fa-chart-line"></i> Promedio de Propinas';let prom=propinas.length?propinas.reduce((s,p)=>s+(p.monto_bs||p.monto||0),0)/propinas.length:0;contenido=`<p style="font-size:2em;text-align:center;color:var(--propina)">${formatBs(prom)}</p><p style="text-align:center">promedio por propina</p>`;break;case'deliverysResumen':title.innerHTML='<i class="fas fa-motorcycle"></i> Resumen Deliverys';let totalDelDia=calcularTotalDeliverysHoy(),cantDel=pedidos.filter(p=>p.tipo==='delivery'&&p.estado==='enviado'&&new Date(p.timestamp).toDateString()===new Date().toDateString()).length,promDel=cantDel>0?totalDelDia/cantDel:0;contenido=`<p><strong>Total deliverys hoy:</strong> ${formatBs(totalDelDia)}</p><p><strong>Cantidad de entregas:</strong> ${cantDel}</p><p><strong>Promedio por entrega:</strong> ${formatBs(promDel)}</p>`;break;case'deliverysCantidad':title.innerHTML='<i class="fas fa-hashtag"></i> Entregas del D칤a';let cantEntregas=pedidos.filter(p=>p.tipo==='delivery'&&p.estado==='enviado'&&new Date(p.timestamp).toDateString()===new Date().toDateString()).length;contenido=`<p style="font-size:2em;text-align:center;color:var(--delivery)">${cantEntregas}</p><p style="text-align:center">entregas realizadas hoy</p>`;break;case'deliverysPromedio':title.innerHTML='<i class="fas fa-chart-line"></i> Promedio por Entrega';let totalDelDiaProm=calcularTotalDeliverysHoy(),cantDelProm=pedidos.filter(p=>p.tipo==='delivery'&&p.estado==='enviado'&&new Date(p.timestamp).toDateString()===new Date().toDateString()).length,promDelProm=cantDelProm>0?totalDelDiaProm/cantDelProm:0;contenido=`<p style="font-size:2em;text-align:center;color:var(--delivery)">${formatBs(promDelProm)}</p><p style="text-align:center">promedio por entrega</p>`;break}body.innerHTML=contenido,modal.classList.add('active')}function crearDetalleVentaCompacto(venta,pedido){if(!pedido)return'';let hora=new Date(pedido.timestamp).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}),items=(pedido.items||[]).map(i=>`<div class="detail-item-row-compact"><span>${i.cantidad||1}x ${i.nombre}</span><span>${formatBs(usdToBs((i.precioUnitarioUSD||0)*(i.cantidad||1)))}</span></div>`).join(''),metodos='';if(pedido.pagos_mixtos?.length)metodos='<div style="margin-top:3px">'+pedido.pagos_mixtos.map(p=>{let nom=p.metodo==='efectivo_bs'?'Bs':p.metodo==='efectivo_usd'?'$':p.metodo==='pago_movil'?'游님':'游눱';return`<span class="detail-metodo-tag">${nom} ${formatBs(p.monto)}</span>`}).join('')+'</div>';return`<div class="detail-item-compact"><div class="detail-header-compact"><span>${hora}</span><span class="detail-metodo-tag">${venta.tipo}</span></div><div class="detail-items-compact">${items}</div><div class="detail-total-compact">Total: ${formatBs(venta.subtotal_platillos||venta.total*tasaEfectiva)}</div>${metodos}</div>`}function crearDetallePedidoCompacto(pedido){let hora=new Date(pedido.timestamp).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}),items=(pedido.items||[]).map(i=>`<div class="detail-item-row-compact"><span>${i.cantidad||1}x ${i.nombre}</span><span>${formatBs(usdToBs((i.precioUnitarioUSD||0)*(i.cantidad||1)))}</span></div>`).join('');return`<div class="detail-item-compact"><div class="detail-header-compact"><span>${hora}</span><span class="detail-metodo-tag">${pedido.tipo}</span></div><div class="detail-items-compact">${items}</div><div class="detail-total-compact">Total: ${formatBs(usdToBs(pedido.total||0))}</div></div>`}function setupRealtimeSubscriptions(){suscripciones.forEach(s=>s.unsubscribe()),suscripciones=[],suscripciones.push(window.supabaseClient.channel('cajero-pedidos-'+Date.now()).on('postgres_changes',{event:'*',schema:'public',table:'pedidos'},async()=>{await verificarCambiosPedidos()}).subscribe()),suscripciones.push(window.supabaseClient.channel('cajero-ventas-'+Date.now()).on('postgres_changes',{event:'*',schema:'public',table:'ventas'},async()=>{await cargarVentasHoy(),actualizarEstadisticas()}).subscribe()),suscripciones.push(window.supabaseClient.channel('cajero-propinas-'+Date.now()).on('postgres_changes',{event:'*',schema:'public',table:'propinas'},async()=>{await cargarPropinas(),actualizarEstadisticas(),renderizarPropinas()}).subscribe()),suscripciones.push(window.supabaseClient.channel('cajero-mesoneros-'+Date.now()).on('postgres_changes',{event:'*',schema:'public',table:'mesoneros'},async()=>{await cargarMesoneros()}).subscribe()),suscripciones.push(window.supabaseClient.channel('cajero-deliverys-'+Date.now()).on('postgres_changes',{event:'*',schema:'public',table:'deliverys'},async()=>{await cargarDeliverys()}).subscribe()),suscripciones.push(window.supabaseClient.channel('cajero-menu-'+Date.now()).on('postgres_changes',{event:'*',schema:'public',table:'menu'},async()=>{await cargarMenu()}).subscribe()),suscripciones.push(window.supabaseClient.channel('cajero-inventario-'+Date.now()).on('postgres_changes',{event:'*',schema:'public',table:'inventario'},async()=>{stockCache.invalidate(),await cargarInventario()}).subscribe()),suscripciones.push(window.supabaseClient.channel('cajero-config-'+Date.now()).on('postgres_changes',{event:'UPDATE',schema:'public',table:'config',filter:'id=eq.1'},p=>{configGlobal={...configGlobal,...p.new},tasaEfectiva=configGlobal.tasa_efectiva||400,renderizarPedidos(),renderizarMenu(),actualizarEstadisticas()}).subscribe())}function setupEventListeners(){document.addEventListener('keydown',e=>{if(e.key==='Escape'){['cobroModal','propinaModal','confirmModal','rechazoModal','detalleModal','mesaModal','comprobanteModal','deliveryModal'].forEach(id=>{let m=document.getElementById(id);m.classList.contains('active')&&(id==='cobroModal'?cerrarCobroModal():id==='propinaModal'?cerrarPropinaModal():cerrarModal(id))})}if(e.key==='Enter'){if(document.getElementById('confirmModal').classList.contains('active')){let confirmBtn=document.getElementById('confirmActionBtn');confirmBtn.disabled||(e.preventDefault(),ejecutarConfirmacion())}if(document.getElementById('cobroModal').classList.contains('active')&&!document.getElementById('confirmCobroBtn').disabled&&(e.preventDefault(),confirmarCobro()),document.getElementById('propinaModal').classList.contains('active')&&!document.getElementById('confirmPropinaBtn').disabled&&(e.preventDefault(),confirmarPropina()),document.getElementById('rechazoModal').classList.contains('active')&&e.key==='Enter'&&(e.preventDefault(),confirmarRechazo())}});let navTabs=document.getElementById('navTabs'),startX,scrollLeft,isDown=!1;navTabs.addEventListener('mousedown',e=>{isDown=!0,navTabs.classList.add('active'),startX=e.pageX-navTabs.offsetLeft,scrollLeft=navTabs.scrollLeft}),navTabs.addEventListener('mouseleave',()=>{isDown=!1,navTabs.classList.remove('active')}),navTabs.addEventListener('mouseup',()=>{isDown=!1,navTabs.classList.remove('active')}),navTabs.addEventListener('mousemove',e=>{if(!isDown)return;e.preventDefault();let x=e.pageX-navTabs.offsetLeft,walk=(x-startX)*2;navTabs.scrollLeft=scrollLeft-walk}),navTabs.addEventListener('touchstart',e=>{isDown=!0,startX=e.touches[0].pageX-navTabs.offsetLeft,scrollLeft=navTabs.scrollLeft}),navTabs.addEventListener('touchend',()=>{isDown=!1}),navTabs.addEventListener('touchmove',e=>{if(!isDown)return;e.preventDefault();let x=e.touches[0].pageX-navTabs.offsetLeft,walk=(x-startX)*2;navTabs.scrollLeft=scrollLeft-walk})}function formatBs(m){return new Intl.NumberFormat('es-VE',{style:'currency',currency:'VES',minimumFractionDigits:2}).format(m).replace('VES','Bs.')}function formatUSD(m){return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2}).format(m)}function usdToBs(u){return u*(tasaEfectiva||400)}function crearDetallePedidoHTML(pedido){let metodos='';pedido.pagos_mixtos&&(metodos='<div class="payment-methods">'+pedido.pagos_mixtos.map(p=>`<span class="payment-tag"><i class="fas fa-${p.metodo==='pago_movil'?'mobile-alt':p.metodo==='punto_venta'?'credit-card':'money-bill-wave'}"></i> ${p.metodo==='efectivo_bs'?'Bs':p.metodo==='efectivo_usd'?'$':p.metodo==='pago_movil'?'游님':'游눱'} ${formatBs(p.monto)}</span>`).join('')+'</div>');return`<div class="detail-item"><div class="detail-row"><span class="detail-label">Cliente:</span><span class="detail-value">${pedido.cliente_nombre||'N/A'}</span></div><div class="detail-row"><span class="detail-label">Tipo:</span><span class="detail-value">${pedido.tipo}</span></div>${pedido.tipo==='mesa'?`<div class="detail-row"><span class="detail-label">Mesa:</span><span class="detail-value">${pedido.mesa}</span></div>`:''}${pedido.tipo==='delivery'?`<div class="detail-row"><span class="detail-label">Direcci칩n:</span><span class="detail-value">${pedido.direccion}</span></div><div class="detail-row"><span class="detail-label">Tel칠fono:</span><span class="detail-value">${pedido.telefono}</span></div>`:''}${pedido.referencia?`<div class="detail-row"><span class="detail-label">Ref:</span><span class="detail-value">${pedido.referencia}</span></div>`:''}<div class="detail-row"><span class="detail-label">Items:</span></div>${(pedido.items||[]).map(i=>`<div class="detail-row"><span>${i.cantidad||1}x ${i.nombre}</span><span>${formatBs(usdToBs(i.precioUnitarioUSD*(i.cantidad||1)))}</span></div>`).join('')}${metodos?`<div class="detail-row"><span class="detail-label">Pagos:</span></div>${metodos}`:''}<div class="detail-row" style="font-weight:700"><span>TOTAL</span><span>${formatBs(usdToBs(pedido.total||0))}</span></div></div>`}
    </script>
</body>
</html>