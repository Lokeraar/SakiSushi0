<!DOCTYPE html>
<html lang="es">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes"><title> Panel del Cajero - Saki Sushi</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><script>
window.mostrarToast=function(m,t='success'){try{const a=document.getElementById('toast'),b=document.getElementById('toastText');if(a&&b){b.textContent=m;a.className='toast show';if(t==='error'){a.querySelector('i').style.color='var(--danger)';a.style.borderLeftColor='var(--danger)';}else{a.querySelector('i').style.color='var(--success)';a.style.borderLeftColor='var(--success)';}setTimeout(()=>a.classList.remove('show'),3000);}else alert(m);}catch(e){alert(m);}};
window.formatBs=function(m){try{return new Intl.NumberFormat('es-VE',{style:'currency',currency:'VES',minimumFractionDigits:2}).format(m).replace('VES','Bs');}catch(e){return'Bs '+ (m||0).toFixed(2);}};
window.formatUSD=function(m){try{return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2}).format(m);}catch(e){return'$ '+ (m||0).toFixed(2);}};
window.usdToBs=function(u){return u*(window.tasaEfectiva||400);};
window.cerrarModal=function(m){const a=document.getElementById(m);if(a)a.classList.remove('active');if(m==='confirmModal'){window.pedidoParaAccion=null;window.accionPendiente=null;}};
window.mostrarLogin=function(){document.getElementById('username').value='';document.getElementById('password').value='';document.getElementById('loginContainer').classList.remove('hidden');document.getElementById('panelContainer').classList.add('hidden');window.detenerAlarma();};
window.detenerAlarma=function(){if(window.alarmaAudio&&window.alarmaActiva){try{window.alarmaAudio.pause();window.alarmaAudio.currentTime=0;}catch(e){}window.alarmaActiva=false;}};
window.verificarYControlarAlarma=function(){if(!window.alarmaAudio)window.alarmaAudio=document.getElementById('alarmaSonido');if(!window.alarmaAudio)return;const a=(window.pedidos||[]).filter(b=>b.estado==='pendiente').length;if(a>0&&!window.enProcesoDeCobro){if(!window.alarmaActiva){window.alarmaAudio.play().then(()=>{window.alarmaActiva=true;}).catch(()=>{});}}else if(window.alarmaActiva&&(a===0||window.enProcesoDeCobro)){window.alarmaAudio.pause();window.alarmaAudio.currentTime=0;window.alarmaActiva=false;}};
window.hacerLogin=async function(){const a=document.getElementById('username')?.value,b=document.getElementById('password')?.value;if(!a||!b){window.mostrarToast('Ingresa usuario y contraseña','error');return;}try{if(!window.supabaseClient){window.mostrarToast('Error: Cliente Supabase no inicializado','error');return;}const c=await window.supabaseClient.from('usuarios').select('*').eq('username',a).eq('password',b).eq('activo',true).maybeSingle();if(c.error)throw c.error;if(!c.data){window.mostrarToast('Credenciales inválidas','error');return;}window.currentUser=c.data;sessionStorage.setItem('cajero_user',JSON.stringify(c.data));window.mostrarToast('✅ Bienvenido '+c.data.nombre,'success');setTimeout(async()=>{try{await window.cargarDatosIniciales();window.mostrarPanel();}catch(e){console.error('Error cargando datos:',e);window.mostrarToast('Error cargando datos: '+e.message,'error');window.mostrarPanel();}},500);}catch(d){console.error('Error en login:',d);window.mostrarToast('Error al conectar: '+(d.message||'Error desconocido'),'error');}};
</script><style>
:root{--primary:#D32F2F;--secondary:#212121;--accent:#FF9800;--light:#F5F5F5;--dark:#121212;--warm:#FFC107;--success:#388E3C;--info:#1976D2;--warning:#F57C00;--danger:#ef4444;--propina:#9C27B0;--delivery:#00ACC1;--condonar:#FF6B6B;--favordecaja:#4ECDC4;--shadow:rgba(0,0,0,.15);--transition:all .3s ease}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto','Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
body{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);min-height:100vh;padding:20px;color:#fff}
.login-container{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,var(--primary),var(--secondary));position:fixed;top:0;left:0;right:0;bottom:0;z-index:10000}
.login-container.hidden{display:none}
.login-box{background:rgba(255,255,255,.95);padding:2.5rem;border-radius:15px;box-shadow:0 20px 60px rgba(0,0,0,.3);width:100%;max-width:400px;text-align:center}
.login-box h2{color:var(--primary);margin-bottom:1.5rem;font-family:'Montserrat',sans-serif;font-weight:700;font-size:2rem}
.login-form input{width:100%;padding:1rem;margin-bottom:1rem;border:2px solid #e0e0e0;border-radius:10px;font-size:1rem;transition:var(--transition)}
.login-form input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(211,47,47,.2)}
.login-form button{width:100%;padding:1rem;background:linear-gradient(135deg,var(--primary),#b71c1c);color:white;border:none;border-radius:10px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:var(--transition);font-family:'Montserrat',sans-serif}
.login-form button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(211,47,47,.4)}
.container{max-width:1400px;margin:0 auto;background:rgba(255,255,255,.05);border-radius:15px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1)}
.container.hidden{display:none}
.header{background:linear-gradient(135deg,var(--primary),#B71C1C);color:white;padding:25px 30px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:20px}
.header-left h1{font-size:2.5em;font-family:'Montserrat',sans-serif;font-weight:800;margin-bottom:5px}
.header-left p{opacity:.9;font-size:1.1em}
.header-right{display:flex;align-items:center;gap:20px}
.nav-tabs{background:rgba(0,0,0,.3);display:flex;padding:0 30px;gap:10px;overflow-x:auto}
.nav-tab{background:transparent;color:#fff;border:none;padding:20px 30px;font-size:1em;cursor:pointer;transition:var(--transition);font-family:'Montserrat',sans-serif;font-weight:500;border-bottom:3px solid transparent;white-space:nowrap}
.nav-tab:hover{background:rgba(255,255,255,.1)}
.nav-tab.active{border-bottom-color:var(--accent);color:var(--accent)}
.content{padding:30px}
.section{display:none}
.section.active{display:block}
.section-title{font-size:2em;color:#fff;margin-bottom:25px;display:flex;align-items:center;gap:15px;font-family:'Montserrat',sans-serif;font-weight:700}
.section-title .badge{background:var(--primary);color:white;padding:5px 15px;border-radius:20px;font-size:1rem}
.stats-grid-modern{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:30px}
@media (max-width:768px){.stats-grid-modern{grid-template-columns:repeat(2,1fr);gap:12px}}
@media (min-width:769px) and (max-width:1024px){.stats-grid-modern{grid-template-columns:repeat(3,1fr);gap:15px}}
@media (min-width:1400px){.stats-grid-modern{grid-template-columns:repeat(6,1fr)}}
.stat-button{position:relative;background:rgba(255,255,255,.1);padding:25px 15px;border-radius:12px;box-shadow:0 5px 20px var(--shadow);text-align:center;transition:var(--transition);border:2px solid transparent;cursor:pointer;backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);overflow:hidden;z-index:1;display:flex;flex-direction:column;align-items:center;gap:10px;width:100%;font-family:inherit;color:#fff}
.stat-button::after{content:"";width:1px;height:1px;background:none;position:absolute;z-index:-1;top:50%;left:50%;transition:.3s ease-in-out all;border-radius:100px;transform-origin:center;transform:translate(-50%,-50%)}
.stat-button:hover::after{transform:scale(400);background:var(--primary)}
.stat-button:hover{border-color:var(--accent);transform:translateY(-5px)}
.stat-button .stat-icon{width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5em;color:white;margin:0;background:transparent;position:relative;z-index:2}
.stat-button .stat-icon.pendientes{background:var(--warning)}
.stat-button .stat-icon.cobrados{background:var(--success)}
.stat-button .stat-icon.ventas{background:var(--info)}
.stat-button .stat-icon.platillos{background:var(--primary)}
.stat-button .stat-icon.propinas{background:var(--propina)}
.stat-button .stat-icon.delivery-total{background:var(--delivery)}
.stat-button .stat-value{font-size:2.2em;font-weight:800;color:#fff;font-family:'Montserrat',sans-serif;line-height:1.2;position:relative;z-index:2}
.stat-button .stat-label{color:rgba(255,255,255,.8);font-size:.9rem;font-weight:500;text-transform:uppercase;letter-spacing:0.5px;position:relative;z-index:2}
.pedidos-columns{display:grid;gap:20px;margin:20px 0 30px 0}
@media (max-width:768px){.pedidos-columns{grid-template-columns:1fr}}
@media (min-width:769px) and (max-width:1199px){.pedidos-columns{grid-template-columns:repeat(2,1fr)}}
@media (min-width:1200px){.pedidos-columns{grid-template-columns:repeat(3,1fr)}}
.pedidos-column{background:rgba(255,255,255,.1);border-radius:12px;overflow:hidden;box-shadow:0 5px 20px var(--shadow);height:fit-content;max-height:600px;display:flex;flex-direction:column;backdrop-filter:blur(5px)}
.column-header{padding:10px 15px;color:white;font-weight:700;font-size:1rem;display:flex;align-items:center;justify-content:space-between;font-family:'Montserrat',sans-serif}
.column-header.mesa{background:linear-gradient(135deg,var(--info),#1565C0)}
.column-header.delivery{background:linear-gradient(135deg,var(--success),#2E7D32)}
.column-header.reserva{background:linear-gradient(135deg,#9c27b0,#7b1fa2)}
.column-header.delivery-stats{background:linear-gradient(135deg,var(--delivery),#00838F)}
.column-header .count-badge{background:rgba(255,255,255,.3);padding:3px 10px;border-radius:20px;font-size:.8rem}
.column-content{padding:10px;overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:8px;max-height:500px}
.order-card-compact{background:rgba(0,0,0,.3);border-radius:6px;padding:8px;border-left:4px solid;font-size:.75rem;line-height:1.2;transition:var(--transition);color:#fff}
.order-card-compact:hover{transform:translateX(-2px);box-shadow:0 3px 8px rgba(0,0,0,.2)}
.order-card-compact.pendiente{border-left-color:var(--warning)}
.order-card-compact.en_cocina{border-left-color:var(--info)}
.order-card-compact.en_camino{border-left-color:var(--success)}
.order-card-compact.reserva_pendiente{border-left-color:#9c27b0}
.order-card-compact.reserva_atendida{border-left-color:#ff5722}
.order-header-compact{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px;font-size:.7rem}
.order-time-compact{color:rgba(255,255,255,.7);background:rgba(255,255,255,.1);padding:2px 6px;border-radius:10px;display:inline-flex;align-items:center;gap:3px}
.order-info-compact{margin-bottom:4px;padding:3px;background:rgba(0,0,0,.2);border-radius:4px;font-size:.7rem}
.order-info-compact i{width:12px;color:var(--accent);margin-right:2px}
.order-items-compact{margin-bottom:4px;padding:3px;background:rgba(0,0,0,.2);border-radius:4px}
.order-item-row-compact{display:flex;justify-content:space-between;padding:2px 0;font-size:.7rem;border-bottom:1px dashed rgba(255,255,255,.1)}
.order-item-row-compact:last-child{border-bottom:none}
.item-name-compact{font-weight:500}
.item-price-compact{font-weight:600;color:var(--accent)}
.order-total-compact{font-weight:700;color:var(--accent);text-align:right;margin:4px 0;padding-top:3px;border-top:1px dashed rgba(255,255,255,.1);font-size:.75rem}
.comprobante-thumbnail{margin:4px 0;cursor:pointer;border:1px solid rgba(255,255,255,.2);border-radius:3px;overflow:hidden;max-width:60px}
.comprobante-thumbnail img{width:100%;height:auto;display:block}
.order-actions-compact{display:flex;gap:4px;margin-top:5px}
.btn-compact{flex:1;padding:4px;border:none;border-radius:3px;font-size:.65rem;font-weight:600;cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;justify-content:center;gap:2px}
.btn-cobrar-compact{background:linear-gradient(135deg,var(--success),#2E7D32);color:white}
.btn-rechazar-compact{background:linear-gradient(135deg,var(--danger),#B71C1C);color:white}
.btn-entregar-compact{background:linear-gradient(135deg,var(--info),#1565C0);color:white}
.btn-enviar-compact{background:linear-gradient(135deg,var(--success),#2E7D32);color:white}
.btn-confirmar-compact{background:linear-gradient(135deg,#9c27b0,#7b1fa2);color:white}
.btn-propina-compact{background:linear-gradient(135deg,var(--propina),#7B1FA2);color:white}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);z-index:3000;display:none;justify-content:center;align-items:center;padding:20px;backdrop-filter:blur(10px)}
.modal-overlay.active{display:flex}
.modal-content{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);border-radius:20px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto;animation:slideUp .3s ease;border:1px solid rgba(255,255,255,.1)}
@keyframes slideUp{from{transform:translateY(50px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-header{background:linear-gradient(135deg,var(--primary),#B71C1C);color:white;padding:20px 25px;display:flex;justify-content:space-between;align-items:center}
.modal-header.propina{background:linear-gradient(135deg,var(--propina),#7B1FA2)}
.modal-header.delivery{background:linear-gradient(135deg,var(--delivery),#00838F)}
.modal-header.condonar{background:linear-gradient(135deg,var(--condonar),#c92a2a)}
.modal-header.favor{background:linear-gradient(135deg,var(--favordecaja),#1e7e7e)}
.modal-header h2{font-family:'Montserrat',sans-serif;font-size:1.3rem;display:flex;align-items:center;gap:10px}
.modal-close{background:rgba(255,255,255,.2);border:none;color:white;font-size:1.3rem;cursor:pointer;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
.modal-close:hover{background:rgba(255,255,255,.3);transform:scale(1.1)}
.modal-body{padding:25px;color:#fff}
.modal-footer{padding:20px 25px;border-top:2px solid rgba(255,255,255,.1);display:flex;gap:15px}
.payment-mix-container{margin-bottom:20px}
.pago-item{background:rgba(0,0,0,.3);border-radius:8px;padding:15px;margin-bottom:15px;border:1px solid rgba(255,255,255,.1);position:relative}
.pago-item select,.pago-item input{width:100%;padding:8px;margin-bottom:8px;border:1px solid rgba(255,255,255,.2);border-radius:4px;font-size:.9rem;background:rgba(0,0,0,.5);color:#fff}
.pago-item select:focus,.pago-item input:focus{outline:none;border-color:var(--accent)}
.pago-item select option{background:#1a1a2e}
.remove-pago{position:absolute;top:8px;right:8px;background:var(--danger);color:white;border:none;width:24px;height:24px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.8rem;transition:var(--transition)}
.remove-pago:hover{transform:scale(1.1)}
.pagos-total{background:rgba(0,0,0,.3);padding:15px;border-radius:8px;margin:15px 0}
.pagos-resumen{display:flex;justify-content:space-between;padding:5px 0;font-size:.95rem}
.pagos-resumen-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
.pagos-resumen-row .input-group{display:flex;flex-direction:column}
.pagos-resumen-row .input-group label{font-size:.8rem;color:var(--gray-400);margin-bottom:3px}
.pagos-resumen-row .input-group input{padding:6px;border:1px solid rgba(255,255,255,.2);border-radius:4px;background:rgba(0,0,0,.5);color:#fff}
.pagos-checkbox{display:flex;align-items:center;gap:8px;margin:10px 0;padding:10px;background:rgba(0,0,0,.2);border-radius:6px}
.pagos-checkbox input[type="checkbox"]{width:18px;height:18px}
.pagos-checkbox label{font-size:.9rem;color:#fff}
.pagos-checkbox .badge{background:var(--condonar);color:white;padding:2px 8px;border-radius:12px;font-size:.7rem;margin-left:10px}
.pagos-checkbox .badge.favor{background:var(--favordecaja)}
.detail-item-compact{background:rgba(0,0,0,.3);border-radius:6px;padding:10px;margin-bottom:10px;border-left:3px solid var(--info);font-size:.8rem;line-height:1.2}
.detail-header-compact{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;color:rgba(255,255,255,.7);font-weight:500}
.detail-time-compact{background:rgba(255,255,255,.1);padding:2px 6px;border-radius:10px;font-size:.7rem}
.detail-items-compact{margin:5px 0;padding-left:5px}
.detail-item-row-compact{display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px dotted rgba(255,255,255,.1)}
.detail-item-row-compact:last-child{border-bottom:none}
.detail-total-compact{font-weight:700;color:var(--accent);text-align:right;margin-top:5px;padding-top:3px;border-top:1px dashed rgba(255,255,255,.1);font-size:.85rem}
.detail-metodo-tag{background:rgba(56,142,60,.2);color:var(--success);padding:2px 6px;border-radius:12px;font-size:.7rem;font-weight:600;display:inline-flex;align-items:center;gap:3px;margin-right:4px}
.propina-tag{background:rgba(156,39,176,.2);color:var(--propina);padding:2px 8px;border-radius:12px;font-size:.7rem;font-weight:600;display:inline-flex;align-items:center;gap:3px}
.delivery-tag{background:rgba(0,172,193,.2);color:var(--delivery);padding:2px 8px;border-radius:12px;font-size:.7rem;font-weight:600;display:inline-flex;align-items:center;gap:3px}
.condonar-tag{background:rgba(255,107,107,.2);color:var(--condonar);padding:2px 8px;border-radius:12px;font-size:.7rem;font-weight:600;display:inline-flex;align-items:center;gap:3px}
.favor-tag{background:rgba(78,205,196,.2);color:var(--favordecaja);padding:2px 8px;border-radius:12px;font-size:.7rem;font-weight:600;display:inline-flex;align-items:center;gap:3px}
.ranking-bar{display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid rgba(255,255,255,.1)}
.ranking-position{width:26px;height:26px;background:var(--accent);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem}
.ranking-info{flex:1}
.ranking-name{font-weight:600;font-size:.9rem}
.ranking-cantidad{color:rgba(255,255,255,.6);font-size:.8rem}
.ranking-bar-container{width:80px;height:6px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden}
.ranking-bar-fill{height:100%;background:var(--primary);border-radius:4px}
.mesa-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;margin-top:15px}
.mesa-btn{background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);border-radius:8px;padding:12px 5px;cursor:pointer;font-size:.9rem;font-weight:600;color:#fff;transition:var(--transition);display:flex;flex-direction:column;align-items:center;gap:5px}
.mesa-btn:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
.mesa-btn i{font-size:1.5rem;color:var(--accent)}
.menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px}
.menu-card{background:rgba(255,255,255,.1);border-radius:10px;overflow:hidden;box-shadow:0 5px 20px var(--shadow);backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1)}
.menu-card-image{height:140px;background-size:cover;background-position:center;background-color:rgba(0,0,0,.5)}
.menu-card-content{padding:15px}
.menu-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.menu-card-title{font-weight:700;font-size:1rem;color:#fff}
.menu-card-price{font-weight:700;color:var(--accent)}
.menu-card-stock{font-size:.8rem;padding:.25rem .5rem;border-radius:4px;background:rgba(0,0,0,.3);display:inline-block;margin-top:5px}
.menu-card-stock.available{color:var(--success)}
.menu-card-stock.low{color:var(--warning)}
.menu-card-stock.sold-out{color:var(--danger)}
.empty-state{text-align:center;padding:30px 15px;color:rgba(255,255,255,.5);font-size:.9rem}
.empty-state i{font-size:2.5em;margin-bottom:10px}
.toast{position:fixed;top:80px;right:20px;background:linear-gradient(135deg,#1a1a2e,#16213e);padding:15px 20px;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,.3);display:none;align-items:center;gap:12px;z-index:5000;animation:slideIn .3s ease;border-left:4px solid var(--success);border:1px solid rgba(255,255,255,.1);color:#fff}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0%);opacity:1}}
.toast.show{display:flex}
.loading-spinner{display:inline-block;width:30px;height:30px;border:3px solid rgba(211,47,47,.2);border-radius:50%;border-top-color:var(--primary);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-container{text-align:center;padding:2rem}
.keyboard-hint{background:rgba(0,0,0,.3);padding:10px 15px;border-radius:8px;font-size:.8rem;color:rgba(255,255,255,.7);margin-top:15px;display:flex;justify-content:center;gap:20px}
.keyboard-hint kbd{background:rgba(255,255,255,.1);padding:3px 6px;border-radius:4px;border:1px solid rgba(255,255,255,.2);font-family:monospace;color:#fff}
.text-center{text-align:center}
.mt-2{margin-top:.5rem}
.mb-2{margin-bottom:.5rem}
.mesonero-selector{margin-bottom:20px}
.mesonero-selector label{display:block;margin-bottom:8px;font-weight:600;color:#fff}
.mesonero-selector select{width:100%;padding:10px;border:2px solid rgba(255,255,255,.2);border-radius:8px;font-size:1rem;background:rgba(0,0,0,.5);color:#fff}
.mesonero-selector select option{background:#1a1a2e}
.delivery-selector{margin-bottom:20px}
.delivery-selector label{display:block;margin-bottom:8px;font-weight:600;color:#fff}
.delivery-selector select{width:100%;padding:10px;border:2px solid rgba(255,255,255,.2);border-radius:8px;font-size:1rem;background:rgba(0,0,0,.5);color:#fff}
.delivery-selector select option{background:#1a1a2e}
.propina-monto-group{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px}
.propina-monto-group input{width:100%;padding:10px;border:2px solid rgba(255,255,255,.2);border-radius:8px;font-size:1rem;background:rgba(0,0,0,.5);color:#fff}
.propina-monto-group input:focus{outline:none;border-color:var(--accent)}
.referencia-input{display:flex;gap:8px;justify-content:center;margin-bottom:20px}
.referencia-input input{width:45px;height:45px;text-align:center;font-size:1.3rem;border:2px solid rgba(255,255,255,.2);border-radius:8px;background:rgba(0,0,0,.5);color:#fff}
.referencia-input input:focus{border-color:var(--accent);outline:none}
.btn-primary{background:linear-gradient(135deg,var(--primary),#b71c1c);color:white;border:none;padding:.75rem 1.5rem;border-radius:8px;font-weight:600;cursor:pointer;transition:var(--transition)}
.btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 5px 15px rgba(211,47,47,.4)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed}
.btn-secondary{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);padding:.75rem 1.5rem;border-radius:8px;font-weight:600;cursor:pointer;transition:var(--transition)}
.btn-secondary:hover{background:rgba(255,255,255,.2)}
.btn-condonar{background:linear-gradient(135deg,var(--condonar),#c92a2a);color:white;border:none;padding:.75rem 1.5rem;border-radius:8px;font-weight:600;cursor:pointer;transition:var(--transition)}
.btn-condonar:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 5px 15px rgba(255,107,107,.4)}
.btn-favor{background:linear-gradient(135deg,var(--favordecaja),#1e7e7e);color:white;border:none;padding:.75rem 1.5rem;border-radius:8px;font-weight:600;cursor:pointer;transition:var(--transition)}
.btn-favor:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 5px 15px rgba(78,205,196,.4)}
.motorizados-list{display:flex;flex-direction:column;gap:10px;margin-top:15px}
.motorizado-item{display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,.3);padding:12px;border-radius:8px;border-left:4px solid var(--delivery)}
.motorizado-nombre{font-weight:600;color:#fff}
.motorizado-monto{font-weight:700;color:var(--accent)}
.categorias-wrapper{position:relative;width:100%;overflow-x:auto;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;scrollbar-width:none;-ms-overflow-style:none}
.categorias-wrapper::-webkit-scrollbar{display:none}
.category-list{display:flex;gap:10px;padding:10px 0;list-style:none;margin:0;white-space:nowrap}
.category-item{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;background:rgba(255,255,255,.1);border-radius:30px;cursor:pointer;transition:var(--transition);border:1px solid rgba(255,255,255,.1);color:#fff;font-weight:500}
.category-item:hover{background:var(--primary);transform:translateY(-2px)}
.category-item.active{background:var(--accent);color:var(--secondary);border-color:var(--accent)}
.category-item i{font-size:1rem}
.swipe-hint{display:flex;align-items:center;justify-content:center;gap:10px;margin:10px 0;color:var(--gray-400);font-size:.8rem}
.swipe-hint i{animation:slideHint 1.5s infinite}
@keyframes slideHint{0%,100%{transform:translateX(0)}50%{transform:translateX(5px)}}
</style></head><body><audio id="alarmaSonido" loop preload="auto"><source src="https://iqwwoihiiyrtypyqzhgy.supabase.co/storage/v1/object/public/alarma/Alarm%20Clock%20Effect%20Sound%20HD%20-%20Despertador%20Efecto%20D'%20Sonido.mp3" type="audio/mpeg"></audio><div class="login-container" id="loginContainer"><div class="login-box"><h2><i class="fas fa-cash-register"></i> Cajero Saki Sushi</h2><form class="login-form" id="loginForm" onsubmit="event.preventDefault(); window.hacerLogin()"><input type="text" id="username" placeholder="Usuario"><input type="password" id="password" placeholder="Contraseña"><button type="submit">Iniciar Sesión</button></form></div></div><div class="container hidden" id="panelContainer"><div class="header"><div class="header-left"><h1><i class="fas fa-cash-register"></i> Panel del Cajero</h1><p>Saki Sushi - Gestión de pedidos y cobros</p></div><div class="header-right"><button class="btn btn-primary" onclick="window.abrirSelectorMesa()" style="padding:12px 25px"><i class="fas fa-utensils"></i> Menú Cliente</button><button class="btn btn-secondary" onclick="window.cerrarSesion()" style="padding:12px 25px"><i class="fas fa-sign-out-alt"></i> Salir</button></div></div><div class="nav-tabs"><button class="nav-tab active" onclick="window.showSection('pedidos')"><i class="fas fa-clipboard-list"></i> Pedidos</button><button class="nav-tab" onclick="window.showSection('menu')"><i class="fas fa-utensils"></i> Ver Menú</button><button class="nav-tab" onclick="window.showSection('propinas')"><i class="fas fa-hand-holding-heart"></i> Propinas</button><button class="nav-tab" onclick="window.showSection('deliverys')"><i class="fas fa-motorcycle"></i> Deliverys</button></div><div class="content"><div class="section active" id="section-pedidos"><h2 class="section-title"><i class="fas fa-clipboard-list"></i> Pedidos del Día</h2><div class="stats-grid-modern"><button class="stat-button cuatro" onclick="window.abrirModalDetalle('preparacion')"><span class="stat-icon pendientes"><i class="fas fa-fire"></i></span><span class="stat-value" id="statPreparacion">0</span><span class="stat-label">En Preparación</span></button><button class="stat-button cuatro" onclick="window.abrirModalDetalle('cobrados')"><span class="stat-icon cobrados"><i class="fas fa-check-circle"></i></span><span class="stat-value" id="statCobrados">0</span><span class="stat-label">Cobrados Hoy</span></button><button class="stat-button cuatro" onclick="window.abrirModalDetalle('ventas')"><span class="stat-icon ventas"><i class="fas fa-dollar-sign"></i></span><span class="stat-value" id="statVentas">Bs 0</span><span class="stat-label">Ventas Totales</span></button><button class="stat-button cuatro" onclick="window.abrirModalDetalle('platillos')"><span class="stat-icon platillos"><i class="fas fa-utensils"></i></span><span class="stat-value" id="statPlatillos">0</span><span class="stat-label">Platillos Vend.</span></button><button class="stat-button cuatro" onclick="window.abrirModalDetalle('propinas')"><span class="stat-icon propinas"><i class="fas fa-hand-holding-heart"></i></span><span class="stat-value" id="statPropinas">Bs 0</span><span class="stat-label">Propinas Hoy</span></button><button class="stat-button cuatro" onclick="window.abrirModalDeliverys()"><span class="stat-icon delivery-total"><i class="fas fa-motorcycle"></i></span><span class="stat-value" id="statDeliverysTotal">Bs 0</span><span class="stat-label">Deliverys</span></button></div><div style="margin:30px 0 20px 0"><h3 style="font-size:1.5rem;color:#fff;display:flex;align-items:center;gap:10px"><i class="fas fa-clock" style="color:var(--warning)"></i> Pedidos Pendientes<span class="badge" style="background:var(--warning)" id="totalPendientesBadge">0</span></h3></div><div class="pedidos-columns"><div class="pedidos-column"><div class="column-header mesa"><span><i class="fas fa-store"></i> MESA</span><span class="count-badge" id="mesaPendientesCount">0</span></div><div class="column-content" id="mesaPendientesContainer"></div></div><div class="pedidos-column"><div class="column-header delivery"><span><i class="fas fa-motorcycle"></i> DELIVERY</span><span class="count-badge" id="deliveryPendientesCount">0</span></div><div class="column-content" id="deliveryPendientesContainer"></div></div><div class="pedidos-column"><div class="column-header reserva"><span><i class="fas fa-calendar-check"></i> RESERVA</span><span class="count-badge" id="reservaPendientesCount">0</span></div><div class="column-content" id="reservaPendientesContainer"></div></div></div><div style="margin:40px 0 20px 0"><h3 style="font-size:1.5rem;color:#fff;display:flex;align-items:center;gap:10px"><i class="fas fa-fire" style="color:var(--warning)"></i> Pedidos en Preparación<span class="badge" style="background:var(--warning)" id="totalPreparacionBadge">0</span></h3></div><div class="pedidos-columns"><div class="pedidos-column"><div class="column-header mesa"><span><i class="fas fa-fire"></i> MESA EN COCINA</span><span class="count-badge" id="mesaCocinaCount">0</span></div><div class="column-content" id="mesaCocinaContainer"></div></div><div class="pedidos-column"><div class="column-header delivery"><span><i class="fas fa-truck"></i> DELIVERY EN CAMINO</span><span class="count-badge" id="deliveryCaminoCount">0</span></div><div class="column-content" id="deliveryCaminoContainer"></div></div><div class="pedidos-column"><div class="column-header reserva"><span><i class="fas fa-clock"></i> RESERVAS PENDIENTES</span><span class="count-badge" id="reservaProcesoCount">0</span></div><div class="column-content" id="reservaProcesoContainer"></div></div></div></div><div class="section" id="section-menu"><h2 class="section-title"><i class="fas fa-utensils"></i> Menú Actual</h2><div class="categorias-wrapper" id="categoriasWrapper"><ul class="category-list" id="categoryList"></ul></div><div class="swipe-hint"><i class="fas fa-chevron-left"></i> Desliza para ver más categorías <i class="fas fa-chevron-right"></i></div><div class="menu-grid" id="menuGrid"><div class="loading-container"><div class="loading-spinner"></div><p>Cargando menú...</p></div></div></div><div class="section" id="section-propinas"><h2 class="section-title"><i class="fas fa-hand-holding-heart"></i> Propinas del Día</h2><div class="stats-grid-modern" style="margin-bottom:30px"><button class="stat-button cuatro" onclick="window.abrirModalDetalle('propinasDetalle')"><span class="stat-icon propinas"><i class="fas fa-hand-holding-heart"></i></span><span class="stat-value" id="propinasTotal">Bs 0</span><span class="stat-label">Total Propinas</span></button><button class="stat-button cuatro" onclick="window.abrirModalDetalle('propinasCantidad')"><span class="stat-icon propinas"><i class="fas fa-hashtag"></i></span><span class="stat-value" id="propinasCantidad">0</span><span class="stat-label">Cantidad</span></button><button class="stat-button cuatro" onclick="window.abrirModalDetalle('propinasPromedio')"><span class="stat-icon propinas"><i class="fas fa-chart-line"></i></span><span class="stat-value" id="propinasPromedio">Bs 0</span><span class="stat-label">Promedio</span></button></div><div id="propinasContainer" class="pedidos-columns" style="grid-template-columns:1fr"><div class="pedidos-column" style="max-height:500px"><div class="column-header propina"><span><i class="fas fa-clock"></i> Últimas Propinas</span><span class="count-badge" id="propinasListCount">0</span></div><div class="column-content" id="propinasListContainer"></div></div></div></div><div class="section" id="section-deliverys"><h2 class="section-title"><i class="fas fa-motorcycle" style="color:var(--delivery)"></i> Estadísticas de Deliverys</h2><div class="stats-grid-modern" style="margin-bottom:30px"><button class="stat-button cuatro" onclick="window.abrirModalDetalle('deliverysTotal')"><span class="stat-icon delivery-total"><i class="fas fa-motorcycle"></i></span><span class="stat-value" id="deliverysTotalStats">Bs 0</span><span class="stat-label">Total Deliverys</span></button><button class="stat-button cuatro" onclick="window.abrirModalDetalle('deliverysCantidad')"><span class="stat-icon delivery-total"><i class="fas fa-hashtag"></i></span><span class="stat-value" id="deliverysCantidadStats">0</span><span class="stat-label">Entregas Hoy</span></button><button class="stat-button cuatro" onclick="window.abrirModalDetalle('deliverysPromedio')"><span class="stat-icon delivery-total"><i class="fas fa-chart-line"></i></span><span class="stat-value" id="deliverysPromedioStats">Bs 0</span><span class="stat-label">Promedio por entrega</span></button></div><div id="deliverysContainer" class="pedidos-columns" style="grid-template-columns:1fr"><div class="pedidos-column" style="max-height:500px"><div class="column-header delivery-stats"><span><i class="fas fa-clock"></i> Últimas Entregas</span><span class="count-badge" id="deliverysListCount">0</span></div><div class="column-content" id="deliverysListContainer"></div></div></div></div></div></div><div class="modal-overlay" id="cobroModal"><div class="modal-content"><div class="modal-header"><h2><i class="fas fa-cash-register"></i> Procesar Cobro</h2><button class="modal-close" onclick="window.cerrarCobroModal()"><i class="fas fa-times"></i></button></div><div class="modal-body" id="cobroModalBody"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="window.cerrarCobroModal()">Cancelar (ESC)</button><button class="btn btn-primary" id="confirmCobroBtn" onclick="window.confirmarCobro()" disabled>Confirmar Cobro (ENTER)</button></div></div></div><div class="modal-overlay" id="propinaModal"><div class="modal-content"><div class="modal-header propina"><h2><i class="fas fa-hand-holding-heart"></i> Registrar Propina</h2><button class="modal-close" onclick="window.cerrarPropinaModal()"><i class="fas fa-times"></i></button></div><div class="modal-body" id="propinaModalBody"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="window.cerrarPropinaModal()">Cancelar (ESC)</button><button class="btn btn-primary" id="confirmPropinaBtn" style="background:linear-gradient(135deg,var(--propina),#7B1FA2)" onclick="window.confirmarPropina()" disabled>Guardar Propina</button></div></div></div><div class="modal-overlay" id="confirmModal"><div class="modal-content"><div class="modal-header" id="confirmModalHeader"><h2 id="confirmModalTitle"><i class="fas fa-check-circle"></i> Confirmar Acción</h2><button class="modal-close" onclick="window.cerrarModal('confirmModal')"><i class="fas fa-times"></i></button></div><div class="modal-body" id="confirmModalBody"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="window.cerrarModal('confirmModal')">Cancelar (ESC)</button><button class="btn btn-primary" id="confirmActionBtn" onclick="window.ejecutarConfirmacion()">Confirmar (ENTER)</button></div></div></div><div class="modal-overlay" id="rechazoModal"><div class="modal-content"><div class="modal-header" style="background:linear-gradient(135deg,var(--danger),#B71C1C)"><h2><i class="fas fa-times-circle"></i> Rechazar Pedido</h2><button class="modal-close" onclick="window.cerrarModal('rechazoModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><p style="margin-bottom:20px;color:#fff">Selecciona la razón del rechazo:</p><div style="display:flex;flex-direction:column;gap:10px"><label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;cursor:pointer"><input type="radio" name="rejectionReason" value="referencia_invalida" style="width:18px;height:18px"><span>Referencia de pago inválida o falsa</span></label><label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;cursor:pointer"><input type="radio" name="rejectionReason" value="monto_insuficiente" style="width:18px;height:18px"><span>Monto insuficiente</span></label><label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;cursor:pointer"><input type="radio" name="rejectionReason" value="datos_incorrectos" style="width:18px;height:18px"><span>Datos de contacto/dirección incorrectos</span></label><label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;cursor:pointer"><input type="radio" name="rejectionReason" value="no_disponible" style="width:18px;height:18px"><span>Producto no disponible</span></label><label style="display:flex;align-items:center;gap:10px;padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:6px;cursor:pointer"><input type="radio" name="rejectionReason" value="fuera_horario" style="width:18px;height:18px"><span>Fuera de horario de delivery</span></label></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="window.cerrarModal('rechazoModal')">Cancelar</button><button class="btn btn-primary" style="background:linear-gradient(135deg,var(--danger),#B71C1C)" onclick="window.confirmarRechazo()">Confirmar Rechazo</button></div></div></div><div class="modal-overlay" id="detalleModal"><div class="modal-content"><div class="modal-header" style="background:linear-gradient(135deg,var(--info),#1565C0)"><h2 id="detalleModalTitle"><i class="fas fa-chart-bar"></i> Detalle</h2><button class="modal-close" onclick="window.cerrarModal('detalleModal')"><i class="fas fa-times"></i></button></div><div class="modal-body" id="detalleModalBody"></div><div class="modal-footer"><button class="btn btn-primary" onclick="window.cerrarModal('detalleModal')">Cerrar (ESC)</button></div></div></div><div class="modal-overlay" id="mesaModal"><div class="modal-content"><div class="modal-header" style="background:linear-gradient(135deg,var(--info),#1565C0)"><h2><i class="fas fa-chair"></i> Seleccionar Mesa</h2><button class="modal-close" onclick="window.cerrarModal('mesaModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><p style="margin-bottom:20px;color:#fff">Elige la mesa para la cual quieres armar el pedido:</p><div id="mesaList" class="mesa-grid"><div class="loading-container"><div class="loading-spinner"></div><p>Cargando mesas...</p></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="window.cerrarModal('mesaModal')">Cancelar</button></div></div></div><div class="modal-overlay" id="comprobanteModal"><div class="modal-content" style="max-width:500px"><div class="modal-header" style="background:linear-gradient(135deg,var(--info),#1565C0)"><h2><i class="fas fa-receipt"></i> Comprobante de Pago</h2><button class="modal-close" onclick="window.cerrarModal('comprobanteModal')"><i class="fas fa-times"></i></button></div><div class="modal-body text-center" id="comprobanteModalBody"></div><div class="modal-footer"><button class="btn btn-primary" onclick="window.cerrarModal('comprobanteModal')">Cerrar (ESC)</button></div></div></div><div class="modal-overlay" id="deliveryModal"><div class="modal-content"><div class="modal-header delivery"><h2><i class="fas fa-motorcycle"></i> Acumulado Deliverys (Hoy)</h2><button class="modal-close" onclick="window.cerrarModal('deliveryModal')"><i class="fas fa-times"></i></button></div><div class="modal-body" id="deliveryModalBody"></div><div class="modal-footer"><button class="btn btn-primary" onclick="window.cerrarModal('deliveryModal')">Cerrar (ESC)</button></div></div></div><div class="toast" id="toast"><i class="fas fa-check-circle" style="color:var(--success);font-size:1.2rem"></i><div><p id="toastText" style="margin:0;color:#fff">Operación completada</p></div></div><script src="../supabase-config.js"></script><script>
window.currentUser=null;window.pedidos=[];window.ventasHoy=[];window.propinas=[];window.menuItems=[];window.inventario=[];window.mesas=[];window.currentPedido=null;window.pedidoParaAccion=null;window.accionPendiente=null;window.pagosMixtos=[];window.tasaEfectiva=400;window.currentPropinaPedido=null;window.mesoneros=[];window.deliverys=[];window.stockCache={data:{},lastUpdate:0,duration:5e3,get:function(id){const a=Date.now();if(a-this.lastUpdate>this.duration)this.clear();return this.data[id]},set:function(id,v){this.data[id]=v;this.lastUpdate=Date.now()},clear:function(){this.data={};this.lastUpdate=Date.now()},invalidate:function(){this.data={};this.lastUpdate=0}};window.currentPropinaData={mesonero:'',mesa:'Mesa 1',metodo:'efectivo_bs',montoBs:0,montoUsd:0,referencia:'',tasaAplicada:400};window.alarmaAudio=document.getElementById('alarmaSonido');window.alarmaActiva=false;window.enProcesoDeCobro=false;window.suscripciones=[];window.paginaVisible=true;window.reconectando=false;window.intervaloVerificacion=null;window.ultimaActualizacion=Date.now();
window.mostrarPanel=function(){document.getElementById('loginContainer').classList.add('hidden');document.getElementById('panelContainer').classList.remove('hidden');window.setupEventListeners();window.setupRealtimeSubscriptions();setTimeout(()=>window.verificarYControlarAlarma(),100);};
window.cerrarSesion=function(){sessionStorage.removeItem('cajero_user');window.currentUser=null;window.detenerAlarma();window.mostrarLogin();};
window.showSection=function(s){document.querySelectorAll('.section').forEach(a=>a.classList.remove('active'));document.querySelectorAll('.nav-tab').forEach(a=>a.classList.remove('active'));document.getElementById(`section-${s}`).classList.add('active');event.target.classList.add('active');if(s==='pedidos')window.renderizarPedidos();else if(s==='menu')window.renderizarMenu();else if(s==='propinas')window.renderizarPropinas();else if(s==='deliverys')window.renderizarDeliverysStats();};
window.abrirSelectorMesa=async function(){await window.cargarMesas();const a=document.getElementById('mesaModal'),b=document.getElementById('mesaList');b.innerHTML=(window.mesas||[]).length?window.mesas.map(c=>`<button class="mesa-btn" onclick="window.abrirMesa('${c.nombre}')"><i class="fas fa-chair"></i>${c.nombre}</button>`).join(''):'<p class="text-center">No hay mesas</p>';a.classList.add('active');};
window.abrirMesa=function(a){window.open(`${window.location.origin}/Cliente/index.html?mesa=${encodeURIComponent(a)}`,'_blank');window.cerrarModal('mesaModal');};
window.cerrarCobroModal=function(){document.getElementById('cobroModal').classList.remove('active');window.enProcesoDeCobro=false;window.currentPedido=null;window.pagosMixtos=[];setTimeout(()=>window.verificarYControlarAlarma(),100);};
window.cerrarPropinaModal=function(){document.getElementById('propinaModal').classList.remove('active');window.currentPropinaPedido=null;};
window.cargarDatosIniciales=async function(){try{await window.cargarConfiguracion();window.tasaEfectiva=(window.configGlobal&&window.configGlobal.tasa_efectiva)||400;await window.cargarPedidos();await window.cargarVentasHoy();await window.cargarPropinas();await window.cargarMenu();await window.cargarInventario();await window.cargarMesas();await window.cargarMesoneros();await window.cargarDeliverys();window.actualizarEstadisticas();window.renderizarPedidos();window.renderizarPropinas();window.renderizarDeliverysStats();window.iniciarVerificacionPeriodica();}catch(e){console.error('Error cargando datos:',e);}};
window.verificarUsuarios=async function(){try{const a=await window.supabaseClient.from('usuarios').select('*').limit(1);if(a.error)throw a.error;if(!a.data||a.data.length===0){await window.supabaseClient.from('usuarios').insert([{id:'user_'+Date.now()+'_1',nombre:'Cajero Principal',username:'cajero1',password:'123456',rol:'cajero',activo:true},{id:'user_'+Date.now()+'_2',nombre:'Cajero Secundario',username:'cajero2',password:'123456',rol:'cajero',activo:true}]);window.mostrarToast('Usuarios creados: cajero1 / 123456','success');}}catch(e){console.error('Error verificando usuarios:',e);}};
window.cargarPedidos=async function(){try{const a=new Date();a.setHours(0,0,0,0);const b=new Date(a);b.setDate(b.getDate()+2);const c=await window.supabaseClient.from('pedidos').select('*').gte('timestamp',a.toISOString()).lt('timestamp',b.toISOString()).order('timestamp',{ascending:false});if(c.error)throw c.error;window.pedidos=c.data||[];}catch(e){console.error('Error cargando pedidos:',e);}};
window.cargarVentasHoy=async function(){try{const a=new Date();a.setHours(0,0,0,0);const b=new Date(a);b.setDate(b.getDate()+1);const c=await window.supabaseClient.from('ventas').select('*').gte('fecha',a.toISOString()).lt('fecha',b.toISOString()).order('fecha',{ascending:false});if(c.error)throw c.error;window.ventasHoy=c.data||[];}catch(e){console.error('Error cargando ventas:',e);}};
window.cargarPropinas=async function(){try{const a=new Date();a.setHours(0,0,0,0);const b=new Date(a);b.setDate(b.getDate()+1);const c=await window.supabaseClient.from('propinas').select('*').gte('fecha',a.toISOString()).lt('fecha',b.toISOString()).order('fecha',{ascending:false});if(c.error)throw c.error;window.propinas=c.data||[];}catch(e){console.error('Error cargando propinas:',e);}};
window.cargarMenu=async function(){try{const a=await window.supabaseClient.from('menu').select('*').eq('disponible',true);if(a.error)throw a.error;window.menuItems=a.data||[];window.renderizarMenu();}catch(e){console.error('Error cargando menú:',e);}};
window.cargarInventario=async function(){try{const a=await window.supabaseClient.from('inventario').select('*');if(a.error)throw a.error;window.inventario=a.data||[];window.stockCache.invalidate();window.renderizarMenu();}catch(e){console.error('Error cargando inventario:',e);}};
window.cargarMesas=async function(){try{const a=await window.supabaseClient.from('codigos_qr').select('*').order('nombre');if(a.error)throw a.error;window.mesas=a.data||[];}catch(e){console.error('Error cargando mesas:',e);}};
window.cargarMesoneros=async function(){try{const a=await window.supabaseClient.from('mesoneros').select('*').eq('activo',true).order('nombre');if(a.error)throw a.error;window.mesoneros=a.data||[];}catch(e){console.error('Error cargando mesoneros:',e);}};
window.cargarDeliverys=async function(){try{const a=await window.supabaseClient.from('deliverys').select('*').eq('activo',true).order('nombre');if(a.error)throw a.error;window.deliverys=a.data||[];}catch(e){console.error('Error cargando deliverys:',e);}};
window.getStockDisponible=async function(i){try{const a=window.stockCache.get(i);if(a!==undefined)return a;const b=window.inventario.find(c=>c.id===i);if(!b)return 0;let c=0;(window.pedidos||[]).forEach(d=>{if(d.items&&d.estado==='pendiente'){d.items.forEach(e=>{if(!e.personalizacion||!e.personalizacion.includes(i))c+=e.cantidad||1;});}});const d=(b.stock||0)-(b.reservado||0)-c;window.stockCache.set(i,d);return d;}catch(e){console.error('Error obteniendo stock:',e);return 0;}};
window.calcularStockPlatillo=async function(p){let a=Infinity;if(p.ingredientes&&Object.keys(p.ingredientes).length>0){for(const[b,c]of Object.entries(p.ingredientes)){const d=await window.getStockDisponible(b),e=c.cantidad||1,f=Math.floor(d/e);a=Math.min(a,f);}}else a=p.stock_maximo||999;return a;};
window.actualizarEstadisticas=function(){const a=(window.pedidos||[]).filter(b=>['en_cocina','en_camino','reserva_pendiente','reserva_atendida'].includes(b.estado)).length,b=(window.ventasHoy||[]).length,c=(window.ventasHoy||[]).reduce((d,e)=>d+(e.subtotal_platillos||0),0),d=(window.ventasHoy||[]).reduce((e,f)=>e+(f.items||0),0),e=(window.propinas||[]).reduce((f,g)=>f+(g.monto_bs||g.monto||0),0),f=window.calcularTotalDeliverysHoy();document.getElementById('statPreparacion').textContent=a;document.getElementById('statCobrados').textContent=b;document.getElementById('statVentas').textContent=window.formatBs(c);document.getElementById('statPlatillos').textContent=d;document.getElementById('statPropinas').textContent=window.formatBs(e);document.getElementById('statDeliverysTotal').textContent=window.formatBs(f);};
window.renderizarPedidos=function(){const a=window.pedidos.filter(b=>b.tipo==='mesa'&&b.estado==='pendiente'),b=window.pedidos.filter(c=>c.tipo==='delivery'&&c.estado==='pendiente'),c=window.pedidos.filter(d=>d.tipo==='reserva'&&d.estado==='pendiente'),d=window.pedidos.filter(e=>e.tipo==='mesa'&&e.estado==='en_cocina'),e=window.pedidos.filter(f=>f.tipo==='delivery'&&f.estado==='en_camino'),f=window.pedidos.filter(g=>g.tipo==='reserva'&&g.estado==='reserva_pendiente'),g=window.pedidos.filter(h=>h.tipo==='reserva'&&h.estado==='reserva_atendida');document.getElementById('mesaPendientesCount').textContent=a.length;document.getElementById('deliveryPendientesCount').textContent=b.length;document.getElementById('reservaPendientesCount').textContent=c.length;document.getElementById('totalPendientesBadge').textContent=a.length+b.length+c.length;document.getElementById('mesaCocinaCount').textContent=d.length;document.getElementById('deliveryCaminoCount').textContent=e.length;document.getElementById('reservaProcesoCount').textContent=f.length+g.length;document.getElementById('totalPreparacionBadge').textContent=d.length+e.length+f.length+g.length;document.getElementById('mesaPendientesContainer').innerHTML=a.length?a.map(h=>window.crearTarjetaPedidoCompacta(h,'pendiente')).join(''):'<div class="empty-state"><i class="fas fa-store"></i><p>No hay pedidos en mesa</p></div>';document.getElementById('deliveryPendientesContainer').innerHTML=b.length?b.map(h=>window.crearTarjetaPedidoCompacta(h,'pendiente')).join(''):'<div class="empty-state"><i class="fas fa-motorcycle"></i><p>No hay pedidos delivery</p></div>';document.getElementById('reservaPendientesContainer').innerHTML=c.length?c.map(h=>window.crearTarjetaPedidoCompacta(h,'pendiente')).join(''):'<div class="empty-state"><i class="fas fa-calendar-check"></i><p>No hay reservas</p></div>';document.getElementById('mesaCocinaContainer').innerHTML=d.length?d.map(h=>window.crearTarjetaPedidoCompacta(h,'preparacion')).join(''):'<div class="empty-state"><i class="fas fa-fire"></i><p>No hay pedidos en cocina</p></div>';document.getElementById('deliveryCaminoContainer').innerHTML=e.length?e.map(h=>window.crearTarjetaPedidoCompacta(h,'preparacion')).join(''):'<div class="empty-state"><i class="fas fa-truck"></i><p>No hay deliveries en camino</p></div>';document.getElementById('reservaProcesoContainer').innerHTML=(f.length+g.length)?[...f,...g].map(h=>window.crearTarjetaPedidoCompacta(h,'preparacion')).join(''):'<div class="empty-state"><i class="fas fa-clock"></i><p>No hay reservas pendientes</p></div>';};
window.crearTarjetaPedidoCompacta=function(p,t){try{const a=new Date(p.timestamp).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});let b='';if(p.tipo==='mesa')b=`<div class="order-info-compact"><i class="fas fa-chair"></i> Mesa #${p.mesa||'N/A'}</div>`;else if(p.tipo==='delivery')b=`<div class="order-info-compact"><div><i class="fas fa-map-marker-alt"></i> ${(p.direccion||'').substring(0,20)}...</div><div><i class="fas fa-phone"></i> ${p.telefono||'N/A'}</div>${p.costo_delivery_bs?`<div><i class="fas fa-truck"></i> Delivery: ${window.formatBs(p.costo_delivery_bs)}</div>`:''}</div>`;else b=`<div class="order-info-compact"><div><i class="fas fa-user"></i> ${p.cliente_nombre||'Cliente'}</div><div><i class="fas fa-calendar"></i> ${p.fecha_reserva?new Date(p.fecha_reserva).toLocaleDateString():'N/A'}</div></div>`;const c=(p.items||[]).slice(0,2).map(d=>`<div class="order-item-row-compact"><span class="item-name-compact">${d.cantidad||1}x ${d.nombre}</span><span class="item-price-compact">${window.formatBs(window.usdToBs((d.precioUnitarioUSD||0)*(d.cantidad||1)))}</span></div>`).join(''),d=(p.items||[]).length,e=d>2?`<div class="order-item-row-compact" style="justify-content:center;color:var(--gray-400)">+${d-2} más</div>`:'',f=window.formatBs(window.usdToBs(p.total||0)),g=p.comprobante_url&&(p.tipo==='delivery'||p.tipo==='reserva')?`<div class="comprobante-thumbnail" onclick="window.verComprobante('${p.id}')"><img src="${p.comprobante_url}" style="max-width:100%;cursor:pointer"></div>`:'';let h='';if(t==='pendiente')h=`<button class="btn-compact btn-cobrar-compact" onclick="window.mostrarCobro('${p.id}')">Cobrar</button><button class="btn-compact btn-rechazar-compact" onclick="window.mostrarRechazo('${p.id}')">Rechazar</button>`;else if(p.tipo==='mesa'&&p.estado==='en_cocina')h=`<button class="btn-compact btn-entregar-compact" onclick="window.mostrarConfirmacion('${p.id}','entregado')"><i class="fas fa-check"></i> Entregado</button>`;else if(p.tipo==='delivery'&&p.estado==='en_camino')h=`<button class="btn-compact btn-enviar-compact" onclick="window.mostrarConfirmacionDelivery('${p.id}')"><i class="fas fa-truck"></i> Enviar</button>`;else if(p.tipo==='reserva'&&p.estado==='reserva_pendiente')h=`<button class="btn-compact btn-confirmar-compact" onclick="window.mostrarConfirmacion('${p.id}','reserva_atendida')"><i class="fas fa-user-check"></i> Confirmar</button>`;else if(p.tipo==='reserva'&&p.estado==='reserva_atendida')h=`<button class="btn-compact btn-entregar-compact" onclick="window.mostrarConfirmacion('${p.id}','reserva_completada')"><i class="fas fa-check"></i> Entregado</button>`;return`<div class="order-card-compact ${p.estado}"><div class="order-header-compact"><span class="order-time-compact"><i class="far fa-clock"></i> ${a}</span><span style="font-weight:600;color:var(--${p.tipo==='mesa'?'info':p.tipo==='delivery'?'success':'accent'});font-size:.7rem;text-transform:uppercase">${p.tipo}</span></div>${b}<div class="order-items-compact">${c}${e}</div><div class="order-total-compact">${f}</div>${g}<div class="order-actions-compact">${h}</div></div>`;}catch(e){console.error('Error creando tarjeta:',e);return'';}};
window.calcularTotalDeliverysHoy=function(){try{const a=new Date();a.setHours(0,0,0,0);const b=new Date(a);b.setDate(b.getDate()+1);return(window.pedidos||[]).filter(c=>c.tipo==='delivery'&&c.estado==='enviado'&&new Date(c.timestamp)>=a&&new Date(c.timestamp)<b).reduce((d,e)=>d+(e.costo_delivery_bs||0),0);}catch(e){return 0;}};
window.obtenerAcumuladoDeliverysHoy=async function(){try{const a=new Date();a.setHours(0,0,0,0);const b=new Date(a);b.setDate(b.getDate()+1);const c=await window.supabaseClient.from('entregas_delivery').select('delivery_id, monto_bs').gte('fecha_entrega',a.toISOString()).lt('fecha_entrega',b.toISOString());if(c.error)throw c.error;const d={};(c.data||[]).forEach(e=>{d[e.delivery_id]=(d[e.delivery_id]||0)+e.monto_bs;});return d;}catch(e){console.error('Error obteniendo acumulado deliverys:',e);return{};}};
window.abrirModalDeliverys=async function(){try{const a=await window.obtenerAcumuladoDeliverysHoy(),b=document.getElementById('deliveryModal'),c=document.getElementById('deliveryModalBody');let d='<h3 style="margin-bottom:20px">Acumulado por motorizado (Hoy)</h3>';if(!window.deliverys||window.deliverys.length===0)d+='<div class="empty-state"><i class="fas fa-motorcycle"></i><p>No hay motorizados registrados</p></div>';else{d+='<div class="motorizados-list">';window.deliverys.forEach(e=>{const f=a[e.id]||0;d+=`<div class="motorizado-item"><span class="motorizado-nombre">${e.nombre}</span><span class="motorizado-monto">${window.formatBs(f)}</span></div>`;});d+='</div>';}c.innerHTML=d;b.classList.add('active');}catch(e){console.error('Error abriendo modal deliverys:',e);window.mostrarToast('Error al cargar datos de deliverys','error');}};
window.mostrarCobro=function(pid){window.currentPedido=(window.pedidos||[]).find(a=>a.id===pid);if(!window.currentPedido)return;window.enProcesoDeCobro=true;if(window.alarmaActiva){window.alarmaAudio.pause();window.alarmaAudio.currentTime=0;window.alarmaActiva=false;}window.pagosMixtos=[];let a='efectivo_bs';if(window.currentPedido.tipo==='delivery'||window.currentPedido.tipo==='reserva')a='pago_movil';const b=window.usdToBs(window.currentPedido.total||0),c=document.getElementById('cobroModalBody'),d=(window.currentPedido.items||[]).map(e=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.1)"><span>${e.cantidad||1}x ${e.nombre}</span><span style="font-weight:600">${window.formatBs(window.usdToBs((e.precioUnitarioUSD||0)*(e.cantidad||1)))}</span></div>`).join('');c.innerHTML=`<div style="background:rgba(0,0,0,.3);padding:15px;border-radius:8px;margin-bottom:20px"><h4>Resumen del Pedido</h4>${d}${window.currentPedido.costo_delivery_bs?`<div style="display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:2px solid rgba(255,255,255,.1)"><span>Costo delivery:</span><span>${window.formatBs(window.currentPedido.costo_delivery_bs)}</span></div>`:''}<div style="display:flex;justify-content:space-between;margin-top:15px;padding-top:15px;border-top:2px solid var(--primary);font-weight:700"><span>Total a pagar:</span><span id="totalPagarDisplay" style="color:var(--accent)">${window.formatBs(b)}</span></div></div><div style="margin-bottom:20px;padding:12px;background:rgba(245,124,0,.1);border-left:4px solid var(--warning)"><label style="display:flex;align-items:center;gap:10px;color:#fff"><input type="checkbox" id="invitacionCheck" style="width:18px;height:18px"><strong>Por parte de la casa (invitación)</strong></label></div><div id="pagosSection"><h4>Pagos Mixtos</h4><div id="pagosContainer" class="payment-mix-container"></div><button class="btn btn-secondary" onclick="window.agregarMetodoPago()" style="width:100%;margin-bottom:20px"><i class="fas fa-plus"></i> Agregar Método de Pago</button><div id="extrasSection" style="display:none"><div class="pagos-resumen-row" id="vueltoRow" style="display:none"><div class="input-group"><label>Vuelto a entregar (Bs)</label><input type="number" id="vueltoInput" step="0.01" min="0" max="9999999999.99" oninput="window.calcularConVuelto()" inputmode="decimal"></div><div class="input-group"><label>Vuelto restante</label><span id="vueltoRestante">Bs 0.00</span></div></div><div class="pagos-checkbox" id="condonarCheckbox" style="display:none"><input type="checkbox" id="condonarCheck"><label><strong>Condonar monto restante</strong> <span class="badge" id="condonarMonto">Bs 0.00</span></label></div><div class="pagos-checkbox" id="favorCheckbox" style="display:none"><input type="checkbox" id="favorCheck"><label><strong>A favor de caja</strong> <span class="badge favor" id="favorMonto">Bs 0.00</span></label></div></div><div class="pagos-total"><div class="pagos-resumen"><span>Total recibido:</span><span id="totalRecibido">Bs 0.00</span></div><div class="pagos-resumen"><span>Pendiente:</span><span id="pendiente" style="color:var(--danger)">Bs 0.00</span></div><div class="pagos-resumen"><span>Sobrante:</span><span id="sobrante" style="color:var(--success)">Bs 0.00</span></div><div class="pagos-resumen" id="condonadoDisplay" style="display:none"><span>Condonado:</span><span id="condonadoValue" style="color:var(--condonar)">Bs 0.00</span></div><div class="pagos-resumen" id="favorDisplay" style="display:none"><span>A favor caja:</span><span id="favorValue" style="color:var(--favordecaja)">Bs 0.00</span></div></div></div><div class="keyboard-hint"><span><kbd>ENTER</kbd> confirmar</span><span><kbd>ESC</kbd> cancelar</span></div>`;document.getElementById('invitacionCheck').addEventListener('change',function(e){document.getElementById('pagosSection').style.opacity=e.target.checked?'0.5':'1';document.getElementById('pagosSection').style.pointerEvents=e.target.checked?'none':'auto';window.recalcularTotales();});window.agregarMetodoPago(a);document.getElementById('cobroModal').classList.add('active');window.recalcularTotales();};
window.agregarMetodoPago=function(a='pago_movil'){window.pagosMixtos.push({id:Date.now()+Math.random(),metodo:a,monto:0,referencia:''});window.renderizarPagosMixtos();window.recalcularTotales();};
window.renderizarPagosMixtos=function(){const a=document.getElementById('pagosContainer');if(!a)return;a.innerHTML=window.pagosMixtos.map((b,c)=>`<div class="pago-item" data-id="${b.id}">${window.pagosMixtos.length>1?`<button class="remove-pago" onclick="window.eliminarMetodoPago('${b.id}')"><i class="fas fa-times"></i></button>`:''}<select onchange="window.actualizarPago('${b.id}','metodo',this.value)"><option value="efectivo_bs" ${b.metodo==='efectivo_bs'?'selected':''}>Efectivo Bs</option><option value="efectivo_usd" ${b.metodo==='efectivo_usd'?'selected':''}>Efectivo Dólar</option><option value="pago_movil" ${b.metodo==='pago_movil'?'selected':''}>Pago Móvil</option><option value="punto_venta" ${b.metodo==='punto_venta'?'selected':''}>Punto de Venta</option></select><input type="number" step="0.01" max="9999999999.99" placeholder="Monto ${b.metodo==='efectivo_usd'?'en USD':'en Bs'}" value="${b.monto||0}" oninput="window.actualizarPago('${b.id}','monto',this.value)" inputmode="decimal">${b.metodo==='pago_movil'?`<input type="text" maxlength="6" placeholder="Referencia (6 dígitos)" value="${b.referencia||''}" oninput="window.actualizarPago('${b.id}','referencia',this.value)">`:''}</div>`).join('');};
window.actualizarPago=function(id,campo,valor){const a=window.pagosMixtos.find(b=>b.id==id);if(!a)return;if(campo==='monto'){let b=parseFloat(valor)||0;if(b>9999999999.99)b=9999999999.99;a.monto=b;}else if(campo==='metodo'){a.metodo=valor;if(valor!=='pago_movil')a.referencia='';}else if(campo==='referencia')a.referencia=valor;window.renderizarPagosMixtos();window.recalcularTotales();};
window.eliminarMetodoPago=function(id){window.pagosMixtos=window.pagosMixtos.filter(a=>a.id!=id);window.renderizarPagosMixtos();window.recalcularTotales();};
window.recalcularTotales=function(){const a=window.usdToBs(window.currentPedido?.total||0);let b=window.pagosMixtos.reduce((c,d)=>c+(d.metodo==='efectivo_usd'?window.usdToBs(d.monto||0):(d.monto||0)),0);const c=a-b,d=b-a;document.getElementById('totalRecibido').textContent=window.formatBs(b);document.getElementById('pendiente').textContent=window.formatBs(Math.max(0,c));document.getElementById('sobrante').textContent=window.formatBs(Math.max(0,d));const e=document.getElementById('extrasSection'),f=document.getElementById('vueltoRow'),g=document.getElementById('condonarCheckbox'),h=document.getElementById('favorCheckbox'),i=document.getElementById('condonarCheck'),j=document.getElementById('favorCheck'),k=document.getElementById('vueltoInput');let l=false;if(c<0){l=true;f.style.display='grid';if(k.value){const m=parseFloat(k.value)||0,n=Math.abs(c)-m;document.getElementById('vueltoRestante').textContent=window.formatBs(Math.max(0,n));if(n>0){h.style.display='flex';document.getElementById('favorMonto').textContent=window.formatBs(n);}else h.style.display='none';}else{document.getElementById('vueltoRestante').textContent=window.formatBs(Math.abs(c));h.style.display='none';}g.style.display='none';}else if(c>0){l=true;f.style.display='none';g.style.display='flex';document.getElementById('condonarMonto').textContent=window.formatBs(c);h.style.display='none';}else{l=false;f.style.display='none';g.style.display='none';h.style.display='none';}e.style.display=l?'block':'none';const m=document.getElementById('invitacionCheck');let n=m.checked||window.pagosMixtos.length>0;if(c>0){if(i&&i.checked){const o=parseFloat(k?.value)||0,p=Math.abs(c)-o;if(p===0)n=true;else n=false;}else n=false;}if(c<0){const o=parseFloat(k?.value)||0,p=Math.abs(c)-o;if(p>0){if(j&&j.checked)n=true;else n=false;}else n=true;}document.getElementById('confirmCobroBtn').disabled=!n;};
window.calcularConVuelto=function(){window.recalcularTotales();};
window.confirmarCobro=async function(){if(!window.currentPedido)return;const a=document.getElementById('invitacionCheck').checked,b=document.getElementById('condonarCheck'),c=document.getElementById('favorCheck'),d=document.getElementById('vueltoInput');let e,f,g,h=0,i=0,j=0,k;if(a){e=window.currentPedido.tipo==='delivery'?'en_camino':(window.currentPedido.tipo==='reserva'?'reserva_pendiente':'en_cocina');f='invitacion';g=[{metodo:'invitacion',monto:0,montoBs:0}];k=0;}else{const l=window.usdToBs(window.currentPedido.total||0);k=window.pagosMixtos.reduce((m,n)=>m+(n.metodo==='efectivo_usd'?window.usdToBs(n.monto||0):(n.monto||0)),0);let m=l-k;if(b&&b.checked&&m>0){h=m;m=0;}if(c&&c.checked){const n=Math.abs(m);if(m<0){const o=parseFloat(d?.value)||0;i=Math.abs(m)-o;if(i<0)i=0;j=o;}else{i=m;m=0;}}e=window.currentPedido.tipo==='delivery'?'en_camino':(window.currentPedido.tipo==='reserva'?'reserva_pendiente':'en_cocina');g=window.pagosMixtos.map(p=>({metodo:p.metodo,monto:p.monto,montoBs:p.metodo==='efectivo_usd'?window.usdToBs(p.monto):p.monto,referencia:p.referencia||null}));f=window.pagosMixtos.length===1?window.pagosMixtos[0].metodo:'mixto';}try{await window.supabaseClient.from('pedidos').update({estado:e,metodo_pago:f,pagos_mixtos:g,cajero:window.currentUser?.nombre||'Cajero',fecha_cobro:new Date().toISOString(),condonado:h||0,a_favor_caja:i||0,vuelto_entregado:j||0,monto_recibido:k}).eq('id',window.currentPedido.id);const l=window.currentPedido.items?.reduce((m,n)=>m+(n.cantidad||1),0)||0,m=(window.currentPedido.items||[]).reduce((n,o)=>n+(o.precioUnitarioUSD||0)*(o.cantidad||1),0),n=window.usdToBs(m);await window.supabaseClient.from('ventas').insert([{pedido_id:window.currentPedido.id,total:window.currentPedido.total,subtotal_platillos:n,items:l,metodo_pago:f,tipo:window.currentPedido.tipo,fecha:new Date().toISOString()}]);let o,p;if(a){o='🎁 Pedido por invitación';p='Tu pedido ha sido procesado. ¡Disfruta!';}else if(window.currentPedido.tipo==='delivery'){o='✅ Pago confirmado';p='Tu delivery está en camino';}else if(window.currentPedido.tipo==='reserva'){o='✅ Reserva confirmada';p='Tu reserva ha sido confirmada';}else{o='✅ Pago confirmado';p='Tu pedido está en preparación';}await window.supabaseClient.from('notificaciones').insert([{pedido_id:window.currentPedido.id,tipo:'approved',titulo:o,mensaje:p,timestamp:new Date().toISOString(),session_id:window.currentPedido.session_id,leida:false}]);document.getElementById('cobroModal').classList.remove('active');window.mostrarToast('💰 Cobro procesado');window.enProcesoDeCobro=false;window.currentPedido=null;window.pagosMixtos=[];await window.recargarPedidosCompletos();await window.cargarMenu();window.renderizarPropinas();}catch(e){console.error('Error en cobro:',e);window.mostrarToast('❌ Error al procesar el cobro','error');}};
window.mostrarRechazo=function(a){window.pedidoParaAccion=(window.pedidos||[]).find(b=>b.id===a);if(window.pedidoParaAccion)document.getElementById('rechazoModal').classList.add('active');};
window.confirmarRechazo=async function(){if(!window.pedidoParaAccion)return;const a=document.querySelector('input[name="rejectionReason"]:checked')?.value;if(!a){window.mostrarToast('Selecciona una razón','error');return;}try{await window.supabaseClient.rpc('liberar_ingredientes',{p_pedido_id:window.pedidoParaAccion.id});await window.supabaseClient.from('pedidos').update({estado:'rechazado'}).eq('id',window.pedidoParaAccion.id);const b={referencia_invalida:'Referencia inválida',monto_insuficiente:'Monto insuficiente',datos_incorrectos:'Datos incorrectos',no_disponible:'Producto no disponible',fuera_horario:'Fuera de horario'};await window.supabaseClient.from('notificaciones').insert([{pedido_id:window.pedidoParaAccion.id,tipo:'rejected',titulo:'❌ Pedido rechazado',mensaje:`Motivo: ${b[a]||a}`,timestamp:new Date().toISOString(),session_id:window.pedidoParaAccion.session_id,leida:false}]);window.cerrarModal('rechazoModal');window.mostrarToast('🗑️ Pedido rechazado');await window.recargarPedidosCompletos();window.verificarYControlarAlarma();}catch(e){console.error('Error al rechazar:',e);window.mostrarToast('❌ Error al rechazar','error');}};
window.renderizarPropinas=function(){const a=window.propinas.reduce((b,c)=>b+(c.monto_bs||c.monto||0),0),b=window.propinas.length,c=b>0?a/b:0;document.getElementById('propinasTotal').textContent=window.formatBs(a);document.getElementById('propinasCantidad').textContent=b;document.getElementById('propinasPromedio').textContent=window.formatBs(c);document.getElementById('propinasListCount').textContent=b;document.getElementById('propinasListContainer').innerHTML=b?window.propinas.map(d=>window.crearTarjetaPropina(d)).join(''):'<div class="empty-state"><i class="fas fa-hand-holding-heart"></i><p>No hay propinas hoy</p></div>';};
window.crearTarjetaPropina=function(p){try{const a=new Date(p.fecha),b=a.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}),c=(window.mesoneros||[]).find(d=>d.id===p.mesonero_id),d=c?c.nombre:'N/A';return`<div class="order-card-compact" style="border-left-color:var(--propina)"><div class="order-header-compact"><span class="order-time-compact"><i class="far fa-clock"></i> ${b}</span><span class="propina-tag"><i class="fas fa-hand-holding-heart"></i> Propina</span></div><div class="order-info-compact"><div><i class="fas fa-user"></i> Mesonero: ${d}</div><div><i class="fas fa-chair"></i> Mesa: ${p.mesa||'N/A'}</div><div><i class="fas fa-${p.metodo==='efectivo_bs'?'money-bill-wave':p.metodo==='efectivo_usd'?'dollar-sign':p.metodo==='pago_movil'?'mobile-alt':'credit-card'}"></i> Método: ${p.metodo}</div><div><i class="fas fa-user-tie"></i> Cajero: ${p.cajero||'Cajero'}</div></div><div class="order-total-compact" style="color:var(--propina)">${window.formatBs(p.monto_bs||p.monto)}</div></div>`;}catch(e){console.error('Error creando tarjeta de propina:',e);return'';}};
window.mostrarPropinaModal=function(){window.currentPropinaData={mesonero:'',mesa:'Mesa 1',metodo:'efectivo_bs',montoBs:0,montoUsd:0,referencia:'',tasaAplicada:window.tasaEfectiva};const a=document.getElementById('propinaModalBody'),b=(window.mesoneros||[]).map(c=>`<option value="${c.id}">${c.nombre}</option>`).join('');let c='';for(let d=1;d<=10;d++)c+=`<option value="Mesa ${d}">Mesa ${d}</option>`;c+=`<option value="Delivery">Delivery</option><option value="Reserva">Reserva</option>`;a.innerHTML=`<div style="margin-bottom:20px"><div class="mesonero-selector"><label>🧑‍🍳 Mesonero</label><select id="propinaMesonero"><option value="">Seleccionar mesonero...</option>${b}</select></div><div class="mesa-selector"><label>🪑 Mesa Atendida</label><select id="propinaMesa">${c}</select></div><div style="margin-bottom:20px"><label>💳 Método de Pago</label><div style="display:flex;gap:10px;margin-top:8px"><label style="flex:1;background:rgba(0,0,0,.3);padding:10px;border-radius:8px;text-align:center;cursor:pointer"><input type="radio" name="propinaMetodo" value="efectivo_bs" checked onchange="window.cambiarMetodoPropina('efectivo_bs')"> Efectivo Bs</label><label style="flex:1;background:rgba(0,0,0,.3);padding:10px;border-radius:8px;text-align:center;cursor:pointer"><input type="radio" name="propinaMetodo" value="efectivo_usd" onchange="window.cambiarMetodoPropina('efectivo_usd')"> Efectivo USD</label><label style="flex:1;background:rgba(0,0,0,.3);padding:10px;border-radius:8px;text-align:center;cursor:pointer"><input type="radio" name="propinaMetodo" value="pago_movil" onchange="window.cambiarMetodoPropina('pago_movil')"> Pago Móvil</label><label style="flex:1;background:rgba(0,0,0,.3);padding:10px;border-radius:8px;text-align:center;cursor:pointer"><input type="radio" name="propinaMetodo" value="punto_venta" onchange="window.cambiarMetodoPropina('punto_venta')"> Punto Venta</label></div></div><div class="propina-monto-group" id="propinaMontoGroup"><input type="number" id="propinaMontoBs" step="0.01" placeholder="Monto en Bs" oninput="window.calcularMontoPropina('bs')" inputmode="decimal"><input type="number" id="propinaMontoUsd" step="0.01" placeholder="Monto en USD" disabled oninput="window.calcularMontoPropina('usd')" inputmode="decimal"></div><div id="propinaReferenciaGroup" style="display:none;margin-bottom:20px"><label>🔢 Referencia (6 dígitos)</label><div class="referencia-input"><input type="text" maxlength="1" class="ref-propina" data-index="0" oninput="window.moverRefPropina(this,0)"><input type="text" maxlength="1" class="ref-propina" data-index="1" oninput="window.moverRefPropina(this,1)"><input type="text" maxlength="1" class="ref-propina" data-index="2" oninput="window.moverRefPropina(this,2)"><input type="text" maxlength="1" class="ref-propina" data-index="3" oninput="window.moverRefPropina(this,3)"><input type="text" maxlength="1" class="ref-propina" data-index="4" oninput="window.moverRefPropina(this,4)"><input type="text" maxlength="1" class="ref-propina" data-index="5" oninput="window.moverRefPropina(this,5)"></div></div><div style="background:rgba(0,0,0,.3);padding:15px;border-radius:8px"><div style="display:flex;justify-content:space-between"><span><strong>Total a registrar:</strong></span><span id="propinaTotalDisplay" style="color:var(--accent);font-size:1.2rem">Bs 0.00</span></div><div style="font-size:.85rem;color:rgba(255,255,255,.7);margin-top:5px">Tasa aplicada: ${window.tasaEfectiva} Bs/USD</div></div></div><div class="keyboard-hint"><span><kbd>ENTER</kbd> guardar</span><span><kbd>ESC</kbd> cancelar</span></div>`;document.querySelectorAll('.ref-propina').forEach(d=>{d.addEventListener('input',function(){const e=Array.from(document.querySelectorAll('.ref-propina')).map(f=>f.value).join('');window.currentPropinaData.referencia=e;window.validarPropina();});});document.getElementById('propinaModal').classList.add('active');};
window.cambiarMetodoPropina=function(a){window.currentPropinaData.metodo=a;const b=document.getElementById('propinaMontoBs'),c=document.getElementById('propinaMontoUsd'),d=document.getElementById('propinaReferenciaGroup');if(a==='efectivo_usd'){b.disabled=true;c.disabled=false;d.style.display='none';}else if(a==='pago_movil'){b.disabled=false;c.disabled=true;d.style.display='block';}else{b.disabled=false;c.disabled=true;d.style.display='none';}window.validarPropina();};
window.calcularMontoPropina=function(a){if(a==='bs'){window.currentPropinaData.montoBs=parseFloat(document.getElementById('propinaMontoBs').value)||0;if(window.currentPropinaData.metodo==='efectivo_usd')window.currentPropinaData.montoUsd=window.currentPropinaData.montoBs/window.tasaEfectiva;document.getElementById('propinaTotalDisplay').textContent=window.formatBs(window.currentPropinaData.montoBs);}else{window.currentPropinaData.montoUsd=parseFloat(document.getElementById('propinaMontoUsd').value)||0;window.currentPropinaData.montoBs=window.currentPropinaData.montoUsd*window.tasaEfectiva;document.getElementById('propinaTotalDisplay').textContent=window.formatBs(window.currentPropinaData.montoBs);}window.validarPropina();};
window.moverRefPropina=function(a,b){if(a.value.length===1&&b<5)document.querySelector(`.ref-propina[data-index="${b+1}"]`).focus();const c=Array.from(document.querySelectorAll('.ref-propina')).map(d=>d.value).join('');window.currentPropinaData.referencia=c;window.validarPropina();};
window.validarPropina=function(){const a=document.getElementById('propinaMesonero')?.value,b=document.getElementById('propinaMesa')?.value;if(!a||!b){document.getElementById('confirmPropinaBtn').disabled=true;return;}if(window.currentPropinaData.metodo==='pago_movil'){const c=window.currentPropinaData.referencia&&window.currentPropinaData.referencia.length===6;document.getElementById('confirmPropinaBtn').disabled=!(window.currentPropinaData.montoBs>0&&c);}else if(window.currentPropinaData.metodo==='efectivo_usd')document.getElementById('confirmPropinaBtn').disabled=!(window.currentPropinaData.montoUsd>0);else document.getElementById('confirmPropinaBtn').disabled=!(window.currentPropinaData.montoBs>0);};
window.confirmarPropina=async function(){if(!window.currentUser)return;const a=document.getElementById('propinaMesonero').value,b=document.getElementById('propinaMesa').value,c=(window.mesoneros||[]).find(d=>d.id===a);if(!c){window.mostrarToast('Selecciona un mesonero','error');return;}try{const d={mesonero_id:a,mesa:b,metodo:window.currentPropinaData.metodo,monto_original:window.currentPropinaData.metodo==='efectivo_usd'?window.currentPropinaData.montoUsd:window.currentPropinaData.montoBs,moneda_original:window.currentPropinaData.metodo==='efectivo_usd'?'USD':'Bs',tasa_aplicada:window.currentPropinaData.metodo==='efectivo_usd'?window.tasaEfectiva:null,monto_bs:window.currentPropinaData.montoBs,referencia:window.currentPropinaData.referencia||null,cajero:window.currentUser.nombre,fecha:new Date().toISOString(),entregado:false};await window.supabaseClient.from('propinas').insert([d]);window.cerrarPropinaModal();window.mostrarToast('💰 Propina registrada','success');await window.cargarPropinas();window.actualizarEstadisticas();window.renderizarPropinas();}catch(e){console.error('Error:',e);window.mostrarToast('❌ Error al registrar propina','error');}};
window.renderizarMenu=async function(){const a=document.getElementById('menuGrid'),b=document.getElementById('categoryList');if(!window.menuItems||!window.menuItems.length){a.innerHTML='<div class="empty-state"><i class="fas fa-utensils"></i><p>No hay platillos disponibles</p></div>';return;}const c=[...new Set(window.menuItems.map(d=>d.categoria).filter(Boolean))];let d='<li class="category-item active" data-categoria="todos"><i class="fas fa-utensils"></i> Todos</li>';c.forEach(e=>{d+=`<li class="category-item" data-categoria="${e}"><i class="fas fa-${e==='entradas'?'fa-leaf':e==='sushi'?'fa-fish':e==='rolls'?'fa-egg':e==='tragos'?'fa-wine-glass-alt':e==='pokes'?'fa-bowl-food':e==='ensaladas'?'fa-carrot':e==='china'?'fa-dragon':e==='japonesa'?'fa-sun':e==='ofertas'?'fa-fire':'fa-utensils'}"></i> ${e}</li>`;});b.innerHTML=d;document.querySelectorAll('.category-item').forEach(f=>{f.addEventListener('click',function(){document.querySelectorAll('.category-item').forEach(g=>g.classList.remove('active'));this.classList.add('active');window.filtrarMenuPorCategoria(this.dataset.categoria);});});window.filtrarMenuPorCategoria('todos');};
window.filtrarMenuPorCategoria=function(a){let b=[];if(a==='todos')b=window.menuItems;else b=window.menuItems.filter(c=>c.categoria===a);window.renderizarMenuItems(b);};
window.renderizarMenuItems=async function(a){const b=document.getElementById('menuGrid'),c=await Promise.all(a.map(async d=>{const e=await window.calcularStockPlatillo(d);let f='available',g='Disponible';if(e<=0){f='sold-out';g='Agotado';}else if(e<5){f='low';g=`Últimas ${e} unidades`;}else g=`${e} disponibles`;return{...d,stock:e,stockClass:f,stockText:g};}));b.innerHTML=c.map(h=>`<div class="menu-card"><div class="menu-card-image" style="background-image:url('${h.imagen||'https://via.placeholder.com/300x150?text=Saki+Sushi'}')"></div><div class="menu-card-content"><div class="menu-card-header"><span class="menu-card-title">${h.nombre}</span><span class="menu-card-price">${window.formatBs(window.usdToBs(h.precio||0))}</span></div><p style="font-size:.85rem;color:rgba(255,255,255,.6);margin-bottom:.5rem">${h.descripcion||''}</p><div class="menu-card-stock ${h.stockClass}"><i class="fas fa-box"></i> ${h.stockText}</div></div></div>`).join('');};
window.renderizarDeliverysStats=function(){const a=window.pedidos.filter(b=>b.tipo==='delivery'&&b.estado==='enviado'&&new Date(b.timestamp).toDateString()===new Date().toDateString()),b=a.reduce((c,d)=>c+(d.costo_delivery_bs||0),0),c=a.length,d=c>0?b/c:0;document.getElementById('deliverysTotalStats').textContent=window.formatBs(b);document.getElementById('deliverysCantidadStats').textContent=c;document.getElementById('deliverysPromedioStats').textContent=window.formatBs(d);document.getElementById('deliverysListCount').textContent=c;document.getElementById('deliverysListContainer').innerHTML=c?a.map(e=>window.crearTarjetaDelivery(e)).join(''):'<div class="empty-state"><i class="fas fa-motorcycle"></i><p>No hay entregas hoy</p></div>';};
window.crearTarjetaDelivery=function(a){try{const b=new Date(a.timestamp),c=b.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});return`<div class="order-card-compact" style="border-left-color:var(--delivery)"><div class="order-header-compact"><span class="order-time-compact"><i class="far fa-clock"></i> ${c}</span><span class="delivery-tag"><i class="fas fa-motorcycle"></i> Delivery</span></div><div class="order-info-compact"><div><i class="fas fa-map-marker-alt"></i> ${(a.direccion||'').substring(0,20)}...</div><div><i class="fas fa-phone"></i> ${a.telefono||'N/A'}</div><div><i class="fas fa-tag"></i> Pedido: ${a.id.substring(0,8)}</div></div><div class="order-total-compact" style="color:var(--delivery)">${window.formatBs(a.costo_delivery_bs||0)}</div></div>`;}catch(e){return'';}};
window.mostrarConfirmacionDelivery=function(a){const b=window.pedidos.find(c=>c.id===a);if(!b)return;window.pedidoParaAccion=b;const c=document.getElementById('confirmModal'),d=document.getElementById('confirmModalTitle'),e=document.getElementById('confirmModalBody'),f=document.getElementById('confirmModalHeader');d.innerHTML='<i class="fas fa-truck"></i> Asignar Delivery';f.style.background='linear-gradient(135deg,var(--delivery),#00838F)';const g=window.deliverys.map(h=>`<option value="${h.id}">${h.nombre}</option>`).join('');e.innerHTML=`<p>Selecciona el motorizado que realizará el envío:</p><div class="delivery-selector" style="margin:20px 0"><select id="deliverySelector" style="width:100%;padding:10px;background:rgba(0,0,0,.5);color:#fff;border:2px solid rgba(255,255,255,.2);border-radius:8px;"><option value="">-- Seleccionar motorizado --</option>${g}</select></div>${window.crearDetallePedidoResumido(b)}<div class="keyboard-hint" style="margin-top:20px"><span><kbd>ENTER</kbd> confirmar</span><span><kbd>ESC</kbd> cancelar</span></div>`;document.getElementById('confirmActionBtn').disabled=true;setTimeout(()=>{const h=document.getElementById('deliverySelector');if(h){h.addEventListener('change',function(){document.getElementById('confirmActionBtn').disabled=!this.value;});}},100);c.classList.add('active');};
window.mostrarConfirmacion=function(a,b){const c=window.pedidos.find(d=>d.id===a);if(!c)return;window.pedidoParaAccion=c;window.accionPendiente=b;const d=document.getElementById('confirmModal'),e=document.getElementById('confirmModalTitle'),f=document.getElementById('confirmModalBody'),g=document.getElementById('confirmModalHeader');let h,i,j;if(b==='entregado'){h='Confirmar Entrega';i='¿Pedido entregado?';g.style.background='linear-gradient(135deg,var(--success),#2E7D32)';j={titulo:'🍽️ ¡Que aproveche!',mensaje:'Tu pedido ha sido entregado.'};}else if(b==='enviado'){h='Confirmar Envío';i='¿Pedido enviado?';g.style.background='linear-gradient(135deg,var(--info),#1565C0)';j={titulo:'🚚 Delivery en camino',mensaje:'El repartidor ya salió.'};}else if(b==='reserva_atendida'){h='Cliente Confirmado';i='¿Cliente llegó?';g.style.background='linear-gradient(135deg,#9c27b0,#7b1fa2)';j={titulo:'✅ Cliente confirmado',mensaje:'Estás siendo atendido.'};}else{h='Confirmar';i='¿Confirmar acción?';g.style.background='linear-gradient(135deg,var(--success),#2E7D32)';j={titulo:'✅ Completado',mensaje:'Acción confirmada.'};}e.innerHTML=`<i class="fas fa-check-circle"></i> ${h}`;f.innerHTML=`<p>${i}</p>${window.crearDetallePedidoResumido(c)}<div style="background:rgba(56,142,60,.1);padding:15px;margin-top:20px"><strong>Notificación:</strong><br>${j.titulo}<br>${j.mensaje}</div><div class="keyboard-hint"><span><kbd>ENTER</kbd> confirmar</span><span><kbd>ESC</kbd> cancelar</span></div>`;d.classList.add('active');};
window.crearDetallePedidoResumido=function(a){try{let b='';if(a.tipo==='mesa')b=`<div class="detail-row"><span class="detail-label">Mesa:</span><span class="detail-value">${a.mesa}</span></div>`;else if(a.tipo==='delivery')b=`<div class="detail-row"><span class="detail-label">Dirección:</span><span class="detail-value">${a.direccion}</span></div><div class="detail-row"><span class="detail-label">Teléfono:</span><span class="detail-value">${a.telefono}</span></div>`;else b=`<div class="detail-row"><span class="detail-label">Fecha:</span><span class="detail-value">${a.fecha_reserva?new Date(a.fecha_reserva).toLocaleDateString():'N/A'}</span></div>`;return`<div class="detail-item"><div class="detail-row"><span class="detail-label">Tipo:</span><span class="detail-value">${a.tipo}</span></div>${b}<div class="detail-row"><span class="detail-label">Items:</span></div>${(a.items||[]).map(c=>`<div class="detail-row"><span>${c.cantidad||1}x ${c.nombre}</span><span>${window.formatBs(window.usdToBs(c.precioUnitarioUSD*(c.cantidad||1)))}</span></div>`).join('')}<div class="detail-row" style="font-weight:700"><span>TOTAL</span><span>${window.formatBs(window.usdToBs(a.total||0))}</span></div></div>`;}catch(e){return'';}};
window.crearDetallePedidoHTML=function(a){let b='';if(a.pagos_mixtos){b='<div class="payment-methods">'+a.pagos_mixtos.map(c=>{const d=c.metodo==='pago_movil'?'mobile-alt':(c.metodo==='punto_venta'?'credit-card':'money-bill-wave'),e=c.metodo==='efectivo_bs'?'Bs':(c.metodo==='efectivo_usd'?'$':(c.metodo==='pago_movil'?'📱':'💳'));return`<span class="payment-tag"><i class="fas fa-${d}"></i> ${e} ${window.formatBs(c.monto)}</span>`;}).join('')+'</div>';}let c='';if(a.condonado>0)c+=`<span class="condonar-tag"><i class="fas fa-gift"></i> Condonado: ${window.formatBs(a.condonado)}</span>`;if(a.a_favor_caja>0)c+=`<span class="favor-tag"><i class="fas fa-piggy-bank"></i> A favor: ${window.formatBs(a.a_favor_caja)}</span>`;return`<div class="detail-item"><div class="detail-row"><span class="detail-label">Tipo:</span><span class="detail-value">${a.tipo}</span></div>${a.tipo==='mesa'?`<div class="detail-row"><span class="detail-label">Mesa:</span><span class="detail-value">${a.mesa}</span></div>`:''}${a.tipo==='delivery'?`<div class="detail-row"><span class="detail-label">Dirección:</span><span class="detail-value">${a.direccion}</span></div><div class="detail-row"><span class="detail-label">Teléfono:</span><span class="detail-value">${a.telefono}</span></div>`:''}<div class="detail-row"><span class="detail-label">Items:</span></div>${(a.items||[]).map(d=>`<div class="detail-row"><span>${d.cantidad||1}x ${d.nombre}</span><span>${window.formatBs(window.usdToBs(d.precioUnitarioUSD*(d.cantidad||1)))}</span></div>`).join('')}${b?`<div class="detail-row"><span class="detail-label">Pagos:</span></div>${b}`:''}${c?`<div class="detail-row">${c}</div>`:''}<div class="detail-row" style="font-weight:700"><span>TOTAL</span><span>${window.formatBs(window.usdToBs(a.total||0))}</span></div></div>`;};
window.crearDetalleVentaCompacto=function(a,b){if(!b)return'';try{const c=new Date(b.timestamp).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}),d=(b.items||[]).map(e=>`<div class="detail-item-row-compact"><span>${e.cantidad||1}x ${e.nombre}</span><span>${window.formatBs(window.usdToBs((e.precioUnitarioUSD||0)*(e.cantidad||1)))}</span></div>`).join('');let e='';if(b.pagos_mixtos?.length){e='<div style="margin-top:3px">'+b.pagos_mixtos.map(f=>{const g=f.metodo==='efectivo_bs'?'Bs':f.metodo==='efectivo_usd'?'$':f.metodo==='pago_movil'?'📱':'💳';return`<span class="detail-metodo-tag">${g} ${window.formatBs(f.monto)}</span>`;}).join('')+'</div>';}let f='';if(b.condonado>0)f+=`<span class="condonar-tag"><i class="fas fa-gift"></i> Condonado: ${window.formatBs(b.condonado)}</span>`;if(b.a_favor_caja>0)f+=`<span class="favor-tag"><i class="fas fa-piggy-bank"></i> A favor: ${window.formatBs(b.a_favor_caja)}</span>`;return`<div class="detail-item-compact"><div class="detail-header-compact"><span>${c}</span><span class="detail-metodo-tag">${a.tipo}</span></div><div class="detail-items-compact">${d}</div><div class="detail-total-compact">Total: ${window.formatBs(a.subtotal_platillos||(a.total*window.tasaEfectiva))}</div>${e}${f?`<div style="margin-top:5px">${f}</div>`:''}</div>`;}catch(e){return'';}};
window.crearDetallePedidoCompacto=function(a){try{const b=new Date(a.timestamp).toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}),c=(a.items||[]).map(d=>`<div class="detail-item-row-compact"><span>${d.cantidad||1}x ${d.nombre}</span><span>${window.formatBs(window.usdToBs((d.precioUnitarioUSD||0)*(d.cantidad||1)))}</span></div>`).join('');return`<div class="detail-item-compact"><div class="detail-header-compact"><span>${b}</span><span class="detail-metodo-tag">${a.tipo}</span></div><div class="detail-items-compact">${c}</div><div class="detail-total-compact">Total: ${window.formatBs(window.usdToBs(a.total||0))}</div></div>`;}catch(e){return'';}};
window.verComprobante=async function(a){const b=window.pedidos.find(c=>c.id===a);if(!b||!b.comprobante_url){window.mostrarToast('No hay comprobante','error');return;}const c=document.getElementById('comprobanteModal');document.getElementById('comprobanteModalBody').innerHTML=`<div style="text-align:center"><img src="${b.comprobante_url}" style="max-width:100%;max-height:400px;border-radius:8px;margin-bottom:15px"><p><strong>Referencia:</strong> ${b.referencia||'N/A'}</p><p><strong>Teléfono:</strong> ${b.telefono||'N/A'}</p><p><strong>Total:</strong> ${window.formatBs(window.usdToBs(b.total||0))}</p></div><div class="keyboard-hint"><span><kbd>ESC</kbd> cerrar</span></div>`;c.classList.add('active');};
window.abrirModalDetalle=async function(a){await window.cargarVentasHoy();await window.cargarPropinas();const b=document.getElementById('detalleModal'),c=document.getElementById('detalleModalTitle'),d=document.getElementById('detalleModalBody');let e='';try{switch(a){case'preparacion':c.innerHTML='<i class="fas fa-fire"></i> Pedidos en Preparación';const f=window.pedidos.filter(g=>['en_cocina','en_camino','reserva_pendiente','reserva_atendida'].includes(g.estado));e=f.length?f.map(g=>window.crearDetallePedidoCompacto(g)).join(''):'<div class="empty-state"><i class="fas fa-inbox"></i><p>No hay pedidos en preparación</p></div>';break;case'cobrados':c.innerHTML='<i class="fas fa-check-circle"></i> Cobrados Hoy';if(!window.ventasHoy||!window.ventasHoy.length)e='<div class="empty-state"><i class="fas fa-inbox"></i><p>No hay cobros registrados hoy</p></div>';else e=window.ventasHoy.map(h=>{const i=window.pedidos.find(j=>j.id===h.pedido_id);return window.crearDetalleVentaCompacto(h,i);}).join('');break;case'ventas':c.innerHTML='<i class="fas fa-dollar-sign"></i> Ventas Totales (Platillos)';const k=window.ventasHoy.reduce((l,m)=>l+(m.subtotal_platillos||0),0);let l=0,m=0,n=0,o=0,p=0,q=0;window.ventasHoy.forEach(r=>{const s=window.pedidos.find(t=>t.id===r.pedido_id);if(s?.condonado)p+=s.condonado;if(s?.a_favor_caja)q+=s.a_favor_caja;if(s?.metodo_pago){if(s.metodo_pago==='efectivo_bs')l+=r.subtotal_platillos||0;else if(s.metodo_pago==='efectivo_usd')m+=r.subtotal_platillos||0;else if(s.metodo_pago==='pago_movil')n+=r.subtotal_platillos||0;else if(s.metodo_pago==='punto_venta')o+=r.subtotal_platillos||0;}});e=`<p><strong>Total del día (platillos):</strong> ${window.formatBs(k)}</p><p><strong>Cantidad de ventas:</strong> ${window.ventasHoy.length}</p>${p>0?`<p><strong class="condonar-tag">Condonado:</strong> ${window.formatBs(p)}</p>`:''}${q>0?`<p><strong class="favor-tag">A favor de caja:</strong> ${window.formatBs(q)}</p>`:''}<h4>Desglose por método:</h4><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px"><div class="payment-tag" style="justify-content:space-between;padding:6px"><span>Efectivo Bs</span><span>${window.formatBs(l)}</span></div><div class="payment-tag" style="justify-content:space-between;padding:6px"><span>Efectivo USD</span><span>${window.formatBs(m)}</span></div><div class="payment-tag" style="justify-content:space-between;padding:6px"><span>Pago Móvil</span><span>${window.formatBs(n)}</span></div><div class="payment-tag" style="justify-content:space-between;padding:6px"><span>Punto de Venta</span><span>${window.formatBs(o)}</span></div></div><h4>Ventas del día:</h4>${window.ventasHoy.map(u=>{const v=window.pedidos.find(w=>w.id===u.pedido_id);return window.crearDetalleVentaCompacto(u,v);}).join('')}`;break;case'platillos':c.innerHTML='<i class="fas fa-utensils"></i> Platillos Vendidos';const x=new Date().toDateString(),y=window.pedidos.filter(z=>['cobrado','entregado','enviado','reserva_completada'].includes(z.estado)&&new Date(z.timestamp).toDateString()===x),aa={},bb=0;y.forEach(cc=>{cc.items?.forEach(dd=>{const ee=dd.cantidad||1;aa[dd.nombre]=(aa[dd.nombre]||0)+ee;bb+=ee;});});const ff=Object.entries(aa).sort((gg,hh)=>hh[1]-gg[1]),ii=ff[0]?.[1]||0;if(!ff.length)e='<div class="empty-state"><i class="fas fa-utensils"></i><p>No hay platillos vendidos hoy</p></div>';else e=`<p><strong>Total unidades:</strong> ${bb}</p><div style="max-height:400px;overflow-y:auto">${ff.map(([jj,kk],ll)=>`<div class="ranking-bar"><div class="ranking-position">${ll+1}</div><div class="ranking-info"><div class="ranking-name">${jj}</div><div class="ranking-cantidad">${kk} vendido(s)</div></div><div class="ranking-bar-container"><div class="ranking-bar-fill" style="width:${(kk/ii)*100}%"></div></div></div>`).join('')}</div>`;break;case'propinasDetalle':c.innerHTML='<i class="fas fa-hand-holding-heart"></i> Propinas del Día';const mm=window.propinas.reduce((nn,oo)=>nn+(oo.monto_bs||oo.monto||0),0),pp=window.propinas.length,qq=pp>0?mm/pp:0;e=`<p><strong>Total propinas:</strong> ${window.formatBs(mm)}</p><p><strong>Cantidad:</strong> ${pp}</p><p><strong>Promedio:</strong> ${window.formatBs(qq)}</p><h4>Detalle por propina:</h4>${pp?window.propinas.map(rr=>window.crearTarjetaPropina(rr)).join(''):'<div class="empty-state"><i class="fas fa-hand-holding-heart"></i><p>No hay propinas hoy</p></div>'}`;break;case'propinasCantidad':c.innerHTML='<i class="fas fa-hashtag"></i> Cantidad de Propinas';e=`<p style="font-size:2em;text-align:center;color:var(--propina)">${window.propinas.length}</p><p style="text-align:center">propinas recibidas hoy</p>`;break;case'propinasPromedio':c.innerHTML='<i class="fas fa-chart-line"></i> Promedio de Propinas';const ss=window.propinas.length?window.propinas.reduce((tt,uu)=>tt+(uu.monto_bs||uu.monto||0),0)/window.propinas.length:0;e=`<p style="font-size:2em;text-align:center;color:var(--propina)">${window.formatBs(ss)}</p><p style="text-align:center">promedio por propina</p>`;break;case'deliverysTotal':c.innerHTML='<i class="fas fa-motorcycle"></i> Total Deliverys';const vv=window.calcularTotalDeliverysHoy();e=`<p style="font-size:2em;text-align:center;color:var(--delivery)">${window.formatBs(vv)}</p><p style="text-align:center">acumulado en deliveries hoy</p>`;break;case'deliverysCantidad':c.innerHTML='<i class="fas fa-hashtag"></i> Entregas Hoy';const ww=window.pedidos.filter(xx=>xx.tipo==='delivery'&&xx.estado==='enviado'&&new Date(xx.timestamp).toDateString()===new Date().toDateString()).length;e=`<p style="font-size:2em;text-align:center;color:var(--delivery)">${ww}</p><p style="text-align:center">entregas realizadas hoy</p>`;break;case'deliverysPromedio':c.innerHTML='<i class="fas fa-chart-line"></i> Promedio por Entrega';const yy=window.pedidos.filter(zz=>zz.tipo==='delivery'&&zz.estado==='enviado'&&new Date(zz.timestamp).toDateString()===new Date().toDateString()),aaa=yy.reduce((bbb,ccc)=>bbb+(ccc.costo_delivery_bs||0),0),ddd=yy.length>0?aaa/yy.length:0;e=`<p style="font-size:2em;text-align:center;color:var(--delivery)">${window.formatBs(ddd)}</p><p style="text-align:center">promedio por entrega</p>`;break;default:e='<p>Selecciona una opción válida</p>';}}catch(e){console.error('Error en abrirModalDetalle:',e);e='<p>Error al cargar los datos</p>';}d.innerHTML=e;b.classList.add('active');};
window.ejecutarConfirmacion=async function(){if(!window.pedidoParaAccion)return;try{let a,b;if(window.accionPendiente==='entregado'){a='🍽️ Pedido entregado';b='¡Buen Provecho! Gracias por elegir Saki Sushi';}else if(window.accionPendiente==='enviado'){const c=document.getElementById('deliverySelector')?.value;if(!c){window.mostrarToast('Selecciona un motorizado','error');return;}const d=window.deliverys.find(e=>e.id===c);await window.supabaseClient.from('entregas_delivery').insert([{pedido_id:window.pedidoParaAccion.id,delivery_id:c,monto_bs:window.pedidoParaAccion.costo_delivery_bs||0,fecha_entrega:new Date().toISOString()}]);a='🚚 Delivery en camino';b=d?`Tu pedido está siendo entregado por ${d.nombre}`:'El repartidor ya salió';}else if(window.accionPendiente==='reserva_atendida'){a='✅ Reserva Confirmada';b='En breve tu pedido te será entregado, ¡Gracias por preferirnos!';}else if(window.accionPendiente==='reserva_completada'){a='🍽️ Pedido entregado';b='¡Buen Provecho! Gracias por elegir Saki Sushi';}else{a='🔄 Estado actualizado';b='Tu pedido ha sido actualizado';}await window.supabaseClient.from('pedidos').update({estado:window.accionPendiente}).eq('id',window.pedidoParaAccion.id);await window.supabaseClient.from('notificaciones').insert([{pedido_id:window.pedidoParaAccion.id,tipo:'approved',titulo:a,mensaje:b,timestamp:new Date().toISOString(),session_id:window.pedidoParaAccion.session_id,leida:false}]);window.cerrarModal('confirmModal');window.mostrarToast('✅ Estado actualizado');await window.recargarPedidosCompletos();window.verificarYControlarAlarma();}catch(e){console.error('Error:',e);window.mostrarToast('❌ Error','error');}};
window.verificarCambiosPedidos=async function(){if(window.reconectando||window.enProcesoDeCobro)return;try{const a=new Date();a.setHours(0,0,0,0);const b=new Date(a);b.setDate(b.getDate()+2);const c=await window.supabaseClient.from('pedidos').select('id, estado, timestamp').gte('timestamp',a.toISOString()).lt('timestamp',b.toISOString());if(c.error)throw c.error;if(c.data){let d=false;if(c.data.length!==(window.pedidos||[]).length)d=true;else{const e=new Map((window.pedidos||[]).map(f=>[f.id,f.estado]));for(const g of c.data){if(e.get(g.id)!==g.estado){d=true;break;}}}if(d){console.log('📦 Cambios detectados en pedidos, recargando...');await window.recargarPedidosCompletos();window.ultimaActualizacion=Date.now();}}}catch(e){console.error('Error verificando cambios:',e);}};
window.recargarPedidosCompletos=async function(){try{await window.cargarPedidos();await window.cargarVentasHoy();window.actualizarEstadisticas();window.renderizarPedidos();window.verificarYControlarAlarma();}catch(e){console.error('Error recargando pedidos:',e);}};
window.iniciarVerificacionPeriodica=function(){if(window.intervaloVerificacion)clearInterval(window.intervaloVerificacion);window.intervaloVerificacion=setInterval(async()=>{if(window.paginaVisible&&!window.enProcesoDeCobro)await window.verificarCambiosPedidos();},3000);};
window.setupRealtimeSubscriptions=function(){try{if(window.suscripciones)window.suscripciones.forEach(a=>{try{a.unsubscribe();}catch(e){}});window.suscripciones=[];const b=(c,d,e)=>{try{const f=window.supabaseClient.channel(c+'-'+Date.now()).on('postgres_changes',{event:'*',schema:'public',table:d},e).subscribe();window.suscripciones.push(f);}catch(g){console.error('Error suscribiendo a '+d,g);}};b('cajero-pedidos','pedidos',async()=>{await window.verificarCambiosPedidos();});b('cajero-ventas','ventas',async()=>{await window.cargarVentasHoy();window.actualizarEstadisticas();});b('cajero-propinas','propinas',async()=>{await window.cargarPropinas();window.actualizarEstadisticas();window.renderizarPropinas();});b('cajero-mesoneros','mesoneros',async()=>{await window.cargarMesoneros();});b('cajero-deliverys','deliverys',async()=>{await window.cargarDeliverys();});b('cajero-menu','menu',async()=>{await window.cargarMenu();});b('cajero-inventario','inventario',async()=>{window.stockCache.invalidate();await window.cargarInventario();});b('cajero-config','config',(a)=>{window.configGlobal={...window.configGlobal,...a.new};window.tasaEfectiva=window.configGlobal.tasa_efectiva||400;window.renderizarPedidos();window.renderizarMenu();window.actualizarEstadisticas();});}catch(e){console.error('Error configurando suscripciones:',e);}};
window.setupEventListeners=function(){document.addEventListener('keydown',(a)=>{if(a.key==='Escape'){['cobroModal','propinaModal','confirmModal','rechazoModal','detalleModal','mesaModal','comprobanteModal','deliveryModal'].forEach(b=>{const c=document.getElementById(b);if(c&&c.classList.contains('active')){if(b==='cobroModal')window.cerrarCobroModal();else if(b==='propinaModal')window.cerrarPropinaModal();else window.cerrarModal(b);}});}if(a.key==='Enter'){if(document.getElementById('confirmModal')&&document.getElementById('confirmModal').classList.contains('active')){const b=document.getElementById('confirmActionBtn');if(b&&!b.disabled){a.preventDefault();window.ejecutarConfirmacion();}}if(document.getElementById('cobroModal')&&document.getElementById('cobroModal').classList.contains('active')&&!document.getElementById('confirmCobroBtn').disabled){a.preventDefault();window.confirmarCobro();}if(document.getElementById('propinaModal')&&document.getElementById('propinaModal').classList.contains('active')&&!document.getElementById('confirmPropinaBtn').disabled){a.preventDefault();window.confirmarPropina();}}});const b=document.getElementById('categoriasWrapper');if(b){let c=0;b.addEventListener('touchstart',d=>{c=d.touches[0].clientX;});b.addEventListener('touchmove',d=>{if(!c)return;const e=d.touches[0].clientX,f=c-e;if(Math.abs(f)>20)d.preventDefault();});b.addEventListener('touchend',d=>{if(!c)return;const e=d.changedTouches[0].clientX,f=c-e;if(Math.abs(f)>50){if(f>0)b.scrollLeft+=150;else b.scrollLeft-=150;}c=0;});}};
document.addEventListener('DOMContentLoaded',async()=>{console.log('DOM cargado, verificando sesión...');window.alarmaAudio=document.getElementById('alarmaSonido');const a=sessionStorage.getItem('cajero_user');if(a){try{window.currentUser=JSON.parse(a);await window.cargarDatosIniciales();window.mostrarPanel();}catch(e){console.error('Error restaurando sesión:',e);window.mostrarLogin();}}else window.mostrarLogin();document.addEventListener('visibilitychange',function(){if(document.hidden)window.paginaVisible=false;else{window.paginaVisible=true;window.verificarCambiosPedidos();}});});
</script></body></html>