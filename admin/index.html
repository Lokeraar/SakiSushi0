<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saki Sushi - Panel Administraci칩n</title>
    
    <!-- Fuentes Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- QRCode.js -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* MISMO ESTILO QUE TEN칈AS - SIN CAMBIOS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #D32F2F;
            --secondary: #212121;
            --accent: #FF9800;
            --light-bg: #F5F5F5;
            --dark-bg: #121212;
            --success: #388E3C;
            --info: #1976D2;
            --warning: #F57C00;
            --danger: #ef4444;
            --text-light: #ffffff;
            --text-dark: #333333;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-dark);
            min-height: 100vh;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
        }

        /* Login */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-box h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .login-form input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 1rem;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .login-form button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .login-form button:hover {
            background-color: #b71c1c;
        }

        .recovery-link {
            text-align: center;
            margin-top: 1rem;
        }

        .recovery-link a {
            color: var(--info);
            text-decoration: none;
            font-size: 0.9rem;
        }

        /* Panel principal */
        .panel-container {
            display: none;
            min-height: 100vh;
            background-color: var(--light-bg);
        }

        .panel-container.active {
            display: block;
        }

        /* Header */
        .header {
            background-color: var(--secondary);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-left h2 {
            color: var(--accent);
        }

        .save-button {
            background-color: var(--success);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .save-button:hover {
            background-color: #2e7d32;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-button {
            background: none;
            border: 1px solid var(--gray-600);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .nav-button:hover {
            background-color: var(--gray-700);
        }

        .logout-button {
            background-color: var(--danger);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .logout-button:hover {
            background-color: #dc2626;
        }

        /* Barra de tasa (editable) */
        .tasa-bar {
            background-color: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .tasa-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tasa-item label {
            font-weight: 600;
            color: var(--gray-700);
        }

        .tasa-item input {
            width: 100px;
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
        }

        .tasa-value {
            font-weight: 700;
            color: var(--primary);
            min-width: 80px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-400);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .btn-small {
            padding: 0.25rem 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            background-color: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-small.danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-small.success {
            background-color: var(--success);
            color: white;
        }

        /* Pesta침as */
        .tabs {
            display: flex;
            background-color: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 0 2rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-600);
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Contenido */
        .content {
            padding: 2rem;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Tarjetas de dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .dashboard-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card-title {
            color: var(--gray-600);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--secondary);
        }

        .card-value small {
            font-size: 0.9rem;
            color: var(--gray-500);
        }

        .alert-list {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .alert-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .alert-item.critical {
            color: var(--danger);
            font-weight: 600;
        }

        /* Gr치ficos */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            margin-bottom: 1rem;
            color: var(--secondary);
        }

        .chart-wrapper {
            height: 300px;
            position: relative;
        }

        /* Tablas */
        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table th {
            background-color: var(--gray-800);
            color: white;
            padding: 1rem;
            text-align: left;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background-color: var(--gray-100);
        }

        /* Tarjetas de men칰 */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .menu-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .menu-card-image {
            height: 150px;
            background-color: var(--gray-200);
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .menu-card-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .menu-card-actions button {
            background: rgba(255,255,255,0.9);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .menu-card-actions button:hover {
            background: white;
            transform: scale(1.1);
        }

        .menu-card-content {
            padding: 1rem;
        }

        .menu-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .menu-card-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .menu-card-stock {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background-color: var(--gray-200);
        }

        .menu-card-precio {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .menu-card-descripcion {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .menu-card-ingredientes {
            font-size: 0.8rem;
            color: var(--gray-500);
            max-height: 100px;
            overflow-y: auto;
        }

        .menu-card-ingredientes span {
            display: inline-block;
            background-color: var(--gray-200);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin: 0.2rem;
        }

        .menu-card-ingredientes .sin-stock {
            background-color: #fee2e2;
            color: var(--danger);
        }

        .disponible-badge {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success);
        }

        .no-disponible-badge {
            background-color: var(--danger);
        }

        /* Tarjetas de inventario */
        .inventario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .inventario-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .inventario-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .inventario-nombre {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .inventario-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray-600);
            margin-left: 0.5rem;
        }

        .inventario-stock {
            margin: 0.5rem 0;
        }

        .stock-bar {
            height: 8px;
            background-color: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.25rem;
        }

        .stock-fill {
            height: 100%;
            background-color: var(--primary);
            transition: width 0.3s;
        }

        .stock-fill.critical {
            background-color: var(--danger);
        }

        .inventario-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        .inventario-minimo {
            color: var(--warning);
        }

        /* Tarjetas de usuarios */
        .usuarios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .usuario-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .usuario-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .usuario-nombre {
            font-weight: 600;
        }

        .usuario-username {
            color: var(--gray-600);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .usuario-estado {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .usuario-estado span {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            background-color: var(--gray-200);
        }

        .usuario-estado .activo {
            background-color: var(--success);
            color: white;
        }

        .usuario-estado .inactivo {
            background-color: var(--danger);
            color: white;
        }

        .usuario-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Tarjetas de QR */
        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .qr-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .qr-image {
            width: 150px;
            height: 150px;
            margin: 0 auto 1rem;
        }

        .qr-nombre {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .qr-url {
            font-size: 0.7rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
            word-break: break-all;
        }

        .qr-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .qr-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray-600);
            font-size: 1rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-header h3 {
            color: var(--secondary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-600);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--gray-200);
            background-color: var(--gray-100);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Formularios */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .ingrediente-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .ingrediente-row select {
            flex: 2;
        }

        .ingrediente-row input {
            flex: 1;
        }

        .ingrediente-row button {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary:hover {
            background-color: #b71c1c;
        }

        .btn-secondary {
            background-color: var(--gray-200);
            color: var(--gray-700);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background-color: var(--gray-300);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        /* Overlay para contrase침a */
        .password-overlay {
            position: relative;
        }

        .password-protected {
            filter: blur(4px);
            pointer-events: none;
            user-select: none;
        }

        .password-unlock {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(211, 47, 47, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--secondary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 3000;
            display: none;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .toast.show {
            display: block;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        .toast.info {
            background: var(--info);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Preview de imagen */
        .image-preview {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .image-preview img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        .image-preview small {
            color: var(--gray-600);
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h2><i class="fas fa-cog"></i> Admin Saki Sushi</h2>
            <form class="login-form" id="loginForm">
                <input type="password" id="adminPassword" placeholder="Contrase침a de Administrador" required autocomplete="current-password">
                <button type="submit">Ingresar</button>
            </form>
            <div class="recovery-link">
                <a href="#" id="recoveryLink">쯆lvidaste la contrase침a?</a>
            </div>
        </div>
    </div>

    <!-- Panel Principal -->
    <div class="panel-container" id="panelContainer">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h2><i class="fas fa-crown"></i> Administraci칩n Saki Sushi</h2>
                <button class="save-button" id="saveAllButton">
                    <i class="fas fa-save"></i> Guardar Todo
                </button>
            </div>
            <div class="header-right">
                <a href="../Cliente/index.html" target="_blank" class="nav-button">
                    <i class="fas fa-utensils"></i> Cliente
                </a>
                <a href="../Cajero/index.html" target="_blank" class="nav-button">
                    <i class="fas fa-cash-register"></i> Cajero
                </a>
                <button class="logout-button" id="logoutButton">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </header>

        <!-- Barra de tasa (editable) -->
        <div class="tasa-bar" id="tasaBar">
            <div class="tasa-item">
                <label>Tasa Base:</label>
                <input type="number" step="0.01" id="tasaBaseInput" value="400.00">
            </div>
            <div class="tasa-item">
                <label>Aumento Diario %:</label>
                <input type="number" step="0.1" id="aumentoDiarioInput" value="0">
            </div>
            <div class="tasa-item">
                <label>Aumento Activo:</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="aumentoActivoToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="tasa-item">
                <button class="btn-small danger" id="detenerAumentoBtn">Detener por Completo</button>
                <button class="btn-small success" id="activarAumentoBtn">Activar por Completo</button>
            </div>
            <div class="tasa-item">
                <label>Tasa Efectiva:</label>
                <span class="tasa-value" id="tasaEfectivaDisplay">400.00</span>
            </div>
            <div class="tasa-item">
                <label>Aumento Acumulado:</label>
                <span class="tasa-value" id="aumentoAcumuladoDisplay">0%</span>
            </div>
        </div>

        <!-- Pesta침as -->
        <div class="tabs">
            <div class="tab active" data-tab="dashboard">Dashboard</div>
            <div class="tab" data-tab="menu">Men칰 y Precios</div>
            <div class="tab" data-tab="inventario">Inventario</div>
            <div class="tab" data-tab="usuarios">Usuarios</div>
            <div class="tab" data-tab="configuracion">Configuraci칩n</div>
            <div class="tab" data-tab="qr">C칩digos QR</div>
            <div class="tab" data-tab="reportes">Reportes</div>
        </div>

        <!-- Contenido -->
        <div class="content">
            <!-- Dashboard -->
            <div class="tab-pane active" id="dashboardPane">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-title">Ventas Hoy</div>
                        <div class="card-value" id="ventasHoy">$0.00</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-title">Tasa Efectiva</div>
                        <div class="card-value" id="tasaEfectivaCard">Bs. 400.00</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-title">Productos Activos</div>
                        <div class="card-value" id="productosActivos">0</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-title">Alertas Stock</div>
                        <div class="card-value" id="alertasStock">0</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <!-- Pedidos recientes -->
                    <div class="alert-list">
                        <h3 style="margin-bottom: 1rem;">Pedidos Recientes</h3>
                        <div id="pedidosRecientes"></div>
                    </div>

                    <!-- Stock cr칤tico - AHORA CON ALERTAS EN TIEMPO REAL -->
                    <div class="alert-list">
                        <h3 style="margin-bottom: 1rem;">Stock Cr칤tico</h3>
                        <div id="stockCritico"></div>
                    </div>
                </div>
            </div>

            <!-- Men칰 y Precios -->
            <div class="tab-pane" id="menuPane">
                <button class="btn-primary" onclick="abrirModalNuevoPlatillo()" style="margin-bottom: 1rem;">
                    <i class="fas fa-plus"></i> Nuevo Platillo
                </button>
                <div class="menu-grid" id="menuGrid"></div>
            </div>

            <!-- Inventario -->
            <div class="tab-pane" id="inventarioPane">
                <button class="btn-primary" onclick="abrirModalNuevoIngrediente()" style="margin-bottom: 1rem;">
                    <i class="fas fa-plus"></i> Nuevo Ingrediente
                </button>
                <div class="inventario-grid" id="inventarioGrid"></div>
            </div>

            <!-- Usuarios -->
            <div class="tab-pane" id="usuariosPane">
                <button class="btn-primary" onclick="abrirModalNuevoUsuario()" style="margin-bottom: 1rem;">
                    <i class="fas fa-plus"></i> Nuevo Cajero
                </button>
                <div class="usuarios-grid" id="usuariosGrid"></div>
            </div>

            <!-- Configuraci칩n -->
            <div class="tab-pane" id="configuracionPane">
                <div class="alert-list" style="max-width: 500px;">
                    <h3 style="margin-bottom: 1rem;">Cambiar Contrase침a</h3>
                    <div class="form-group">
                        <label>Contrase침a Actual</label>
                        <input type="password" id="currentPassword">
                    </div>
                    <div class="form-group">
                        <label>Nueva Contrase침a</label>
                        <input type="password" id="newPassword">
                    </div>
                    <div class="form-group">
                        <label>Confirmar Nueva Contrase침a</label>
                        <input type="password" id="confirmPassword">
                    </div>
                    <button class="btn-primary" onclick="cambiarPassword()">Cambiar Contrase침a</button>
                </div>

                <div class="alert-list" style="max-width: 500px; margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Correo de Recuperaci칩n</h3>
                    <div class="form-group">
                        <label>Correo Electr칩nico</label>
                        <input type="email" id="recoveryEmail" value="admin@sakisushi.com">
                    </div>
                    <button class="btn-primary" onclick="guardarRecoveryEmail()">Guardar</button>
                </div>

                <!-- NUEVO: Umbral de stock cr칤tico -->
                <div class="alert-list" style="max-width: 500px; margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Configuraci칩n de Alertas</h3>
                    <div class="form-group">
                        <label>Umbral de Stock Cr칤tico (unidades m칤nimas)</label>
                        <input type="number" id="alertaStockMinimo" value="5" min="1">
                        <small>Cuando un ingrediente baje de esta cantidad, aparecer치 en alertas</small>
                    </div>
                    <button class="btn-primary" onclick="guardarUmbralStock()">Guardar Umbral</button>
                </div>
            </div>

            <!-- C칩digos QR -->
            <div class="tab-pane" id="qrPane">
                <div style="margin-bottom: 2rem;">
                    <h3>Generar Nuevo QR</h3>
                    <div style="display: flex; gap: 1rem; align-items: flex-end;">
                        <div class="form-group" style="flex: 1;">
                            <label>Nombre de la Mesa</label>
                            <input type="text" id="qrNombreMesa" placeholder="Ej: Mesa 1">
                        </div>
                        <button class="btn-primary" onclick="generarQR()">
                            <i class="fas fa-qrcode"></i> Generar QR
                        </button>
                    </div>
                </div>
                <div class="qr-grid" id="qrGrid"></div>
            </div>

            <!-- Reportes -->
            <div class="tab-pane" id="reportesPane">
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                    <div class="form-group">
                        <label>Desde</label>
                        <input type="date" id="reporteDesde">
                    </div>
                    <div class="form-group">
                        <label>Hasta</label>
                        <input type="date" id="reporteHasta">
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button class="btn-primary" onclick="cargarReportes()">Filtrar</button>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-title">Ventas D칤a</div>
                        <div class="card-value" id="ventasDia">$0.00</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-title">Ventas Semana</div>
                        <div class="card-value" id="ventasSemana">$0.00</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-title">Ticket Promedio</div>
                        <div class="card-value" id="ticketPromedio">$0.00</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-title">Platillo Top</div>
                        <div class="card-value" id="platilloTop">-</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <h3>Ventas 칔ltimos 7 D칤as</h3>
                        <div class="chart-wrapper">
                            <canvas id="ventasChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Ventas por Categor칤a</h3>
                        <div class="chart-wrapper">
                            <canvas id="categoriasChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>M칠todos de Pago</h3>
                        <div class="chart-wrapper">
                            <canvas id="pagosChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h3>Ventas por Hora</h3>
                        <div class="chart-wrapper">
                            <canvas id="horaChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="table-responsive" style="margin-top: 2rem;">
                    <h3>Detalle de Ventas</h3>
                    <table class="data-table" id="ventasTable">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Pedido</th>
                                <th>Total</th>
                                <th>Items</th>
                                <th>M칠todo</th>
                                <th>Tipo</th>
                            </tr>
                        </thead>
                        <tbody id="ventasTableBody">
                            <!-- Datos din치micos -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast para notificaciones -->
    <div class="toast" id="toast"></div>

    <!-- Modal de Platillo -->
    <div class="modal" id="platilloModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="platilloModalTitle">Nuevo Platillo</h3>
                <button class="modal-close" id="closePlatilloModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="platilloForm">
                    <div class="form-group">
                        <label>Imagen del Platillo</label>
                        <input type="file" id="platilloImagen" accept="image/*">
                        <small>O ingresa URL (opcional):</small>
                        <input type="url" id="platilloImagenUrl" placeholder="https://...">
                        <div id="imagenPreview" class="image-preview" style="display: none;">
                            <img id="previewImg" src="" alt="Vista previa">
                            <div>
                                <small>Vista previa</small>
                                <button type="button" class="btn-small" onclick="limpiarImagenPreview()">Eliminar</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre</label>
                            <input type="text" id="platilloNombre" required>
                        </div>
                        <div class="form-group">
                            <label>Categor칤a</label>
                            <select id="platilloCategoria" required>
                                <option value="">Seleccionar</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Subcategor칤a</label>
                        <select id="platilloSubcategoria">
                            <option value="">Ninguna</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Precio (USD)</label>
                            <input type="number" step="0.01" id="platilloPrecio" required>
                        </div>
                        <div class="form-group">
                            <label>Disponible</label>
                            <select id="platilloDisponible">
                                <option value="true">S칤</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Descripci칩n</label>
                        <textarea id="platilloDescripcion" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Ingredientes</label>
                        <div id="ingredientesContainer">
                            <!-- Ingredientes din치micos -->
                        </div>
                        <button type="button" class="btn-secondary" onclick="agregarIngredienteRow()" style="margin-top: 0.5rem;">
                            <i class="fas fa-plus"></i> Agregar Ingrediente
                        </button>
                    </div>

                    <div class="form-group">
                        <label>Stock Calculado:</label>
                        <span id="stockCalculado">0</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelPlatillo">Cancelar</button>
                <button class="btn-primary" id="savePlatillo">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Ingrediente -->
    <div class="modal" id="ingredienteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="ingredienteModalTitle">Nuevo Ingrediente</h3>
                <button class="modal-close" id="closeIngredienteModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="ingredienteForm">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" id="ingredienteNombre" required>
                    </div>

                    <div class="form-group password-overlay" id="stockOverlay">
                        <label>Stock Actual</label>
                        <div id="stockActualField" class="password-protected">
                            <input type="number" step="0.01" id="ingredienteStock" disabled>
                        </div>
                        <div class="password-unlock" id="stockUnlock">
                            <input type="password" placeholder="Contrase침a" id="stockPassword">
                            <button type="button" onclick="desbloquearStock()">Desbloquear</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Mercanc칤a Nueva a Agregar</label>
                        <input type="number" step="0.01" id="ingredienteAgregar">
                    </div>

                    <div class="form-group">
                        <label>Unidad</label>
                        <select id="ingredienteUnidad">
                            <option value="unidades">Unidades</option>
                            <option value="gramos">Gramos</option>
                            <option value="mililitros">Mililitros</option>
                            <option value="kilogramos">Kilogramos</option>
                            <option value="litros">Litros</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Stock M칤nimo (en unidad base)</label>
                        <input type="number" step="0.01" id="ingredienteMinimo">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Costo Total Compra (USD)</label>
                            <input type="number" step="0.01" id="costoTotal" onchange="calcularCostoUnitario()">
                        </div>
                        <div class="form-group">
                            <label>Cantidad Comprada</label>
                            <input type="number" step="0.01" id="cantidadComprada" onchange="calcularCostoUnitario()">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Precio de Costo (USD por unidad)</label>
                        <input type="number" step="0.01" id="ingredienteCosto">
                    </div>

                    <div class="form-group">
                        <label>Precio de Venta (USD por unidad)</label>
                        <input type="number" step="0.01" id="ingredienteVenta">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelIngrediente">Cancelar</button>
                <button class="btn-primary" id="saveIngrediente">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Usuario -->
    <div class="modal" id="usuarioModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Cajero</h3>
                <button class="modal-close" id="closeUsuarioModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="usuarioForm">
                    <div class="form-group">
                        <label>Nombre Completo</label>
                        <input type="text" id="usuarioNombre" required>
                    </div>
                    <div class="form-group">
                        <label>Nombre de Usuario</label>
                        <input type="text" id="usuarioUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Contrase침a Temporal</label>
                        <input type="text" id="usuarioPassword" value="123456" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelUsuario">Cancelar</button>
                <button class="btn-primary" id="saveUsuario">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal de QR Ampliado -->
    <div class="modal" id="qrAmpliadoModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>C칩digo QR</h3>
                <button class="modal-close" id="closeQrAmpliadoModal">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div id="qrAmpliado" style="width: 300px; height: 300px; margin: 0 auto;"></div>
                <div id="qrAmpliadoInfo" style="margin-top: 1rem;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" id="closeQrAmpliado">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Primero Supabase (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Luego tu configuraci칩n -->
    <script src="../supabase-config.js"></script>
    <script>
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let isAdminAuthenticated = false;
        let menuItems = [];
        let inventarioItems = [];
        let usuarios = [];
        let qrCodes = [];
        let charts = {};
        let platilloEditandoId = null;

        // ============================================
        // FUNCIONES DE TOAST
        // ============================================
        function mostrarToast(mensaje, tipo = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = mensaje;
            toast.className = `toast show ${tipo}`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ============================================
        // FUNCIONES DE INICIALIZACI칍N
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('游댌 Verificando sesi칩n de admin...');
            const adminSession = sessionStorage.getItem('admin_authenticated');
            if (adminSession === 'true') {
                console.log('游녻 Sesi칩n de admin encontrada');
                isAdminAuthenticated = true;
                mostrarPanel();
            } else {
                console.log('游녻 No hay sesi칩n de admin');
                mostrarLogin();
            }
        });

        function mostrarLogin() {
            console.log('游댏 Mostrando pantalla de login admin');
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('panelContainer').classList.remove('active');
        }

        function mostrarPanel() {
            console.log('游늵 Mostrando panel de administraci칩n');
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('panelContainer').classList.add('active');
            console.log('丘뙖잺 Cargando datos iniciales...');
            cargarConfiguracionInicial();
            cargarMenu();
            cargarInventario();
            cargarUsuarios();
            cargarQRs();
            cargarReportes();
            cargarPedidosRecientes();
            setupEventListeners();
            setupRealtimeSubscriptions();
        }

        // ============================================
        // FUNCIONES DE CARGA MEJORADAS
        // ============================================
        async function cargarConfiguracionInicial() {
            console.log('丘뙖잺 Cargando configuraci칩n inicial...');
            await cargarConfiguracion();
            actualizarTasaUI();
            // Cargar umbral de stock cr칤tico
            document.getElementById('alertaStockMinimo').value = configGlobal.alerta_stock_minimo || 5;
            console.log('九 Configuraci칩n cargada');
        }

        function actualizarTasaUI() {
            document.getElementById('tasaBaseInput').value = configGlobal.tasa_cambio || 400;
            document.getElementById('aumentoDiarioInput').value = configGlobal.aumento_diario || 0;
            document.getElementById('aumentoActivoToggle').checked = configGlobal.aumento_activo || false;
            document.getElementById('tasaEfectivaDisplay').textContent = (configGlobal.tasa_efectiva || 400).toFixed(2);
            document.getElementById('aumentoAcumuladoDisplay').textContent = (configGlobal.aumento_acumulado || 0) + '%';
            document.getElementById('tasaEfectivaCard').textContent = `Bs. ${(configGlobal.tasa_efectiva || 400).toFixed(2)}`;
        }

        async function cargarMenu() {
            console.log('游꼮 Cargando men칰...');
            try {
                const { data, error } = await window.supabaseClient
                    .from('menu')
                    .select('*');
                
                if (error) throw error;
                menuItems = data || [];
                console.log(`游꼮 ${menuItems.length} platillos cargados`);
                renderizarMenu();
                actualizarProductosActivos();
            } catch (error) {
                console.error('Error cargando men칰:', error);
                mostrarToast('Error cargando men칰', 'error');
            }
        }

        async function cargarInventario() {
            console.log('游닍 Cargando inventario...');
            try {
                const { data, error } = await window.supabaseClient
                    .from('inventario')
                    .select('*');
                
                if (error) throw error;
                inventarioItems = data || [];
                console.log(`游닍 ${inventarioItems.length} ingredientes cargados`);
                renderizarInventario();
                actualizarAlertasStock();
                
                // NUEVO: Al cargar inventario, actualizar el men칰
                await cargarMenu(); // Esto asegura que los badges de disponibilidad se actualicen
                
                // NUEVO: Verificar stock cr칤tico
                await verificarStockCritico();
                
            } catch (error) {
                console.error('Error cargando inventario:', error);
                mostrarToast('Error cargando inventario', 'error');
            }
        }

        // ============================================
        // NUEVA FUNCI칍N: verificarStockCritico
        // ============================================
        async function verificarStockCritico() {
            try {
                const { data, error } = await window.supabaseClient.rpc('verificar_stock_critico');
                if (error) throw error;
                
                const stockCriticoDiv = document.getElementById('stockCritico');
                
                if (data && data.length > 0) {
                    stockCriticoDiv.innerHTML = data.map(item => `
                        <div class="alert-item critical">
                            <span>
                                <strong>${item.nombre}</strong><br>
                                Stock: ${item.stock_actual} / M칤nimo: ${item.stock_minimo}
                                <span style="color: var(--danger);">(Faltan ${item.unidades_faltantes})</span>
                            </span>
                            <button class="btn-small" onclick="agregarStock('${item.ingrediente_id}')">
                                <i class="fas fa-plus"></i> Agregar
                            </button>
                        </div>
                    `).join('');
                    
                    // Mostrar alerta en el dashboard
                    document.getElementById('alertasStock').textContent = data.length;
                    
                    // Si hay stock cr칤tico, mostrar notificaci칩n
                    if (data.length > 0) {
                        mostrarToast(`丘멆잺 ${data.length} ingrediente(s) con stock cr칤tico`, 'warning');
                    }
                } else {
                    stockCriticoDiv.innerHTML = '<p>No hay alertas de stock</p>';
                    document.getElementById('alertasStock').textContent = '0';
                }
            } catch (error) {
                console.error('Error verificando stock cr칤tico:', error);
            }
        }

        // ============================================
        // FUNCI칍N PARA GUARDAR UMBRAL DE STOCK
        // ============================================
        async function guardarUmbralStock() {
            const umbral = parseInt(document.getElementById('alertaStockMinimo').value);
            
            if (isNaN(umbral) || umbral < 1) {
                mostrarToast('Ingresa un valor v치lido (m칤nimo 1)', 'error');
                return;
            }
            
            try {
                const { error } = await window.supabaseClient
                    .from('config')
                    .update({ alerta_stock_minimo: umbral })
                    .eq('id', 1);
                
                if (error) throw error;
                
                configGlobal.alerta_stock_minimo = umbral;
                mostrarToast('九 Umbral de stock actualizado', 'success');
                
                // Re-verificar stock cr칤tico con el nuevo umbral
                await verificarStockCritico();
                
            } catch (error) {
                console.error('Error guardando umbral:', error);
                mostrarToast('仇 Error al guardar el umbral', 'error');
            }
        }

        // ============================================
        // FUNCIONES DE RENDERIZADO MEJORADAS
        // ============================================
        function renderizarMenu() {
            const grid = document.getElementById('menuGrid');
            grid.innerHTML = '';
            
            menuItems.forEach(item => {
                // Verificar disponibilidad de ingredientes
                const ingredientesEstado = [];
                let todosDisponibles = true;
                
                if (item.ingredientes) {
                    for (const [ingId, ingInfo] of Object.entries(item.ingredientes)) {
                        const ing = inventarioItems.find(i => i.id === ingId);
                        const disponible = ing && (ing.stock - ing.reservado) >= (ingInfo.cantidad || 0);
                        if (!disponible) todosDisponibles = false;
                        ingredientesEstado.push({
                            nombre: ingInfo.nombre || ingId,
                            disponible: disponible
                        });
                    }
                }
                
                const card = document.createElement('div');
                card.className = 'menu-card';
                card.innerHTML = `
                    <div class="menu-card-image" style="background-image: url('${item.imagen || 'https://via.placeholder.com/300x150?text=Saki+Sushi'}')">
                        <div class="menu-card-actions">
                            <button onclick="editarPlatillo('${item.id}')" title="Editar"><i class="fas fa-edit"></i></button>
                            <button onclick="eliminarPlatillo('${item.id}')" title="Eliminar"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="menu-card-content">
                        <div class="menu-card-header">
                            <span class="menu-card-title">${item.nombre}</span>
                            <span class="${item.disponible && todosDisponibles ? 'disponible-badge' : 'no-disponible-badge'}" title="${!todosDisponibles ? 'Sin stock de ingredientes' : ''}"></span>
                        </div>
                        <div class="menu-card-precio">
                            ${formatUSD(item.precio || 0)} / ${formatBs(usdToBs(item.precio || 0))}
                        </div>
                        <div class="menu-card-stock">Stock: ${item.stock || 0}</div>
                        <div class="menu-card-descripcion">${item.descripcion || ''}</div>
                        <div class="menu-card-ingredientes">
                            ${ingredientesEstado.map(ing => `
                                <span class="${!ing.disponible ? 'sin-stock' : ''}">
                                    ${ing.nombre} ${!ing.disponible ? '(sin stock)' : ''}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function renderizarInventario() {
            const grid = document.getElementById('inventarioGrid');
            grid.innerHTML = '';
            
            inventarioItems.forEach(item => {
                const disponible = item.stock - item.reservado;
                const porcentajeStock = item.minimo > 0 ? (disponible / item.minimo) * 100 : 100;
                const critical = disponible <= item.minimo;
                
                const card = document.createElement('div');
                card.className = 'inventario-card';
                card.innerHTML = `
                    <div class="inventario-header">
                        <span class="inventario-nombre">${item.nombre}</span>
                        <div class="inventario-actions">
                            <button onclick="editarIngrediente('${item.id}')"><i class="fas fa-edit"></i></button>
                            <button onclick="eliminarIngrediente('${item.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="inventario-stock">
                        <strong>Stock:</strong> ${item.stock || 0} ${item.unidad_base || 'unidades'}
                        <small>(Reservado: ${item.reservado || 0} | Disponible: ${disponible})</small>
                        <div class="stock-bar">
                            <div class="stock-fill ${critical ? 'critical' : ''}" style="width: ${Math.min(porcentajeStock, 100)}%"></div>
                        </div>
                    </div>
                    <div class="inventario-info">
                        <div>
                            <strong>M칤nimo:</strong><br>
                            <span class="inventario-minimo">${item.minimo || 0} ${item.unidad_base || 'unidades'}</span>
                        </div>
                        <div>
                            <strong>Costo:</strong><br>
                            ${formatUSD(item.precio_costo || 0)} / ${formatBs(usdToBs(item.precio_costo || 0))}
                        </div>
                        <div>
                            <strong>Venta:</strong><br>
                            ${formatUSD(item.precio_unitario || 0)} / ${formatBs(usdToBs(item.precio_unitario || 0))}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // ============================================
        // FUNCIONES DE USUARIOS
        // ============================================
        async function cargarUsuarios() {
            console.log('游논 Cargando usuarios...');
            try {
                const { data, error } = await window.supabaseClient
                    .from('usuarios')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                usuarios = data || [];
                console.log(`游논 ${usuarios.length} usuarios cargados`);
                renderizarUsuarios();
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                mostrarToast('Error cargando usuarios', 'error');
            }
        }

        function renderizarUsuarios() {
            const grid = document.getElementById('usuariosGrid');
            grid.innerHTML = '';
            
            usuarios.forEach(user => {
                const card = document.createElement('div');
                card.className = 'usuario-card';
                card.innerHTML = `
                    <div class="usuario-header">
                        <span class="usuario-nombre">${user.nombre}</span>
                        <span class="${user.activo ? 'activo' : 'inactivo'}">${user.activo ? 'Activo' : 'Inactivo'}</span>
                    </div>
                    <div class="usuario-username">@${user.username}</div>
                    <div class="usuario-estado">
                        <span>Rol: ${user.rol || 'cajero'}</span>
                    </div>
                    <div class="usuario-actions">
                        <button class="btn-small ${user.activo ? 'danger' : 'success'}" onclick="toggleUsuarioActivo('${user.id}', ${!user.activo})">
                            ${user.activo ? 'Desactivar' : 'Activar'}
                        </button>
                        <button class="btn-small danger" onclick="eliminarUsuario('${user.id}')">
                            Eliminar
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function abrirModalNuevoUsuario() {
            document.getElementById('usuarioForm').reset();
            document.getElementById('usuarioModal').classList.add('active');
        }

        document.getElementById('saveUsuario').addEventListener('click', async () => {
            const nombre = document.getElementById('usuarioNombre').value;
            const username = document.getElementById('usuarioUsername').value;
            const password = document.getElementById('usuarioPassword').value;
            
            if (!nombre || !username || !password) {
                mostrarToast('Completa todos los campos', 'error');
                return;
            }
            
            try {
                const nuevoUsuario = {
                    id: generarId('user_'),
                    nombre: nombre,
                    username: username,
                    password: password,
                    rol: 'cajero',
                    activo: true
                };
                
                const { error } = await window.supabaseClient
                    .from('usuarios')
                    .insert([nuevoUsuario]);
                
                if (error) throw error;
                
                document.getElementById('usuarioModal').classList.remove('active');
                await cargarUsuarios();
                mostrarToast('九 Usuario creado', 'success');
                
            } catch (error) {
                console.error('Error creando usuario:', error);
                mostrarToast('仇 Error al crear usuario', 'error');
            }
        });

        async function toggleUsuarioActivo(userId, activo) {
            try {
                const { error } = await window.supabaseClient
                    .from('usuarios')
                    .update({ activo: activo })
                    .eq('id', userId);
                
                if (error) throw error;
                await cargarUsuarios();
                mostrarToast(`九 Usuario ${activo ? 'activado' : 'desactivado'}`, 'success');
            } catch (error) {
                console.error('Error actualizando usuario:', error);
                mostrarToast('仇 Error al actualizar usuario', 'error');
            }
        }

        async function eliminarUsuario(userId) {
            if (!confirm('쮼st치s seguro de eliminar este usuario? Esta acci칩n no se puede deshacer.')) return;
            
            try {
                const { error } = await window.supabaseClient
                    .from('usuarios')
                    .delete()
                    .eq('id', userId);
                
                if (error) throw error;
                await cargarUsuarios();
                mostrarToast('九 Usuario eliminado', 'success');
            } catch (error) {
                console.error('Error eliminando usuario:', error);
                mostrarToast('仇 Error al eliminar usuario', 'error');
            }
        }

        // ============================================
        // FUNCIONES DE QR
        // ============================================
        async function cargarQRs() {
            console.log('游님 Cargando c칩digos QR...');
            try {
                const { data, error } = await window.supabaseClient
                    .from('codigos_qr')
                    .select('*')
                    .order('fecha', { ascending: false });
                
                if (error) throw error;
                qrCodes = data || [];
                console.log(`游님 ${qrCodes.length} c칩digos QR cargados`);
                renderizarQRs();
            } catch (error) {
                console.error('Error cargando QRs:', error);
                mostrarToast('Error cargando QRs', 'error');
            }
        }

        function renderizarQRs() {
            const grid = document.getElementById('qrGrid');
            grid.innerHTML = '';
            
            qrCodes.forEach(qr => {
                const url = `${window.location.origin}/Cliente/index.html?mesa=${encodeURIComponent(qr.nombre)}`;
                
                const card = document.createElement('div');
                card.className = 'qr-card';
                card.innerHTML = `
                    <div class="qr-image" id="qr-${qr.id}"></div>
                    <div class="qr-nombre">${qr.nombre}</div>
                    <div class="qr-url">${url}</div>
                    <div class="qr-actions">
                        <button onclick="ampliarQR('${qr.id}', '${qr.nombre}', '${url}')" title="Ampliar"><i class="fas fa-expand"></i></button>
                        <button onclick="eliminarQR('${qr.id}')" title="Eliminar"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                grid.appendChild(card);
                
                // Generar QR
                new QRCode(document.getElementById(`qr-${qr.id}`), {
                    text: url,
                    width: 150,
                    height: 150
                });
            });
        }

        async function generarQR() {
            const nombre = document.getElementById('qrNombreMesa').value.trim();
            if (!nombre) {
                mostrarToast('Ingresa un nombre para la mesa', 'error');
                return;
            }
            
            const qr = {
                id: generarId('QR_'),
                nombre: nombre,
                fecha: new Date().toISOString()
            };
            
            try {
                const { error } = await window.supabaseClient
                    .from('codigos_qr')
                    .insert([qr]);
                
                if (error) throw error;
                
                document.getElementById('qrNombreMesa').value = '';
                await cargarQRs();
                mostrarToast('九 QR generado', 'success');
            } catch (error) {
                console.error('Error generando QR:', error);
                mostrarToast('仇 Error al generar QR', 'error');
            }
        }

        function ampliarQR(id, nombre, url) {
            const container = document.getElementById('qrAmpliado');
            container.innerHTML = '';
            
            new QRCode(container, {
                text: url,
                width: 300,
                height: 300
            });
            
            document.getElementById('qrAmpliadoInfo').innerHTML = `
                <strong>${nombre}</strong><br>
                <small>${url}</small>
            `;
            
            document.getElementById('qrAmpliadoModal').classList.add('active');
        }

        async function eliminarQR(id) {
            if (!confirm('쮼st치s seguro de eliminar este c칩digo QR?')) return;
            
            try {
                const { error } = await window.supabaseClient
                    .from('codigos_qr')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                await cargarQRs();
                mostrarToast('九 QR eliminado', 'success');
            } catch (error) {
                console.error('Error eliminando QR:', error);
                mostrarToast('仇 Error al eliminar QR', 'error');
            }
        }

        // ============================================
        // FUNCIONES DE REPORTES
        // ============================================
        async function cargarReportes() {
            console.log('游늵 Cargando reportes...');
            try {
                const desde = document.getElementById('reporteDesde').value;
                const hasta = document.getElementById('reporteHasta').value;
                
                let query = window.supabaseClient
                    .from('pedidos')
                    .select('*')
                    .in('estado', ['cobrado', 'entregado', 'enviado', 'reserva_completada']);
                
                if (desde) {
                    query = query.gte('timestamp', new Date(desde).toISOString());
                }
                if (hasta) {
                    const hastaDate = new Date(hasta);
                    hastaDate.setDate(hastaDate.getDate() + 1);
                    query = query.lt('timestamp', hastaDate.toISOString());
                }
                
                const { data, error } = await query.order('timestamp', { ascending: false });
                
                if (error) throw error;
                
                console.log(`游늵 ${data?.length || 0} pedidos cargados para reportes`);
                actualizarEstadisticasReportes(data || []);
                actualizarGraficos(data || []);
                actualizarTablaVentas(data || []);
            } catch (error) {
                console.error('Error cargando reportes:', error);
                mostrarToast('Error cargando reportes', 'error');
            }
        }

        function actualizarEstadisticasReportes(pedidos) {
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            const ventasHoy = pedidos.filter(p => new Date(p.timestamp) >= hoy)
                .reduce((sum, p) => sum + (p.total || 0), 0);
            
            const semana = new Date();
            semana.setDate(semana.getDate() - 7);
            const ventasSemana = pedidos.filter(p => new Date(p.timestamp) >= semana)
                .reduce((sum, p) => sum + (p.total || 0), 0);
            
            const ticketPromedio = pedidos.length > 0 
                ? pedidos.reduce((sum, p) => sum + (p.total || 0), 0) / pedidos.length 
                : 0;
            
            const platillosCount = {};
            pedidos.forEach(p => {
                if (p.items) {
                    p.items.forEach(item => {
                        platillosCount[item.nombre] = (platillosCount[item.nombre] || 0) + (item.cantidad || 0);
                    });
                }
            });
            
            let platilloTop = '-';
            let maxCount = 0;
            for (const [nombre, count] of Object.entries(platillosCount)) {
                if (count > maxCount) {
                    maxCount = count;
                    platilloTop = nombre;
                }
            }
            
            document.getElementById('ventasDia').textContent = formatUSD(ventasHoy);
            document.getElementById('ventasSemana').textContent = formatUSD(ventasSemana);
            document.getElementById('ticketPromedio').textContent = formatUSD(ticketPromedio);
            document.getElementById('platilloTop').textContent = platilloTop;
        }

        function actualizarGraficos(pedidos) {
            // Ventas 칰ltimos 7 d칤as
            const ventasPorDia = {};
            for (let i = 6; i >= 0; i--) {
                const fecha = new Date();
                fecha.setDate(fecha.getDate() - i);
                const fechaStr = fecha.toISOString().split('T')[0];
                ventasPorDia[fechaStr] = 0;
            }
            
            pedidos.forEach(p => {
                const fecha = new Date(p.timestamp).toISOString().split('T')[0];
                if (ventasPorDia.hasOwnProperty(fecha)) {
                    ventasPorDia[fecha] += p.total || 0;
                }
            });
            
            if (charts.ventas) charts.ventas.destroy();
            charts.ventas = new Chart(document.getElementById('ventasChart'), {
                type: 'line',
                data: {
                    labels: Object.keys(ventasPorDia),
                    datasets: [{
                        label: 'Ventas (USD)',
                        data: Object.values(ventasPorDia),
                        borderColor: 'var(--primary)',
                        backgroundColor: 'rgba(211, 47, 47, 0.1)',
                        tension: 0.1
                    }]
                }
            });
            
            // Ventas por categor칤a
            const categorias = {};
            pedidos.forEach(p => {
                if (p.items) {
                    p.items.forEach(item => {
                        const platillo = menuItems.find(m => m.nombre === item.nombre);
                        const categoria = platillo?.categoria || 'Otros';
                        categorias[categoria] = (categorias[categoria] || 0) + ((item.precioUnitarioUSD || 0) * (item.cantidad || 0));
                    });
                }
            });
            
            if (charts.categorias) charts.categorias.destroy();
            charts.categorias = new Chart(document.getElementById('categoriasChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categorias),
                    datasets: [{
                        data: Object.values(categorias),
                        backgroundColor: ['#D32F2F', '#FF9800', '#1976D2', '#388E3C', '#F57C00', '#6c757d']
                    }]
                }
            });
            
            // M칠todos de pago
            const metodos = {};
            pedidos.forEach(p => {
                if (p.pagos_mixtos && Array.isArray(p.pagos_mixtos)) {
                    p.pagos_mixtos.forEach(pago => {
                        const key = pago.metodo || 'otro';
                        metodos[key] = (metodos[key] || 0) + (pago.monto || 0);
                    });
                } else if (p.metodo_pago) {
                    metodos[p.metodo_pago] = (metodos[p.metodo_pago] || 0) + (p.total || 0);
                }
            });
            
            if (charts.pagos) charts.pagos.destroy();
            charts.pagos = new Chart(document.getElementById('pagosChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(metodos).map(m => {
                        const nombres = {
                            efectivo_bs: 'Efectivo Bs',
                            efectivo_usd: 'Efectivo USD',
                            pago_movil: 'Pago M칩vil',
                            punto_venta: 'Punto de Venta',
                            mixto: 'Mixto',
                            invitacion: 'Invitaci칩n'
                        };
                        return nombres[m] || m;
                    }),
                    datasets: [{
                        label: 'Monto (USD)',
                        data: Object.values(metodos).map(v => v / (configGlobal.tasa_efectiva || 400)),
                        backgroundColor: 'var(--info)'
                    }]
                }
            });
            
            // Ventas por hora
            const horas = {};
            for (let i = 0; i < 24; i++) {
                horas[i] = 0;
            }
            
            pedidos.forEach(p => {
                const hora = new Date(p.timestamp).getHours();
                horas[hora] += p.total || 0;
            });
            
            if (charts.hora) charts.hora.destroy();
            charts.hora = new Chart(document.getElementById('horaChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(horas).map(h => `${h}:00`),
                    datasets: [{
                        label: 'Ventas (USD)',
                        data: Object.values(horas),
                        backgroundColor: 'var(--accent)'
                    }]
                }
            });
        }

        function actualizarTablaVentas(pedidos) {
            const tbody = document.getElementById('ventasTableBody');
            tbody.innerHTML = '';
            
            pedidos.slice(0, 50).forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(p.timestamp).toLocaleDateString()}</td>
                    <td>${p.id}</td>
                    <td>${formatUSD(p.total || 0)}</td>
                    <td>${p.items?.reduce((sum, i) => sum + (i.cantidad || 0), 0) || 0}</td>
                    <td>${p.metodo_pago || 'N/A'}</td>
                    <td>${p.tipo || 'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // ============================================
        // FUNCIONES DE PEDIDOS RECIENTES
        // ============================================
        async function cargarPedidosRecientes() {
            console.log('游늶 Cargando pedidos recientes...');
            try {
                const { data, error } = await window.supabaseClient
                    .from('pedidos')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(5);
                
                if (error) throw error;
                
                const container = document.getElementById('pedidosRecientes');
                container.innerHTML = (data || []).map(p => `
                    <div class="alert-item">
                        <span><strong>${p.id}</strong> - ${formatUSD(p.total || 0)}</span>
                        <small>${new Date(p.timestamp).toLocaleString()}</small>
                    </div>
                `).join('') || '<p>No hay pedidos recientes</p>';
                console.log('游늶 Pedidos recientes cargados');
            } catch (error) {
                console.error('Error cargando pedidos recientes:', error);
            }
        }

        // ============================================
        // FUNCIONES DE CONFIGURACI칍N
        // ============================================
        async function cambiarPassword() {
            const current = document.getElementById('currentPassword').value;
            const nueva = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            
            if (current !== configGlobal.admin_password) {
                mostrarToast('Contrase침a actual incorrecta', 'error');
                return;
            }
            
            if (nueva !== confirm) {
                mostrarToast('Las contrase침as no coinciden', 'error');
                return;
            }
            
            if (nueva.length < 4) {
                mostrarToast('La contrase침a debe tener al menos 4 caracteres', 'error');
                return;
            }
            
            try {
                const { error } = await window.supabaseClient
                    .from('config')
                    .update({ admin_password: nueva })
                    .eq('id', 1);
                
                if (error) throw error;
                
                configGlobal.admin_password = nueva;
                mostrarToast('九 Contrase침a actualizada', 'success');
                
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } catch (error) {
                console.error('Error cambiando contrase침a:', error);
                mostrarToast('仇 Error al cambiar la contrase침a', 'error');
            }
        }

        async function guardarRecoveryEmail() {
            const email = document.getElementById('recoveryEmail').value;
            
            if (!email || !email.includes('@')) {
                mostrarToast('Ingresa un correo v치lido', 'error');
                return;
            }
            
            try {
                const { error } = await window.supabaseClient
                    .from('config')
                    .update({ recovery_email: email })
                    .eq('id', 1);
                
                if (error) throw error;
                mostrarToast('九 Correo de recuperaci칩n guardado', 'success');
            } catch (error) {
                console.error('Error guardando email:', error);
                mostrarToast('仇 Error al guardar el correo', 'error');
            }
        }

        // ============================================
        // FUNCIONES DE SUSCRIPCI칍N EN TIEMPO REAL MEJORADAS
        // ============================================
        function setupRealtimeSubscriptions() {
            console.log('游댃 Configurando suscripciones en tiempo real...');
            
            // Suscripci칩n a cambios en men칰
            window.supabaseClient
                .channel('admin-menu')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'menu'
                }, () => {
                    console.log('游닍 Cambio en men칰, recargando...');
                    cargarMenu();
                })
                .subscribe();
            
            // Suscripci칩n a cambios en inventario (con verificaci칩n cr칤tica)
            window.supabaseClient
                .channel('admin-inventario')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'inventario'
                }, (payload) => {
                    console.log('游닍 Cambio en inventario, recargando...');
                    
                    // Si el stock baj칩 del m칤nimo, verificar cr칤ticos inmediatamente
                    if (payload.eventType === 'UPDATE' && payload.new.stock <= payload.new.minimo) {
                        verificarStockCritico();
                        mostrarToast(`丘멆잺 Stock cr칤tico: ${payload.new.nombre}`, 'warning');
                    }
                    
                    cargarInventario(); // Esto ya llama a verificarStockCritico
                })
                .subscribe();
            
            // NUEVO: Suscripci칩n a cambios en inventario para stock cr칤tico (filtro espec칤fico)
            window.supabaseClient
                .channel('admin-inventario-critical')
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'inventario',
                    filter: 'stock=lte.minimo' // Este filtro puede no funcionar, mejor hacerlo en el callback
                }, (payload) => {
                    // Ya se maneja en el callback anterior
                })
                .subscribe();
            
            // Suscripci칩n a cambios en usuarios
            window.supabaseClient
                .channel('admin-usuarios')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'usuarios'
                }, () => {
                    console.log('游논 Cambio en usuarios, recargando...');
                    cargarUsuarios();
                })
                .subscribe();
            
            // Suscripci칩n a cambios en c칩digos QR
            window.supabaseClient
                .channel('admin-qr')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'codigos_qr'
                }, () => {
                    console.log('游님 Cambio en c칩digos QR, recargando...');
                    cargarQRs();
                })
                .subscribe();
            
            // Suscripci칩n a cambios en pedidos (para dashboard)
            window.supabaseClient
                .channel('admin-pedidos')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'pedidos'
                }, () => {
                    console.log('游늶 Cambio en pedidos, actualizando dashboard...');
                    cargarPedidosRecientes();
                    if (document.getElementById('reportesPane').classList.contains('active')) {
                        cargarReportes();
                    }
                })
                .subscribe();
            
            console.log('九 Suscripciones configuradas');
        }

        // ============================================
        // FUNCIONES DE UTILIDAD Y EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            console.log('游댢 Configurando event listeners de admin...');
            
            // Login
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const password = document.getElementById('adminPassword').value;
                
                try {
                    const { data, error } = await window.supabaseClient
                        .from('config')
                        .select('admin_password')
                        .eq('id', 1)
                        .maybeSingle();
                    
                    if (error) {
                        console.error('Error en consulta:', error);
                        mostrarToast('Error al conectar con la base de datos', 'error');
                        return;
                    }
                    
                    if (!data) {
                        mostrarToast('No se encontr칩 configuraci칩n en la base de datos', 'error');
                        return;
                    }
                    
                    if (data.admin_password !== password) {
                        mostrarToast('Contrase침a incorrecta', 'error');
                        return;
                    }
                    
                    isAdminAuthenticated = true;
                    sessionStorage.setItem('admin_authenticated', 'true');
                    
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('panelContainer').classList.add('active');
                    
                    await cargarConfiguracionInicial();
                    await cargarMenu();
                    await cargarInventario();
                    await cargarUsuarios();
                    await cargarQRs();
                    await cargarReportes();
                    await cargarPedidosRecientes();
                    
                    mostrarToast('九 Bienvenido Administrador', 'success');
                    
                } catch (error) {
                    console.error('Error en login:', error);
                    mostrarToast('Error al iniciar sesi칩n: ' + error.message, 'error');
                }
            });

            // Recuperaci칩n de contrase침a
            document.getElementById('recoveryLink').addEventListener('click', async (e) => {
                e.preventDefault();
                
                const codigo = Math.floor(100000 + Math.random() * 900000);
                console.log('C칩digo de recuperaci칩n (simulado):', codigo);
                
                const codigoIngresado = prompt('Ingresa el c칩digo de recuperaci칩n (revisa la consola):');
                
                if (codigoIngresado === codigo.toString()) {
                    const { data } = await window.supabaseClient
                        .from('config')
                        .select('admin_password, recovery_email')
                        .eq('id', 1)
                        .single();
                    
                    alert(`Tu contrase침a es: ${data.admin_password}\nCorreo de recuperaci칩n: ${data.recovery_email}`);
                } else {
                    mostrarToast('C칩digo incorrecto', 'error');
                }
            });

            // Logout
            document.getElementById('logoutButton').addEventListener('click', () => {
                sessionStorage.removeItem('admin_authenticated');
                isAdminAuthenticated = false;
                mostrarLogin();
                mostrarToast('游녦 Sesi칩n cerrada', 'info');
            });

            // Guardar todo
            document.getElementById('saveAllButton').addEventListener('click', async () => {
                await guardarConfiguracion();
            });

            // Cambios en tasa
            document.getElementById('tasaBaseInput').addEventListener('change', recalcularTasaEfectiva);
            document.getElementById('aumentoDiarioInput').addEventListener('change', recalcularTasaEfectiva);
            document.getElementById('aumentoActivoToggle').addEventListener('change', recalcularTasaEfectiva);

            // Botones de aumento
            document.getElementById('detenerAumentoBtn').addEventListener('click', () => {
                document.getElementById('aumentoActivoToggle').checked = false;
                configGlobal.aumento_detenido = true;
                recalcularTasaEfectiva();
                mostrarToast('낒勇 Aumento detenido', 'info');
            });

            document.getElementById('activarAumentoBtn').addEventListener('click', () => {
                document.getElementById('aumentoActivoToggle').checked = true;
                configGlobal.aumento_detenido = false;
                recalcularTasaEfectiva();
                mostrarToast('郊윒잺 Aumento activado', 'info');
            });

            // Pesta침as
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const tabId = tab.dataset.tab;
                    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                    document.getElementById(tabId + 'Pane').classList.add('active');
                    
                    if (tabId === 'reportes') {
                        cargarReportes();
                    }
                });
            });

            // Cerrar modales
            const closeButtons = [
                'closePlatilloModal', 'cancelPlatillo',
                'closeIngredienteModal', 'cancelIngrediente',
                'closeUsuarioModal', 'cancelUsuario',
                'closeQrAmpliadoModal', 'closeQrAmpliado'
            ];
            
            closeButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.addEventListener('click', () => {
                        const modal = btn.closest('.modal');
                        if (modal) modal.classList.remove('active');
                    });
                }
            });

            // Cerrar modales al hacer clic fuera
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });

            // Preview de imagen
            document.getElementById('platilloImagen').addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('previewImg').src = e.target.result;
                        document.getElementById('imagenPreview').style.display = 'flex';
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });

            document.getElementById('platilloImagenUrl').addEventListener('input', function(e) {
                if (this.value) {
                    document.getElementById('previewImg').src = this.value;
                    document.getElementById('imagenPreview').style.display = 'flex';
                }
            });

            // Guardar platillo
            document.getElementById('savePlatillo').addEventListener('click', guardarPlatillo);
            
            console.log('九 Event listeners de admin configurados');
        }

        // ============================================
        // FUNCIONES DE CONFIGURACI칍N DE TASA
        // ============================================
        function recalcularTasaEfectiva() {
            const tasaBase = parseFloat(document.getElementById('tasaBaseInput').value) || 0;
            const aumentoDiario = parseFloat(document.getElementById('aumentoDiarioInput').value) || 0;
            const aumentoActivo = document.getElementById('aumentoActivoToggle').checked;
            
            let aumentoAcumulado = configGlobal.aumento_acumulado || 0;
            
            if (aumentoActivo && !configGlobal.aumento_detenido) {
                const ahora = new Date();
                if (configGlobal.fecha_ultimo_aumento) {
                    const ultimo = new Date(configGlobal.fecha_ultimo_aumento);
                    const dias = Math.floor((ahora - ultimo) / (1000 * 60 * 60 * 24));
                    aumentoAcumulado += dias * aumentoDiario;
                }
            }
            
            const tasaEfectiva = tasaBase * (1 + aumentoAcumulado / 100);
            
            document.getElementById('tasaEfectivaDisplay').textContent = tasaEfectiva.toFixed(2);
            document.getElementById('aumentoAcumuladoDisplay').textContent = aumentoAcumulado.toFixed(2) + '%';
            
            configGlobal.tasa_cambio = tasaBase;
            configGlobal.aumento_diario = aumentoDiario;
            configGlobal.aumento_activo = aumentoActivo;
            configGlobal.aumento_acumulado = aumentoAcumulado;
            configGlobal.tasa_efectiva = tasaEfectiva;
        }

        async function guardarConfiguracion() {
            try {
                const { error } = await window.supabaseClient
                    .from('config')
                    .update({
                        tasa_cambio: configGlobal.tasa_cambio,
                        aumento_diario: configGlobal.aumento_diario,
                        aumento_activo: configGlobal.aumento_activo,
                        aumento_detenido: configGlobal.aumento_detenido,
                        aumento_acumulado: configGlobal.aumento_acumulado,
                        tasa_efectiva: configGlobal.tasa_efectiva,
                        ultima_actualizacion: new Date().toISOString()
                    })
                    .eq('id', 1);
                
                if (error) throw error;
                mostrarToast('九 Configuraci칩n guardada', 'success');
            } catch (error) {
                console.error('Error guardando configuraci칩n:', error);
                mostrarToast('仇 Error al guardar la configuraci칩n', 'error');
            }
        }

        // ============================================
        // FUNCIONES DE PLATILLOS
        // ============================================
        function abrirModalNuevoPlatillo() {
            document.getElementById('platilloModalTitle').textContent = 'Nuevo Platillo';
            document.getElementById('platilloForm').reset();
            document.getElementById('ingredientesContainer').innerHTML = '';
            limpiarImagenPreview();
            cargarCategoriasSelect();
            platilloEditandoId = null;
            document.getElementById('platilloModal').classList.add('active');
        }

        function cargarCategoriasSelect() {
            const select = document.getElementById('platilloCategoria');
            select.innerHTML = '<option value="">Seleccionar</option>';
            
            Object.keys(categoriasMenu).forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });
            
            select.addEventListener('change', (e) => {
                cargarSubcategoriasSelect(e.target.value);
            });
        }

        function cargarSubcategoriasSelect(categoria) {
            const select = document.getElementById('platilloSubcategoria');
            select.innerHTML = '<option value="">Ninguna</option>';
            
            if (categoria && categoriasMenu[categoria]) {
                categoriasMenu[categoria].forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    select.appendChild(option);
                });
            }
        }

        function agregarIngredienteRow(ingredienteId = '', cantidad = '', unidad = '') {
            const container = document.getElementById('ingredientesContainer');
            const row = document.createElement('div');
            row.className = 'ingrediente-row';
            
            const select = document.createElement('select');
            select.innerHTML = '<option value="">Seleccionar ingrediente</option>';
            inventarioItems.forEach(ing => {
                const option = document.createElement('option');
                option.value = ing.id;
                option.textContent = ing.nombre;
                if (ing.id === ingredienteId) option.selected = true;
                select.appendChild(option);
            });
            
            const inputCantidad = document.createElement('input');
            inputCantidad.type = 'number';
            inputCantidad.step = '0.01';
            inputCantidad.placeholder = 'Cantidad';
            inputCantidad.value = cantidad;
            
            const inputUnidad = document.createElement('input');
            inputUnidad.type = 'text';
            inputUnidad.placeholder = 'Unidad (ej: gramos, unidades)';
            inputUnidad.value = unidad;
            
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '<i class="fas fa-times"></i>';
            removeBtn.onclick = () => row.remove();
            
            row.appendChild(select);
            row.appendChild(inputCantidad);
            row.appendChild(inputUnidad);
            row.appendChild(removeBtn);
            
            container.appendChild(row);
        }

        function limpiarImagenPreview() {
            document.getElementById('platilloImagen').value = '';
            document.getElementById('platilloImagenUrl').value = '';
            document.getElementById('imagenPreview').style.display = 'none';
            document.getElementById('previewImg').src = '';
        }

        function editarPlatillo(id) {
            const platillo = menuItems.find(p => p.id === id);
            if (!platillo) return;
            
            platilloEditandoId = id;
            document.getElementById('platilloModalTitle').textContent = 'Editar Platillo';
            
            limpiarImagenPreview();
            
            document.getElementById('platilloNombre').value = platillo.nombre || '';
            document.getElementById('platilloCategoria').value = platillo.categoria || '';
            document.getElementById('platilloSubcategoria').value = platillo.subcategoria || '';
            document.getElementById('platilloPrecio').value = platillo.precio || '';
            document.getElementById('platilloDescripcion').value = platillo.descripcion || '';
            document.getElementById('platilloDisponible').value = platillo.disponible ? 'true' : 'false';
            
            if (platillo.imagen) {
                document.getElementById('previewImg').src = platillo.imagen;
                document.getElementById('imagenPreview').style.display = 'flex';
                document.getElementById('platilloImagenUrl').value = platillo.imagen;
            }
            
            cargarSubcategoriasSelect(platillo.categoria);
            
            document.getElementById('ingredientesContainer').innerHTML = '';
            if (platillo.ingredientes) {
                Object.entries(platillo.ingredientes).forEach(([ingId, ingInfo]) => {
                    agregarIngredienteRow(ingId, ingInfo.cantidad, ingInfo.unidad);
                });
            }
            
            document.getElementById('platilloModal').classList.add('active');
        }

        async function guardarPlatillo() {
            try {
                const saveBtn = document.getElementById('savePlatillo');
                const originalText = saveBtn.textContent;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
                saveBtn.disabled = true;

                const nombre = document.getElementById('platilloNombre').value;
                const categoria = document.getElementById('platilloCategoria').value;
                const subcategoria = document.getElementById('platilloSubcategoria').value;
                const precio = parseFloat(document.getElementById('platilloPrecio').value);
                const descripcion = document.getElementById('platilloDescripcion').value;
                const disponible = document.getElementById('platilloDisponible').value === 'true';
                
                if (!nombre || !categoria || !precio) {
                    mostrarToast('Completa los campos obligatorios', 'error');
                    return;
                }

                let imagenUrl = '';
                const archivoImagen = document.getElementById('platilloImagen').files[0];
                const imagenUrlInput = document.getElementById('platilloImagenUrl').value;
                
                if (archivoImagen) {
                    const resultado = await subirImagenPlatillo(archivoImagen, 'menu');
                    if (resultado.success) {
                        imagenUrl = resultado.url;
                    } else {
                        mostrarToast('Error al subir la imagen: ' + resultado.error, 'error');
                        return;
                    }
                } else if (imagenUrlInput) {
                    imagenUrl = imagenUrlInput;
                }
                
                const ingredientes = {};
                const ingredienteRows = document.querySelectorAll('#ingredientesContainer .ingrediente-row');
                ingredienteRows.forEach(row => {
                    const select = row.querySelector('select');
                    const cantidad = row.querySelector('input[type="number"]').value;
                    
                    if (select && select.value && cantidad) {
                        ingredientes[select.value] = {
                            cantidad: parseFloat(cantidad),
                            nombre: select.options[select.selectedIndex]?.text || select.value
                        };
                    }
                });
                
                const platillo = {
                    id: platilloEditandoId || generarId('plat_'),
                    nombre: nombre,
                    categoria: categoria,
                    subcategoria: subcategoria || null,
                    precio: precio,
                    descripcion: descripcion,
                    imagen: imagenUrl,
                    ingredientes: ingredientes,
                    disponible: disponible,
                    stock: 0,
                    stock_maximo: 0
                };
                
                let error;
                if (platilloEditandoId) {
                    ({ error } = await window.supabaseClient
                        .from('menu')
                        .update(platillo)
                        .eq('id', platilloEditandoId));
                } else {
                    ({ error } = await window.supabaseClient
                        .from('menu')
                        .insert([platillo]));
                }
                
                if (error) throw error;
                
                document.getElementById('platilloModal').classList.remove('active');
                platilloEditandoId = null;
                limpiarImagenPreview();
                await cargarMenu();
                
                mostrarToast('九 Platillo guardado', 'success');
                
            } catch (error) {
                console.error('Error guardando platillo:', error);
                mostrarToast('仇 Error al guardar el platillo: ' + error.message, 'error');
            } finally {
                const saveBtn = document.getElementById('savePlatillo');
                saveBtn.innerHTML = 'Guardar';
                saveBtn.disabled = false;
            }
        }

        async function eliminarPlatillo(id) {
            if (!confirm('쮼st치s seguro de eliminar este platillo?')) return;
            
            try {
                const platillo = menuItems.find(p => p.id === id);
                if (platillo && platillo.imagen && platillo.imagen.includes('imagenes-platillos')) {
                    await eliminarImagenPlatillo(platillo.imagen);
                }
                
                const { error } = await window.supabaseClient
                    .from('menu')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                await cargarMenu();
                mostrarToast('九 Platillo eliminado', 'success');
            } catch (error) {
                console.error('Error eliminando platillo:', error);
                mostrarToast('仇 Error al eliminar el platillo', 'error');
            }
        }

        // ============================================
        // FUNCIONES DE INVENTARIO
        // ============================================
        function abrirModalNuevoIngrediente() {
            document.getElementById('ingredienteModalTitle').textContent = 'Nuevo Ingrediente';
            document.getElementById('ingredienteForm').reset();
            document.getElementById('ingredienteStock').disabled = true;
            document.getElementById('ingredienteStock').value = 0;
            document.getElementById('stockActualField').classList.add('password-protected');
            document.getElementById('stockUnlock').style.display = 'block';
            document.getElementById('ingredienteModal').classList.add('active');
        }

        function editarIngrediente(id) {
            const ingrediente = inventarioItems.find(i => i.id === id);
            if (!ingrediente) return;
            
            document.getElementById('ingredienteModalTitle').textContent = 'Editar Ingrediente';
            document.getElementById('ingredienteNombre').value = ingrediente.nombre || '';
            document.getElementById('ingredienteStock').value = ingrediente.stock || 0;
            document.getElementById('ingredienteUnidad').value = ingrediente.unidad_base || 'unidades';
            document.getElementById('ingredienteMinimo').value = ingrediente.minimo || 0;
            document.getElementById('ingredienteCosto').value = ingrediente.precio_costo || 0;
            document.getElementById('ingredienteVenta').value = ingrediente.precio_unitario || 0;
            document.getElementById('ingredienteAgregar').value = '';
            
            document.getElementById('ingredienteStock').disabled = true;
            document.getElementById('stockActualField').classList.add('password-protected');
            document.getElementById('stockUnlock').style.display = 'block';
            document.getElementById('stockPassword').value = '';
            
            document.getElementById('ingredienteModal').classList.add('active');
        }

        function desbloquearStock() {
            const password = document.getElementById('stockPassword').value;
            
            if (password === configGlobal.admin_password) {
                document.getElementById('ingredienteStock').disabled = false;
                document.getElementById('stockActualField').classList.remove('password-protected');
                document.getElementById('stockUnlock').style.display = 'none';
            } else {
                mostrarToast('Contrase침a incorrecta', 'error');
            }
        }

        function calcularCostoUnitario() {
            const costoTotal = parseFloat(document.getElementById('costoTotal').value) || 0;
            const cantidad = parseFloat(document.getElementById('cantidadComprada').value) || 1;
            
            if (costoTotal && cantidad) {
                document.getElementById('ingredienteCosto').value = (costoTotal / cantidad).toFixed(2);
            }
        }

        function agregarStock(ingredienteId) {
            const ingrediente = inventarioItems.find(i => i.id === ingredienteId);
            if (ingrediente) {
                editarIngrediente(ingredienteId);
                setTimeout(() => {
                    document.getElementById('ingredienteAgregar').focus();
                }, 500);
            }
        }

        document.getElementById('saveIngrediente').addEventListener('click', async () => {
            const id = document.getElementById('ingredienteModalTitle').textContent === 'Nuevo Ingrediente' 
                ? generarId('ing_') 
                : (inventarioItems.find(i => i.nombre === document.getElementById('ingredienteNombre').value)?.id || generarId('ing_'));
            
            const nombre = document.getElementById('ingredienteNombre').value;
            const stockActual = parseFloat(document.getElementById('ingredienteStock').value) || 0;
            const agregar = parseFloat(document.getElementById('ingredienteAgregar').value) || 0;
            const unidad = document.getElementById('ingredienteUnidad').value;
            const minimo = parseFloat(document.getElementById('ingredienteMinimo').value) || 0;
            const costo = parseFloat(document.getElementById('ingredienteCosto').value) || 0;
            const venta = parseFloat(document.getElementById('ingredienteVenta').value) || 0;
            
            if (!nombre) {
                mostrarToast('Ingresa el nombre del ingrediente', 'error');
                return;
            }
            
            try {
                const ingrediente = {
                    id: id,
                    nombre: nombre,
                    stock: stockActual + agregar,
                    reservado: 0,
                    unidad_base: unidad,
                    minimo: minimo,
                    precio_costo: costo,
                    precio_unitario: venta
                };
                
                let error;
                const existe = inventarioItems.some(i => i.id === id);
                
                if (existe) {
                    ({ error } = await window.supabaseClient
                        .from('inventario')
                        .update(ingrediente)
                        .eq('id', id));
                } else {
                    ({ error } = await window.supabaseClient
                        .from('inventario')
                        .insert([ingrediente]));
                }
                
                if (error) throw error;
                
                document.getElementById('ingredienteModal').classList.remove('active');
                await cargarInventario();
                mostrarToast('九 Ingrediente guardado', 'success');
                
            } catch (error) {
                console.error('Error guardando ingrediente:', error);
                mostrarToast('仇 Error al guardar ingrediente', 'error');
            }
        });

        async function eliminarIngrediente(id) {
            if (!confirm('쮼st치s seguro de eliminar este ingrediente? Se perder치 de todos los platillos que lo usen.')) return;
            
            try {
                const { error } = await window.supabaseClient
                    .from('inventario')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                await cargarInventario();
                mostrarToast('九 Ingrediente eliminado', 'success');
            } catch (error) {
                console.error('Error eliminando ingrediente:', error);
                mostrarToast('仇 Error al eliminar ingrediente', 'error');
            }
        }

        // ============================================
        // FUNCIONES DE ESTAD칈STICAS DEL DASHBOARD
        // ============================================
        async function actualizarProductosActivos() {
            const activos = menuItems.filter(m => m.disponible).length;
            document.getElementById('productosActivos').textContent = activos;
        }

        async function actualizarAlertasStock() {
            const alertas = inventarioItems.filter(i => i.stock <= i.minimo).length;
            document.getElementById('alertasStock').textContent = alertas;
        }
    </script>
</body>
</html>