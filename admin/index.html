<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saki Sushi - Administración</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* Estilos generales */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; }
        .login-container { max-width: 300px; margin: 100px auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .login-container input { width: 100%; padding: 0.5rem; margin: 0.5rem 0; }
        .login-container button { width: 100%; padding: 0.5rem; background: #b22222; color: white; border: none; cursor: pointer; }
        .panel { display: none; }
        .panel.visible { display: block; }
        header { background: #b22222; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .tasa-bar { background: #333; color: white; padding: 0.5rem 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .tasa-bar input, .tasa-bar select { padding: 0.3rem; border-radius: 4px; border: none; }
        .tabs { display: flex; background: #ddd; flex-wrap: wrap; }
        .tab { padding: 0.8rem 1.5rem; cursor: pointer; background: #eee; border: none; }
        .tab.active { background: white; font-weight: bold; }
        .tab-content { display: none; padding: 1rem; }
        .tab-content.active { display: block; }
        .cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem; }
        .card { background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn { background: #b22222; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin: 0.2rem; }
        .btn-secondary { background: #666; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 0.5rem; border-bottom: 1px solid #ddd; text-align: left; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 8px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .qr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .qr-item { background: white; padding: 1rem; text-align: center; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        .qr-item img { width: 100%; max-width: 150px; }
        .qr-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); color: white; display: flex; flex-direction: column; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .qr-item:hover .qr-overlay { opacity: 1; }
        .chart-container { width: 100%; height: 300px; margin-bottom: 2rem; }
    </style>
</head>
<body>
    <!-- Login -->
    <div class="login-container" id="loginView">
        <h2>Acceso Administrador</h2>
        <input type="password" id="adminPassword" placeholder="Contraseña">
        <button onclick="loginAdmin()">Ingresar</button>
        <p id="loginError" style="color:red;"></p>
    </div>

    <!-- Panel principal -->
    <div class="panel" id="panelView">
        <header>
            <div><i class="fas fa-crown"></i> Saki Sushi - Administración</div>
            <div>
                <span id="syncStatus"><i class="fas fa-sync-alt"></i> Sincronizado</span>
                <button onclick="verCliente()">Ver Menú Cliente</button>
                <button onclick="verCajero()">Panel Cajero</button>
                <button onclick="guardarTodo()">Guardar Todo</button>
                <button onclick="logoutAdmin()">Salir</button>
            </div>
        </header>

        <!-- Barra de tasa -->
        <div class="tasa-bar">
            <label>Tasa base USD: <input type="number" id="tasaBase" step="0.01" value="40" onchange="actualizarTasa()"></label>
            <label>Aumento diario %: <input type="number" id="aumentoDiario" step="0.1" value="1" onchange="actualizarTasa()"></label>
            <label><input type="checkbox" id="aumentoActivo" onchange="toggleAumento()"> Aumento automático</label>
            <button id="detenerBtn" onclick="detenerAumento()">Detener por completo</button>
            <button id="activarBtn" style="display:none;" onclick="activarAumento()">Activar por completo</button>
            <span>Tasa efectiva: <span id="tasaEfectiva">40.00</span></span>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="cambiarTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="cambiarTab('menu')">Menú & Precios</button>
            <button class="tab" onclick="cambiarTab('inventario')">Inventario</button>
            <button class="tab" onclick="cambiarTab('usuarios')">Usuarios</button>
            <button class="tab" onclick="cambiarTab('config')">Configuración</button>
            <button class="tab" onclick="cambiarTab('qr')">Códigos QR</button>
            <button class="tab" onclick="cambiarTab('reportes')">Reportes</button>
        </div>

        <!-- Dashboard -->
        <div class="tab-content active" id="tabDashboard">
            <div class="cards">
                <div class="card"><h3>Ventas hoy</h3><p id="ventasHoy">0 USD</p></div>
                <div class="card"><h3>Tasa efectiva</h3><p id="tasaCard">40.00</p></div>
                <div class="card"><h3>Productos activos</h3><p id="productosActivos">0</p></div>
                <div class="card"><h3>Alertas stock</h3><p id="alertasStock">0</p></div>
            </div>
            <h3>Últimos 5 pedidos</h3>
            <table id="ultimosPedidos">
                <thead><tr><th>ID</th><th>Fecha</th><th>Total USD</th><th>Estado</th></tr></thead>
                <tbody></tbody>
            </table>
            <h3>Ingredientes con stock crítico</h3>
            <table id="stockCritico">
                <thead><tr><th>Ingrediente</th><th>Stock</th><th>Mínimo</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Menú & Precios -->
        <div class="tab-content" id="tabMenu">
            <button class="btn" onclick="abrirModalPlatillo()">+ Nuevo Platillo</button>
            <table id="menuTable">
                <thead><tr><th>Imagen</th><th>Nombre</th><th>Precio USD</th><th>Precio Bs</th><th>Stock</th><th>Disponible</th><th>Acciones</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Inventario -->
        <div class="tab-content" id="tabInventario">
            <button class="btn" onclick="abrirModalIngrediente()">+ Nuevo Ingrediente</button>
            <table id="inventarioTable">
                <thead><tr><th>Nombre</th><th>Stock</th><th>Unidad</th><th>Mínimo</th><th>Costo USD</th><th>Precio venta USD</th><th>Barra</th><th>Acciones</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Usuarios -->
        <div class="tab-content" id="tabUsuarios">
            <h3>Nuevo Cajero</h3>
            <input type="text" id="nuevoNombre" placeholder="Nombre">
            <input type="text" id="nuevoUsername" placeholder="Username">
            <input type="password" id="nuevoPassword" placeholder="Contraseña">
            <button class="btn" onclick="crearUsuario()">Crear</button>
            <h3>Lista de Cajeros</h3>
            <table id="usuariosTable">
                <thead><tr><th>Nombre</th><th>Username</th><th>Activo</th><th>Acciones</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Configuración -->
        <div class="tab-content" id="tabConfig">
            <h3>Cambiar contraseña de admin</h3>
            <input type="password" id="currentPass" placeholder="Actual">
            <input type="password" id="newPass" placeholder="Nueva">
            <input type="password" id="confirmPass" placeholder="Confirmar">
            <button class="btn" onclick="cambiarPassword()">Cambiar</button>
            <h3>Correo de recuperación</h3>
            <input type="email" id="recoveryEmail" placeholder="correo@ejemplo.com">
            <button class="btn" onclick="guardarRecoveryEmail()">Guardar</button>
        </div>

        <!-- Códigos QR -->
        <div class="tab-content" id="tabQR">
            <h3>Generar QR para mesa</h3>
            <input type="text" id="nombreMesa" placeholder="Ej: Mesa 1">
            <button class="btn" onclick="generarQR()">Generar</button>
            <div class="qr-grid" id="qrGrid"></div>
        </div>

        <!-- Reportes -->
        <div class="tab-content" id="tabReportes">
            <div class="cards">
                <div class="card"><h3>Ventas hoy</h3><p id="repVentasHoy">0 USD</p></div>
                <div class="card"><h3>Ventas semana</h3><p id="repVentasSemana">0 USD</p></div>
                <div class="card"><h3>Ticket promedio</h3><p id="repTicketPromedio">0 USD</p></div>
                <div class="card"><h3>Platillo más vendido</h3><p id="repPlatilloTop">-</p></div>
            </div>
            <div class="chart-container">
                <canvas id="chartVentasDiarias"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="chartCategorias"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="chartMetodosPago"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="chartHoras"></canvas>
            </div>
            <h3>Transacciones</h3>
            <table id="transaccionesTable">
                <thead><tr><th>Fecha</th><th>Pedido ID</th><th>Cajero</th><th>Items</th><th>Total USD</th><th>Método</th><th>Estado</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Modal Platillo -->
    <div class="modal" id="modalPlatillo">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalPlatillo()">&times;</span>
            <h3 id="modalPlatilloTitulo">Nuevo Platillo</h3>
            <form id="formPlatillo">
                <input type="hidden" id="platilloId">
                <div class="form-group"><label>Nombre</label><input type="text" id="platilloNombre" required></div>
                <div class="form-group"><label>Categoría</label>
                    <select id="platilloCategoria" onchange="cambiarCategoria()">
                        <option value="entradas">Entradas</option>
                        <option value="sushi">Sushi</option>
                        <option value="rolls">Rolls</option>
                        <option value="tragos">Tragos</option>
                        <option value="pokes">Pokes</option>
                        <option value="ensaladas">Ensaladas</option>
                        <option value="china">Comida China</option>
                        <option value="japonesa">Comida Japonesa</option>
                        <option value="ninos">Para Niños</option>
                        <option value="ejecutivo">Combo Ejecutivo</option>
                    </select>
                </div>
                <div class="form-group" id="subcategoriaGroup" style="display:none;"><label>Subcategoría</label>
                    <select id="platilloSubcategoria"></select>
                </div>
                <div class="form-group"><label>Precio USD</label><input type="number" step="0.01" id="platilloPrecio" required></div>
                <div class="form-group"><label>Descripción</label><textarea id="platilloDescripcion"></textarea></div>
                <div class="form-group"><label>Imagen (URL o subir)</label>
                    <input type="file" id="platilloImagenFile" accept="image/*">
                    <input type="text" id="platilloImagenUrl" placeholder="O pegar URL">
                    <img id="platilloImagenPreview" style="max-width:100px; display:none;">
                </div>
                <h4>Ingredientes</h4>
                <div id="ingredientesList"></div>
                <button type="button" class="btn" onclick="agregarIngredienteFila()">+ Agregar Ingrediente</button>
                <p>Stock calculado: <span id="stockCalculado">0</span></p>
                <button type="submit" class="btn">Guardar</button>
            </form>
        </div>
    </div>

    <!-- Modal Ingrediente -->
    <div class="modal" id="modalIngrediente">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalIngrediente()">&times;</span>
            <h3 id="modalIngredienteTitulo">Nuevo Ingrediente</h3>
            <form id="formIngrediente">
                <input type="hidden" id="ingredienteId">
                <div class="form-group"><label>Nombre</label><input type="text" id="ingredienteNombre" required></div>
                <div class="form-group"><label>Unidad</label>
                    <select id="ingredienteUnidad">
                        <option value="unidades">Unidades</option>
                        <option value="kilogramos">Kilogramos</option>
                        <option value="litros">Litros</option>
                    </select>
                </div>
                <div class="form-group"><label>Stock actual</label><input type="number" step="0.01" id="ingredienteStock" disabled></div>
                <div class="form-group"><label>Stock nuevo a agregar</label><input type="number" step="0.01" id="ingredienteStockNuevo" oninput="calcularStockTotal()"></div>
                <div class="form-group"><label>Stock total resultante</label><input type="number" step="0.01" id="ingredienteStockTotal" readonly></div>
                <div class="form-group"><label>Stock mínimo</label><input type="number" step="0.01" id="ingredienteMinimo" required></div>
                <h4>Calculadora de costo</h4>
                <div class="form-group"><label>Costo total de compra ($)</label><input type="number" step="0.01" id="costoTotalCompra" oninput="calcularPrecioUnitario()"></div>
                <div class="form-group"><label>Cantidad comprada</label><input type="number" step="0.01" id="cantidadComprada" oninput="calcularPrecioUnitario()"></div>
                <div class="form-group"><label>Precio de costo unitario ($)</label><input type="number" step="0.01" id="precioCostoUnitario" readonly></div>
                <div class="form-group"><label>Precio de venta unitario ($)</label><input type="number" step="0.01" id="precioVentaUnitario" required></div>
                <button type="submit" class="btn">Guardar</button>
                <button type="button" class="btn btn-secondary" id="btnEliminarIngrediente" onclick="eliminarIngrediente()" style="display:none;">Eliminar</button>
            </form>
        </div>
    </div>

    <!-- Modal Confirmación (para vueltos, etc) -->
    <div class="modal" id="modalConfirm">
        <div class="modal-content">
            <p id="confirmMsg"></p>
            <button class="btn" onclick="confirmAction()">Aceptar</button>
            <button class="btn btn-secondary" onclick="cerrarModalConfirm()">Cancelar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://tu-proyecto.supabase.co';
        const SUPABASE_ANON_KEY = 'tu-anon-key';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let config = null;
        let menu = [];
        let inventario = [];
        let usuarios = [];
        let pedidos = [];
        let codigosQR = [];
        let tasaEfectiva = 40;
        let accionConfirm = null;

        // Login
        async function loginAdmin() {
            const pass = document.getElementById('adminPassword').value;
            const { data, error } = await supabase.from('config').select('admin_password').eq('id',1).single();
            if (error || data.admin_password !== pass) {
                document.getElementById('loginError').innerText = 'Contraseña incorrecta';
            } else {
                document.getElementById('loginView').style.display = 'none';
                document.getElementById('panelView').classList.add('visible');
                iniciarPanel();
            }
        }

        function logoutAdmin() {
            document.getElementById('loginView').style.display = 'block';
            document.getElementById('panelView').classList.remove('visible');
        }

        function verCliente() { window.open('cliente.html', '_blank'); }
        function verCajero() { window.open('cajero.html', '_blank'); }

        async function iniciarPanel() {
            await cargarConfig();
            await cargarMenu();
            await cargarInventario();
            await cargarUsuarios();
            await cargarPedidos();
            await cargarQR();
            suscribirseCambios();
            renderDashboard();
            renderMenuTable();
            renderInventarioTable();
            renderUsuariosTable();
            renderQRGrid();
            actualizarTasaUI();
        }

        async function cargarConfig() {
            const { data } = await supabase.from('config').select('*').eq('id',1).single();
            config = data;
            tasaEfectiva = data.tasa_efectiva;
            document.getElementById('tasaBase').value = data.tasa_cambio;
            document.getElementById('aumentoDiario').value = data.aumento_diario;
            document.getElementById('aumentoActivo').checked = data.aumento_activo;
            if (data.aumento_detenido) {
                document.getElementById('detenerBtn').style.display = 'none';
                document.getElementById('activarBtn').style.display = 'inline-block';
            } else {
                document.getElementById('detenerBtn').style.display = 'inline-block';
                document.getElementById('activarBtn').style.display = 'none';
            }
            document.getElementById('recoveryEmail').value = data.recovery_email || '';
        }

        async function cargarMenu() {
            const { data } = await supabase.from('menu').select('*');
            menu = data || [];
        }

        async function cargarInventario() {
            const { data } = await supabase.from('inventario').select('*');
            inventario = data || [];
        }

        async function cargarUsuarios() {
            const { data } = await supabase.from('usuarios').select('*').eq('rol', 'cajero');
            usuarios = data || [];
        }

        async function cargarPedidos() {
            const { data } = await supabase.from('pedidos').select('*').order('timestamp', { ascending: false }).limit(100);
            pedidos = data || [];
        }

        async function cargarQR() {
            const { data } = await supabase.from('codigos_qr').select('*');
            codigosQR = data || [];
        }

        function suscribirseCambios() {
            supabase.channel('admin-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'config' }, payload => {
                    config = payload.new;
                    tasaEfectiva = payload.new.tasa_efectiva;
                    actualizarTasaUI();
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'menu' }, () => cargarMenu().then(() => renderMenuTable()))
                .on('postgres_changes', { event: '*', schema: 'public', table: 'inventario' }, () => cargarInventario().then(() => renderInventarioTable()))
                .on('postgres_changes', { event: '*', schema: 'public', table: 'usuarios' }, () => cargarUsuarios().then(() => renderUsuariosTable()))
                .on('postgres_changes', { event: '*', schema: 'public', table: 'codigos_qr' }, () => cargarQR().then(() => renderQRGrid()))
                .subscribe();
        }

        // ========== TASA ==========
        function actualizarTasa() {
            const tasa = parseFloat(document.getElementById('tasaBase').value);
            const aumento = parseFloat(document.getElementById('aumentoDiario').value);
            const activo = document.getElementById('aumentoActivo').checked;
            // Actualizar en DB
            supabase.from('config').update({
                tasa_cambio: tasa,
                aumento_diario: aumento,
                aumento_activo: activo,
                ultima_actualizacion: new Date().toISOString()
            }).eq('id',1).then(() => {
                // La tasa efectiva se recalcula por trigger
            });
        }

        function toggleAumento() {
            actualizarTasa();
        }

        function detenerAumento() {
            supabase.from('config').update({ aumento_detenido: true, aumento_activo: false }).eq('id',1).then(() => {
                document.getElementById('detenerBtn').style.display = 'none';
                document.getElementById('activarBtn').style.display = 'inline-block';
            });
        }

        function activarAumento() {
            supabase.from('config').update({ aumento_detenido: false, aumento_activo: true, fecha_inicio_aumento: new Date().toISOString() }).eq('id',1).then(() => {
                document.getElementById('detenerBtn').style.display = 'inline-block';
                document.getElementById('activarBtn').style.display = 'none';
            });
        }

        function actualizarTasaUI() {
            document.getElementById('tasaEfectiva').innerText = tasaEfectiva.toFixed(2);
            document.getElementById('tasaCard').innerText = tasaEfectiva.toFixed(2);
        }

        // ========== DASHBOARD ==========
        function renderDashboard() {
            const hoy = new Date().toISOString().split('T')[0];
            const ventasHoy = pedidos.filter(p => p.estado === 'cobrado' && p.fecha_cobro && p.fecha_cobro.startsWith(hoy)).reduce((acc, p) => acc + p.total, 0);
            document.getElementById('ventasHoy').innerText = ventasHoy.toFixed(2) + ' USD';
            document.getElementById('productosActivos').innerText = menu.filter(m => m.disponible).length;
            const alertas = inventario.filter(i => i.stock < i.minimo).length;
            document.getElementById('alertasStock').innerText = alertas;

            const ultimos = pedidos.slice(0,5);
            let html = '';
            ultimos.forEach(p => {
                html += `<tr><td>${p.id}</td><td>${new Date(p.timestamp).toLocaleString()}</td><td>${p.total.toFixed(2)}</td><td>${p.estado}</td></tr>`;
            });
            document.querySelector('#ultimosPedidos tbody').innerHTML = html;

            const criticos = inventario.filter(i => i.stock < i.minimo);
            let critHtml = '';
            criticos.forEach(i => {
                critHtml += `<tr><td>${i.nombre}</td><td>${i.stock}</td><td>${i.minimo}</td></tr>`;
            });
            document.querySelector('#stockCritico tbody').innerHTML = critHtml;
        }

        // ========== MENÚ ==========
        function renderMenuTable() {
            const tbody = document.querySelector('#menuTable tbody');
            tbody.innerHTML = '';
            menu.forEach(p => {
                const precioBs = (p.precio * tasaEfectiva).toFixed(2);
                const ingredientesTooltip = Object.keys(p.ingredientes || {}).map(id => {
                    const ing = inventario.find(i => i.id === id);
                    return ing ? `${ing.nombre}: ${ing.stock >= p.ingredientes[id].cantidad ? '✅' : '❌'}` : '';
                }).join(', ');
                tbody.innerHTML += `<tr>
                    <td><img src="${p.imagen || 'https://via.placeholder.com/50'}" width="50"></td>
                    <td title="${ingredientesTooltip}">${p.nombre}</td>
                    <td>${p.precio}</td>
                    <td>${precioBs}</td>
                    <td>${p.stock}</td>
                    <td><input type="checkbox" ${p.disponible ? 'checked' : ''} onchange="toggleDisponible('${p.id}', this.checked)"></td>
                    <td><button onclick="editarPlatillo('${p.id}')"><i class="fas fa-edit"></i></button> <button onclick="eliminarPlatillo('${p.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            });
        }

        function toggleDisponible(id, disponible) {
            supabase.from('menu').update({ disponible }).eq('id', id);
        }

        function abrirModalPlatillo() {
            document.getElementById('modalPlatilloTitulo').innerText = 'Nuevo Platillo';
            document.getElementById('formPlatillo').reset();
            document.getElementById('platilloId').value = '';
            document.getElementById('ingredientesList').innerHTML = '';
            document.getElementById('modalPlatillo').style.display = 'flex';
        }

        function cerrarModalPlatillo() {
            document.getElementById('modalPlatillo').style.display = 'none';
        }

        function cambiarCategoria() {
            const cat = document.getElementById('platilloCategoria').value;
            const subGroup = document.getElementById('subcategoriaGroup');
            const subSelect = document.getElementById('platilloSubcategoria');
            let opciones = [];
            if (cat === 'rolls') opciones = ['rolls-frios', 'rolls-tempura'];
            else if (cat === 'china') opciones = ['arroz-chino', 'arroz-cantones', 'chopsuey', 'lomey', 'chow-mein', 'fideos-arroz', 'tallarines-cantones', 'mariscos', 'foo-yung', 'sopas', 'entremeses'];
            else if (cat === 'japonesa') opciones = ['yakimeshi', 'yakisoba', 'pasta-udon', 'churrasco'];
            else {
                subGroup.style.display = 'none';
                return;
            }
            subGroup.style.display = 'block';
            subSelect.innerHTML = opciones.map(o => `<option value="${o}">${o}</option>`).join('');
        }

        function agregarIngredienteFila() {
            const container = document.getElementById('ingredientesList');
            const div = document.createElement('div');
            div.className = 'ingrediente-fila';
            div.innerHTML = `
                <input type="text" placeholder="Nombre ingrediente" list="ingredientesLista" onchange="buscarIngrediente(this)">
                <input type="number" step="0.01" placeholder="Cantidad" onchange="calcularStockPlatilloLocal()">
                <span class="unidad"></span>
                <label><input type="checkbox" checked> Obligatorio</label>
                <button type="button" onclick="this.parentElement.remove(); calcularStockPlatilloLocal();"><i class="fas fa-trash"></i></button>
            `;
            container.appendChild(div);
        }

        function buscarIngrediente(input) {
            const nombre = input.value;
            const ing = inventario.find(i => i.nombre.toLowerCase() === nombre.toLowerCase());
            if (ing) {
                input.dataset.id = ing.id;
                input.value = ing.nombre;
                const fila = input.parentElement;
                fila.querySelector('.unidad').innerText = ing.unidad;
                fila.querySelector('input[type="number"]').step = ing.unidad === 'unidades' ? 1 : 0.01;
            }
        }

        function calcularStockPlatilloLocal() {
            // Simulación: calcular mínimo de ingredientes
            let stock = Infinity;
            document.querySelectorAll('.ingrediente-fila').forEach(fila => {
                const ingId = fila.querySelector('input[list]')?.dataset?.id;
                const cantidad = parseFloat(fila.querySelector('input[type="number"]').value);
                if (ingId && cantidad > 0) {
                    const ing = inventario.find(i => i.id === ingId);
                    if (ing) {
                        const posible = Math.floor(ing.stock / cantidad);
                        if (posible < stock) stock = posible;
                    }
                }
            });
            if (stock === Infinity) stock = 0;
            document.getElementById('stockCalculado').innerText = stock;
        }

        document.getElementById('formPlatillo').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('platilloId').value || 'plat_' + Date.now();
            const nombre = document.getElementById('platilloNombre').value;
            const categoria = document.getElementById('platilloCategoria').value;
            const subcategoria = document.getElementById('subcategoriaGroup').style.display !== 'none' ? document.getElementById('platilloSubcategoria').value : null;
            const precio = parseFloat(document.getElementById('platilloPrecio').value);
            const descripcion = document.getElementById('platilloDescripcion').value;
            let imagen = document.getElementById('platilloImagenUrl').value;
            // Si hay archivo, subirlo
            const file = document.getElementById('platilloImagenFile').files[0];
            if (file) {
                const fileName = `platillos/${id}_${file.name}`;
                const { error } = await supabase.storage.from('platillos').upload(fileName, file);
                if (!error) {
                    imagen = supabase.storage.from('platillos').getPublicUrl(fileName).data.publicUrl;
                }
            }

            // Construir ingredientes
            const ingredientes = {};
            document.querySelectorAll('.ingrediente-fila').forEach(fila => {
                const ingId = fila.querySelector('input[list]')?.dataset?.id;
                const cantidad = parseFloat(fila.querySelector('input[type="number"]').value);
                const obligatorio = fila.querySelector('input[type="checkbox"]').checked;
                const unidad = fila.querySelector('.unidad').innerText;
                if (ingId && cantidad > 0) {
                    ingredientes[ingId] = { cantidad, obligatorio, unidad };
                }
            });

            const stockCalculado = parseInt(document.getElementById('stockCalculado').innerText);

            const platillo = {
                id,
                nombre,
                categoria,
                subcategoria,
                precio,
                descripcion,
                imagen,
                ingredientes,
                stock: stockCalculado,
                stock_maximo: stockCalculado,
                disponible: true,
                created_at: new Date().toISOString()
            };

            const { error } = await supabase.from('menu').upsert([platillo]);
            if (error) alert('Error: ' + error.message);
            else cerrarModalPlatillo();
        });

        function editarPlatillo(id) {
            const p = menu.find(m => m.id === id);
            if (!p) return;
            document.getElementById('modalPlatilloTitulo').innerText = 'Editar Platillo';
            document.getElementById('platilloId').value = p.id;
            document.getElementById('platilloNombre').value = p.nombre;
            document.getElementById('platilloCategoria').value = p.categoria;
            if (p.subcategoria) {
                document.getElementById('subcategoriaGroup').style.display = 'block';
                document.getElementById('platilloSubcategoria').innerHTML = `<option value="${p.subcategoria}">${p.subcategoria}</option>`;
            } else {
                document.getElementById('subcategoriaGroup').style.display = 'none';
            }
            document.getElementById('platilloPrecio').value = p.precio;
            document.getElementById('platilloDescripcion').value = p.descripcion || '';
            document.getElementById('platilloImagenUrl').value = p.imagen || '';
            document.getElementById('platilloImagenPreview').src = p.imagen || '';
            document.getElementById('platilloImagenPreview').style.display = p.imagen ? 'block' : 'none';
            // Ingredientes
            const container = document.getElementById('ingredientesList');
            container.innerHTML = '';
            for (let [ingId, data] of Object.entries(p.ingredientes || {})) {
                const ing = inventario.find(i => i.id === ingId);
                if (ing) {
                    const div = document.createElement('div');
                    div.className = 'ingrediente-fila';
                    div.innerHTML = `
                        <input type="text" value="${ing.nombre}" list="ingredientesLista" onchange="buscarIngrediente(this)" data-id="${ingId}">
                        <input type="number" step="${ing.unidad==='unidades'?1:0.01}" value="${data.cantidad}" onchange="calcularStockPlatilloLocal()">
                        <span class="unidad">${ing.unidad}</span>
                        <label><input type="checkbox" ${data.obligatorio ? 'checked' : ''}> Obligatorio</label>
                        <button type="button" onclick="this.parentElement.remove(); calcularStockPlatilloLocal();"><i class="fas fa-trash"></i></button>
                    `;
                    container.appendChild(div);
                }
            }
            calcularStockPlatilloLocal();
            document.getElementById('modalPlatillo').style.display = 'flex';
        }

        function eliminarPlatillo(id) {
            if (confirm('¿Eliminar platillo?')) {
                supabase.from('menu').delete().eq('id', id);
            }
        }

        // ========== INVENTARIO ==========
        function renderInventarioTable() {
            const tbody = document.querySelector('#inventarioTable tbody');
            tbody.innerHTML = '';
            inventario.forEach(i => {
                const porcentaje = (i.stock / i.minimo) * 100;
                let color = 'green';
                if (i.stock < i.minimo) color = 'red';
                else if (i.stock < i.minimo * 2) color = 'orange';
                const barra = `<div style="background:${color}; width:${Math.min(porcentaje,100)}%; height:20px;"></div>`;
                tbody.innerHTML += `<tr>
                    <td>${i.nombre}</td>
                    <td>${i.stock} ${i.unidad}</td>
                    <td>${i.minimo}</td>
                    <td>${i.precio_costo} USD</td>
                    <td>${i.precio_unitario} USD</td>
                    <td>${barra}</td>
                    <td><button onclick="editarIngrediente('${i.id}')"><i class="fas fa-edit"></i></button></td>
                </tr>`;
            });
        }

        function abrirModalIngrediente() {
            document.getElementById('modalIngredienteTitulo').innerText = 'Nuevo Ingrediente';
            document.getElementById('formIngrediente').reset();
            document.getElementById('ingredienteId').value = '';
            document.getElementById('btnEliminarIngrediente').style.display = 'none';
            document.getElementById('modalIngrediente').style.display = 'flex';
        }

        function cerrarModalIngrediente() {
            document.getElementById('modalIngrediente').style.display = 'none';
        }

        function calcularStockTotal() {
            const stockActual = parseFloat(document.getElementById('ingredienteStock').value) || 0;
            const nuevo = parseFloat(document.getElementById('ingredienteStockNuevo').value) || 0;
            document.getElementById('ingredienteStockTotal').value = stockActual + nuevo;
        }

        function calcularPrecioUnitario() {
            const total = parseFloat(document.getElementById('costoTotalCompra').value) || 0;
            const cantidad = parseFloat(document.getElementById('cantidadComprada').value) || 0;
            if (cantidad > 0) {
                document.getElementById('precioCostoUnitario').value = (total / cantidad).toFixed(2);
            }
        }

        document.getElementById('formIngrediente').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('ingredienteId').value || 'ing_' + Date.now();
            const nombre = document.getElementById('ingredienteNombre').value;
            const unidad = document.getElementById('ingredienteUnidad').value;
            const stockNuevo = parseFloat(document.getElementById('ingredienteStockNuevo').value) || 0;
            const stockActual = parseFloat(document.getElementById('ingredienteStock').value) || 0;
            const stock = stockActual + stockNuevo;
            const minimo = parseFloat(document.getElementById('ingredienteMinimo').value);
            const precioCosto = parseFloat(document.getElementById('precioCostoUnitario').value) || 0;
            const precioVenta = parseFloat(document.getElementById('precioVentaUnitario').value);

            const ingrediente = {
                id,
                nombre,
                unidad,
                stock,
                minimo,
                precio_costo: precioCosto,
                precio_unitario: precioVenta
            };

            const { error } = await supabase.from('inventario').upsert([ingrediente]);
            if (error) alert('Error: ' + error.message);
            else cerrarModalIngrediente();
        });

        function editarIngrediente(id) {
            const ing = inventario.find(i => i.id === id);
            if (!ing) return;
            document.getElementById('modalIngredienteTitulo').innerText = 'Editar Ingrediente';
            document.getElementById('ingredienteId').value = ing.id;
            document.getElementById('ingredienteNombre').value = ing.nombre;
            document.getElementById('ingredienteUnidad').value = ing.unidad;
            document.getElementById('ingredienteStock').value = ing.stock;
            document.getElementById('ingredienteMinimo').value = ing.minimo;
            document.getElementById('precioCostoUnitario').value = ing.precio_costo;
            document.getElementById('precioVentaUnitario').value = ing.precio_unitario;
            document.getElementById('btnEliminarIngrediente').style.display = 'inline-block';
            document.getElementById('modalIngrediente').style.display = 'flex';
        }

        async function eliminarIngrediente() {
            const id = document.getElementById('ingredienteId').value;
            if (!id) return;
            // Verificar si está en uso
            const enUso = menu.some(p => p.ingredientes && p.ingredientes[id]);
            if (enUso) {
                alert('No se puede eliminar porque está en uso en algún platillo.');
                return;
            }
            if (confirm('¿Eliminar ingrediente?')) {
                await supabase.from('inventario').delete().eq('id', id);
                cerrarModalIngrediente();
            }
        }

        // ========== USUARIOS ==========
        function renderUsuariosTable() {
            const tbody = document.querySelector('#usuariosTable tbody');
            tbody.innerHTML = '';
            usuarios.forEach(u => {
                tbody.innerHTML += `<tr>
                    <td>${u.nombre}</td>
                    <td>${u.username}</td>
                    <td><input type="checkbox" ${u.activo ? 'checked' : ''} onchange="toggleUsuarioActivo('${u.id}', this.checked)"></td>
                    <td><button onclick="eliminarUsuario('${u.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            });
        }

        function toggleUsuarioActivo(id, activo) {
            supabase.from('usuarios').update({ activo }).eq('id', id);
        }

        function eliminarUsuario(id) {
            if (confirm('¿Eliminar usuario?')) {
                supabase.from('usuarios').delete().eq('id', id);
            }
        }

        async function crearUsuario() {
            const nombre = document.getElementById('nuevoNombre').value;
            const username = document.getElementById('nuevoUsername').value;
            const password = document.getElementById('nuevoPassword').value;
            if (!nombre || !username || !password) return alert('Complete todos los campos');
            const id = 'user_' + Date.now();
            const { error } = await supabase.from('usuarios').insert([{
                id, nombre, username, password, rol: 'cajero', activo: true, created_at: new Date().toISOString()
            }]);
            if (error) alert(error.message);
            else {
                document.getElementById('nuevoNombre').value = '';
                document.getElementById('nuevoUsername').value = '';
                document.getElementById('nuevoPassword').value = '';
            }
        }

        // ========== CONFIGURACIÓN ==========
        async function cambiarPassword() {
            const current = document.getElementById('currentPass').value;
            const newPass = document.getElementById('newPass').value;
            const confirm = document.getElementById('confirmPass').value;
            if (newPass !== confirm) return alert('Las contraseñas no coinciden');
            const { data } = await supabase.from('config').select('admin_password').eq('id',1).single();
            if (data.admin_password !== current) return alert('Contraseña actual incorrecta');
            await supabase.from('config').update({ admin_password: newPass }).eq('id',1);
            alert('Contraseña cambiada');
        }

        async function guardarRecoveryEmail() {
            const email = document.getElementById('recoveryEmail').value;
            await supabase.from('config').update({ recovery_email: email }).eq('id',1);
        }

        // ========== CÓDIGOS QR ==========
        function generarQR() {
            const nombre = document.getElementById('nombreMesa').value;
            if (!nombre) return;
            const id = 'QR_' + Date.now();
            const url = window.location.origin + '/cliente.html?mesa=' + encodeURIComponent(nombre);
            // Guardar en DB
            supabase.from('codigos_qr').insert([{ id, nombre, fecha: new Date().toISOString() }]).then(() => {
                renderQRGrid();
            });
        }

        function renderQRGrid() {
            const grid = document.getElementById('qrGrid');
            grid.innerHTML = '';
            codigosQR.forEach(qr => {
                const url = window.location.origin + '/cliente.html?mesa=' + encodeURIComponent(qr.nombre);
                const div = document.createElement('div');
                div.className = 'qr-item';
                div.innerHTML = `<div id="qrcode-${qr.id}"></div><p>${qr.nombre}</p><div class="qr-overlay"><button onclick="ampliarQR('${qr.id}')">Ampliar</button><button onclick="eliminarQR('${qr.id}')">Eliminar</button></div>`;
                grid.appendChild(div);
                new QRCode(document.getElementById(`qrcode-${qr.id}`), { text: url, width: 150, height: 150 });
            });
        }

        function ampliarQR(id) {
            const qr = codigosQR.find(q => q.id === id);
            if (!qr) return;
            const url = window.location.origin + '/cliente.html?mesa=' + encodeURIComponent(qr.nombre);
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `<div class="modal-content"><span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span><div id="qrGrande"></div><a href="${url}" download="${qr.nombre}.png">Descargar</a></div>`;
            document.body.appendChild(modal);
            new QRCode(document.getElementById('qrGrande'), { text: url, width: 300, height: 300 });
        }

        function eliminarQR(id) {
            if (confirm('¿Eliminar QR?')) {
                supabase.from('codigos_qr').delete().eq('id', id);
            }
        }

        // ========== REPORTES ==========
        function renderReportes() {
            const hoy = new Date().toISOString().split('T')[0];
            const ventasHoy = pedidos.filter(p => p.estado === 'cobrado' && p.fecha_cobro && p.fecha_cobro.startsWith(hoy)).reduce((acc, p) => acc + p.total, 0);
            document.getElementById('repVentasHoy').innerText = ventasHoy.toFixed(2) + ' USD';

            const hace7 = new Date(Date.now() - 7*24*60*60*1000).toISOString();
            const ventasSemana = pedidos.filter(p => p.estado === 'cobrado' && p.fecha_cobro && p.fecha_cobro >= hace7).reduce((acc, p) => acc + p.total, 0);
            document.getElementById('repVentasSemana').innerText = ventasSemana.toFixed(2) + ' USD';

            const cobrados = pedidos.filter(p => p.estado === 'cobrado');
            const ticketProm = cobrados.length ? cobrados.reduce((acc, p) => acc + p.total, 0) / cobrados.length : 0;
            document.getElementById('repTicketPromedio').innerText = ticketProm.toFixed(2) + ' USD';

            // Platillo más vendido
            const ventasPorPlatillo = {};
            cobrados.forEach(p => {
                p.items.forEach(i => {
                    ventasPorPlatillo[i.nombre] = (ventasPorPlatillo[i.nombre] || 0) + i.cantidad;
                });
            });
            let topPlatillo = Object.entries(ventasPorPlatillo).sort((a,b) => b[1] - a[1])[0];
            document.getElementById('repPlatilloTop').innerText = topPlatillo ? `${topPlatillo[0]} (${topPlatillo[1]})` : '-';

            // Gráficos
            // Ventas diarias últimos 7 días
            const fechas = [];
            const ventasDiarias = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const fechaStr = d.toISOString().split('T')[0];
                fechas.push(fechaStr);
                const total = pedidos.filter(p => p.estado === 'cobrado' && p.fecha_cobro && p.fecha_cobro.startsWith(fechaStr)).reduce((acc, p) => acc + p.total, 0);
                ventasDiarias.push(total);
            }
            new Chart(document.getElementById('chartVentasDiarias'), {
                type: 'line',
                data: { labels: fechas, datasets: [{ label: 'Ventas USD', data: ventasDiarias }] }
            });

            // Ventas por categoría
            const categorias = {};
            cobrados.forEach(p => {
                p.items.forEach(i => {
                    const platillo = menu.find(m => m.id === i.platilloId);
                    if (platillo) {
                        categorias[platillo.categoria] = (categorias[platillo.categoria] || 0) + i.cantidad * platillo.precio;
                    }
                });
            });
            new Chart(document.getElementById('chartCategorias'), {
                type: 'doughnut',
                data: { labels: Object.keys(categorias), datasets: [{ data: Object.values(categorias) }] }
            });

            // Métodos de pago
            const metodos = {};
            cobrados.forEach(p => {
                metodos[p.metodo_pago] = (metodos[p.metodo_pago] || 0) + 1;
            });
            new Chart(document.getElementById('chartMetodosPago'), {
                type: 'bar',
                data: { labels: Object.keys(metodos), datasets: [{ label: 'Cantidad', data: Object.values(metodos) }] }
            });

            // Ventas por hora
            const horas = Array(24).fill(0);
            cobrados.forEach(p => {
                const hora = new Date(p.fecha_cobro).getHours();
                horas[hora] += p.total;
            });
            new Chart(document.getElementById('chartHoras'), {
                type: 'bar',
                data: { labels: [...Array(24).keys()], datasets: [{ label: 'Ventas USD', data: horas }] }
            });

            // Tabla de transacciones
            const tbody = document.querySelector('#transaccionesTable tbody');
            tbody.innerHTML = '';
            cobrados.slice(0,20).forEach(p => {
                tbody.innerHTML += `<tr>
                    <td>${new Date(p.fecha_cobro).toLocaleString()}</td>
                    <td>${p.id}</td>
                    <td>${p.cajero || ''}</td>
                    <td>${p.items.length}</td>
                    <td>${p.total.toFixed(2)}</td>
                    <td>${p.metodo_pago}</td>
                    <td>${p.estado}</td>
                </tr>`;
            });
        }

        // ========== UTILIDADES ==========
        function cambiarTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab${tab.charAt(0).toUpperCase()+tab.slice(1)}`).classList.add('active');
            document.querySelector(`.tab:nth-child(${['dashboard','menu','inventario','usuarios','config','qr','reportes'].indexOf(tab)+1})`).classList.add('active');
            if (tab === 'reportes') renderReportes();
        }

        function guardarTodo() {
            // Forzar sincronización (no necesario, pero feedback)
            document.getElementById('syncStatus').innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Sincronizando...';
            setTimeout(() => {
                document.getElementById('syncStatus').innerHTML = '<i class="fas fa-check"></i> Sincronizado';
            }, 1000);
        }
    </script>
</body>
</html>
