<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saki Sushi - Cliente</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Estilos embebidos -->
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; color: #333; }
        header { background: #b22222; color: white; padding: 1rem; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .logo { font-size: 1.5rem; font-weight: bold; cursor: pointer; }
        .logo i { margin-right: 0.5rem; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .search-box { padding: 0.5rem; border-radius: 20px; border: none; width: 250px; }
        .notification-bell { position: relative; cursor: pointer; }
        .badge { position: absolute; top: -5px; right: -5px; background: gold; color: black; border-radius: 50%; padding: 0.2rem 0.5rem; font-size: 0.7rem; }
        .menu-toggle { font-size: 1.5rem; cursor: pointer; }
        .sidebar { position: fixed; top: 0; left: -300px; width: 300px; height: 100%; background: white; box-shadow: 2px 0 5px rgba(0,0,0,0.2); transition: left 0.3s; z-index: 200; overflow-y: auto; padding: 1rem; }
        .sidebar.open { left: 0; }
        .sidebar .close-btn { text-align: right; font-size: 1.5rem; cursor: pointer; }
        .categoria { padding: 0.5rem; border-bottom: 1px solid #ddd; cursor: pointer; }
        .subcategoria { padding-left: 1rem; font-size: 0.9rem; color: #555; display: none; }
        .subcategoria.visible { display: block; }
        .main { display: flex; padding: 1rem; gap: 1rem; flex-wrap: wrap; }
        .menu-grid { flex: 3; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; }
        .card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        .card img { width: 100%; height: 150px; object-fit: cover; }
        .card-content { padding: 1rem; }
        .card-title { font-weight: bold; margin-bottom: 0.5rem; }
        .card-desc { font-size: 0.9rem; color: #666; margin-bottom: 0.5rem; }
        .card-price { font-weight: bold; color: #b22222; }
        .agotado { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; pointer-events: none; }
        .card-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; }
        .btn { background: #b22222; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .carrito { flex: 1; background: white; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 80px; }
        .carrito-item { display: flex; justify-content: space-between; margin-bottom: 0.5rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
        .carrito-total { font-weight: bold; margin-top: 1rem; text-align: right; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 300; }
        .modal-content { background: white; border-radius: 8px; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .close { float: right; font-size: 1.5rem; cursor: pointer; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.3rem; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }
        .parroquia-selector { position: relative; }
        .parroquia-list { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; display: none; }
        .parroquia-list div { padding: 0.5rem; cursor: pointer; }
        .parroquia-list div:hover { background: #f0f0f0; }
        .costo-envio { margin-top: 0.5rem; font-style: italic; }
        .referencia-inputs { display: flex; gap: 0.3rem; }
        .referencia-inputs input { width: 3rem; text-align: center; }
        .notif-panel { position: fixed; top: 0; right: -350px; width: 350px; height: 100%; background: white; box-shadow: -2px 0 5px rgba(0,0,0,0.2); transition: right 0.3s; z-index: 250; overflow-y: auto; padding: 1rem; }
        .notif-panel.open { right: 0; }
        .notif-item { padding: 0.5rem; border-bottom: 1px solid #eee; cursor: pointer; }
        .notif-item.pending { background: #fff3cd; }
        .notif-item.approved { background: #d4edda; }
        .notif-item.rejected { background: #f8d7da; }
        .notif-titulo { font-weight: bold; }
        .notif-mensaje { font-size: 0.9rem; }
        .badge-mesa { background: gold; padding: 0.2rem 0.5rem; border-radius: 5px; }
    </style>
</head>
<body>
    <header>
        <div class="logo" onclick="cargarMenu()"><i class="fas fa-utensils"></i> Saki Sushi</div>
        <div class="header-actions">
            <input type="text" id="buscador" class="search-box" placeholder="Buscar platillo...">
            <div class="notification-bell" onclick="toggleNotificaciones()">
                <i class="fas fa-bell"></i>
                <span class="badge" id="notif-count">0</span>
            </div>
            <div class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
        </div>
    </header>

    <!-- Sidebar categorías -->
    <div class="sidebar" id="sidebar">
        <div class="close-btn" onclick="toggleSidebar()"><i class="fas fa-times"></i></div>
        <h3>Categorías</h3>
        <div id="categorias-list"></div>
    </div>

    <!-- Panel de notificaciones -->
    <div class="notif-panel" id="notifPanel">
        <div style="display: flex; justify-content: space-between;">
            <h3>Notificaciones</h3>
            <i class="fas fa-times" onclick="toggleNotificaciones()" style="cursor:pointer;"></i>
        </div>
        <div id="notificaciones-list"></div>
    </div>

    <!-- Main content -->
    <div class="main">
        <div class="menu-grid" id="menu-grid"></div>
        <div class="carrito" id="carrito">
            <h3>Tu Pedido</h3>
            <div id="carrito-items"></div>
            <div class="carrito-total" id="carrito-total">Total: 0 Bs</div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <button class="btn" id="btnDelivery" onclick="abrirModalDelivery()" style="flex:1;">Delivery</button>
                <button class="btn" id="btnReserva" onclick="abrirModalReserva()" style="flex:1;">Reserva</button>
            </div>
            <button class="btn" id="btnMesa" onclick="confirmarPedidoMesa()" style="display:none; width:100%;">Confirmar Pedido</button>
        </div>
    </div>

    <!-- Modal Personalización -->
    <div class="modal" id="modalPersonalizar">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalPersonalizar()">&times;</span>
            <h3 id="personalizar-titulo"></h3>
            <div id="personalizar-ingredientes"></div>
            <p>Precio ajustado: <span id="personalizar-precio"></span> Bs</p>
            <button class="btn" id="btnConfirmarPersonalizar" onclick="confirmarPersonalizacion()">Añadir al pedido</button>
        </div>
    </div>

    <!-- Modal Delivery -->
    <div class="modal" id="modalDelivery">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalDelivery()">&times;</span>
            <h3>Pedir Delivery</h3>
            <p class="aviso">Tienes 20 minutos para realizar el pago, de lo contrario tu pedido será cancelado.</p>
            <div class="form-group">
                <label>Datos de pago:</label>
                <p>Banco Banesco<br>Teléfono: 0424-1525233<br>Rif: J-501519838</p>
            </div>
            <div class="form-group parroquia-selector">
                <label>Parroquia</label>
                <input type="text" id="parroquiaSearch" placeholder="Buscar parroquia..." onkeyup="filtrarParroquias()">
                <div id="parroquiaSelected" style="padding:0.5rem; background:#eee; margin-top:0.3rem; cursor:pointer;" onclick="toggleParroquiaList()">San Bernardino ▼</div>
                <div class="parroquia-list" id="parroquiaList"></div>
                <div class="costo-envio" id="costoEnvio">Costo envío: 2 USD (80 Bs)</div>
            </div>
            <div class="form-group">
                <label>Dirección completa</label>
                <textarea id="direccion" rows="3" minlength="20"></textarea>
            </div>
            <div class="form-group">
                <label>Número de contacto</label>
                <input type="tel" id="telefono" pattern="[0-9]{11,14}">
            </div>
            <div class="form-group">
                <label>Código de referencia (6 dígitos)</label>
                <div class="referencia-inputs" id="refInputs">
                    <input type="text" maxlength="1" onkeyup="moveFocus(this, event)">
                    <input type="text" maxlength="1" onkeyup="moveFocus(this, event)">
                    <input type="text" maxlength="1" onkeyup="moveFocus(this, event)">
                    <input type="text" maxlength="1" onkeyup="moveFocus(this, event)">
                    <input type="text" maxlength="1" onkeyup="moveFocus(this, event)">
                    <input type="text" maxlength="1" onkeyup="moveFocus(this, event)">
                </div>
            </div>
            <div class="form-group">
                <label>Comprobante de pago (imagen)</label>
                <input type="file" id="comprobante" accept="image/*">
            </div>
            <button class="btn" id="btnConfirmarDelivery" onclick="confirmarDelivery()" disabled>Confirmar Pedido</button>
        </div>
    </div>

    <!-- Modal Reserva -->
    <div class="modal" id="modalReserva">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalReserva()">&times;</span>
            <h3>Reservar Pedido</h3>
            <p class="aviso">Tienes 20 minutos para realizar el pago, de lo contrario tu pedido será cancelado.</p>
            <div class="form-group">
                <label>Datos de pago:</label>
                <p>Banco Banesco<br>Teléfono: 0424-1525233<br>Rif: J-501519838</p>
            </div>
            <div class="form-group">
                <label>Fecha de reserva</label>
                <input type="date" id="fechaReserva" min="">
            </div>
            <div class="form-group">
                <label>Nombre y apellido</label>
                <input type="text" id="nombreReserva">
            </div>
            <div class="form-group">
                <label>Código de referencia (6 dígitos)</label>
                <div class="referencia-inputs" id="refReservaInputs">
                    <input type="text" maxlength="1" onkeyup="moveFocus(this, event)">
                    <input type="text" maxlength="1" onkeyup="moveFocus(this, event)">
                    <input type="text" maxlength="1" onkeyup="moveFocus(this, event)">
                    <input type="text" maxlength="1" onkeyup="moveFocus(this, event)">
                    <input type="text" maxlength="1" onkeyup="moveFocus(this, event)">
                    <input type="text" maxlength="1" onkeyup="moveFocus(this, event)">
                </div>
            </div>
            <div class="form-group">
                <label>Comprobante de pago (imagen)</label>
                <input type="file" id="comprobanteReserva" accept="image/*">
            </div>
            <button class="btn" id="btnConfirmarReserva" onclick="confirmarReserva()" disabled>Confirmar Pedido</button>
        </div>
    </div>

    <!-- Supabase JS v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ==================== CONFIGURACIÓN SUPABASE ====================
        const SUPABASE_URL = 'https://tu-proyecto.supabase.co';
        const SUPABASE_ANON_KEY = 'tu-anon-key';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ==================== VARIABLES GLOBALES ====================
        let menu = [];
        let inventario = [];
        let config = null;
        let carrito = [];
        let platilloSeleccionado = null;
        let personalizacionActual = [];
        let tasaEfectiva = 40;
        let pedidoIdActual = null; // Para notificaciones
        let modoMesa = false;
        let numeroMesa = null;
        let parroquias = [
            { nombre: "San Bernardino", precioUSD: 2 },
            { nombre: "San José", precioUSD: 2 },
            { nombre: "San Agustín", precioUSD: 2 },
            { nombre: "Candelaria", precioUSD: 2 },
            { nombre: "San Juan", precioUSD: 3 },
            { nombre: "Catedral", precioUSD: 3 },
            { nombre: "Santa Rosalía", precioUSD: 3 },
            { nombre: "El Recreo", precioUSD: 4 },
            { nombre: "La Candelaria", precioUSD: 2 },
            { nombre: "San Pedro", precioUSD: 4 },
            { nombre: "El Paraíso", precioUSD: 4 },
            { nombre: "La Vega", precioUSD: 4 },
            { nombre: "El Valle", precioUSD: 5 },
            { nombre: "Coche", precioUSD: 5 },
            { nombre: "Caricuao", precioUSD: 7 },
            { nombre: "Antímano", precioUSD: 7 },
            { nombre: "Macarao", precioUSD: 7 },
            { nombre: "23 de Enero", precioUSD: 4 },
            { nombre: "La Pastora", precioUSD: 3 },
            { nombre: "Altagracia", precioUSD: 3 },
            { nombre: "Santa Teresa", precioUSD: 3 },
            { nombre: "Santa Rosalía de Palermo", precioUSD: 3 },
            { nombre: "Chacao", precioUSD: 5 },
            { nombre: "Leoncio Martínez", precioUSD: 6 },
            { nombre: "Petare", precioUSD: 6 },
            { nombre: "La Dolorita", precioUSD: 6 },
            { nombre: "Fila de Mariches", precioUSD: 6 },
            { nombre: "Caucagüita", precioUSD: 7 },
            { nombre: "El Cafetal", precioUSD: 6 },
            { nombre: "Las Minas", precioUSD: 5 },
            { nombre: "Nuestra Señora del Rosario", precioUSD: 7 },
            { nombre: "Sucre", precioUSD: 7 },
            { nombre: "El Junquito", precioUSD: 7 }
        ];
        let parroquiaSeleccionada = "San Bernardino";

        // ==================== INICIALIZACIÓN ====================
        window.onload = async () => {
            // Detectar si es modo mesa por URL
            const urlParams = new URLSearchParams(window.location.search);
            const mesa = urlParams.get('mesa');
            if (mesa) {
                modoMesa = true;
                numeroMesa = mesa;
                document.getElementById('btnDelivery').style.display = 'none';
                document.getElementById('btnReserva').style.display = 'none';
                document.getElementById('btnMesa').style.display = 'block';
                document.querySelector('.badge-mesa')?.remove();
                const header = document.querySelector('header');
                const badge = document.createElement('span');
                badge.className = 'badge-mesa';
                badge.innerText = `Mesa ${mesa}`;
                header.appendChild(badge);
            }

            await cargarConfig();
            await cargarInventario();
            await cargarMenu();
            await cargarNotificaciones();
            suscribirseCambios();
            construirSidebar();
            cargarCarritoLocal();

            // Inputs de referencia
            document.querySelectorAll('#refInputs input, #refReservaInputs input').forEach(input => {
                input.addEventListener('input', validarReferencia);
            });

            // Validación de campos en delivery/reserva
            document.getElementById('direccion').addEventListener('input', validarDelivery);
            document.getElementById('telefono').addEventListener('input', validarDelivery);
            document.getElementById('parroquiaSearch').addEventListener('input', filtrarParroquias);
            document.getElementById('comprobante').addEventListener('change', validarDelivery);
            document.getElementById('fechaReserva').addEventListener('change', validarReserva);
            document.getElementById('nombreReserva').addEventListener('input', validarReserva);
            document.getElementById('comprobanteReserva').addEventListener('change', validarReserva);

            // Iniciar verificación de timeout (solo para este cliente, pero no es necesario porque el cajero lo maneja)
        };

        // ==================== FUNCIONES SUPABASE ====================
        async function cargarConfig() {
            const { data, error } = await supabase.from('config').select('*').eq('id',1).single();
            if (error) console.error(error);
            else {
                config = data;
                tasaEfectiva = data.tasa_efectiva;
            }
        }

        async function cargarInventario() {
            const { data, error } = await supabase.from('inventario').select('*');
            if (error) console.error(error);
            else inventario = data;
        }

        async function cargarMenu() {
            const { data, error } = await supabase.from('menu').select('*').eq('disponible', true);
            if (error) console.error(error);
            else {
                menu = data;
                renderizarMenu();
            }
        }

        async function cargarNotificaciones() {
            if (!pedidoIdActual) return;
            const { data, error } = await supabase.from('notificaciones').select('*').eq('pedido_id', pedidoIdActual).order('timestamp', { ascending: false });
            if (error) console.error(error);
            else renderNotificaciones(data);
        }

        function suscribirseCambios() {
            // Suscripción a cambios en menú
            supabase.channel('menu-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'menu' }, payload => {
                    cargarMenu(); // Recargar todo por simplicidad
                })
                .subscribe();

            supabase.channel('inventario-changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'inventario' }, payload => {
                    cargarInventario();
                })
                .subscribe();

            supabase.channel('config-changes')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'config' }, payload => {
                    config = payload.new;
                    tasaEfectiva = payload.new.tasa_efectiva;
                    actualizarPreciosEnUI();
                })
                .subscribe();

            if (pedidoIdActual) {
                supabase.channel(`notif-${pedidoIdActual}`)
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notificaciones', filter: `pedido_id=eq.${pedidoIdActual}` }, payload => {
                        agregarNotificacion(payload.new);
                    })
                    .subscribe();
            }
        }

        // ==================== RENDERIZADO ====================
        function renderizarMenu(filtro = '') {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            const filtroLower = filtro.toLowerCase();
            menu.forEach(platillo => {
                if (filtro && !platillo.nombre.toLowerCase().includes(filtroLower)) return;
                const stock = calcularStockPlatillo(platillo);
                const disponible = stock > 0 && platillo.disponible;
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <img src="${platillo.imagen || 'https://via.placeholder.com/300?text=Sushi'}" alt="${platillo.nombre}">
                    <div class="card-content">
                        <div class="card-title">${platillo.nombre}</div>
                        <div class="card-desc">${platillo.descripcion || ''}</div>
                        <div class="card-price">${(platillo.precio * tasaEfectiva).toFixed(2)} Bs</div>
                        <div class="card-actions">
                            <button class="btn" onclick="agregarAlCarrito('${platillo.id}')" ${!disponible ? 'disabled' : ''}>+</button>
                            <span>Stock: ${stock}</span>
                        </div>
                    </div>
                    ${!disponible ? '<div class="agotado">AGOTADO</div>' : ''}
                `;
                grid.appendChild(card);
            });
        }

        function calcularStockPlatillo(platillo) {
            // Usar el stock ya calculado en la tabla, pero también verificar ingredientes
            return platillo.stock;
        }

        function actualizarPreciosEnUI() {
            document.querySelectorAll('.card-price').forEach((el, index) => {
                // Recalcular con nuevo tasaEfectiva
            });
            renderizarMenu(document.getElementById('buscador').value);
            renderCarrito();
        }

        // ==================== PERSONALIZACIÓN ====================
        function agregarAlCarrito(platilloId) {
            const platillo = menu.find(p => p.id === platilloId);
            if (!platillo) return;
            // Verificar si tiene ingredientes no obligatorios
            const ingredientes = Object.entries(platillo.ingredientes).filter(([id, ing]) => !ing.obligatorio);
            if (ingredientes.length > 0) {
                abrirModalPersonalizacion(platillo);
            } else {
                // Añadir directamente
                añadirItemAlCarrito(platillo, []);
            }
        }

        function abrirModalPersonalizacion(platillo) {
            platilloSeleccionado = platillo;
            personalizacionActual = [];
            document.getElementById('personalizar-titulo').innerText = platillo.nombre;
            const container = document.getElementById('personalizar-ingredientes');
            container.innerHTML = '';
            const ingredientes = Object.entries(platillo.ingredientes).filter(([id, ing]) => !ing.obligatorio);
            ingredientes.forEach(([id, ing]) => {
                const ingrediente = inventario.find(i => i.id === id);
                if (!ingrediente) return;
                const div = document.createElement('div');
                div.style.marginBottom = '0.5rem';
                div.innerHTML = `
                    <label>
                        <input type="checkbox" data-id="${id}" data-precio="${ingrediente.precio_unitario}" data-cantidad="${ing.cantidad}" onchange="actualizarPrecioPersonalizacion()">
                        ${ingrediente.nombre} (descuento ${(ingrediente.precio_unitario * ing.cantidad * tasaEfectiva).toFixed(2)} Bs)
                    </label>
                `;
                container.appendChild(div);
            });
            actualizarPrecioPersonalizacion();
            document.getElementById('modalPersonalizar').style.display = 'flex';
        }

        function actualizarPrecioPersonalizacion() {
            if (!platilloSeleccionado) return;
            let descuento = 0;
            document.querySelectorAll('#personalizar-ingredientes input:checked').forEach(cb => {
                const precio = parseFloat(cb.dataset.precio);
                const cantidad = parseFloat(cb.dataset.cantidad);
                descuento += precio * cantidad * tasaEfectiva;
            });
            const precioBase = platilloSeleccionado.precio * tasaEfectiva;
            const precioFinal = Math.max(0, precioBase - descuento);
            document.getElementById('personalizar-precio').innerText = precioFinal.toFixed(2);
        }

        function confirmarPersonalizacion() {
            const quitados = [];
            document.querySelectorAll('#personalizar-ingredientes input:checked').forEach(cb => {
                quitados.push(cb.dataset.id);
            });
            añadirItemAlCarrito(platilloSeleccionado, quitados);
            cerrarModalPersonalizar();
        }

        function cerrarModalPersonalizar() {
            document.getElementById('modalPersonalizar').style.display = 'none';
        }

        function añadirItemAlCarrito(platillo, quitados) {
            const item = {
                platilloId: platillo.id,
                nombre: platillo.nombre,
                cantidad: 1,
                personalizacion: quitados,
                precioUnitarioUSD: platillo.precio,
                precioEnBs: platillo.precio * tasaEfectiva,
                subtotal: platillo.precio * tasaEfectiva,
                descuentoPorIngredientes: 0 // se recalcula al mostrar
            };
            // Calcular descuento real
            let descuento = 0;
            quitados.forEach(id => {
                const ing = platillo.ingredientes[id];
                if (ing) {
                    const ingrediente = inventario.find(i => i.id === id);
                    if (ingrediente) {
                        descuento += ingrediente.precio_unitario * ing.cantidad * tasaEfectiva;
                    }
                }
            });
            item.subtotal = (platillo.precio * tasaEfectiva) - descuento;
            item.precioEnBs = item.subtotal;
            carrito.push(item);
            guardarCarritoLocal();
            renderCarrito();
        }

        function renderCarrito() {
            const container = document.getElementById('carrito-items');
            container.innerHTML = '';
            let total = 0;
            carrito.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'carrito-item';
                div.innerHTML = `
                    <div>
                        <strong>${item.nombre}</strong> x${item.cantidad}
                        ${item.personalizacion.length ? '<br><small>sin: '+item.personalizacion.join(', ')+'</small>' : ''}
                    </div>
                    <div>${item.precioEnBs.toFixed(2)} Bs <i class="fas fa-trash" onclick="eliminarItemCarrito(${index})" style="cursor:pointer; margin-left:0.5rem;"></i></div>
                `;
                container.appendChild(div);
                total += item.precioEnBs;
            });
            document.getElementById('carrito-total').innerText = `Total: ${total.toFixed(2)} Bs`;
        }

        function eliminarItemCarrito(index) {
            carrito.splice(index, 1);
            guardarCarritoLocal();
            renderCarrito();
        }

        function guardarCarritoLocal() {
            localStorage.setItem('carrito', JSON.stringify(carrito));
        }

        function cargarCarritoLocal() {
            const saved = localStorage.getItem('carrito');
            if (saved) carrito = JSON.parse(saved);
            renderCarrito();
        }

        // ==================== PEDIDOS ====================
        async function confirmarPedidoMesa() {
            if (carrito.length === 0) return alert('Añade items al carrito');
            const pedidoId = 'PED-' + Date.now() + Math.floor(Math.random()*1000);
            const pedido = {
                id: pedidoId,
                timestamp: new Date().toISOString(),
                estado: 'pendiente',
                tipo: 'mesa',
                items: carrito.map(i => ({
                    platilloId: i.platilloId,
                    nombre: i.nombre,
                    cantidad: i.cantidad,
                    personalizacion: i.personalizacion,
                    precioUnitarioUSD: i.precioUnitarioUSD,
                    precioEnBs: i.precioEnBs,
                    subtotal: i.precioEnBs,
                    descuentoPorIngredientes: 0,
                    tasaCambioAplicada: tasaEfectiva
                })),
                total: carrito.reduce((acc, i) => acc + i.precioEnBs, 0) / tasaEfectiva, // total en USD
                origen: 'cliente_web',
                mesa: numeroMesa,
                tiene_comprobante: false
            };

            try {
                // Llamar a la función RPC para reservar inventario (inserta pedido y descuenta)
                const { error } = await supabase.rpc('reservar_inventario', { p_pedido_id: pedidoId }); // Esta función necesita el pedido ya insertado, así que primero insertamos
                // Mejor: insertar pedido y luego reservar. Pero para atomicidad, se puede crear una función que haga todo.
                // Por simplicidad, insertamos directamente y luego llamamos a reservar_inventario.
                const { error: insertError } = await supabase.from('pedidos').insert([pedido]);
                if (insertError) throw insertError;
                await supabase.rpc('reservar_inventario', { p_pedido_id: pedidoId });
                pedidoIdActual = pedidoId;
                localStorage.setItem('pedidoId', pedidoId);
                // Insertar notificación de pedido creado
                await supabase.from('notificaciones').insert([{
                    pedido_id: pedidoId,
                    tipo: 'pending',
                    titulo: 'Pedido recibido',
                    mensaje: 'Tu pedido está pendiente de pago por el cajero.'
                }]);
                alert('Pedido enviado a la cocina');
                carrito = [];
                guardarCarritoLocal();
                renderCarrito();
            } catch (e) {
                alert('Error al enviar pedido: ' + e.message);
            }
        }

        // ==================== MODALES DELIVERY/RESERVA ====================
        function abrirModalDelivery() {
            document.getElementById('modalDelivery').style.display = 'flex';
            cargarParroquias();
            validarDelivery();
        }

        function cerrarModalDelivery() {
            document.getElementById('modalDelivery').style.display = 'none';
        }

        function abrirModalReserva() {
            document.getElementById('modalReserva').style.display = 'flex';
            document.getElementById('fechaReserva').min = new Date().toISOString().split('T')[0];
            validarReserva();
        }

        function cerrarModalReserva() {
            document.getElementById('modalReserva').style.display = 'none';
        }

        function cargarParroquias() {
            const list = document.getElementById('parroquiaList');
            list.innerHTML = '';
            parroquias.forEach(p => {
                const div = document.createElement('div');
                div.innerText = `${p.nombre} (${p.precioUSD} USD)`;
                div.onclick = () => seleccionarParroquia(p.nombre);
                list.appendChild(div);
            });
        }

        function filtrarParroquias() {
            const search = document.getElementById('parroquiaSearch').value.toLowerCase();
            const list = document.getElementById('parroquiaList');
            list.innerHTML = '';
            parroquias.filter(p => p.nombre.toLowerCase().includes(search)).forEach(p => {
                const div = document.createElement('div');
                div.innerText = `${p.nombre} (${p.precioUSD} USD)`;
                div.onclick = () => seleccionarParroquia(p.nombre);
                list.appendChild(div);
            });
        }

        function toggleParroquiaList() {
            const list = document.getElementById('parroquiaList');
            list.style.display = list.style.display === 'block' ? 'none' : 'block';
        }

        function seleccionarParroquia(nombre) {
            parroquiaSeleccionada = nombre;
            document.getElementById('parroquiaSelected').innerText = nombre + ' ▼';
            document.getElementById('parroquiaList').style.display = 'none';
            const parroquia = parroquias.find(p => p.nombre === nombre);
            const costoUSD = parroquia ? parroquia.precioUSD : 2;
            const costoBs = costoUSD * tasaEfectiva;
            document.getElementById('costoEnvio').innerText = `Costo envío: ${costoUSD} USD (${costoBs.toFixed(2)} Bs)`;
            validarDelivery();
        }

        function moveFocus(input, event) {
            if (input.value.length === 1) {
                const next = input.nextElementSibling;
                if (next) next.focus();
            }
        }

        function validarReferencia() {
            const refInputs = document.querySelectorAll('#refInputs input');
            const ref = Array.from(refInputs).map(i => i.value).join('');
            const refReserva = document.querySelectorAll('#refReservaInputs input');
            const refR = Array.from(refReserva).map(i => i.value).join('');
            // Se valida cuando tenga 6 dígitos
        }

        function validarDelivery() {
            const direccion = document.getElementById('direccion').value;
            const telefono = document.getElementById('telefono').value;
            const refInputs = document.querySelectorAll('#refInputs input');
            const ref = Array.from(refInputs).map(i => i.value).join('');
            const comprobante = document.getElementById('comprobante').files.length > 0;
            const ok = direccion.length >= 20 && telefono.length >= 11 && telefono.length <= 14 && ref.length === 6 && comprobante;
            document.getElementById('btnConfirmarDelivery').disabled = !ok;
        }

        function validarReserva() {
            const fecha = document.getElementById('fechaReserva').value;
            const nombre = document.getElementById('nombreReserva').value;
            const refInputs = document.querySelectorAll('#refReservaInputs input');
            const ref = Array.from(refInputs).map(i => i.value).join('');
            const comprobante = document.getElementById('comprobanteReserva').files.length > 0;
            const ok = fecha && nombre && ref.length === 6 && comprobante;
            document.getElementById('btnConfirmarReserva').disabled = !ok;
        }

        async function confirmarDelivery() {
            if (carrito.length === 0) return alert('Carrito vacío');
            const pedidoId = 'PED-' + Date.now() + Math.floor(Math.random()*1000);
            const parroquia = parroquias.find(p => p.nombre === parroquiaSeleccionada);
            const costoUSD = parroquia ? parroquia.precioUSD : 2;
            const costoBs = costoUSD * tasaEfectiva;
            const totalUSD = carrito.reduce((acc, i) => acc + i.precioUnitarioUSD * i.cantidad, 0) + costoUSD;
            const totalBs = totalUSD * tasaEfectiva;

            const refInputs = document.querySelectorAll('#refInputs input');
            const referencia = Array.from(refInputs).map(i => i.value).join('');

            const file = document.getElementById('comprobante').files[0];
            let comprobanteUrl = '';
            if (file) {
                const fileName = `${pedidoId}_${file.name}`;
                const { error: uploadError } = await supabase.storage.from('comprobantes').upload(fileName, file);
                if (uploadError) throw uploadError;
                comprobanteUrl = supabase.storage.from('comprobantes').getPublicUrl(fileName).data.publicUrl;
            }

            const pedido = {
                id: pedidoId,
                timestamp: new Date().toISOString(),
                estado: 'pendiente',
                tipo: 'delivery',
                items: carrito.map(i => ({
                    platilloId: i.platilloId,
                    nombre: i.nombre,
                    cantidad: i.cantidad,
                    personalizacion: i.personalizacion,
                    precioUnitarioUSD: i.precioUnitarioUSD,
                    precioEnBs: i.precioEnBs,
                    subtotal: i.precioEnBs,
                    descuentoPorIngredientes: 0,
                    tasaCambioAplicada: tasaEfectiva
                })),
                total: totalUSD,
                origen: 'cliente_web',
                parroquia: parroquiaSeleccionada,
                direccion: document.getElementById('direccion').value,
                telefono: document.getElementById('telefono').value,
                referencia: referencia,
                tiene_comprobante: true,
                comprobante_nombre: comprobanteUrl,
                costo_delivery: costoBs,
                costo_delivery_usd: costoUSD
            };

            try {
                const { error } = await supabase.from('pedidos').insert([pedido]);
                if (error) throw error;
                await supabase.rpc('reservar_inventario', { p_pedido_id: pedidoId });
                pedidoIdActual = pedidoId;
                localStorage.setItem('pedidoId', pedidoId);
                await supabase.from('notificaciones').insert([{
                    pedido_id: pedidoId,
                    tipo: 'pending',
                    titulo: 'Pedido recibido',
                    mensaje: 'Esperando confirmación del pago.'
                }]);
                alert('Pedido enviado. Tienes 20 minutos para que el cajero confirme.');
                carrito = [];
                guardarCarritoLocal();
                cerrarModalDelivery();
                renderCarrito();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function confirmarReserva() {
            if (carrito.length === 0) return alert('Carrito vacío');
            const pedidoId = 'PED-' + Date.now() + Math.floor(Math.random()*1000);
            const totalUSD = carrito.reduce((acc, i) => acc + i.precioUnitarioUSD * i.cantidad, 0);
            const refInputs = document.querySelectorAll('#refReservaInputs input');
            const referencia = Array.from(refInputs).map(i => i.value).join('');
            const file = document.getElementById('comprobanteReserva').files[0];
            let comprobanteUrl = '';
            if (file) {
                const fileName = `${pedidoId}_${file.name}`;
                const { error: uploadError } = await supabase.storage.from('comprobantes').upload(fileName, file);
                if (uploadError) throw uploadError;
                comprobanteUrl = supabase.storage.from('comprobantes').getPublicUrl(fileName).data.publicUrl;
            }

            const pedido = {
                id: pedidoId,
                timestamp: new Date().toISOString(),
                estado: 'reserva_pendiente',
                tipo: 'reserva',
                items: carrito.map(i => ({
                    platilloId: i.platilloId,
                    nombre: i.nombre,
                    cantidad: i.cantidad,
                    personalizacion: i.personalizacion,
                    precioUnitarioUSD: i.precioUnitarioUSD,
                    precioEnBs: i.precioEnBs,
                    subtotal: i.precioEnBs,
                    descuentoPorIngredientes: 0,
                    tasaCambioAplicada: tasaEfectiva
                })),
                total: totalUSD,
                origen: 'cliente_web',
                fecha_reserva: document.getElementById('fechaReserva').value,
                cliente_nombre: document.getElementById('nombreReserva').value,
                referencia: referencia,
                tiene_comprobante: true,
                comprobante_nombre: comprobanteUrl
            };

            try {
                const { error } = await supabase.from('pedidos').insert([pedido]);
                if (error) throw error;
                await supabase.rpc('reservar_inventario', { p_pedido_id: pedidoId });
                pedidoIdActual = pedidoId;
                localStorage.setItem('pedidoId', pedidoId);
                await supabase.from('notificaciones').insert([{
                    pedido_id: pedidoId,
                    tipo: 'pending',
                    titulo: 'Reserva recibida',
                    mensaje: 'Esperando confirmación del pago.'
                }]);
                alert('Reserva enviada. Tienes 20 minutos para que el cajero confirme.');
                carrito = [];
                guardarCarritoLocal();
                cerrarModalReserva();
                renderCarrito();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // ==================== NOTIFICACIONES ====================
        function toggleNotificaciones() {
            const panel = document.getElementById('notifPanel');
            panel.classList.toggle('open');
            if (panel.classList.contains('open')) {
                cargarNotificaciones();
            }
        }

        function renderNotificaciones(notifs) {
            const container = document.getElementById('notificaciones-list');
            container.innerHTML = '';
            notifs.forEach(n => {
                const div = document.createElement('div');
                div.className = `notif-item ${n.tipo}`;
                div.onclick = () => marcarLeida(n.id);
                div.innerHTML = `<div class="notif-titulo">${n.titulo}</div><div class="notif-mensaje">${n.mensaje}</div>`;
                container.appendChild(div);
            });
            document.getElementById('notif-count').innerText = notifs.filter(n => !n.leida).length;
        }

        async function marcarLeida(id) {
            await supabase.from('notificaciones').update({ leida: true }).eq('id', id);
        }

        function agregarNotificacion(notif) {
            const container = document.getElementById('notificaciones-list');
            const div = document.createElement('div');
            div.className = `notif-item ${notif.tipo}`;
            div.innerHTML = `<div class="notif-titulo">${notif.titulo}</div><div class="notif-mensaje">${notif.mensaje}</div>`;
            container.prepend(div);
            const count = parseInt(document.getElementById('notif-count').innerText) + 1;
            document.getElementById('notif-count').innerText = count;
        }

        // ==================== SIDEBAR ====================
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function construirSidebar() {
            const categorias = [...new Set(menu.map(p => p.categoria))];
            const container = document.getElementById('categorias-list');
            categorias.forEach(cat => {
                const div = document.createElement('div');
                div.className = 'categoria';
                div.innerText = cat.charAt(0).toUpperCase() + cat.slice(1);
                div.onclick = () => filtrarPorCategoria(cat);
                container.appendChild(div);
                // Subcategorías si existen
                const subcats = [...new Set(menu.filter(p => p.categoria === cat && p.subcategoria).map(p => p.subcategoria))];
                if (subcats.length) {
                    const subDiv = document.createElement('div');
                    subDiv.className = 'subcategoria';
                    subcats.forEach(sub => {
                        const subItem = document.createElement('div');
                        subItem.innerText = sub;
                        subItem.onclick = (e) => {
                            e.stopPropagation();
                            filtrarPorSubcategoria(cat, sub);
                        };
                        subDiv.appendChild(subItem);
                    });
                    container.appendChild(subDiv);
                }
            });
        }

        function filtrarPorCategoria(cat) {
            document.getElementById('buscador').value = '';
            renderizarMenuConFiltro(p => p.categoria === cat);
        }

        function filtrarPorSubcategoria(cat, sub) {
            document.getElementById('buscador').value = '';
            renderizarMenuConFiltro(p => p.categoria === cat && p.subcategoria === sub);
        }

        function renderizarMenuConFiltro(filtroFn) {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            menu.filter(filtroFn).forEach(platillo => {
                const stock = platillo.stock;
                const disponible = stock > 0 && platillo.disponible;
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <img src="${platillo.imagen || 'https://via.placeholder.com/300?text=Sushi'}" alt="${platillo.nombre}">
                    <div class="card-content">
                        <div class="card-title">${platillo.nombre}</div>
                        <div class="card-desc">${platillo.descripcion || ''}</div>
                        <div class="card-price">${(platillo.precio * tasaEfectiva).toFixed(2)} Bs</div>
                        <div class="card-actions">
                            <button class="btn" onclick="agregarAlCarrito('${platillo.id}')" ${!disponible ? 'disabled' : ''}>+</button>
                            <span>Stock: ${stock}</span>
                        </div>
                    </div>
                    ${!disponible ? '<div class="agotado">AGOTADO</div>' : ''}
                `;
                grid.appendChild(card);
            });
        }

        // Buscador
        document.getElementById('buscador').addEventListener('input', (e) => {
            renderizarMenu(e.target.value);
        });
    </script>
</body>
</html>
