<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>üç£ Saki Sushi - Men√∫ Cliente</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Roboto:wght@300;400;500&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#D32F2F;--secondary:#212121;--accent:#FF9800;--light-bg:#F5F5F5;--dark-bg:#121212;--success:#388E3C;--info:#1976D2;--warning:#F57C00;--danger:#ef4444;--text-light:#ffffff;--text-dark:#333333;--gray-100:#f8f9fa;--gray-200:#e9ecef;--gray-300:#dee2e6;--gray-400:#ced4da;--gray-500:#adb5bd;--gray-600:#6c757d;--gray-700:#495057;--gray-800:#343a40;--gray-900:#212529;--shadow-sm:0 2px 4px rgba(0,0,0,0.1);--shadow-md:0 4px 8px rgba(0,0,0,0.15);--shadow-lg:0 8px 16px rgba(0,0,0,0.2);--radius-sm:8px;--radius-md:12px;--radius-lg:16px;--nivel1-bg:linear-gradient(135deg,var(--primary),#b71c1c);--nivel1-text:white;--nivel2-bg:#FFF3E0;--nivel2-border:#FFB74D;--nivel2-text:#E65100;--nivel3-bg:white;--nivel3-border:var(--gray-200)}
        body{font-family:'Roboto',sans-serif;background-image:url('https://userscontent2.emaze.com/images/28851f51-ec90-466c-ad3a-51e653c9f058/c862bd8c3df982859d9f75ed46af72e1.jpg');background-size:cover;background-attachment:fixed;background-position:center;color:var(--text-dark);min-height:100vh;display:flex;flex-direction:column}
        body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,rgba(26,26,46,0.85)0%,rgba(22,33,62,0.9)100%);pointer-events:none;z-index:-1}
        h1,h2,h3,h4,h5,h6{font-family:'Montserrat',sans-serif}
        .slogan-text{font-family:'Playfair Display',serif;font-style:italic;font-weight:500;letter-spacing:.5px;color:var(--accent)}
        .overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:800;display:none;backdrop-filter:blur(3px)}
        .overlay.active{display:block}
        .header{background:linear-gradient(135deg,var(--primary),#b71c1c);color:white;padding:.8rem 1rem;position:sticky;top:0;z-index:1000;box-shadow:var(--shadow-md);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem;min-height:110px;flex-shrink:0}
        @media (max-width:992px){.header{min-height:100px;padding:.5rem}}
        @media (max-width:768px){.header{min-height:auto;padding:.5rem}}
        .header-left{display:flex;align-items:center;gap:.5rem;flex:0 0 auto}
        .menu-hamburguesa{background:rgba(255,255,255,.15);border:none;color:white;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;font-size:1.4rem;backdrop-filter:blur(5px);flex-shrink:0}
        .menu-hamburguesa:hover{background:rgba(255,255,255,.25);transform:scale(1.1)}
        .logo-area{display:flex;align-items:center;gap:1rem;cursor:pointer;flex:1;justify-content:center;flex-wrap:wrap}
        .logo{width:70px;height:70px;border-radius:14px;box-shadow:var(--shadow-md);transform:rotate(-5deg);transition:transform .3s;object-fit:cover}
        .logo:hover{transform:rotate(0) scale(1.05)}
        .logo-area h1{font-size:2rem;font-weight:800;letter-spacing:.5px;white-space:nowrap;cursor:pointer;line-height:1.2}
        .header-slogan{font-family:'Playfair Display',serif;font-style:italic;font-size:1.1rem;color:var(--accent);margin-left:.5rem;white-space:nowrap;border-left:2px solid rgba(255,255,255,.3);padding-left:1rem}
        @media (max-width:992px){.logo{width:60px;height:60px}.logo-area h1{font-size:1.6rem}.header-slogan{font-size:1rem}}
        @media (max-width:768px){.logo-area{flex-direction:column;gap:.3rem}.logo-area h1{font-size:1.4rem;white-space:normal}.header-slogan{font-size:.9rem;border-left:none;padding-left:0;width:100%;text-align:center}}
        .header-icons{display:flex;align-items:center;gap:.8rem;flex:0 0 auto;position:relative}
        .header-icons.left-aligned{margin-left:auto}
        .icon-button{background:rgba(255,255,255,.15);border:none;color:white;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s;font-size:1.4rem;position:relative;backdrop-filter:blur(5px);flex-shrink:0}
        .icon-button:hover{background:rgba(255,255,255,.25);transform:scale(1.1)}
        .notification-badge{position:absolute;top:-5px;right:-5px;background-color:var(--accent);color:white;font-size:.7rem;padding:.2rem .5rem;border-radius:20px;min-width:20px;text-align:center;font-weight:600;box-shadow:var(--shadow-sm)}
        .notification-badge.has-unread{animation:vibrate .3s ease}
        @keyframes vibrate{0%,100%{transform:scale(1)}10%,30%,50%,70%,90%{transform:scale(1.1)}20%,40%,60%,80%{transform:scale(.95)}}
        .cart-badge{position:absolute;top:-5px;right:-5px;background-color:var(--accent);color:white;font-size:.7rem;padding:.2rem .5rem;border-radius:20px;min-width:20px;text-align:center;font-weight:600;box-shadow:var(--shadow-sm)}
        .table-badge{background:var(--accent);color:var(--secondary);padding:.4rem 1rem;border-radius:25px;font-weight:700;font-family:'Montserrat',sans-serif;font-size:1rem;display:inline-block;white-space:nowrap}
        .content-wrapper{width:100%;flex:1;display:flex;flex-direction:column;background:transparent}
        .main-layout{display:flex;flex:1;position:relative;background:transparent;overflow:hidden}
        #sidebarContainer{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:900}
        .category-sidebar{width:280px;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);border-right:1px solid rgba(255,255,255,.1);overflow-y:auto;transition:transform .3s ease;box-shadow:2px 0 8px rgba(0,0,0,.5);position:absolute;left:0;top:0;bottom:0;display:flex;flex-direction:column;backdrop-filter:blur(10px);pointer-events:auto;height:100%}
        @media (max-width:992px){.category-sidebar{transform:translateX(-100%)}.category-sidebar.open{transform:translateX(0);box-shadow:var(--shadow-lg)}}
        @media (min-width:993px){.category-sidebar{transform:translateX(0)!important}}
        .category-header{padding:1rem 1.5rem;display:flex;align-items:center;justify-content:space-between;color:var(--gray-300);font-weight:600;font-size:1.1rem;background:rgba(0,0,0,.2);border-bottom:1px solid rgba(255,255,255,.1);flex-shrink:0}
        .category-header i{cursor:pointer;font-size:1.2rem;color:var(--gray-400);transition:color .2s}
        .category-header i:hover{color:var(--accent)}
        @media (min-width:993px){.category-header i.fa-times{display:none}}
        .category-list{list-style:none;flex:1;overflow-y:auto;padding-bottom:2rem}
        .category-item{padding:.9rem 1.5rem;cursor:pointer;transition:all .2s;font-weight:500;color:var(--gray-300);border-left:4px solid transparent;display:flex;align-items:center;justify-content:space-between}
        .category-item:hover{background-color:rgba(255,255,255,.05);color:var(--accent)}
        .category-item.active{background:linear-gradient(90deg,rgba(211,47,47,.2)0%,rgba(211,47,47,.02)100%);color:var(--accent);border-left-color:var(--accent);font-weight:600}
        .category-item i:first-child{font-size:1rem;margin-right:.8rem;color:var(--accent)}
        .category-item i.fa-chevron-right{font-size:.8rem;color:var(--gray-500);transition:transform .2s;margin-right:0}
        .category-item.active i.fa-chevron-right{color:var(--accent)}
        .category-item[data-categoria=todos]{font-weight:700;border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:.5rem}
        .category-item[data-categoria=ofertas] span{text-transform:uppercase;font-weight:700}
        .subcategory-list{list-style:none;background-color:rgba(0,0,0,.2);font-size:.9rem;max-height:0;overflow:hidden;transition:max-height .3s ease}
        .subcategory-list.expanded{max-height:500px}
        .subcategory-item{padding:.7rem 1.5rem .7rem 3.5rem;cursor:pointer;color:var(--gray-400);transition:all .2s;position:relative}
        .subcategory-item:hover{background-color:rgba(255,255,255,.05);color:var(--accent)}
        .subcategory-item.active{color:var(--accent);font-weight:500}
        .subcategory-item.active::before{content:'‚Ä¢';position:absolute;left:2.5rem;color:var(--accent);font-weight:700}
        .cart-sidebar{width:320px;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);border-left:1px solid rgba(255,255,255,.1);display:flex;flex-direction:column;transition:transform .3s ease;position:absolute;right:0;top:0;bottom:0;box-shadow:-2px 0 8px rgba(0,0,0,.5);backdrop-filter:blur(10px);pointer-events:auto;height:100%}
        @media (max-width:992px){.cart-sidebar{transform:translateX(100%)}.cart-sidebar.open{transform:translateX(0);box-shadow:var(--shadow-lg)}}
        @media (min-width:993px){.cart-sidebar{transform:translateX(0)!important}}
        .cart-header{padding:1rem 1.2rem;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,.2);flex-shrink:0}
        .cart-header h3{font-size:1.2rem;color:var(--gray-100);display:flex;align-items:center;gap:.5rem}
        .cart-header h3 i{color:var(--accent)}
        .cart-header button{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--gray-400);transition:color .2s;width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center}
        .cart-header button:hover{background:rgba(255,255,255,.05);color:var(--danger)}
        @media (min-width:993px){.cart-header button#closeCart{display:none}}
        .cart-items{flex:1;overflow-y:auto;padding:1.2rem;display:flex;flex-direction:column;gap:.8rem}
        .cart-empty{text-align:center;padding:2rem 1rem;color:var(--gray-400)}
        .cart-empty i{font-size:3rem;margin-bottom:.8rem;opacity:.5}
        .cart-empty p{font-size:1rem}
        .nivel1-group{background:rgba(255,255,255,.05);border-radius:var(--radius-md);overflow:hidden;box-shadow:var(--shadow-sm);transition:all .2s;backdrop-filter:blur(5px)}
        .nivel1-group:hover{box-shadow:var(--shadow-md)}
        .nivel1-header{background:var(--nivel1-bg);color:var(--nivel1-text);padding:.8rem 1rem;display:flex;flex-direction:column;gap:.3rem;cursor:pointer;transition:background .2s}
        .nivel1-header:hover{background:linear-gradient(135deg,#b71c1c,var(--primary))}
        .nivel1-header .header-row{display:flex;align-items:center;justify-content:space-between;width:100%}
        .nivel1-header .header-row .nombre{display:flex;align-items:center;gap:.5rem;font-weight:600;font-size:1rem}
        .nivel1-header .header-row .nombre i{font-size:1rem;width:20px;transition:transform .3s}
        .nivel1-header .header-row .nombre i.rotated{transform:rotate(90deg)}
        .nivel1-header .header-details{display:flex;align-items:center;gap:1rem;font-size:.9rem;color:rgba(255,255,255,.9);padding-left:1.8rem}
        .nivel1-header .header-details span{display:flex;align-items:center;gap:.3rem}
        .nivel1-header .header-details i{font-size:.8rem}
        .nivel2-container{max-height:0;overflow:hidden;transition:max-height .3s ease-out;background:rgba(0,0,0,.2)}
        .nivel2-container.expanded{max-height:1000px;transition:max-height .5s ease-in}
        .nivel2-group{margin:.5rem;border-radius:var(--radius-sm);overflow:hidden;border:1px solid var(--nivel2-border)}
        .nivel2-header{background:var(--nivel2-bg);color:var(--nivel2-text);padding:.6rem 1rem;display:flex;flex-direction:column;gap:.2rem;cursor:pointer;transition:background .2s}
        .nivel2-header:hover{background:#FFE0B2}
        .nivel2-header .header-row{display:flex;align-items:center;justify-content:space-between;width:100%}
        .nivel2-header .header-row .nombre{display:flex;align-items:center;gap:.5rem;font-weight:600;font-size:.95rem}
        .nivel2-header .header-row .nombre i{font-size:.9rem;width:18px;transition:transform .3s}
        .nivel2-header .header-row .nombre i.rotated{transform:rotate(90deg)}
        .nivel2-header .header-details{display:flex;align-items:center;gap:.8rem;font-size:.85rem;color:var(--nivel2-text);padding-left:1.8rem}
        .nivel2-header .header-details span{display:flex;align-items:center;gap:.3rem}
        .nivel3-container{max-height:0;overflow:hidden;transition:max-height .3s ease-out;background:var(--nivel3-bg)}
        .nivel3-container.expanded{max-height:500px;transition:max-height .4s ease-in}
        .nivel3-item{display:flex;align-items:center;gap:.8rem;padding:.8rem;border-bottom:1px solid var(--nivel3-border);background:var(--nivel3-bg)}
        .nivel3-item:last-child{border-bottom:none}
        .item-image{width:40px;height:40px;border-radius:var(--radius-sm);background-size:cover;background-position:center;background-color:var(--gray-200);flex-shrink:0}
        .item-info{flex:1}
        .item-info .item-number{font-weight:700;color:var(--primary);font-size:.85rem;margin-right:.5rem}
        .item-info .item-name{font-weight:600;color:var(--secondary);font-size:.9rem}
        .item-info .personalizacion{font-size:.8rem;color:var(--gray-600);font-style:italic;margin-top:.2rem}
        .item-info .personalizacion i{color:var(--accent);margin-right:.3rem}
        .item-precio{font-weight:600;color:var(--secondary);font-size:.9rem;min-width:70px;text-align:right}
        .btn-remove-item{background:none;border:none;color:var(--danger);cursor:pointer;font-size:.9rem;padding:.3rem;opacity:.6;transition:all .2s;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .btn-remove-item:hover{opacity:1;background:var(--gray-100);transform:scale(1.1)}
        .cart-footer{padding:1.2rem;border-top:2px solid rgba(255,255,255,.1);background:rgba(0,0,0,.2);flex-shrink:0}
        .cart-total{display:flex;justify-content:space-between;font-weight:700;font-size:1.2rem;margin-bottom:1.2rem;color:var(--gray-100)}
        .cart-total span:last-child{color:var(--accent)}
        .cart-buttons{display:flex;gap:.5rem;flex-wrap:wrap}
        .btn-primary,.btn-secondary{flex:1;padding:.8rem;border:none;border-radius:50px;font-weight:600;font-size:.9rem;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:.5rem;min-width:120px}
        .btn-primary{background:linear-gradient(135deg,var(--primary),#b71c1c);color:white;box-shadow:var(--shadow-sm)}
        .btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:var(--shadow-md)}
        .btn-primary:disabled{opacity:.5;cursor:not-allowed;background:var(--gray-400)}
        .btn-secondary{background:var(--accent);color:white}
        .btn-secondary:hover:not(:disabled){background:#e68900;transform:translateY(-2px)}
        .btn-secondary:disabled{opacity:.5;cursor:not-allowed}
        .main-content{flex:1;padding:0;transition:margin-left .3s,margin-right .3s;margin-left:0;margin-right:0;width:100%;max-width:100%;background:transparent;overflow-y:auto}
        @media (min-width:993px){.main-content{margin-left:280px;margin-right:320px;width:calc(100% - 600px)}}
        .tagline-section{padding:1rem 1.5rem .5rem 1.5rem;background:transparent}
        .tagline{display:flex;justify-content:center;gap:1rem;margin:0 auto;max-width:900px;flex-wrap:wrap}
        .tagline-item{background:rgba(255,255,255,.05);padding:.6rem 1.2rem;border-radius:50px;font-size:.9rem;font-family:'Montserrat',sans-serif;font-weight:600;color:#fff;cursor:default;transition:all .2s;border:1px solid rgba(255,255,255,.1);white-space:nowrap;flex:0 1 auto}
        .tagline-item:hover{background:rgba(255,255,255,.1);transform:translateY(-2px);box-shadow:var(--shadow-md)}
        .tagline-item.ofertas{text-transform:uppercase;font-weight:800;background:linear-gradient(145deg,#fff3cd,#ffe0b2);border:2px solid var(--accent);color:var(--secondary);animation:neonPulse 1.5s ease-in-out infinite;box-shadow:0 0 10px rgba(255,152,0,.5);cursor:pointer}
        @keyframes neonPulse{0%,100%{box-shadow:0 0 5px #fff3cd,0 0 10px #fff3cd,0 0 15px var(--accent),0 0 20px var(--accent);border-color:var(--accent)}50%{box-shadow:0 0 10px #fff3cd,0 0 20px #fff3cd,0 0 30px var(--primary),0 0 40px var(--primary);border-color:var(--primary)}}
        @media (max-width:480px){.tagline-item{font-size:.75rem;padding:.4rem .8rem}}
        .search-section{padding:0 1.5rem 1rem 1.5rem;background:transparent}
        .search-bar{position:relative;max-width:600px;margin:0 auto}
        .search-bar input{width:100%;padding:.8rem 1rem .8rem 3rem;border:2px solid rgba(255,255,255,.1);border-radius:50px;font-size:1rem;outline:none;background:rgba(0,0,0,.3);color:#fff;transition:all .3s;box-shadow:var(--shadow-sm)}
        .search-bar input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(255,152,0,.2)}
        .search-bar i{position:absolute;left:1.2rem;top:50%;transform:translateY(-50%);color:var(--gray-400);font-size:1.2rem}
        .category-title{margin:0 1.5rem 1rem 1.5rem;background:rgba(0,0,0,.2);padding:1.2rem;border-radius:var(--radius-lg);border:1px solid rgba(255,255,255,.1);text-align:center}
        .category-title h2{font-size:1.8rem;color:var(--accent);margin-bottom:.3rem}
        .menu-section{padding:0 1.5rem 1.5rem 1.5rem}
        .menu-grid{display:grid;gap:1.2rem}
        @media (max-width:640px){.menu-grid{grid-template-columns:1fr}}
        @media (min-width:641px) and (max-width:992px){.menu-grid{grid-template-columns:repeat(2,1fr)}}
        @media (min-width:993px){.menu-grid{grid-template-columns:repeat(2,1fr)}}
        .pagination-controls{display:flex;justify-content:center;align-items:center;gap:1rem;margin-top:2rem;margin-bottom:1rem}
        .pagination-btn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;padding:.5rem 1.2rem;border-radius:50px;cursor:pointer;transition:all .2s;font-weight:600;display:flex;align-items:center;gap:.5rem}
        .pagination-btn:hover:not(:disabled){background:var(--accent);color:var(--secondary);transform:translateY(-2px)}
        .pagination-btn:disabled{opacity:.3;cursor:not-allowed}
        .pagination-info{color:#fff;font-size:1rem;background:rgba(0,0,0,.3);padding:.5rem 1rem;border-radius:50px}
        .menu-card{background:rgba(255,255,255,.05);border-radius:var(--radius-md);overflow:hidden;box-shadow:var(--shadow-sm);transition:all .3s;position:relative;border:1px solid rgba(255,255,255,.1);display:flex;flex-direction:column;backdrop-filter:blur(5px);height:100%}
        .menu-card:hover{transform:translateY(-3px);box-shadow:var(--shadow-md)}
        .menu-card-image{height:160px;background-size:cover;background-position:center;position:relative;background-color:rgba(0,0,0,.5)}
        .menu-card-badge{position:absolute;top:.8rem;right:.8rem;background:rgba(0,0,0,.7);color:white;padding:.2rem .6rem;border-radius:20px;font-size:.75rem;font-weight:500;backdrop-filter:blur(4px);display:flex;align-items:center;gap:.3rem}
        .menu-card-badge i{font-size:.7rem}
        .menu-card-badge.agotado{background:rgba(239,68,68,.9)}
        .menu-card-badge.available{background:var(--success)}
        .menu-card-badge.low{background:var(--warning)}
        .menu-card-badge.sold-out{background:var(--danger)}
        .menu-card-content{padding:1rem;flex:1;display:flex;flex-direction:column}
        .menu-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.5rem}
        .menu-card-title{font-size:1.1rem;font-weight:600;color:#fff;line-height:1.3}
        .menu-card-price{font-weight:700;color:var(--accent);font-size:1.2rem;white-space:nowrap}
        .menu-card-description{font-size:.85rem;color:var(--gray-400);margin-bottom:.8rem;line-height:1.4;flex:1}
        .menu-card-footer{display:flex;align-items:center;justify-content:space-between;margin-top:auto;gap:.5rem}
        .btn-add{background:var(--accent);color:white;border:none;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;font-size:1rem;box-shadow:var(--shadow-sm);flex-shrink:0}
        .btn-add:hover:not(:disabled){background:#e68900;transform:scale(1.1)}
        .btn-add:disabled{background:var(--gray-400);cursor:not-allowed;opacity:.5}
        .btn-customize{background:var(--primary);color:white;border:none;padding:.4rem .8rem;border-radius:25px;font-size:.8rem;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:.3rem;transition:all .2s;flex:1;justify-content:center}
        .btn-customize:hover:not(:disabled){background:#b71c1c;transform:translateY(-2px)}
        .btn-customize:disabled{background:var(--gray-400);cursor:not-allowed}
        .btn-customize i{font-size:.8rem}
        .stock-info{font-size:.75rem;color:var(--gray-400);display:flex;align-items:center;gap:.3rem;margin-top:.5rem}
        .stock-info i.available{color:var(--success)}
        .stock-info i.low{color:var(--warning)}
        .stock-info i.sold-out{color:var(--danger)}
        .notifications-wrapper{position:relative;display:inline-block}
        .notifications-panel{position:fixed;top:100px;right:20px;width:320px;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);border-radius:var(--radius-md);box-shadow:var(--shadow-lg);display:none;max-height:calc(100vh - 120px);overflow-y:auto;z-index:1001;border:1px solid rgba(255,255,255,.1);backdrop-filter:blur(10px)}
        @media (max-width:480px){.notifications-panel{width:280px;right:10px}}
        .notifications-panel.active{display:block}
        .notifications-header{padding:1rem;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,.2);border-radius:var(--radius-md) var(--radius-md) 0 0;position:sticky;top:0;z-index:10}
        .notifications-header h4{font-size:1rem;color:var(--gray-100)}
        .notifications-header span{background:var(--primary);color:white;padding:.2rem .6rem;border-radius:20px;font-size:.75rem;font-weight:600}
        .notifications-list{padding:.5rem}
        .notification-item{padding:.8rem;border-bottom:1px solid rgba(255,255,255,.1);transition:background .2s;cursor:pointer;border-radius:var(--radius-sm);margin:.2rem;font-size:.9rem;color:#fff}
        .notification-item:hover{background:rgba(255,255,255,.05)}
        .notification-item.unread{background:rgba(211,47,47,.2);border-left:3px solid var(--primary)}
        .notification-item.approved{border-left:4px solid var(--success);background:rgba(56,142,60,.1)}
        .notification-item.rejected{border-left:4px solid var(--danger);background:rgba(239,68,68,.1)}
        .notification-item.pending{border-left:4px solid var(--warning);background:rgba(245,124,0,.1)}
        .notification-title{font-weight:600;color:#fff;margin-bottom:.2rem;display:flex;align-items:center;gap:.5rem;font-size:.95rem}
        .notification-title i.fa-check-circle{color:var(--success)}
        .notification-title i.fa-times-circle{color:var(--danger)}
        .notification-title i.fa-clock{color:var(--warning)}
        .notification-message{font-size:.85rem;color:var(--gray-400);margin-bottom:.2rem}
        .notification-time{font-size:.7rem;color:var(--gray-500);display:flex;align-items:center;gap:.3rem}
        .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);z-index:2000;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
        .modal-overlay.active{display:flex}
        .modal-container{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);border-radius:var(--radius-lg);max-width:500px;width:95%;max-height:90vh;overflow-y:auto;position:relative;animation:modalSlideIn .3s ease;box-shadow:var(--shadow-lg);border:1px solid rgba(255,255,255,.1)}
        @media (max-width:480px){.modal-container{width:100%;max-height:100vh;border-radius:0}}
        @keyframes modalSlideIn{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}
        .modal-header{padding:1.2rem;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:rgba(0,0,0,.2);z-index:10;border-radius:var(--radius-lg) var(--radius-lg) 0 0}
        .modal-header h3{font-size:1.3rem;color:#fff}
        .modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--gray-400);width:35px;height:35px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s}
        .modal-close:hover{background:rgba(255,255,255,.05);color:var(--danger)}
        .modal-body{padding:1.2rem;color:#fff}
        .modal-footer{padding:1.2rem;border-top:1px solid rgba(255,255,255,.1);background:rgba(0,0,0,.2);display:flex;justify-content:flex-end;gap:1rem;border-radius:0 0 var(--radius-lg) var(--radius-lg)}
        .footer{background:var(--secondary);color:white;padding:2rem 1.5rem 1rem;width:100%;margin-top:auto;position:relative;z-index:100;flex-shrink:0}
        .footer::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:100px;height:4px;background:linear-gradient(90deg,var(--primary),var(--accent));border-radius:2px}
        .footer-content{max-width:1400px;margin:0 auto;display:grid;grid-template-columns:repeat(4,1fr);gap:2rem;margin-bottom:2rem;width:100%}
        @media (max-width:992px) and (min-width:769px){.footer-content{grid-template-columns:repeat(4,1fr);gap:1.5rem}}
        @media (max-width:768px){.footer-content{grid-template-columns:1fr;gap:1.5rem;text-align:center}}
        .footer-section{display:flex;flex-direction:column;align-items:center;text-align:center}
        .footer-section h4{color:var(--accent);margin-bottom:1.2rem;font-size:1.2rem;position:relative;display:inline-block;padding-bottom:.5rem}
        .footer-section h4::after{content:'';position:absolute;left:50%;transform:translateX(-50%);bottom:0;width:40px;height:3px;background:var(--primary);border-radius:2px}
        .footer-section p,.footer-section a{color:var(--gray-400);text-decoration:none;display:flex;align-items:center;gap:.8rem;margin-bottom:.8rem;transition:color .2s,transform .2s;font-size:.95rem;justify-content:center}
        .footer-section a:hover{color:var(--accent);transform:translateY(-2px)}
        .footer-section i{width:20px;color:var(--primary);font-size:1.1rem}
        .whatsapp-link{color:#25D366!important;font-weight:600}
        .whatsapp-link:hover{color:#1da851!important}
        .social-icons{display:flex;gap:1rem;margin-top:.5rem;justify-content:center}
        .social-icons a{background:rgba(255,255,255,.1);width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .3s;color:white;font-size:1.2rem;margin-bottom:0}
        .social-icons a:hover{background:var(--primary);transform:translateY(-3px)}
        .footer-brand{text-align:center;padding-top:1.5rem;border-top:1px solid var(--gray-800);max-width:1400px;margin:0 auto;width:100%}
        .footer-brand-logo{width:50px;height:50px;border-radius:50%;object-fit:cover;border:2px solid var(--accent);margin-bottom:.5rem}
        .footer-brand-slogan{font-family:'Playfair Display',serif;font-style:italic;color:var(--accent);margin-bottom:.5rem}
        .footer-copyright{color:var(--gray-500);font-size:.85rem}
        .loading-spinner{display:inline-block;width:30px;height:30px;border:3px solid rgba(211,47,47,.2);border-radius:50%;border-top-color:var(--primary);animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-container{text-align:center;padding:2rem;color:#fff}
        .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);color:white;padding:.8rem 1.5rem;border-radius:50px;box-shadow:var(--shadow-lg);z-index:3000;display:none;animation:slideUp .3s ease;font-family:'Montserrat',sans-serif;align-items:center;gap:.8rem;font-size:.9rem;max-width:90%;text-align:center}
        .toast.show{display:flex}
        .toast.success{background:var(--success)}
        .toast.error{background:var(--danger)}
        .toast.info{background:var(--info)}
        .toast.warning{background:var(--warning)}
        @keyframes slideUp{from{transform:translate(-50%,20px);opacity:0}to{transform:translate(-50%,0);opacity:1}}
        .scroll-indicator{display:flex;flex-direction:column;align-items:center;justify-content:center;margin:1rem 0 0.5rem 0;animation:bounce 2s infinite;cursor:pointer;opacity:0.8;transition:opacity 0.3s}
        .scroll-indicator:hover{opacity:1}
        .scroll-indicator i{font-size:1.8rem;color:var(--accent);filter:drop-shadow(0 0 5px rgba(255,152,0,0.5))}
        .scroll-indicator span{font-size:0.8rem;color:var(--gray-300);margin-top:0.2rem;font-weight:500}
        @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
        .scroll-indicator.hidden{display:none}
        .payment-timer{background:linear-gradient(135deg,var(--warning),#F57C00);color:white;padding:1rem;border-radius:10px;text-align:center;margin-bottom:1rem;font-family:'Montserrat',sans-serif}
        .timer-display{font-size:1.8rem;font-weight:700;margin-top:5px;font-family:monospace}
        .asterisk{color:var(--danger);margin-left:2px;font-weight:bold}
        .parroquia-selector{position:relative;margin-bottom:1rem}
        .selected-parroquia{background:rgba(0,0,0,.3);padding:.8rem 1rem;border:2px solid rgba(255,255,255,.1);border-radius:var(--radius-md);display:flex;justify-content:space-between;align-items:center;cursor:pointer;font-size:1rem;transition:all .2s;box-shadow:var(--shadow-sm);color:#fff}
        .selected-parroquia:hover{border-color:var(--accent);box-shadow:var(--shadow-md)}
        .selected-parroquia i{transition:transform .3s;color:var(--gray-400)}
        .selected-parroquia i.fa-chevron-up{transform:rotate(180deg)}
        .parroquia-search{width:100%;padding:.8rem 1rem;border:2px solid var(--accent);border-radius:var(--radius-md) var(--radius-md) 0 0;font-size:1rem;outline:none;border-bottom:none;background:rgba(0,0,0,.5);color:#fff}
        .parroquia-search:focus{box-shadow:0 0 0 3px rgba(255,152,0,.1)}
        .parroquia-select{width:100%;padding:.5rem;border:2px solid var(--accent);border-radius:0 0 var(--radius-md) var(--radius-md);font-size:1rem;background:rgba(0,0,0,.5);color:#fff;max-height:200px;overflow-y:auto}
        .parroquia-select option{padding:.8rem 1rem;border-bottom:1px solid rgba(255,255,255,.1);cursor:pointer;transition:background .2s;background:rgba(0,0,0,.5);color:#fff}
        .parroquia-select option:hover,.parroquia-select option:checked{background:linear-gradient(135deg,var(--primary),#b71c1c);color:white}
        .payment-info{background:rgba(0,0,0,.3);padding:1.5rem;border-radius:var(--radius-md);margin-bottom:1.5rem;border:2px dashed var(--primary);box-shadow:var(--shadow-sm)}
        .payment-info h4{color:#fff;margin-bottom:1.2rem;font-size:1.2rem;display:flex;align-items:center;gap:.5rem;border-bottom:1px solid rgba(255,255,255,.1);padding-bottom:.8rem}
        .payment-info h4 i{font-size:1.3rem;color:var(--primary)}
        .payment-details{background:rgba(0,0,0,.2);padding:1rem;border-radius:var(--radius-sm);margin-bottom:1rem}
        .payment-details p{display:flex;align-items:center;gap:.8rem;margin-bottom:.8rem;font-size:1rem;padding:.5rem;border-bottom:1px solid rgba(255,255,255,.1);transition:background .2s;color:#fff}
        .payment-details p:hover{background:rgba(255,255,255,.05)}
        .payment-details p:last-child{border-bottom:none;margin-bottom:0}
        .payment-details i{width:24px;color:var(--primary);font-size:1.1rem}
        .payment-details strong{color:#fff;min-width:70px;font-weight:600}
        .payment-details .valor{color:var(--accent);font-weight:700;font-family:monospace;font-size:1.1rem;flex:1;text-align:right;margin-right:.5rem}
        .payment-details .valor-placeholder{color:var(--gray-400);font-weight:400;font-family:'Roboto',sans-serif;font-size:.95rem;font-style:italic;flex:1;text-align:right}
        .btn-copy{background:rgba(255,255,255,.1);border:none;color:var(--success);width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;font-size:.9rem;margin-left:.3rem;flex-shrink:0}
        .btn-copy:hover{background:var(--success);color:white;transform:scale(1.1)}
        .btn-copy.copied{background:var(--success);color:white}
        .payment-note{background:rgba(245,124,0,.1);padding:1rem;border-radius:var(--radius-sm);border-left:4px solid var(--accent);font-size:.9rem;color:var(--gray-300)}
        .payment-note i{color:var(--accent);margin-right:.5rem}
        .payment-note p{margin-top:.3rem;font-size:.85rem;color:var(--gray-400)}
        .delivery-price-display{background:rgba(56,142,60,.1);border:2px solid var(--success);border-radius:var(--radius-sm);padding:.8rem;margin-bottom:1.2rem;text-align:center;font-weight:600;color:var(--success);font-size:.95rem}
        .delivery-price-display.placeholder{color:var(--gray-500);font-style:italic}
        .file-input-wrapper{position:relative}
        .file-input-label{display:block;padding:1rem;background:rgba(0,0,0,.3);border:2px dashed var(--primary);border-radius:var(--radius-sm);text-align:center;cursor:pointer;transition:all .3s;font-size:1rem;color:#fff}
        .file-input-label:hover{background:rgba(0,0,0,.5);border-color:var(--accent)}
        .file-input-label.has-file{border-color:var(--success);background:rgba(56,142,60,.1)}
        .file-input-label i{font-size:2rem;color:var(--primary);margin-bottom:.5rem}
        .file-input-label span{display:block;font-size:.9rem;color:var(--gray-300);margin-top:.3rem}
        .info-box{padding:.8rem;border-radius:var(--radius-sm);margin-bottom:1rem;font-size:.9rem}
        .info-box.mesa{background:rgba(25,118,210,.1);border-left:4px solid var(--info);color:var(--info)}
        .info-box.delivery-pending{background:rgba(245,124,0,.1);border-left:4px solid var(--warning);color:var(--warning)}
        .info-box.confirmed{background:rgba(56,142,60,.1);border-left:4px solid var(--success);color:var(--success)}
        .upload-progress{width:100%;height:6px;background:rgba(255,255,255,.1);border-radius:3px;margin-top:.5rem;overflow:hidden}
        .upload-progress-bar{height:100%;background:var(--accent);transition:width .2s ease;border-radius:3px}
        .confirm-dialog{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);border-radius:var(--radius-lg);padding:2rem;text-align:center;border:1px solid rgba(255,255,255,.1);max-width:400px;margin:0 auto}
        .confirm-dialog i{font-size:3rem;color:var(--accent);margin-bottom:1rem}
        .confirm-dialog h3{color:#fff;margin-bottom:1rem;font-size:1.5rem}
        .confirm-dialog p{color:var(--gray-300);margin-bottom:2rem;line-height:1.6}
        .confirm-dialog-buttons{display:flex;gap:1rem;justify-content:center}
        .confirm-dialog .btn-confirm{background:linear-gradient(135deg,var(--success),#2E7D32);color:white;border:none;padding:.8rem 2rem;border-radius:50px;font-weight:600;cursor:pointer;transition:all .2s}
        .confirm-dialog .btn-confirm:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(56,142,60,.4)}
        .confirm-dialog .btn-cancel{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);padding:.8rem 2rem;border-radius:50px;font-weight:600;cursor:pointer;transition:all .2s}
        .confirm-dialog .btn-cancel:hover{background:rgba(255,255,255,.2)}
        .text-primary{color:var(--primary)}
        .text-accent{color:var(--accent)}
        .bg-light{background:var(--light-bg)}
        .text-center{text-align:center}
    </style>
</head>
<body>
    <div class="overlay" id="overlay" onclick="cerrarTodosLosPaneles()"></div>
    <div class="toast" id="toast"></div>
    <header class="header">
        <div class="header-left">
            <button class="menu-hamburguesa" id="menuToggle" title="Categor√≠as"><i class="fas fa-bars"></i></button>
        </div>
        <div class="logo-area" onclick="resetToAllCategories()">
            <img src="https://lh3.googleusercontent.com/pw/AP1GczPrZAoWxmsOGRD9xl1hO5Q65JXuwUZzoR6gUk-cw5lVmarxQe_-lwqpA60tTKLlXfpvIjAJlKC6jFls-xETJOPkebLIIPhbGlUkknmhrRbdhMUll2UViGSUj3WmHKg2YEsZlAfxBPPTjIHhScjD0jfe=w1439-h1439-s-no-gm" alt="Saki Sushi" class="logo">
            <h1>Saki Sushi</h1>
            <span class="header-slogan">"Adictos al universo saki"</span>
        </div>
        <div class="header-icons" id="headerIcons">
            <div style="position:relative"><button class="icon-button" id="notificationBell"><i class="fas fa-bell"></i></button><span class="notification-badge" id="notificationBadge" style="display:none">0</span></div>
            <div style="position:relative"><button class="icon-button" id="cartToggle" title="Carrito"><i class="fas fa-shopping-cart"></i></button><span class="cart-badge" id="cartBadge" style="display:none;">0</span></div>
            <div class="table-badge" id="tableBadge" style="display:none;">Mesa <span id="tableNumber">--</span></div>
        </div>
    </header>
    <div class="content-wrapper">
        <div class="main-layout">
            <div id="sidebarContainer">
                <div class="category-sidebar" id="categorySidebar">
                    <div class="category-header">
                        <span><i class="fas fa-utensils"></i> Categor√≠as</span>
                        <i class="fas fa-times" id="closeCategoryMenu"></i>
                    </div>
                    <ul class="category-list" id="categoryList">
                        <li class="loading-container"><div class="loading-spinner"></div><p>Cargando categor√≠as...</p></li>
                    </ul>
                </div>
                <div class="cart-sidebar" id="cartSidebar">
                    <div class="cart-header">
                        <h3><i class="fas fa-shopping-cart"></i> Tu Pedido</h3>
                        <button id="closeCart"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="cart-items" id="cartItems">
                        <div class="cart-empty">
                            <i class="fas fa-shopping-basket"></i>
                            <p>Tu carrito est√° vac√≠o</p>
                            <small>¬°Agrega algunos platillos!</small>
                        </div>
                    </div>
                    <div class="cart-footer" id="cartFooter" style="display:none;">
                        <div class="cart-total">
                            <span>Total:</span>
                            <span id="cartTotal">Bs. 0,00</span>
                        </div>
                        <div class="cart-buttons" id="cartButtons"></div>
                    </div>
                </div>
            </div>
            <main class="main-content" id="mainContent">
                <div class="tagline-section">
                    <div class="tagline">
                        <div class="tagline-item ofertas" onclick="selectCategoria('ofertas')">üî• OFERTAS ESPECIALES</div>
                        <div class="tagline-item">üêü Fresco del d√≠a</div>
                        <div class="tagline-item">üéå Tradicional</div>
                        <div class="tagline-item">üë®‚Äçüç≥ Chef experto</div>
                    </div>
                </div>
                <div class="search-section">
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Buscar platillos...">
                    </div>
                </div>
                <div class="category-title">
                    <h2 id="categoryTitle">Men√∫</h2>
                </div>
                <div class="menu-section">
                    <div class="menu-grid" id="menuGrid">
                        <div class="loading-container"><div class="loading-spinner"></div><p>Cargando deliciosas opciones...</p></div>
                    </div>
                    <div class="pagination-controls" id="paginationControls">
                        <button class="pagination-btn" id="prevPageBtn" disabled><i class="fas fa-chevron-left"></i> Anterior</button>
                        <span class="pagination-info" id="pageInfo">P√°gina 1 de 1</span>
                        <button class="pagination-btn" id="nextPageBtn" disabled>Siguiente <i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </main>
        </div>
        <div class="modal-overlay" id="customizeModal"><div class="modal-container"><div class="modal-header"><h3><i class="fas fa-star text-accent"></i> Personalizar</h3><button class="modal-close" id="closeCustomizeModal">&times;</button></div><div class="modal-body" id="customizeModalBody"></div><div class="modal-footer"><button class="btn-secondary" id="cancelCustomize">Cancelar</button><button class="btn-primary" id="addToCartFromModal"><i class="fas fa-cart-plus"></i> A√±adir</button></div></div></div>
        <div class="modal-overlay" id="confirmMesaModal"><div class="modal-container"><div class="modal-header"><h3><i class="fas fa-store"></i> Confirmar Pedido</h3><button class="modal-close" id="closeConfirmMesaModal">&times;</button></div><div class="modal-body"><div class="info-box mesa"><i class="fas fa-info-circle"></i> Pedido para <strong>Mesa <span id="confirmTableNumber">#--</span></strong></div><div style="margin:1rem 0"><h4 style="margin-bottom:.8rem">Resumen:</h4><div id="mesaOrderSummary" style="background:rgba(0,0,0,.2); padding:.8rem; border-radius:var(--radius-sm)"></div></div><div class="info-box mesa" style="margin-top:.5rem"><i class="fas fa-clock"></i> Por favor, pasa a caja a cancelar.</div><div style="margin:1rem 0"><label for="clienteNombre" style="display:block; margin-bottom:.3rem; font-weight:600; color:#fff">Tu nombre (opcional):</label><input type="text" id="clienteNombre" placeholder="Ej: Juan" style="width:100%; padding:.7rem; border:1px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); background:rgba(0,0,0,.3); color:#fff"></div></div><div class="modal-footer"><button class="btn-secondary" id="cancelMesaOrder">Cancelar</button><button class="btn-primary" id="confirmMesaOrder"><i class="fas fa-check"></i> Hacer Pedido</button></div></div></div>
        <div class="modal-overlay" id="deliveryModal"><div class="modal-container"><div class="modal-header"><h3><i class="fas fa-motorcycle"></i> Delivery</h3><button class="modal-close" id="closeDeliveryModal">&times;</button></div><div class="modal-body"><div class="payment-timer" id="deliveryTimer" style="display:block"><i class="fas fa-hourglass-half"></i> 20 min para pagar<div class="timer-display" id="deliveryTimerDisplay">20:00</div></div><div class="payment-info"><h4><i class="fas fa-credit-card"></i> Datos de Pago - Pago M√≥vil</h4><div class="payment-details"><p><i class="fas fa-university"></i><strong>Banco:</strong><span class="valor">Banesco</span></p><p><i class="fas fa-phone-alt"></i><strong>Tel√©fono:</strong><span class="valor" id="telefonoPago">0424-1525233</span><button class="btn-copy" onclick="copiarAlPortapapeles('0424-1525233', this)" title="Copiar tel√©fono"><i class="fas fa-copy"></i></button></p><p><i class="fas fa-id-card"></i><strong>RIF:</strong><span class="valor" id="rifPago">J-501519838</span><button class="btn-copy" onclick="copiarAlPortapapeles('J-501519838', this)" title="Copiar RIF"><i class="fas fa-copy"></i></button></p><p><i class="fas fa-dollar-sign"></i><strong>Monto:</strong><span class="valor-placeholder" id="montoPago">Primero seleccione Parroquia a enviar</span></p></div><div class="payment-note"><i class="fas fa-info-circle"></i><strong>S√≥lo se aceptan pagos por Pago M√≥vil</strong><p>Por favor, aseg√∫rese de que su direcci√≥n y tel√©fono sean los correctos para garantizar que su pedido llegue a sus manos sin inconvenientes.</p></div></div><form id="deliveryForm"><div style="margin-bottom:1.5rem"><label style="display:block; margin-bottom:.5rem; font-weight:600; color:#fff">Parroquia a enviar: <span class="asterisk">*</span></label><div class="parroquia-selector"><div class="selected-parroquia" onclick="toggleParroquiaSelect()"><span id="selectedParroquiaText">Seleccionar parroquia</span><i class="fas fa-chevron-down" id="parroquiaChevron"></i></div><input type="text" id="parroquiaSearch" class="parroquia-search" placeholder="Buscar parroquia..." style="display:none"><select id="parroquiaSelect" class="parroquia-select" size="5" style="display:none" onchange="seleccionarParroquia(this)"><option value="">Seleccionar parroquia</option><option value="Altagracia">Altagracia</option><option value="Ant√≠mano">Ant√≠mano</option><option value="Candelaria">Candelaria</option><option value="Caricuao">Caricuao</option><option value="Caucag√ºita">Caucag√ºita</option><option value="Catedral">Catedral</option><option value="Chacao">Chacao</option><option value="Coche">Coche</option><option value="El Cafetal">El Cafetal</option><option value="El Junquito">El Junquito</option><option value="El Para√≠so">El Para√≠so</option><option value="El Recreo">El Recreo</option><option value="El Valle">El Valle</option><option value="Fila de Mariches">Fila de Mariches</option><option value="La Dolorita">La Dolorita</option><option value="La Pastora">La Pastora</option><option value="La Vega">La Vega</option><option value="Las Minas">Las Minas</option><option value="Leoncio Mart√≠nez">Leoncio Mart√≠nez</option><option value="Macarao">Macarao</option><option value="Nuestra Se√±ora del Rosario">Nuestra Se√±ora del Rosario</option><option value="Petare">Petare</option><option value="San Agust√≠n">San Agust√≠n</option><option value="San Bernardino">San Bernardino</option><option value="San Jos√©">San Jos√©</option><option value="San Juan">San Juan</option><option value="San Pedro">San Pedro</option><option value="Santa Rosal√≠a">Santa Rosal√≠a</option><option value="Santa Rosal√≠a de Palermo">Santa Rosal√≠a de Palermo</option><option value="Santa Teresa">Santa Teresa</option><option value="Sucre">Sucre</option><option value="23 de Enero">23 de Enero</option></select></div></div><div class="delivery-price-display" id="deliveryPriceDisplay">Primero seleccione Parroquia a enviar</div><div style="margin-bottom:1.5rem"><label for="direccion" style="display:block; margin-bottom:.5rem; font-weight:600; color:#fff">Direcci√≥n completa <span class="asterisk">*</span></label><textarea id="direccion" required minlength="20" placeholder="Introduce tu direcci√≥n completa (m√≠nimo 20 caracteres)" style="width:100%; padding:.8rem; border:2px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); font-size:1rem; transition:border .2s; background:rgba(0,0,0,.3); color:#fff" rows="3" oninput="actualizarContadorDireccion()"></textarea><div style="display:flex; justify-content:flex-end; margin-top:.3rem"><small id="direccionCounter" style="color:var(--gray-400); font-weight:500">0/20 caracteres</small></div></div><div style="margin-bottom:1.5rem"><label for="telefono" style="display:block; margin-bottom:.5rem; font-weight:600; color:#fff">Tel√©fono (m√°x 14 d√≠gitos) <span class="asterisk">*</span></label><input type="tel" id="telefono" required pattern="\+[0-9]{11,14}" maxlength="15" placeholder="Ej: +5804121234567 o 04121234567" inputmode="numeric" style="width:100%; padding:.8rem; border:2px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); font-size:1rem; background:rgba(0,0,0,.3); color:#fff" oninput="this.value=this.value.replace(/[^0-9+]/g,''); if(this.value.indexOf('+')!==0&&this.value.length>0){this.value='+'+this.value.replace(/\+/g,'')} validarFormularioDelivery()"></div><div style="margin-bottom:1.5rem"><label style="display:block; margin-bottom:.5rem; font-weight:600; color:#fff">Referencia (6 d√≠gitos) <span class="asterisk">*</span></label><div style="display:flex; gap:.5rem; justify-content:center"><input type="text" maxlength="1" class="ref-digit" data-type="delivery" data-index="0" style="width:50px; height:50px; text-align:center; padding:.5rem; border:2px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); font-size:1.4rem; font-weight:600; background:rgba(0,0,0,.3); color:#fff" inputmode="numeric" pattern="[0-9]*" oninput="this.value=this.value.replace(/[^0-9]/g,''); moverSiguiente(this,'delivery',0); validarFormularioDelivery()"><input type="text" maxlength="1" class="ref-digit" data-type="delivery" data-index="1" style="width:50px; height:50px; text-align:center; padding:.5rem; border:2px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); font-size:1.4rem; font-weight:600; background:rgba(0,0,0,.3); color:#fff" inputmode="numeric" pattern="[0-9]*" oninput="this.value=this.value.replace(/[^0-9]/g,''); moverSiguiente(this,'delivery',1); validarFormularioDelivery()"><input type="text" maxlength="1" class="ref-digit" data-type="delivery" data-index="2" style="width:50px; height:50px; text-align:center; padding:.5rem; border:2px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); font-size:1.4rem; font-weight:600; background:rgba(0,0,0,.3); color:#fff" inputmode="numeric" pattern="[0-9]*" oninput="this.value=this.value.replace(/[^0-9]/g,''); moverSiguiente(this,'delivery',2); validarFormularioDelivery()"><input type="text" maxlength="1" class="ref-digit" data-type="delivery" data-index="3" style="width:50px; height:50px; text-align:center; padding:.5rem; border:2px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); font-size:1.4rem; font-weight:600; background:rgba(0,0,0,.3); color:#fff" inputmode="numeric" pattern="[0-9]*" oninput="this.value=this.value.replace(/[^0-9]/g,''); moverSiguiente(this,'delivery',3); validarFormularioDelivery()"><input type="text" maxlength="1" class="ref-digit" data-type="delivery" data-index="4" style="width:50px; height:50px; text-align:center; padding:.5rem; border:2px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); font-size:1.4rem; font-weight:600; background:rgba(0,0,0,.3); color:#fff" inputmode="numeric" pattern="[0-9]*" oninput="this.value=this.value.replace(/[^0-9]/g,''); moverSiguiente(this,'delivery',4); validarFormularioDelivery()"><input type="text" maxlength="1" class="ref-digit" data-type="delivery" data-index="5" style="width:50px; height:50px; text-align:center; padding:.5rem; border:2px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); font-size:1.4rem; font-weight:600; background:rgba(0,0,0,.3); color:#fff" inputmode="numeric" pattern="[0-9]*" oninput="this.value=this.value.replace(/[^0-9]/g,''); moverSiguiente(this,'delivery',5); validarFormularioDelivery()"></div></div><div style="margin-bottom:1.5rem"><label for="comprobante" style="display:block; margin-bottom:.5rem; font-weight:600; color:#fff">Comprobante de pago <span class="asterisk">*</span></label><div class="file-input-wrapper"><input type="file" id="comprobante" accept="image/*" style="display:none" onchange="handleComprobanteSelect(this)"><label for="comprobante" class="file-input-label" id="comprobanteLabel"><i class="fas fa-cloud-upload-alt"></i><span>Haz clic para seleccionar una imagen</span><small>JPG, PNG, GIF (max. 5MB)</small></label><div class="upload-progress" id="uploadProgress" style="display:none"><div class="upload-progress-bar" id="uploadProgressBar" style="width:0%"></div></div></div></div><div style="padding:1rem; background:rgba(0,0,0,.2); border-radius:var(--radius-md); border:2px solid var(--primary)"><div style="display:flex; justify-content:space-between; align-items:center"><span style="font-weight:600; font-size:1.1rem; color:#fff">Total a pagar:</span><span style="font-weight:700; color:var(--accent); font-size:1.4rem" id="deliveryTotal">Primero seleccione parroquia a enviar</span></div></div></form></div><div class="modal-footer"><button class="btn-secondary" id="cancelDelivery">Cancelar</button><button class="btn-primary" id="confirmDelivery" disabled><i class="fas fa-check"></i> Confirmar Pedido</button></div></div></div>
        <div class="modal-overlay" id="reservaModal"><div class="modal-container"><div class="modal-header"><h3><i class="fas fa-calendar-alt"></i> Reserva</h3><button class="modal-close" id="closeReservaModal">&times;</button></div><div class="modal-body"><div class="payment-timer" id="reservaTimer" style="display:block"><i class="fas fa-hourglass-half"></i> 20 min para pagar<div class="timer-display" id="reservaTimerDisplay">20:00</div></div><div class="payment-info"><h4><i class="fas fa-credit-card"></i> Datos de Pago - Pago M√≥vil</h4><div class="payment-details"><p><i class="fas fa-university"></i><strong>Banco:</strong><span class="valor">Banesco</span></p><p><i class="fas fa-phone-alt"></i><strong>Tel√©fono:</strong><span class="valor" id="telefonoPagoReserva">0424-1525233</span><button class="btn-copy" onclick="copiarAlPortapapeles('0424-1525233', this)" title="Copiar tel√©fono"><i class="fas fa-copy"></i></button></p><p><i class="fas fa-id-card"></i><strong>RIF:</strong><span class="valor" id="rifPagoReserva">J-501519838</span><button class="btn-copy" onclick="copiarAlPortapapeles('J-501519838', this)" title="Copiar RIF"><i class="fas fa-copy"></i></button></p><p><i class="fas fa-dollar-sign"></i><strong>Monto:</strong><span class="valor" id="montoReserva">Bs. 0,00</span><button class="btn-copy" onclick="copiarAlPortapapeles(document.getElementById('montoReserva').textContent.replace('Bs. ', ''), this)" title="Copiar monto"><i class="fas fa-copy"></i></button></p></div><div class="payment-note"><i class="fas fa-info-circle"></i><strong>S√≥lo se aceptan pagos por Pago M√≥vil</strong><p>Por favor, aseg√∫rese de que su direcci√≥n y tel√©fono sean los correctos para garantizar que su pedido llegue a sus manos sin inconvenientes.</p></div></div><form id="reservaForm"><div style="margin-bottom:1.5rem"><label for="fechaReserva" style="display:block; margin-bottom:.5rem; font-weight:600; color:#fff">Fecha de la reserva <span class="asterisk">*</span></label><input type="date" id="fechaReserva" required min="" style="width:100%; padding:.8rem; border:2px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); font-size:1rem; background:rgba(0,0,0,.3); color:#fff" onchange="validarFormularioReserva()"></div><div style="margin-bottom:1.5rem"><label for="nombreReserva" style="display:block; margin-bottom:.5rem; font-weight:600; color:#fff">Nombre completo <span class="asterisk">*</span></label><input type="text" id="nombreReserva" required placeholder="Tu nombre" style="width:100%; padding:.8rem; border:2px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); font-size:1rem; background:rgba(0,0,0,.3); color:#fff" oninput="validarFormularioReserva()"></div><div style="margin-bottom:1.5rem"><label style="display:block; margin-bottom:.5rem; font-weight:600; color:#fff">Referencia (6 d√≠gitos) <span class="asterisk">*</span></label><div style="display:flex; gap:.5rem; justify-content:center"><input type="text" maxlength="1" class="ref-digit" data-type="reserva" data-index="0" style="width:50px; height:50px; text-align:center; padding:.5rem; border:2px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); font-size:1.4rem; font-weight:600; background:rgba(0,0,0,.3); color:#fff" inputmode="numeric" pattern="[0-9]*" oninput="this.value=this.value.replace(/[^0-9]/g,''); moverSiguiente(this,'reserva',0); validarFormularioReserva()"><input type="text" maxlength="1" class="ref-digit" data-type="reserva" data-index="1" style="width:50px; height:50px; text-align:center; padding:.5rem; border:2px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); font-size:1.4rem; font-weight:600; background:rgba(0,0,0,.3); color:#fff" inputmode="numeric" pattern="[0-9]*" oninput="this.value=this.value.replace(/[^0-9]/g,''); moverSiguiente(this,'reserva',1); validarFormularioReserva()"><input type="text" maxlength="1" class="ref-digit" data-type="reserva" data-index="2" style="width:50px; height:50px; text-align:center; padding:.5rem; border:2px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); font-size:1.4rem; font-weight:600; background:rgba(0,0,0,.3); color:#fff" inputmode="numeric" pattern="[0-9]*" oninput="this.value=this.value.replace(/[^0-9]/g,''); moverSiguiente(this,'reserva',2); validarFormularioReserva()"><input type="text" maxlength="1" class="ref-digit" data-type="reserva" data-index="3" style="width:50px; height:50px; text-align:center; padding:.5rem; border:2px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); font-size:1.4rem; font-weight:600; background:rgba(0,0,0,.3); color:#fff" inputmode="numeric" pattern="[0-9]*" oninput="this.value=this.value.replace(/[^0-9]/g,''); moverSiguiente(this,'reserva',3); validarFormularioReserva()"><input type="text" maxlength="1" class="ref-digit" data-type="reserva" data-index="4" style="width:50px; height:50px; text-align:center; padding:.5rem; border:2px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); font-size:1.4rem; font-weight:600; background:rgba(0,0,0,.3); color:#fff" inputmode="numeric" pattern="[0-9]*" oninput="this.value=this.value.replace(/[^0-9]/g,''); moverSiguiente(this,'reserva',4); validarFormularioReserva()"><input type="text" maxlength="1" class="ref-digit" data-type="reserva" data-index="5" style="width:50px; height:50px; text-align:center; padding:.5rem; border:2px solid rgba(255,255,255,.1); border-radius:var(--radius-sm); font-size:1.4rem; font-weight:600; background:rgba(0,0,0,.3); color:#fff" inputmode="numeric" pattern="[0-9]*" oninput="this.value=this.value.replace(/[^0-9]/g,''); moverSiguiente(this,'reserva',5); validarFormularioReserva()"></div></div><div style="margin-bottom:1.5rem"><label for="comprobanteReserva" style="display:block; margin-bottom:.5rem; font-weight:600; color:#fff">Comprobante de pago <span class="asterisk">*</span></label><div class="file-input-wrapper"><input type="file" id="comprobanteReserva" accept="image/*" style="display:none" onchange="handleComprobanteReservaSelect(this)"><label for="comprobanteReserva" class="file-input-label" id="comprobanteReservaLabel"><i class="fas fa-cloud-upload-alt"></i><span>Haz clic para seleccionar una imagen</span><small>JPG, PNG, GIF (max. 5MB)</small></label><div class="upload-progress" id="uploadProgressReserva" style="display:none"><div class="upload-progress-bar" id="uploadProgressBarReserva" style="width:0%"></div></div></div></div><div style="padding:1rem; background:rgba(0,0,0,.2); border-radius:var(--radius-md); border:2px solid var(--primary)"><div style="display:flex; justify-content:space-between; align-items:center"><span style="font-weight:600; font-size:1.1rem; color:#fff">Total a pagar:</span><span style="font-weight:700; color:var(--accent); font-size:1.4rem" id="reservaTotal">Bs. 0,00</span></div></div></form></div><div class="modal-footer"><button class="btn-secondary" id="cancelReserva">Cancelar</button><button class="btn-primary" id="confirmReserva" disabled><i class="fas fa-check"></i> Confirmar Reserva</button></div></div></div>
    </div>
    <div class="notifications-panel" id="notificationsPanel">
        <div class="notifications-header">
            <h4>Notificaciones</h4>
            <span id="notificationsCount">0</span>
        </div>
        <div class="notifications-list" id="notificationsList"></div>
    </div>
    <footer class="footer">
		<div class="footer-content">
			<div class="footer-section"><img src="https://lh3.googleusercontent.com/pw/AP1GczPrZAoWxmsOGRD9xl1hO5Q65JXuwUZzoR6gUk-cw5lVmarxQe_-lwqpA60tTKLlXfpvIjAJlKC6jFls-xETJOPkebLIIPhbGlUkknmhrRbdhMUll2UViGSUj3WmHKg2YEsZlAfxBPPTjIHhScjD0jfe=w1439-h1439-s-no-gm" alt="Saki Sushi" class="footer-brand-logo" style="width:140px; height:155px;"><div class="footer-brand-slogan">"Adictos al universo saki"</div></div>
			<div class="footer-section"><h4>Av Universidad</h4><p><i class="fas fa-clock"></i> Lunes a Domingo: 11:00 AM - 10:00 PM</p><a href="https://wa.me/5804242884773" class="whatsapp-link" target="_blank"><i class="fab fa-whatsapp"></i> +58 0424-2884773</a><a href="https://wa.me/5804242884772" class="whatsapp-link" target="_blank"><i class="fab fa-whatsapp"></i> +58 0424-2884772</a><p><i class="fas fa-map-marker-alt"></i> Caracas</p></div>
			<div class="footer-section"><h4>San Bernardino</h4><p><i class="fas fa-clock"></i> Lunes a Domingo: 11:00 AM - 10:00 PM</p><a href="https://wa.me/5804241722322" class="whatsapp-link" target="_blank"><i class="fab fa-whatsapp"></i> +58 0424-1722322</a><a href="https://wa.me/5804241722339" class="whatsapp-link" target="_blank"><i class="fab fa-whatsapp"></i> +58 0424-1722339</a><p><i class="fas fa-map-marker-alt"></i> Caracas</p></div>
			<div class="footer-section"><h4>S√≠guenos</h4><div class="social-icons" style="justify-content:center; gap:2rem; margin-top:0.5rem;"><a href="https://www.instagram.com/sakisushiccs/?hl=es" target="_blank" class="instagram-link" style="background:rgba(255,255,255,.1); width:90px; height:90px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; text-decoration:none;"><i class="fab fa-instagram" style="font-size:3.5rem; line-height:1; display:flex; align-items:center; justify-content:center; width:100%; height:100%;"></i></a><a href="https://www.tiktok.com/@sakisushiccs" target="_blank" class="tiktok-link" style="background:rgba(255,255,255,.1); width:90px; height:90px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; text-decoration:none;"><i class="fab fa-tiktok" style="font-size:3.5rem; line-height:1; display:flex; align-items:center; justify-content:center; width:100%; height:100%;"></i></a></div></div>
		</div>
		<div class="footer-brand"><div class="footer-copyright">¬© 2021 Saki Sushi. Todos los derechos reservados.</div></div>
	</footer>
    <audio id="notificationSound" src="https://iqwwoihiiyrtypyqzhgy.supabase.co/storage/v1/object/public/alarma/IPHONE%20NOTIFICATION%20SOUND%20EFFECT%20(PING_DING).mp3" preload="auto"></audio>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../supabase-config.js"></script>
    <script>
        let sessionId = localStorage.getItem('saki_session_id') || generarId('session_');
        localStorage.setItem('saki_session_id', sessionId);
        let menuItems = [], inventario = [], carrito = [], notificaciones = [], notificacionesNoLeidas = 0;
        let currentCustomizeItem = null, mesaId = null;
        let nivel1Activo = null, nivel2Activo = null;
        let timersActivos = {}, intervalosTimer = {}, pedidosActivos = [];
        let paginaVisible = true, suscripcionesCliente = [];
        let notificacionesPendientes = new Map(), intervaloReintentos = null, canalNotificaciones = null;
        let currentPage = 1, itemsPerPage = 6, filteredMenuItems = [];
        const preciosPorParroquia = {
            "Altagracia": 3, "Ant√≠mano": 7, "Candelaria": 2, "Caricuao": 7, "Caucag√ºita": 7,
            "Catedral": 3, "Chacao": 5, "Coche": 5, "El Cafetal": 6, "El Junquito": 7,
            "El Para√≠so": 4, "El Recreo": 4, "El Valle": 5, "Fila de Mariches": 6, "La Dolorita": 6,
            "La Pastora": 3, "La Vega": 4, "Las Minas": 5, "Leoncio Mart√≠nez": 6, "Macarao": 7,
            "Nuestra Se√±ora del Rosario": 7, "Petare": 6, "San Agust√≠n": 2, "San Bernardino": 2,
            "San Jos√©": 2, "San Juan": 3, "San Pedro": 4, "Santa Rosal√≠a": 3,
            "Santa Rosal√≠a de Palermo": 3, "Santa Teresa": 3, "Sucre": 7, "23 de Enero": 4
        };
        const mensajesEstado = {
            'approved': { titulo: '‚úÖ Pago confirmado', icono: 'check-circle' },
            'rejected': { titulo: '‚ùå Pedido rechazado', icono: 'times-circle' },
            'pending': { titulo: '‚è≥ Pedido pendiente', icono: 'clock' }
        };
        const iconosCategorias = {
            'todos': 'fa-utensils', 'entradas': 'fa-leaf', 'sushi': 'fa-fish',
            'rolls': 'fa-egg', 'tragos': 'fa-wine-glass-alt', 'pokes': 'fa-bowl-food',
            'ensaladas': 'fa-carrot', 'china': 'fa-dragon', 'japonesa': 'fa-sun',
            'ofertas': 'fa-fire', 'ninos': 'fa-child', 'ejecutivo': 'fa-briefcase'
        };
        const categoriasPredefinidas = [
            { id: 'todos', nombre: 'Todos los platillos' },
            { id: 'entradas', nombre: 'Entradas' },
            { id: 'sushi', nombre: 'Sushi' },
            { id: 'rolls', nombre: 'Rolls', subcategorias: ['Rolls Fr√≠os de 10 piezas', 'Rolls Tempura de 12 piezas'] },
            { id: 'tragos', nombre: 'Tragos y bebidas' },
            { id: 'pokes', nombre: 'Pokes' },
            { id: 'ensaladas', nombre: 'Ensaladas' },
            { id: 'china', nombre: 'Comida China', subcategorias: ['Arroz Chino', 'Arroz Cantones', 'Chopsuey', 'Lomey', 'Chow Mein', 'Fideos de Arroz', 'Tallarines Cantones', 'Mariscos', 'Foo Yong', 'Sopas', 'Entremeses'] },
            { id: 'japonesa', nombre: 'Comida Japonesa', subcategorias: ['Yakimeshi', 'Yakisoba', 'Pasta Udon', 'Churrasco'] },
            { id: 'ofertas', nombre: 'OFERTAS ESPECIALES' },
            { id: 'ninos', nombre: 'Para Ni√±os' },
            { id: 'ejecutivo', nombre: 'Combo Ejecutivo' }
        ];
        const urlParams = new URLSearchParams(window.location.search);
        mesaId = urlParams.get('mesa');
        let deliveryFormData = { parroquia: '', direccion: '', telefono: '', referencia: '', comprobante: null };
        let reservaFormData = { fecha: '', nombre: '', referencia: '', comprobante: null };
        let isUploading = false, uploadComplete = false;

        document.addEventListener('visibilitychange', function() {
            if (document.hidden) paginaVisible = false;
            else { paginaVisible = true; recargarAlVolver(); }
        });

        async function recargarAlVolver() {
            await cargarMenu(); await cargarInventario(); await cargarNotificaciones();
            window.stockCache.invalidate(); renderizarMenuPaginado();
        }

        function limpiarCampoComprobante(tipo) {
            if (tipo === 'delivery') {
                document.getElementById('comprobante').value = ''; deliveryFormData.comprobante = null;
                const label = document.getElementById('comprobanteLabel');
                label.innerHTML = '<i class="fas fa-cloud-upload-alt"></i><span>Haz clic para seleccionar una imagen</span><small>JPG, PNG, GIF (max. 5MB)</small>';
                label.classList.remove('has-file');
            } else {
                document.getElementById('comprobanteReserva').value = ''; reservaFormData.comprobante = null;
                const label = document.getElementById('comprobanteReservaLabel');
                label.innerHTML = '<i class="fas fa-cloud-upload-alt"></i><span>Haz clic para seleccionar una imagen</span><small>JPG, PNG, GIF (max. 5MB)</small>';
                label.classList.remove('has-file');
            }
        }

        function limpiarReferencias(type) {
            for (let i = 0; i < 6; i++) {
                const input = document.querySelector(`.ref-digit[data-type="${type}"][data-index="${i}"]`);
                if (input) input.value = '';
            }
        }

        function mostrarDialogoContinuar() {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.id = 'continuarDialogo';
            overlay.innerHTML = `<div class="confirm-dialog"><i class="fas fa-shopping-basket"></i><h3>¬øContinuar con pedido anterior?</h3><p>Parece que tienes un pedido sin finalizar de hace menos de una hora. ¬øDeseas continuar donde lo dejaste?</p><div class="confirm-dialog-buttons"><button class="btn-cancel" id="cancelarPedidoAnterior">Cancelar</button><button class="btn-confirm" id="confirmarPedidoAnterior">Continuar</button></div></div>`;
            document.body.appendChild(overlay);
            document.getElementById('cancelarPedidoAnterior').addEventListener('click', () => {
                document.getElementById('continuarDialogo').remove();
                carrito = []; guardarCarrito(); actualizarCarritoUI(); actualizarCarritoBadge(); limpiarDatosFormulario();
                limpiarReferencias('delivery'); limpiarReferencias('reserva');
                window.pedidoAnterior = null;
            });
            document.getElementById('confirmarPedidoAnterior').addEventListener('click', () => {
                if (window.pedidoAnterior && window.pedidoAnterior.length > 0) {
                    carrito = window.pedidoAnterior;
                    guardarCarrito();
                    actualizarCarritoUI();
                    actualizarCarritoBadge();
                    window.stockCache.invalidate();
                    const platillosAActualizar = new Set();
                    carrito.forEach(instancia => {
                        if (instancia.platilloId) {
                            platillosAActualizar.add(instancia.platilloId);
                            const platillo = menuItems.find(p => p.id === instancia.platilloId);
                            if (platillo && platillo.ingredientes) {
                                Object.keys(platillo.ingredientes).forEach(ingId => {
                                    menuItems.forEach(item => {
                                        if (item.ingredientes && item.ingredientes[ingId]) {
                                            platillosAActualizar.add(item.id);
                                        }
                                    });
                                });
                            }
                        }
                    });
                    platillosAActualizar.forEach(pid => actualizarStockPlatillo(pid));
                    mostrarToast('üîÑ Pedido anterior restaurado', 'success');
                }
                document.getElementById('continuarDialogo').remove();
                window.pedidoAnterior = null;
            });
        }

        function toggleMenuCategorias() {
            if (window.innerWidth <= 992) {
                const menu = document.getElementById('categorySidebar');
                const carrito = document.getElementById('cartSidebar');
                if (!menu.classList.contains('open')) carrito.classList.remove('open');
                menu.classList.toggle('open');
                if (menu.classList.contains('open') || carrito.classList.contains('open')) {
                    document.getElementById('overlay').classList.add('active');
                } else { document.getElementById('overlay').classList.remove('active'); }
            }
        }
        function cerrarMenuCategorias() {
            if (window.innerWidth <= 992) {
                document.getElementById('categorySidebar').classList.remove('open');
                if (!document.getElementById('cartSidebar').classList.contains('open')) {
                    document.getElementById('overlay').classList.remove('active');
                }
            }
        }
        function toggleCarrito() {
            if (window.innerWidth <= 992) {
                const carrito = document.getElementById('cartSidebar');
                const menu = document.getElementById('categorySidebar');
                if (!carrito.classList.contains('open')) menu.classList.remove('open');
                carrito.classList.toggle('open');
                if (carrito.classList.contains('open') || menu.classList.contains('open')) {
                    document.getElementById('overlay').classList.add('active');
                } else { document.getElementById('overlay').classList.remove('active'); }
            }
        }
        function cerrarCarrito() {
            if (window.innerWidth <= 992) {
                document.getElementById('cartSidebar').classList.remove('open');
                if (!document.getElementById('categorySidebar').classList.contains('open')) {
                    document.getElementById('overlay').classList.remove('active');
                }
            }
        }
        function cerrarNotificaciones() { document.getElementById('notificationsPanel').classList.remove('active'); }
        function cerrarTodosLosPaneles() {
            if (window.innerWidth <= 992) {
                document.getElementById('categorySidebar').classList.remove('open');
                document.getElementById('cartSidebar').classList.remove('open');
                document.getElementById('overlay').classList.remove('active');
            }
            cerrarNotificaciones();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('1Ô∏è‚É£ Inicializando cliente...');
            await cargarConfiguracion(); console.log('2Ô∏è‚É£ Configuraci√≥n cargada');
            await cargarMenu(); console.log('3Ô∏è‚É£ Men√∫ cargado');
            await cargarInventario(); console.log('4Ô∏è‚É£ Inventario cargado');
            cargarCategorias(); console.log('5Ô∏è‚É£ Categor√≠as cargadas');
            setupEventListeners(); console.log('6Ô∏è‚É£ Event listeners configurados');
            setupRealtimeSubscriptions(); console.log('7Ô∏è‚É£ Suscripciones configuradas');
            restaurarCarrito(); console.log('8Ô∏è‚É£ Carrito restaurado');
            actualizarUI(); actualizarCarritoBadge(); restaurarDatosFormulario();
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaReserva').min = hoy;
            if (mesaId) {
                document.getElementById('tableNumber').textContent = mesaId;
                document.getElementById('tableBadge').style.display = 'inline-block';
                document.getElementById('confirmTableNumber').textContent = mesaId;
                const headerIcons = document.getElementById('headerIcons');
                const bellWrapper = headerIcons.children[0];
                const cartWrapper = headerIcons.children[1];
                const badge = headerIcons.children[2];
                headerIcons.innerHTML = '';
                headerIcons.appendChild(bellWrapper);
                headerIcons.appendChild(cartWrapper);
                headerIcons.appendChild(badge);
                headerIcons.classList.add('left-aligned');
            }
            resetToAllCategories();
            cerrarTodosLosPaneles();
            console.log('üéâ Cliente listo!');
            iniciarSistemaReintentos();
            setTimeout(() => {
                if (notificaciones.length === 0) cargarPedidosCliente();
            }, 1000);
        });

        window.addEventListener('beforeunload', () => {
            if (intervaloReintentos) clearInterval(intervaloReintentos);
            Object.values(intervalosTimer).forEach(clearInterval);
        });

        window.addEventListener('resize', function() {
            if (window.innerWidth > 992) {
                document.getElementById('categorySidebar').classList.remove('open');
                document.getElementById('cartSidebar').classList.remove('open');
                document.getElementById('overlay').classList.remove('active');
            }
            if (carrito.length > 0) actualizarCarritoUI();
        });

        async function cargarMenu() {
            try {
                const { data, error } = await window.supabaseClient.from('menu').select('*').eq('disponible', true);
                if (error) throw error;
                menuItems = data || [];
                menuItems.sort((a, b) => a.nombre.localeCompare(b.nombre));
                filteredMenuItems = [...menuItems];
                currentPage = 1;
                renderizarMenuPaginado();
            } catch (error) { console.error('Error cargando men√∫:', error); mostrarToast('Error al cargar el men√∫', 'error'); }
        }
        async function cargarInventario() {
            try {
                const { data, error } = await window.supabaseClient.from('inventario').select('*');
                if (error) throw error;
                inventario = data || [];
                renderizarMenuPaginado();
            } catch (error) { console.error('Error cargando inventario:', error); }
        }

        async function getStockDisponible(ingredienteId) {
            try {
                const cache = window.stockCache.get(ingredienteId);
                if (cache !== undefined) return cache;
                const ingrediente = inventario.find(i => i.id === ingredienteId);
                if (!ingrediente) return 0;
                let reservadoEnCarrito = 0;
                carrito.forEach(instancia => {
                    if (instancia.platilloId) {
                        const platillo = menuItems.find(p => p.id === instancia.platilloId);
                        if (platillo && platillo.ingredientes && platillo.ingredientes[ingredienteId]) {
                            if (!instancia.personalizacion.includes(ingredienteId)) {
                                reservadoEnCarrito += platillo.ingredientes[ingredienteId].cantidad || 1;
                            }
                        }
                    }
                });
                const disponible = (ingrediente.stock || 0) - (ingrediente.reservado || 0) - reservadoEnCarrito;
                window.stockCache.set(ingredienteId, disponible);
                return disponible;
            } catch (error) { console.error('Error obteniendo stock:', error); return 0; }
        }
        async function verificarStockDisponible(platilloId, personalizacion = []) {
            const platillo = menuItems.find(p => p.id === platilloId);
            if (!platillo) return { disponible: false, motivo: 'Platillo no encontrado' };
            if (!platillo.ingredientes || Object.keys(platillo.ingredientes).length === 0) return { disponible: true };
            for (const [ingId, ingInfo] of Object.entries(platillo.ingredientes)) {
                if (personalizacion.includes(ingId)) continue;
                const cantidadNecesaria = ingInfo.cantidad || 1;
                const stockDisp = await getStockDisponible(ingId);
                if (stockDisp < cantidadNecesaria) {
                    const ingrediente = inventario.find(i => i.id === ingId);
                    return { disponible: false, motivo: `No hay suficiente ${ingrediente?.nombre || ingId}` };
                }
            }
            return { disponible: true };
        }
        async function actualizarStockPlatillo(platilloId) {
            const platillo = menuItems.find(p => p.id === platilloId);
            if (!platillo) return;
            let stockDisponible = Infinity;
            if (platillo.ingredientes && Object.keys(platillo.ingredientes).length > 0) {
                for (const [ingId, ingInfo] of Object.entries(platillo.ingredientes)) {
                    const stockDisp = await getStockDisponible(ingId);
                    const cantidadNecesaria = ingInfo.cantidad || 1;
                    const posible = Math.floor(stockDisp / cantidadNecesaria);
                    stockDisponible = Math.min(stockDisponible, posible);
                }
            } else { stockDisponible = platillo.stock_maximo || 999; }
            const stockElement = document.getElementById(`stock-${platilloId}`);
            if (!stockElement) return;
            const agotado = stockDisponible <= 0;
            let stockClass = 'available';
            if (agotado) stockClass = 'sold-out';
            else if (stockDisponible < 5) stockClass = 'low';
            stockElement.textContent = `${stockDisponible} disponibles`;
            const iconElement = stockElement.previousElementSibling;
            if (iconElement) iconElement.className = `fas fa-box ${stockClass}`;
            const card = stockElement.closest('.menu-card');
            if (card) {
                const existingBadge = card.querySelector('.menu-card-badge');
                const imageDiv = card.querySelector('.menu-card-image');
                if (agotado && !existingBadge) {
                    const badge = document.createElement('div'); badge.className = 'menu-card-badge sold-out'; badge.innerHTML = '<i class="fas fa-times-circle"></i> Agotado'; imageDiv.appendChild(badge);
                } else if (!agotado && existingBadge && existingBadge.classList.contains('sold-out')) { existingBadge.remove(); }
                else if (stockDisponible < 5 && !existingBadge) {
                    const badge = document.createElement('div'); badge.className = 'menu-card-badge low'; badge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> √öltimas'; imageDiv.appendChild(badge);
                } else if (stockDisponible >= 5 && existingBadge && existingBadge.classList.contains('low')) { existingBadge.remove(); }
            }
        }

        async function crearPedidoTransaccional(pedido) {
            try {
                const pedidoParaRPC = {
                    id: pedido.id, timestamp: pedido.timestamp, estado: pedido.estado, tipo: pedido.tipo,
                    total: pedido.total, session_id: pedido.session_id, mesa: pedido.mesa || null,
                    cliente_nombre: pedido.cliente_nombre || null, parroquia: pedido.parroquia || null,
                    direccion: pedido.direccion || null, telefono: pedido.telefono || null,
                    referencia: pedido.referencia || null, fecha_reserva: pedido.fecha_reserva || null,
                    comprobante_url: pedido.comprobante_url || null, costo_delivery: pedido.costo_delivery || 0,
                    costo_delivery_usd: pedido.costo_delivery_usd || 0
                };
                console.log('üì§ Enviando pedido a RPC:', pedidoParaRPC);
                const { data, error } = await window.supabaseClient.rpc('crear_pedido_con_reserva', { p_pedido: pedidoParaRPC, p_items: pedido.items });
                if (error) throw error;
                if (data && data.success) {
                    let titulo, mensaje;
                    switch (pedido.tipo) {
                        case 'mesa': titulo = '‚úÖ Pedido recibido'; mensaje = 'Por favor, pasa a caja a cancelar'; break;
                        case 'delivery': titulo = '‚úÖ Pedido recibido'; mensaje = 'Estamos verificando tu pago. Te notificaremos cuando tu pedido est√© en camino.'; break;
                        case 'reserva': titulo = '‚úÖ Reserva recibida'; mensaje = 'Confirmando pago...'; break;
                    }
                    if (pedido.tipo === 'delivery') mostrarToastPersonalizado(titulo, mensaje, pedido.parroquia);
                    else mostrarToast(titulo, 'success');
                    const audio = document.getElementById('notificationSound'); if (audio) audio.play().catch(() => {});
                    if (navigator.vibrate) navigator.vibrate(200);
                    const bell = document.getElementById('notificationBell');
                    if (bell) { bell.classList.add('fa-shake'); setTimeout(() => bell.classList.remove('fa-shake'), 1000); }
                    return { success: true, pedidoId: data.pedido_id };
                } else { return { success: false, error: data?.error || 'Error desconocido' }; }
            } catch (error) {
                console.error('‚ùå Error:', error);
                mostrarToast('Error al procesar el pedido: ' + error.message, 'error');
                return { success: false, error: error.message };
            }
        }
        function mostrarToastPersonalizado(titulo, mensaje, parroquia) {
            const toast = document.getElementById('toast');
            toast.innerHTML = `<div><strong>${titulo}</strong><br>Tu pedido de delivery ha sido recibido<br><br><em>Gok≈çny≈´ arigat≈ç gozaimasu</em><br><br>${mensaje}<br><strong>Env√≠o a: ${parroquia}</strong></div>`;
            toast.className = 'toast show success';
            setTimeout(() => toast.classList.remove('show'), 8000);
        }

        function renderizarMenuPaginado(filtroCategoria = null, filtroSubcategoria = null, busqueda = '') {
            let itemsFiltrados = [...menuItems];
            if (filtroCategoria) {
                if (filtroCategoria === 'ofertas') itemsFiltrados = itemsFiltrados.filter(item => item.categoria === 'Ofertas Especiales' || item.precio < 10);
                else if (filtroCategoria !== 'todos') itemsFiltrados = itemsFiltrados.filter(item => item.categoria === filtroCategoria);
            }
            if (filtroSubcategoria) itemsFiltrados = itemsFiltrados.filter(item => item.subcategoria === filtroSubcategoria);
            if (busqueda) {
                const terminos = busqueda.toLowerCase().split(/\s+/).filter(t => t.length > 0);
                itemsFiltrados = itemsFiltrados.filter(item => { const nombre = item.nombre.toLowerCase(); return terminos.every(t => nombre.includes(t)); });
            }
            filteredMenuItems = itemsFiltrados;
            currentPage = 1;
            renderizarPaginaActual();
        }
        async function renderizarPaginaActual() {
            const grid = document.getElementById('menuGrid');
            const totalItems = filteredMenuItems.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const itemsPagina = filteredMenuItems.slice(startIndex, endIndex);
            if (itemsPagina.length === 0) {
                grid.innerHTML = '<div class="loading-container"><p>No hay platillos</p></div>';
                document.getElementById('paginationControls').style.display = 'none';
                return;
            } else { document.getElementById('paginationControls').style.display = 'flex'; }
            Promise.all(itemsPagina.map(async (item) => {
                let stockDisponible = Infinity, ingredientesFaltantes = [];
                if (item.ingredientes && Object.keys(item.ingredientes).length > 0) {
                    for (const [ingId, ingInfo] of Object.entries(item.ingredientes)) {
                        const stockDisp = await getStockDisponible(ingId);
                        const cantidadNecesaria = ingInfo.cantidad || 1;
                        const posible = Math.floor(stockDisp / cantidadNecesaria);
                        stockDisponible = Math.min(stockDisponible, posible);
                        if (posible <= 0) { const ingrediente = inventario.find(i => i.id === ingId); ingredientesFaltantes.push(ingrediente?.nombre || ingId); }
                    }
                } else { stockDisponible = item.stock_maximo || 999; }
                const agotado = stockDisponible <= 0;
                let stockClass = 'available';
                if (agotado) stockClass = 'sold-out';
                else if (stockDisponible < 5) stockClass = 'low';
                return `<div class="menu-card ${agotado ? 'agotado' : ''}" data-id="${item.id}"><div class="menu-card-image" style="background-image:url('${item.imagen || 'https://via.placeholder.com/400x300?text=Sushi'}')">${agotado ? '<div class="menu-card-badge sold-out"><i class="fas fa-times-circle"></i> Agotado</div>' : (stockClass === 'low' ? '<div class="menu-card-badge low"><i class="fas fa-exclamation-triangle"></i> √öltimas</div>' : '')}</div><div class="menu-card-content"><div class="menu-card-header"><h3 class="menu-card-title">${item.nombre}</h3><span class="menu-card-price">${formatBs(usdToBs(item.precio))}</span></div><p class="menu-card-description">${item.descripcion || ''}</p><div class="menu-card-footer">${!agotado ? `<button class="btn-add" onclick="agregarAlCarrito('${item.id}')" title="Agregar"><i class="fas fa-plus"></i></button><button class="btn-customize" onclick="abrirPersonalizacion('${item.id}')" title="Personalizar"><i class="fas fa-star"></i> Personalizar</button>` : `<span class="stock-info" title="${ingredientesFaltantes.join(', ')}"><i class="fas fa-info-circle"></i> Sin stock</span>`}</div>${!agotado ? `<div class="stock-info"><i class="fas fa-box ${stockClass}"></i><span id="stock-${item.id}">${stockDisponible} disponibles</span></div>` : ''}</div></div>`;
            })).then(cards => {
                grid.innerHTML = cards.join('');
                document.getElementById('pageInfo').textContent = `P√°gina ${currentPage} de ${totalPages}`;
                document.getElementById('prevPageBtn').disabled = currentPage === 1;
                document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
            });
        }
        function cambiarPagina(direccion) {
            const totalPages = Math.ceil(filteredMenuItems.length / itemsPerPage) || 1;
            currentPage += direccion;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            renderizarPaginaActual();
        }

        function cargarCategorias() {
            const categoryList = document.getElementById('categoryList');
            let html = '';
            categoriasPredefinidas.forEach(cat => {
                const icono = iconosCategorias[cat.id] || 'fa-utensils';
                const activeClass = cat.id === 'todos' ? 'active' : '';
                html += `<li class="category-item ${activeClass}" data-categoria="${cat.id}"><span><i class="fas ${icono}"></i> ${cat.nombre}</span>${cat.subcategorias ? '<i class="fas fa-chevron-right"></i>' : ''}</li>`;
                if (cat.subcategorias) {
                    html += `<ul class="subcategory-list" data-categoria="${cat.id}">`;
                    cat.subcategorias.forEach(sub => { html += `<li class="subcategory-item" data-subcategoria="${sub}">${sub}</li>`; });
                    html += `</ul>`;
                }
            });
            categoryList.innerHTML = html;
            document.querySelectorAll('.category-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const categoria = item.dataset.categoria;
                    const tieneSubcategorias = item.querySelector('i.fa-chevron-right') !== null;
                    if (tieneSubcategorias && categoria !== 'todos') {
                        const subList = document.querySelector(`.subcategory-list[data-categoria="${categoria}"]`);
                        if (subList) subList.classList.toggle('expanded');
                        return;
                    }
                    document.querySelectorAll('.category-item').forEach(c => c.classList.remove('active'));
                    item.classList.add('active');
                    document.querySelectorAll('.subcategory-list').forEach(list => list.classList.remove('expanded'));
                    document.getElementById('categoryTitle').textContent = categoria === 'todos' ? 'Men√∫' : item.querySelector('span').textContent.replace(/^[^\s]+\s/, '');
                    renderizarMenuPaginado(categoria === 'todos' ? null : categoria);
                    if (window.innerWidth <= 992) cerrarMenuCategorias();
                });
            });
            document.querySelectorAll('.subcategory-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const subcategoria = item.dataset.subcategoria;
                    const categoria = item.closest('.subcategory-list').dataset.categoria;
                    document.querySelectorAll('.category-item').forEach(c => c.classList.remove('active'));
                    document.querySelector(`.category-item[data-categoria="${categoria}"]`).classList.add('active');
                    document.querySelectorAll('.subcategory-item').forEach(s => s.classList.remove('active'));
                    item.classList.add('active');
                    document.getElementById('categoryTitle').textContent = subcategoria;
                    renderizarMenuPaginado(categoria, subcategoria);
                    if (window.innerWidth <= 992) cerrarMenuCategorias();
                });
            });
        }

        function abrirPersonalizacion(platilloId) {
            const platillo = menuItems.find(p => p.id === platilloId);
            if (!platillo) return;
            const modalBody = document.getElementById('customizeModalBody');
            currentCustomizeItem = { ...platillo, cantidad: 1, ingredientesQuitados: [], selectionType: 'completo' };
            Promise.all(Object.entries(platillo.ingredientes || {}).map(async ([ingId, ingInfo]) => {
                const ingrediente = inventario.find(i => i.id === ingId);
                const stockDisp = await getStockDisponible(ingId);
                const disponible = stockDisp >= (ingInfo.cantidad || 1);
                const precio = ingrediente?.precio_unitario || 0;
                return `<div style="margin-bottom:.8rem; padding:.7rem; background:rgba(0,0,0,.2); border-radius:var(--radius-sm); ${!disponible ? 'opacity:0.5;' : ''}"><label style="display:flex; align-items:center; gap:.8rem; cursor:${disponible ? 'pointer' : 'not-allowed'}; color:#fff"><input type="checkbox" class="ingrediente-check" data-ingrediente="${ingId}" data-precio="${precio}" ${!disponible ? 'disabled' : ''}><div style="flex:1"><div style="font-weight:500">${ingInfo.nombre || ingId}</div><div style="font-size:.85rem; color:var(--gray-400)">Valor: ${formatBs(usdToBs(precio))}${!disponible ? '<span style="color:var(--danger); margin-left:.5rem">(Sin stock)</span>' : ''}</div></div></label></div>`;
            })).then(ingredientesHtml => {
                const completoOption = `<div style="margin-bottom:.8rem; padding:.7rem; background:${currentCustomizeItem.selectionType === 'completo' ? 'rgba(56,142,60,.1)' : 'rgba(0,0,0,.2)'}; border-radius:var(--radius-sm); border:2px solid ${currentCustomizeItem.selectionType === 'completo' ? 'var(--success)' : 'transparent'}; cursor:pointer" onclick="selectCompleto()"><div style="display:flex; align-items:center; gap:.8rem"><div style="width:22px; height:22px; border-radius:50%; background:${currentCustomizeItem.selectionType === 'completo' ? 'var(--success)' : 'var(--gray-300)'}; display:flex; align-items:center; justify-content:center; color:white">${currentCustomizeItem.selectionType === 'completo' ? '<i class="fas fa-check" style="font-size:.7rem"></i>' : ''}</div><div style="flex:1"><div style="font-weight:600; color:#fff">Platillo completo</div><div style="font-size:.85rem; color:var(--gray-400)">Con todos los ingredientes</div></div></div></div>`;
                modalBody.innerHTML = `<div style="display:flex; gap:1rem; margin-bottom:1.5rem; background:rgba(0,0,0,.2); padding:.8rem; border-radius:var(--radius-sm)"><img src="${platillo.imagen || 'https://via.placeholder.com/80'}" style="width:80px; height:80px; object-fit:cover; border-radius:var(--radius-sm)"><div><h4 style="font-size:1.2rem; margin-bottom:.3rem; color:#fff">${platillo.nombre}</h4><p style="color:var(--gray-400); font-size:.9rem">${platillo.descripcion || ''}</p><p style="font-weight:600; color:var(--accent); font-size:1rem">Base: ${formatBs(usdToBs(platillo.precio))}</p></div></div><div style="margin-bottom:1.5rem"><label style="display:block; margin-bottom:.5rem; font-weight:600; color:#fff">Cantidad:</label><div style="display:flex; align-items:center; gap:1rem"><button class="btn-icon" onclick="actualizarCantidadPersonalizacion(-1)" style="width:36px; height:36px; border:1px solid rgba(255,255,255,.1); background:rgba(0,0,0,.3); border-radius:50%; cursor:pointer; color:#fff"><i class="fas fa-minus"></i></button><span id="customizeCantidad" style="font-size:1.2rem; font-weight:600; min-width:40px; text-align:center; color:#fff">1</span><button class="btn-icon" onclick="actualizarCantidadPersonalizacion(1)" style="width:36px; height:36px; border:1px solid rgba(255,255,255,.1); background:rgba(0,0,0,.3); border-radius:50%; cursor:pointer; color:#fff"><i class="fas fa-plus"></i></button></div></div><div style="margin-bottom:1.5rem"><label style="display:block; margin-bottom:.5rem; font-weight:600; color:#fff">Opciones:</label>${completoOption}<div id="ingredientesList" style="margin-top:.8rem"><div style="font-weight:500; margin-bottom:.5rem; color:#fff">Quitar ingredientes:</div>${ingredientesHtml.join('') || '<p style="color:var(--gray-400)">Sin ingredientes para personalizar</p>'}</div></div><div style="background:rgba(0,0,0,.2); padding:.8rem; border-radius:var(--radius-sm)"><div style="display:flex; justify-content:space-between"><span style="font-weight:600; color:#fff">Precio final:</span><span style="font-size:1.3rem; font-weight:700; color:var(--accent)" id="customizePrecio">${formatBs(usdToBs(platillo.precio * currentCustomizeItem.cantidad))}</span></div></div>`;
                const viejosCheckboxes = document.querySelectorAll('.ingrediente-check');
                viejosCheckboxes.forEach(cb => { const nuevoCb = cb.cloneNode(true); cb.parentNode.replaceChild(nuevoCb, cb); });
                document.querySelectorAll('.ingrediente-check').forEach(cb => { cb.addEventListener('change', function() { if (this.checked) selectPersonalizado(); calcularPrecioPersonalizado(); }); });
                document.getElementById('customizeModal').classList.add('active');
            });
        }
        function selectCompleto() {
            if (!currentCustomizeItem) return;
            currentCustomizeItem.selectionType = 'completo'; currentCustomizeItem.ingredientesQuitados = [];
            document.querySelectorAll('.ingrediente-check').forEach(cb => cb.checked = false);
            const completoOption = document.querySelector('#ingredientesList').previousElementSibling;
            if (completoOption) {
                completoOption.style.background = 'rgba(56,142,60,.1)'; completoOption.style.borderColor = 'var(--success)';
                const circle = completoOption.querySelector('div > div:first-child');
                if (circle) { circle.style.background = 'var(--success)'; circle.innerHTML = '<i class="fas fa-check" style="font-size:.7rem"></i>'; }
            }
            calcularPrecioPersonalizado();
        }
        function selectPersonalizado() {
            if (!currentCustomizeItem) return;
            currentCustomizeItem.selectionType = 'personalizado';
            const completoOption = document.querySelector('#ingredientesList').previousElementSibling;
            if (completoOption) {
                completoOption.style.background = 'rgba(0,0,0,.2)'; completoOption.style.borderColor = 'transparent';
                const circle = completoOption.querySelector('div > div:first-child');
                if (circle) { circle.style.background = 'var(--gray-300)'; circle.innerHTML = ''; }
            }
            calcularPrecioPersonalizado();
        }
        function actualizarCantidadPersonalizacion(delta) {
            if (!currentCustomizeItem) return;
            currentCustomizeItem.cantidad = Math.max(1, currentCustomizeItem.cantidad + delta);
            document.getElementById('customizeCantidad').textContent = currentCustomizeItem.cantidad;
            calcularPrecioPersonalizado();
        }
        function calcularPrecioPersonalizado() {
            if (!currentCustomizeItem) return;
            let descuento = 0;
            document.querySelectorAll('.ingrediente-check:checked').forEach(cb => { descuento += parseFloat(cb.dataset.precio) || 0; });
            const precioBaseUSD = currentCustomizeItem.precio;
            const precioFinalUSD = Math.max(0, precioBaseUSD - descuento);
            const precioFinalBs = usdToBs(precioFinalUSD) * currentCustomizeItem.cantidad;
            document.getElementById('customizePrecio').textContent = formatBs(precioFinalBs);
        }

        function actualizarCarritoBadge() {
            const cartBadge = document.getElementById('cartBadge');
            const totalItems = carrito.length;
            if (totalItems > 0) { cartBadge.textContent = totalItems; cartBadge.style.display = 'block'; }
            else { cartBadge.style.display = 'none'; }
        }
        async function agregarAlCarrito(platilloId) {
            const platillo = menuItems.find(p => p.id === platilloId);
            if (!platillo) return;
            const verificado = await verificarStockDisponible(platilloId);
            if (!verificado.disponible) { mostrarToast(verificado.motivo || 'No hay stock', 'error'); return; }
            const nuevaInstancia = { id: generarId('inst_'), platilloId: platillo.id, nombre: platillo.nombre, personalizacion: [], imagen: platillo.imagen, precioUnitarioUSD: platillo.precio, precioUnitarioBs: usdToBs(platillo.precio), subtotal: usdToBs(platillo.precio), selectionType: 'completo' };
            carrito.push(nuevaInstancia); guardarCarrito(); actualizarCarritoUI(); actualizarCarritoBadge(); window.stockCache.invalidate();
            const platillosAActualizar = new Set();
            if (platillo.ingredientes) { Object.keys(platillo.ingredientes).forEach(ingId => { menuItems.forEach(item => { if (item.ingredientes && item.ingredientes[ingId]) platillosAActualizar.add(item.id); }); }); }
            platillosAActualizar.add(platilloId);
            for (const pid of platillosAActualizar) await actualizarStockPlatillo(pid);
            mostrarToast('Agregado', 'success');
            if (window.innerWidth <= 992) { document.getElementById('cartSidebar').classList.add('open'); document.getElementById('overlay').classList.add('active'); document.getElementById('categorySidebar').classList.remove('open'); }
        }
        async function agregarPersonalizadoAlCarrito() {
            if (!currentCustomizeItem) { console.error('No hay item para personalizar'); return; }
            const ingredientesQuitados = Array.from(document.querySelectorAll('.ingrediente-check:checked')).map(cb => cb.dataset.ingrediente);
            const verificado = await verificarStockDisponible(currentCustomizeItem.id, ingredientesQuitados);
            if (!verificado.disponible) { mostrarToast(verificado.motivo || 'No hay stock', 'error'); return; }
            let descuento = 0;
            document.querySelectorAll('.ingrediente-check:checked').forEach(cb => { descuento += parseFloat(cb.dataset.precio) || 0; });
            const precioFinalUSD = Math.max(0, currentCustomizeItem.precio - descuento);
            for (let i = 0; i < currentCustomizeItem.cantidad; i++) {
                const nuevaInstancia = { id: generarId('inst_'), platilloId: currentCustomizeItem.id, nombre: currentCustomizeItem.nombre, personalizacion: ingredientesQuitados, imagen: currentCustomizeItem.imagen, precioUnitarioUSD: precioFinalUSD, precioUnitarioBs: usdToBs(precioFinalUSD), subtotal: usdToBs(precioFinalUSD), selectionType: currentCustomizeItem.selectionType };
                carrito.push(nuevaInstancia);
            }
            guardarCarrito(); actualizarCarritoUI(); actualizarCarritoBadge(); window.stockCache.invalidate();
            const platillosAActualizar = new Set();
            const platillo = menuItems.find(p => p.id === currentCustomizeItem.id);
            if (platillo && platillo.ingredientes) { Object.keys(platillo.ingredientes).forEach(ingId => { menuItems.forEach(item => { if (item.ingredientes && item.ingredientes[ingId]) platillosAActualizar.add(item.id); }); }); }
            platillosAActualizar.add(currentCustomizeItem.id);
            for (const pid of platillosAActualizar) await actualizarStockPlatillo(pid);
            document.getElementById('customizeModal').classList.remove('active'); currentCustomizeItem = null;
            mostrarToast(`${currentCustomizeItem?.cantidad || 1} agregado(s)`, 'success');
            if (window.innerWidth <= 992) { document.getElementById('cartSidebar').classList.add('open'); document.getElementById('overlay').classList.add('active'); document.getElementById('categorySidebar').classList.remove('open'); }
        }
        function eliminarInstancia(instanciaId) {
            const instancia = carrito.find(i => i.id === instanciaId);
            const platilloId = instancia?.platilloId;
            carrito = carrito.filter(i => i.id !== instanciaId); guardarCarrito(); actualizarCarritoUI(); actualizarCarritoBadge(); window.stockCache.invalidate();
            if (platilloId) {
                const platillosAActualizar = new Set();
                const platillo = menuItems.find(p => p.id === platilloId);
                if (platillo && platillo.ingredientes) { Object.keys(platillo.ingredientes).forEach(ingId => { menuItems.forEach(item => { if (item.ingredientes && item.ingredientes[ingId]) platillosAActualizar.add(item.id); }); }); }
                platillosAActualizar.add(platilloId);
                for (const pid of platillosAActualizar) actualizarStockPlatillo(pid);
            }
        }
        function toggleNivel1(grupoId) {
            const nivel1Container = document.getElementById(`nivel1-${grupoId}`), icon = document.getElementById(`icon1-${grupoId}`);
            if (nivel1Activo && nivel1Activo !== grupoId) {
                const nivelAnterior = document.getElementById(`nivel1-${nivel1Activo}`), iconAnterior = document.getElementById(`icon1-${nivel1Activo}`);
                if (nivelAnterior) nivelAnterior.classList.remove('expanded'); if (iconAnterior) iconAnterior.classList.remove('rotated');
                if (nivel2Activo && nivel2Activo.startsWith(nivel1Activo)) {
                    const nivel2Anterior = document.getElementById(`nivel2-${nivel2Activo}`), icon2Anterior = document.getElementById(`icon2-${nivel2Activo}`);
                    if (nivel2Anterior) nivel2Anterior.classList.remove('expanded'); if (icon2Anterior) icon2Anterior.classList.remove('rotated'); nivel2Activo = null;
                }
            }
            if (nivel1Container) {
                nivel1Container.classList.toggle('expanded'); if (icon) icon.classList.toggle('rotated');
                if (nivel1Container.classList.contains('expanded')) nivel1Activo = grupoId;
                else { nivel1Activo = null; nivel2Activo = null; }
            }
        }
        function toggleNivel2(subgrupoId, grupoPadreId) {
            const nivel2Container = document.getElementById(`nivel2-${subgrupoId}`), icon = document.getElementById(`icon2-${subgrupoId}`);
            if (nivel2Activo && nivel2Activo !== subgrupoId && nivel2Activo.startsWith(grupoPadreId)) {
                const nivel2Anterior = document.getElementById(`nivel2-${nivel2Activo}`), icon2Anterior = document.getElementById(`icon2-${nivel2Activo}`);
                if (nivel2Anterior) nivel2Anterior.classList.remove('expanded'); if (icon2Anterior) icon2Anterior.classList.remove('rotated');
            }
            if (nivel2Container) {
                nivel2Container.classList.toggle('expanded'); if (icon) icon.classList.toggle('rotated');
                if (nivel2Container.classList.contains('expanded')) nivel2Activo = subgrupoId;
                else nivel2Activo = null;
            }
        }
        function agruparItemsJerarquicamente() {
            const gruposPorPlatillo = {};
            carrito.forEach(instancia => {
                if (!gruposPorPlatillo[instancia.platilloId]) gruposPorPlatillo[instancia.platilloId] = { platilloId: instancia.platilloId, nombre: instancia.nombre, imagen: instancia.imagen, items: [] };
                gruposPorPlatillo[instancia.platilloId].items.push(instancia);
            });
            const resultado = [];
            Object.values(gruposPorPlatillo).forEach(grupoPlatillo => {
                const subgrupos = {};
                grupoPlatillo.items.forEach(instancia => {
                    const personalizacionKey = instancia.personalizacion.sort().join('|');
                    if (!subgrupos[personalizacionKey]) subgrupos[personalizacionKey] = { id: `${grupoPlatillo.platilloId}_${personalizacionKey.replace(/[^a-zA-Z0-9]/g, '_')}`, platilloId: grupoPlatillo.platilloId, nombre: grupoPlatillo.nombre, personalizacion: instancia.personalizacion, items: [], cantidad: 0, subtotal: 0 };
                    subgrupos[personalizacionKey].items.push(instancia);
                    subgrupos[personalizacionKey].cantidad++;
                    subgrupos[personalizacionKey].subtotal += instancia.subtotal;
                });
                resultado.push({ id: grupoPlatillo.platilloId.replace(/[^a-zA-Z0-9]/g, '_'), platilloId: grupoPlatillo.platilloId, nombre: grupoPlatillo.nombre, imagen: grupoPlatillo.imagen, items: grupoPlatillo.items, cantidad: grupoPlatillo.items.length, subtotal: grupoPlatillo.items.reduce((sum, i) => sum + i.subtotal, 0), subgrupos: Object.values(subgrupos) });
            });
            return resultado;
        }
        function actualizarCarritoUI() {
            const cartItems = document.getElementById('cartItems'), 
                  cartFooter = document.getElementById('cartFooter'), 
                  cartTotal = document.getElementById('cartTotal'), 
                  cartButtons = document.getElementById('cartButtons');
            
            if (carrito.length === 0) { 
                cartItems.innerHTML = '<div class="cart-empty"><i class="fas fa-shopping-basket"></i><p>Tu carrito est√° vac√≠o</p></div>'; 
                cartFooter.style.display = 'none'; 
                nivel1Activo = null; 
                nivel2Activo = null; 
                return; 
            }
            
            cartFooter.style.display = 'block';
            const grupos = agruparItemsJerarquicamente();
            let totalGeneral = 0, html = '';
            
            grupos.forEach(grupo => {
                totalGeneral += grupo.subtotal;
                const nivel1Expandido = nivel1Activo === grupo.id;
                html += `<div class="nivel1-group"><div class="nivel1-header" onclick="toggleNivel1('${grupo.id}')"><div class="header-row"><div class="nombre"><i class="fas fa-chevron-right" id="icon1-${grupo.id}" ${nivel1Expandido ? 'class="rotated"' : ''}></i><span>üç£ ${grupo.nombre}</span></div><span class="cantidad-total">${grupo.cantidad} unid.</span></div><div class="header-details"><span><i class="fas fa-tag"></i> Total: ${formatBs(grupo.subtotal)}</span></div></div><div class="nivel2-container ${nivel1Expandido ? 'expanded' : ''}" id="nivel1-${grupo.id}">`;
                grupo.subgrupos.forEach(subgrupo => {
                    const subgrupoId = `${grupo.id}_${subgrupo.id}`, nivel2Expandido = nivel2Activo === subgrupoId;
                    let descripcionPersonalizacion = 'Completo';
                    if (subgrupo.personalizacion.length > 0) { const ingredientesNombres = subgrupo.personalizacion.map(p => { const ing = inventario.find(i => i.id === p); return ing?.nombre || p; }).join(', '); descripcionPersonalizacion = `Sin: ${ingredientesNombres}`; }
                    html += `<div class="nivel2-group"><div class="nivel2-header" onclick="toggleNivel2('${subgrupoId}','${grupo.id}')"><div class="header-row"><div class="nombre"><i class="fas fa-chevron-right" id="icon2-${subgrupoId}" ${nivel2Expandido ? 'class="rotated"' : ''}></i><span>üîπ ${descripcionPersonalizacion}</span></div><span class="cantidad-subtotal">${subgrupo.cantidad} unid.</span></div><div class="header-details"><span><i class="fas fa-tag"></i> Subtotal: ${formatBs(subgrupo.subtotal)}</span></div></div><div class="nivel3-container ${nivel2Expandido ? 'expanded' : ''}" id="nivel2-${subgrupoId}">`;
                    subgrupo.items.forEach((item, index) => {
                        const ingredientesNombres = item.personalizacion.map(p => { const ing = inventario.find(i => i.id === p); return ing?.nombre || p; }).join(', ');
                        html += `<div class="nivel3-item"><div class="item-image" style="background-image:url('${item.imagen || 'https://via.placeholder.com/40'}')"></div><div class="item-info"><span class="item-number">#${index + 1}</span><span class="item-name">${item.nombre}</span>${item.personalizacion.length > 0 ? `<div class="personalizacion"><i class="fas fa-utensil-spoon"></i> ${ingredientesNombres}</div>` : ''}</div><div class="item-precio">${formatBs(item.subtotal)}</div><button class="btn-remove-item" onclick="eliminarInstancia('${item.id}')" title="Eliminar"><i class="fas fa-trash"></i></button></div>`;
                    });
                    html += `</div></div>`;
                });
                html += `</div></div>`;
            });
            
            const cartItemsElement = document.getElementById('cartItems');
            const necesitaScroll = cartItemsElement.scrollHeight > cartItemsElement.clientHeight;
            
            if (carrito.length > 0 && !necesitaScroll) {
                html += `<div class="scroll-indicator" onclick="document.getElementById('cartFooter').scrollIntoView({behavior: 'smooth'})">
                            <i class="fas fa-chevron-down"></i>
                            <span>Desliza para hacer tu pedido</span>
                        </div>`;
            }
            
            cartItems.innerHTML = html; 
            cartTotal.textContent = formatBs(totalGeneral);
            
            cartButtons.innerHTML = '';
            if (mesaId) cartButtons.innerHTML = `<button class="btn-primary" onclick="abrirConfirmacionMesa()"><i class="fas fa-check"></i> Pedir en Mesa</button>`;
            else cartButtons.innerHTML = `<button class="btn-primary" onclick="iniciarProcesoDelivery()"><i class="fas fa-motorcycle"></i> Delivery</button><button class="btn-secondary" onclick="iniciarProcesoReserva()"><i class="fas fa-calendar-alt"></i> Reserva</button>`;
        }
        function guardarCarrito() {
            localStorage.setItem('saki_carrito', JSON.stringify({ 
                items: carrito, 
                timestamp: Date.now() 
            }));
        }
        function restaurarCarrito() {
            const saved = localStorage.getItem('saki_carrito');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.items && data.items.length > 0 && Date.now() - data.timestamp < 3600000) {
                        window.pedidoAnterior = data.items;
                        mostrarDialogoContinuar();
                    } else if (data.items && data.items.length > 0) {
                        localStorage.removeItem('saki_carrito');
                    }
                } catch (e) {
                    console.error('Error restaurando carrito:', e);
                }
            }
        }
        function guardarDatosDelivery() {
            deliveryFormData.parroquia = document.getElementById('parroquiaSelect').value;
            deliveryFormData.direccion = document.getElementById('direccion').value;
            deliveryFormData.telefono = document.getElementById('telefono').value;
            deliveryFormData.referencia = getReferencia('delivery');
            localStorage.setItem('saki_delivery_data', JSON.stringify(deliveryFormData));
        }
        function guardarDatosReserva() {
            reservaFormData.fecha = document.getElementById('fechaReserva').value;
            reservaFormData.nombre = document.getElementById('nombreReserva').value;
            reservaFormData.referencia = getReferencia('reserva');
            localStorage.setItem('saki_reserva_data', JSON.stringify(reservaFormData));
        }
        function limpiarDatosFormulario() {
            deliveryFormData = { parroquia: '', direccion: '', telefono: '', referencia: '', comprobante: null };
            reservaFormData = { fecha: '', nombre: '', referencia: '', comprobante: null };
            localStorage.removeItem('saki_delivery_data'); localStorage.removeItem('saki_reserva_data');
            limpiarCampoComprobante('delivery'); limpiarCampoComprobante('reserva');
        }

        async function handleComprobanteSelect(input) {
            const file = input.files[0];
            if (!file) {
                deliveryFormData.comprobante = null;
                uploadComplete = false;
                validarFormularioDelivery();
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                mostrarToast('El archivo es demasiado grande (m√°x 5MB)', 'error');
                input.value = '';
                return;
            }
            const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/webp', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                mostrarToast('Tipo de archivo no v√°lido. Solo im√°genes JPG, PNG, WEBP o GIF', 'error');
                input.value = '';
                return;
            }
            const progressBar = document.getElementById('uploadProgress');
            const progressBarFill = document.getElementById('uploadProgressBar');
            progressBar.style.display = 'block';
            progressBarFill.style.width = '0%';
            isUploading = true;
            uploadComplete = false;
            document.getElementById('confirmDelivery').disabled = true;
            try {
                let progress = 0;
                const interval = setInterval(() => {
                    if (progress < 90) {
                        progress += 10;
                        progressBarFill.style.width = `${progress}%`;
                    }
                }, 200);
                const result = await window.subirComprobante(file, 'delivery');
                clearInterval(interval);
                if (result.success) {
                    deliveryFormData.comprobante = result.url;
                    uploadComplete = true;
                    progressBarFill.style.width = '100%';
                    mostrarToast('‚úÖ Comprobante subido correctamente', 'success');
                    const label = document.getElementById('comprobanteLabel');
                    label.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success)"></i><span style="color:var(--success); font-weight:600">${file.name}</span><small>Listo para enviar</small>`;
                    label.classList.add('has-file');
                } else {
                    throw new Error(result.error || 'Error al subir el archivo');
                }
            } catch (error) {
                console.error('Error subiendo comprobante:', error);
                mostrarToast('‚ùå Error al subir el comprobante: ' + (error.message || 'Error desconocido'), 'error');
                deliveryFormData.comprobante = null;
                progressBarFill.style.width = '0%';
                input.value = '';
                const label = document.getElementById('comprobanteLabel');
                label.innerHTML = '<i class="fas fa-cloud-upload-alt"></i><span>Haz clic para seleccionar una imagen</span><small>JPG, PNG, GIF (max. 5MB)</small>';
                label.classList.remove('has-file');
            } finally {
                isUploading = false;
                setTimeout(() => {
                    progressBar.style.display = 'none';
                }, 1000);
                validarFormularioDelivery();
            }
        }

        async function handleComprobanteReservaSelect(input) {
            const file = input.files[0];
            if (!file) {
                reservaFormData.comprobante = null;
                uploadComplete = false;
                validarFormularioReserva();
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                mostrarToast('El archivo es demasiado grande (m√°x 5MB)', 'error');
                input.value = '';
                return;
            }
            const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/webp', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                mostrarToast('Tipo de archivo no v√°lido. Solo im√°genes JPG, PNG, WEBP o GIF', 'error');
                input.value = '';
                return;
            }
            const progressBar = document.getElementById('uploadProgressReserva');
            const progressBarFill = document.getElementById('uploadProgressBarReserva');
            progressBar.style.display = 'block';
            progressBarFill.style.width = '0%';
            isUploading = true;
            uploadComplete = false;
            document.getElementById('confirmReserva').disabled = true;
            try {
                let progress = 0;
                const interval = setInterval(() => {
                    if (progress < 90) {
                        progress += 10;
                        progressBarFill.style.width = `${progress}%`;
                    }
                }, 200);
                const result = await window.subirComprobante(file, 'reserva');
                clearInterval(interval);
                if (result.success) {
                    reservaFormData.comprobante = result.url;
                    uploadComplete = true;
                    progressBarFill.style.width = '100%';
                    mostrarToast('‚úÖ Comprobante subido correctamente', 'success');
                    const label = document.getElementById('comprobanteReservaLabel');
                    label.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success)"></i><span style="color:var(--success); font-weight:600">${file.name}</span><small>Listo para enviar</small>`;
                    label.classList.add('has-file');
                } else {
                    throw new Error(result.error || 'Error al subir el archivo');
                }
            } catch (error) {
                console.error('Error subiendo comprobante reserva:', error);
                mostrarToast('‚ùå Error al subir el comprobante: ' + (error.message || 'Error desconocido'), 'error');
                reservaFormData.comprobante = null;
                progressBarFill.style.width = '0%';
                input.value = '';
                const label = document.getElementById('comprobanteReservaLabel');
                label.innerHTML = '<i class="fas fa-cloud-upload-alt"></i><span>Haz clic para seleccionar una imagen</span><small>JPG, PNG, GIF (max. 5MB)</small>';
                label.classList.remove('has-file');
            } finally {
                isUploading = false;
                setTimeout(() => {
                    progressBar.style.display = 'none';
                }, 1000);
                validarFormularioReserva();
            }
        }

        function setupRealtimeSubscriptions() {
            suscripcionesCliente.forEach(s => s.unsubscribe());
            suscripcionesCliente = [];
            canalNotificaciones = window.supabaseClient
                .channel('notificaciones-cliente-' + Date.now())
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'notificaciones', 
                    filter: `session_id=eq.${sessionId}` 
                }, (payload) => {
                    const notif = payload.new;
                    console.log('‚ö° NOTIFICACI√ìN INSTANT√ÅNEA:', notif.titulo);
                    if (notificacionesPendientes.has(notif.id)) notificacionesPendientes.delete(notif.id);
                    procesarNotificacion(notif);
                })
                .subscribe((status) => {
                    console.log('üì° Estado canal notificaciones:', status);
                    if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
                        console.log('‚ö†Ô∏è Canal ca√≠do - reintentos activados');
                    }
                });
            suscripcionesCliente.push(canalNotificaciones);
            suscripcionesCliente.push(window.supabaseClient.channel('inventario-cliente-' + Date.now()).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'inventario' }, () => { window.stockCache.invalidate(); cargarInventario(); }).subscribe());
            suscripcionesCliente.push(window.supabaseClient.channel('menu-cliente-' + Date.now()).on('postgres_changes', { event: '*', schema: 'public', table: 'menu' }, () => { cargarMenu(); }).subscribe());
            suscripcionesCliente.push(window.supabaseClient.channel('pedidos-cliente-' + Date.now())
                .on('postgres_changes', { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: 'pedidos', 
                    filter: `session_id=eq.${sessionId}` 
                }, (payload) => {
                    const pedido = payload.new;
                    if (pedido.estado !== 'pendiente') {
                        let titulo, mensaje, tipo;
                        switch(pedido.estado) {
                            case 'en_camino':
                                titulo = 'üöö Pedido enviado';
                                mensaje = 'El delivery ya sali√≥';
                                tipo = 'approved';
                                break;
                            case 'entregado':
                                titulo = '‚úÖ Pedido entregado';
                                mensaje = '¬°Buen Provecho! Gracias por elegir Saki Sushi';
                                tipo = 'approved';
                                break;
                            case 'reserva_completada':
                                titulo = '‚úÖ Reserva Confirmada';
                                mensaje = 'En breve tu pedido te ser√° entregado, ¬°Gracias por preferirnos!';
                                tipo = 'approved';
                                break;
                            case 'rechazado':
                                titulo = '‚ùå Pedido rechazado';
                                mensaje = 'Tu pedido fue rechazado';
                                tipo = 'rejected';
                                break;
                            case 'cancelado_timeout':
                                titulo = '‚è∞ Tiempo agotado';
                                mensaje = 'El tiempo para pagar ha expirado';
                                tipo = 'rejected';
                                break;
                            default:
                                titulo = '‚úÖ Estado actualizado';
                                mensaje = `Tu pedido est√° ${pedido.estado}`;
                                tipo = 'approved';
                        }
                        mostrarToast(mensaje, tipo === 'rejected' ? 'error' : 'success');
                        window.supabaseClient
                            .from('notificaciones')
                            .insert([{ 
                                pedido_id: pedido.id, 
                                tipo: tipo,
                                titulo: titulo, 
                                mensaje: mensaje, 
                                timestamp: new Date().toISOString(), 
                                session_id: sessionId, 
                                leida: false 
                            }])
                            .then(() => cargarNotificaciones());
                    }
                }).subscribe());
        }

        function iniciarSistemaReintentos() {
            if (intervaloReintentos) return;
            intervaloReintentos = setInterval(() => {
                if (notificacionesPendientes.size === 0) return;
                console.log(`üîÑ Reintentando ${notificacionesPendientes.size} notificaciones...`);
                notificacionesPendientes.forEach((datos, id) => {
                    if (datos.intentos >= 3) {
                        mostrarDialogoRecarga(datos.notificacion);
                        notificacionesPendientes.delete(id);
                        return;
                    }
                    datos.intentos++;
                    verificarNotificacionManual(id, datos.notificacion);
                });
            }, 5000);
        }

        async function verificarNotificacionManual(notifId, notificacion) {
            try {
                const { data, error } = await window.supabaseClient
                    .from('notificaciones')
                    .select('*')
                    .eq('id', notifId)
                    .eq('session_id', sessionId)
                    .single();
                if (data && !error) {
                    console.log(`‚úÖ Notificaci√≥n ${notifId} recuperada en reintento ${notificacionesPendientes.get(notifId)?.intentos}`);
                    procesarNotificacion(data);
                    notificacionesPendientes.delete(notifId);
                    return true;
                }
                const { data: pedido, error: errorPedido } = await window.supabaseClient
                    .from('pedidos')
                    .select('estado, id')
                    .eq('session_id', sessionId)
                    .order('timestamp', { ascending: false })
                    .limit(1)
                    .single();
                if (pedido && pedido.estado !== 'pendiente') {
                    let titulo, mensaje, tipo;
                    switch(pedido.estado) {
                        case 'en_camino':
                            titulo = 'üöö Pedido enviado';
                            mensaje = 'El delivery ya sali√≥';
                            tipo = 'approved';
                            break;
                        case 'entregado':
                            titulo = '‚úÖ Pedido entregado';
                            mensaje = '¬°Buen Provecho! Gracias por elegir Saki Sushi';
                            tipo = 'approved';
                            break;
                        case 'reserva_completada':
                            titulo = '‚úÖ Reserva Confirmada';
                            mensaje = 'En breve tu pedido te ser√° entregado, ¬°Gracias por preferirnos!';
                            tipo = 'approved';
                            break;
                        default:
                            titulo = pedido.estado === 'rechazado' ? '‚ùå Pedido rechazado' : '‚úÖ Estado actualizado';
                            mensaje = `Tu pedido est√° ${pedido.estado}`;
                            tipo = pedido.estado === 'rechazado' ? 'rejected' : 'approved';
                    }
                    const notifLocal = {
                        id: 'local_' + Date.now(),
                        pedido_id: pedido.id,
                        titulo: titulo,
                        mensaje: mensaje,
                        tipo: tipo,
                        timestamp: new Date().toISOString()
                    };
                    procesarNotificacion(notifLocal);
                    notificacionesPendientes.delete(notifId);
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error en reintento:', error);
                return false;
            }
        }

        function mostrarDialogoRecarga(notificacion) {
            if (document.getElementById('dialogoRecarga')) return;
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay active';
            overlay.id = 'dialogoRecarga';
            overlay.innerHTML = `
                <div class="confirm-dialog" style="max-width: 400px;">
                    <i class="fas fa-exclamation-triangle" style="color: var(--warning); font-size: 3rem;"></i>
                    <h3 style="color: #fff; margin: 1rem 0;">üì∂ Conexi√≥n inestable</h3>
                    <p style="color: var(--gray-300); margin-bottom: 1.5rem;">
                        No pudimos confirmar el estado de tu pedido.<br>
                        <strong>${notificacion.titulo || 'Actualizaci√≥n disponible'}</strong><br><br>
                        Haz clic en "Recargar" para ver el estado actual.
                    </p>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button class="btn-secondary" onclick="document.getElementById('dialogoRecarga').remove()">
                            Seguir esperando
                        </button>
                        <button class="btn-primary" onclick="recargarConReintentos()">
                            <i class="fas fa-sync-alt"></i> Recargar ahora
                        </button>
                    </div>
                    <p style="color: var(--gray-500); font-size: 0.8rem; margin-top: 1rem;">
                        Se reintentar√° autom√°ticamente cada 5 segundos
                    </p>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        async function recargarConReintentos() {
            const overlay = document.getElementById('dialogoRecarga');
            if (overlay) overlay.remove();
            mostrarToast('üîÑ Reintentando conexi√≥n...', 'info');
            for (let i = 1; i <= 3; i++) {
                console.log(`Intento ${i} de recarga...`);
                await Promise.all([ cargarNotificaciones(), cargarPedidosCliente() ]);
                if (notificacionesNoLeidas > 0) {
                    mostrarToast('‚úÖ Conexi√≥n restablecida', 'success');
                    return;
                }
                if (i < 3) await new Promise(resolve => setTimeout(resolve, 2000));
            }
            mostrarDialogoRecarga({ titulo: 'Error de conexi√≥n persistente' });
        }

        function procesarNotificacion(notif) {
            console.log('üéØ Procesando notificaci√≥n:', notif);
            notificaciones.unshift(notif);
            if (!notif.leida) notificacionesNoLeidas++;
            document.getElementById('notificationSound').play().catch(() => {});
            if (navigator.vibrate) navigator.vibrate(200);
            const bell = document.getElementById('notificationBell');
            bell.classList.add('fa-shake');
            setTimeout(() => bell.classList.remove('fa-shake'), 1000);
            actualizarNotificacionesUI();
            mostrarToast(notif.titulo, notif.tipo === 'rejected' ? 'error' : 'success');
            const dialogo = document.getElementById('dialogoRecarga');
            if (dialogo) dialogo.remove();
        }

        async function cargarPedidosCliente() {
            try {
                const { data } = await window.supabaseClient
                    .from('pedidos')
                    .select('*')
                    .eq('session_id', sessionId)
                    .order('timestamp', { ascending: false })
                    .limit(5);
                if (data && data.length > 0) {
                    const ultimoPedido = data[0];
                    if (ultimoPedido.estado !== 'pendiente') {
                        const notifExistente = notificaciones.find(n => 
                            n.pedido_id === ultimoPedido.id && 
                            n.tipo === (ultimoPedido.estado === 'rechazado' ? 'rejected' : 'approved')
                        );
                        if (!notifExistente) {
                            let titulo, mensaje, tipo;
                            switch(ultimoPedido.estado) {
                                case 'en_camino':
                                    titulo = 'üöö Pedido enviado';
                                    mensaje = 'El delivery ya sali√≥';
                                    tipo = 'approved';
                                    break;
                                case 'entregado':
                                    titulo = '‚úÖ Pedido entregado';
                                    mensaje = '¬°Buen Provecho! Gracias por elegir Saki Sushi';
                                    tipo = 'approved';
                                    break;
                                case 'reserva_completada':
                                    titulo = '‚úÖ Reserva Confirmada';
                                    mensaje = 'En breve tu pedido te ser√° entregado, ¬°Gracias por preferirnos!';
                                    tipo = 'approved';
                                    break;
                                default:
                                    titulo = ultimoPedido.estado === 'rechazado' ? '‚ùå Pedido rechazado' : '‚úÖ Estado actualizado';
                                    mensaje = `Tu pedido est√° ${ultimoPedido.estado}`;
                                    tipo = ultimoPedido.estado === 'rechazado' ? 'rejected' : 'approved';
                            }
                            const notifLocal = {
                                id: 'local_' + Date.now(),
                                pedido_id: ultimoPedido.id,
                                titulo: titulo,
                                mensaje: mensaje,
                                tipo: tipo,
                                timestamp: new Date().toISOString(),
                                leida: false
                            };
                            procesarNotificacion(notifLocal);
                        }
                    }
                }
            } catch (error) {
                console.error('Error cargando pedidos:', error);
            }
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) { cargarNotificaciones(); marcarTodasComoLeidas(); }
        }
        async function cargarNotificaciones() {
            const { data } = await window.supabaseClient.from('notificaciones').select('*').eq('session_id', sessionId).order('timestamp', { ascending: false }).limit(20);
            if (data) { notificaciones = data; notificacionesNoLeidas = notificaciones.filter(n => !n.leida).length; actualizarNotificacionesUI(); }
        }
        async function marcarTodasComoLeidas() {
            const idsNoLeidas = notificaciones.filter(n => !n.leida).map(n => n.id);
            if (idsNoLeidas.length === 0) return;
            await window.supabaseClient.from('notificaciones').update({ leida: true }).in('id', idsNoLeidas);
            notificaciones = notificaciones.map(n => ({ ...n, leida: true })); notificacionesNoLeidas = 0; actualizarNotificacionesUI();
        }
        async function marcarNotificacionLeida(id) {
            await window.supabaseClient.from('notificaciones').update({ leida: true }).eq('id', id);
            notificaciones = notificaciones.map(n => n.id === id ? { ...n, leida: true } : n);
            notificacionesNoLeidas = notificaciones.filter(n => !n.leida).length; actualizarNotificacionesUI();
        }
        function actualizarNotificacionesUI() {
            const badge = document.getElementById('notificationBadge'), panel = document.getElementById('notificationsPanel'), countSpan = document.getElementById('notificationsCount'), listDiv = document.getElementById('notificationsList');
            if (notificacionesNoLeidas > 0) { badge.textContent = notificacionesNoLeidas; badge.style.display = 'block'; badge.classList.add('has-unread'); }
            else { badge.style.display = 'none'; badge.classList.remove('has-unread'); }
            if (countSpan) countSpan.textContent = notificacionesNoLeidas;
            if (listDiv) {
                if (notificaciones.length === 0) listDiv.innerHTML = '<div style="text-align:center; padding:1rem; color:var(--gray-400)">No hay notificaciones</div>';
                else listDiv.innerHTML = notificaciones.map(n => `<div class="notification-item ${n.tipo} ${!n.leida ? 'unread' : ''}" onclick="marcarNotificacionLeida('${n.id}')"><div class="notification-title"><i class="fas fa-${mensajesEstado[n.tipo]?.icono || 'bell'}"></i> ${n.titulo}</div><div class="notification-message">${n.mensaje}</div><div class="notification-time">${new Date(n.timestamp).toLocaleString()}</div></div>`).join('');
            }
        }

        function iniciarTimerFrontend(tipo, minutos) {
            if (timersActivos[tipo]) clearInterval(intervalosTimer[tipo]);
            const timerDisplay = document.getElementById(tipo + 'TimerDisplay');
            if (!timerDisplay) return;
            const fin = Date.now() + minutos * 60 * 1000; timersActivos[tipo] = fin;
            intervalosTimer[tipo] = setInterval(() => {
                const restante = Math.max(0, Math.floor((fin - Date.now()) / 1000));
                if (restante <= 0) {
                    clearInterval(intervalosTimer[tipo]);
                    timerDisplay.textContent = '00:00';
                    if (tipo === 'delivery') { document.getElementById('deliveryModal').classList.remove('active'); mostrarToast('Tiempo agotado', 'error'); }
                    else { document.getElementById('reservaModal').classList.remove('active'); mostrarToast('Tiempo agotado', 'error'); }
                    delete timersActivos[tipo];
                } else { const mins = Math.floor(restante / 60); const segs = restante % 60; timerDisplay.textContent = `${mins.toString().padStart(2, '0')}:${segs.toString().padStart(2, '0')}`; }
            }, 1000);
        }
        function detenerTimer(tipo) {
            if (intervalosTimer[tipo]) { clearInterval(intervalosTimer[tipo]); delete intervalosTimer[tipo]; delete timersActivos[tipo]; const timerDisplay = document.getElementById(tipo + 'TimerDisplay'); if (timerDisplay) timerDisplay.textContent = '20:00'; }
        }

        function iniciarProcesoDelivery() {
            iniciarTimerFrontend('delivery', 20);
            document.getElementById('selectedParroquiaText').textContent = deliveryFormData.parroquia || 'Seleccionar parroquia';
            document.getElementById('parroquiaSelect').value = deliveryFormData.parroquia || '';
            document.getElementById('direccion').value = deliveryFormData.direccion || '';
            document.getElementById('telefono').value = deliveryFormData.telefono || '';
            if (deliveryFormData.referencia) { for (let i = 0; i < 6; i++) { const input = document.querySelector(`.ref-digit[data-type="delivery"][data-index="${i}"]`); if (input) input.value = deliveryFormData.referencia[i] || ''; } }
            actualizarTotalDelivery();
            document.getElementById('deliveryModal').classList.add('active');
        }
        function iniciarProcesoReserva() {
            iniciarTimerFrontend('reserva', 20);
            const subtotalUSD = carrito.reduce((sum, item) => sum + item.precioUnitarioUSD, 0);
            document.getElementById('reservaTotal').textContent = formatBs(usdToBs(subtotalUSD));
            document.getElementById('montoReserva').textContent = formatBs(usdToBs(subtotalUSD));
            document.getElementById('fechaReserva').value = reservaFormData.fecha || '';
            document.getElementById('nombreReserva').value = reservaFormData.nombre || '';
            if (reservaFormData.referencia) { for (let i = 0; i < 6; i++) { const input = document.querySelector(`.ref-digit[data-type="reserva"][data-index="${i}"]`); if (input) input.value = reservaFormData.referencia[i] || ''; } }
            validarFormularioReserva();
            document.getElementById('reservaModal').classList.add('active');
        }
        function crearPedidoBase(tipo) {
            const tasaActual = configGlobal.tasa_efectiva;
            const items = carrito.map(instancia => ({ platilloId: instancia.platilloId, nombre: instancia.nombre, cantidad: 1, personalizacion: instancia.personalizacion, precioUnitarioUSD: instancia.precioUnitarioUSD, precioEnBs: instancia.precioUnitarioBs, subtotal: instancia.subtotal, tasaCambioAplicada: tasaActual }));
            return { id: generarId('PED-'), timestamp: new Date().toISOString(), estado: 'pendiente', tipo: tipo, items: items, total: carrito.reduce((sum, i) => sum + i.precioUnitarioUSD, 0), session_id: sessionId, mesa: tipo === 'mesa' ? mesaId : null, tasa_aplicada: tasaActual };
        }
        function abrirConfirmacionMesa() {
            const summary = document.getElementById('mesaOrderSummary');
            let total = 0; const grupos = agruparItemsJerarquicamente(); let html = '';
            grupos.forEach(grupo => {
                total += grupo.subtotal;
                grupo.subgrupos.forEach(subgrupo => {
                    let personalizacionTexto = '';
                    if (subgrupo.personalizacion.length > 0) { const ingredientesNombres = subgrupo.personalizacion.map(p => { const ing = inventario.find(i => i.id === p); return ing?.nombre || p; }).join(', '); personalizacionTexto = `<small style="display:block; color:var(--gray-400)">Sin: ${ingredientesNombres}</small>`; }
                    html += `<div style="display:flex; justify-content:space-between; margin-bottom:.5rem"><div><span>${grupo.nombre} x${subgrupo.cantidad}</span>${personalizacionTexto}</div><span style="color:var(--accent)">${formatBs(subgrupo.subtotal)}</span></div>`;
                });
            });
            summary.innerHTML = html;
            summary.innerHTML += `<div style="display:flex; justify-content:space-between; margin-top:1rem; padding-top:.5rem; border-top:2px solid rgba(255,255,255,.1); font-weight:700"><span>Total:</span><span>${formatBs(total)}</span></div>`;
            document.getElementById('confirmMesaModal').classList.add('active');
        }
        async function confirmarPedidoMesa() {
            const pedido = crearPedidoBase('mesa');
            pedido.cliente_nombre = document.getElementById('clienteNombre').value.trim() || 'Cliente';
            const resultado = await crearPedidoTransaccional(pedido);
            if (resultado.success) {
                carrito = []; guardarCarrito(); actualizarCarritoUI(); actualizarCarritoBadge();
                document.getElementById('confirmMesaModal').classList.remove('active');
                window.stockCache.invalidate();
                for (const item of menuItems) await actualizarStockPlatillo(item.id);
                limpiarDatosFormulario();
            } else { mostrarToast('‚ùå Error: ' + resultado.error, 'error'); }
        }

        function toggleParroquiaSelect() {
            const select = document.getElementById('parroquiaSelect'), search = document.getElementById('parroquiaSearch'), chevron = document.getElementById('parroquiaChevron');
            if (select.style.display === 'none') { select.style.display = 'block'; search.style.display = 'block'; chevron.className = 'fas fa-chevron-up'; search.focus(); }
            else { select.style.display = 'none'; search.style.display = 'none'; chevron.className = 'fas fa-chevron-down'; }
        }
        function seleccionarParroquia(select) {
            if (select.value) document.getElementById('selectedParroquiaText').textContent = select.value;
            else document.getElementById('selectedParroquiaText').textContent = 'Seleccionar parroquia';
            toggleParroquiaSelect(); actualizarTotalDelivery(); validarFormularioDelivery(); guardarDatosDelivery();
        }
        function filtrarParroquias() {
            const term = document.getElementById('parroquiaSearch').value.toLowerCase();
            const select = document.getElementById('parroquiaSelect');
            Array.from(select.options).forEach(opt => { if (opt.value === '') return; opt.style.display = opt.text.toLowerCase().includes(term) ? '' : 'none'; });
        }
        function actualizarContadorDireccion() {
            const direccion = document.getElementById('direccion'), contador = document.getElementById('direccionCounter'), longitud = direccion.value.length;
            contador.textContent = `${longitud}/20 caracteres`; contador.style.color = longitud >= 20 ? 'var(--success)' : 'var(--gray-400)';
            validarFormularioDelivery(); guardarDatosDelivery();
        }
        function moverSiguiente(input, type, index) {
            if (input.value.length === 1 && index < 5) { document.querySelector(`.ref-digit[data-type="${type}"][data-index="${index + 1}"]`).focus(); }
            if (type === 'delivery') { guardarDatosDelivery(); } else { guardarDatosReserva(); }
        }
        function actualizarTotalDelivery() {
            const select = document.getElementById('parroquiaSelect');
            const subtotalUSD = carrito.reduce((sum, item) => sum + item.precioUnitarioUSD, 0);
            if (select.value) {
                const precioUSD = preciosPorParroquia[select.value] || 2;
                const totalUSD = subtotalUSD + precioUSD; const totalBs = usdToBs(totalUSD);
                document.getElementById('deliveryTotal').textContent = formatBs(totalBs);
                document.getElementById('deliveryPriceDisplay').textContent = `Costo de env√≠o: ${formatBs(usdToBs(precioUSD))}`;
                const montoPago = document.getElementById('montoPago');
                if (montoPago) { montoPago.className = 'valor'; montoPago.textContent = formatBs(totalBs); }
            } else {
                document.getElementById('deliveryTotal').textContent = 'Primero seleccione Parroquia a enviar';
                document.getElementById('deliveryPriceDisplay').textContent = 'Primero seleccione Parroquia a enviar';
                const montoPago = document.getElementById('montoPago');
                if (montoPago) { montoPago.className = 'valor-placeholder'; montoPago.textContent = 'Primero seleccione Parroquia a enviar'; }
            }
            validarFormularioDelivery();
        }
        function getReferencia(type) {
            let ref = '';
            for (let i = 0; i < 6; i++) { const input = document.querySelector(`.ref-digit[data-type="${type}"][data-index="${i}"]`); if (input) ref += input.value; }
            return ref;
        }
        function validarFormularioDelivery() {
            const parroquia = document.getElementById('parroquiaSelect').value;
            const direccion = document.getElementById('direccion').value;
            const telefono = document.getElementById('telefono').value;
            const referencia = getReferencia('delivery');
            const comprobanteOk = uploadComplete;
            const telefonoValido = /^\+[0-9]{11,14}$/.test(telefono);
            const referenciaValida = window.validarReferencia(referencia);
            const direccionValida = direccion.length >= 20;
            document.getElementById('confirmDelivery').disabled = !(parroquia && direccionValida && telefonoValido && referenciaValida && comprobanteOk && !isUploading);
        }
        function validarFormularioReserva() {
            const fecha = document.getElementById('fechaReserva').value;
            const nombre = document.getElementById('nombreReserva').value;
            const referencia = getReferencia('reserva');
            const comprobanteOk = uploadComplete;
            const referenciaValida = window.validarReferencia(referencia);
            document.getElementById('confirmReserva').disabled = !(fecha && nombre && referenciaValida && comprobanteOk && !isUploading);
        }
        async function confirmarPedidoDelivery() {
            detenerTimer('delivery');
            const pedido = crearPedidoBase('delivery');
            pedido.parroquia = document.getElementById('parroquiaSelect').value;
            pedido.direccion = document.getElementById('direccion').value;
            pedido.telefono = document.getElementById('telefono').value;
            pedido.referencia = getReferencia('delivery');
            pedido.costo_delivery_usd = preciosPorParroquia[pedido.parroquia] || 2;
            pedido.costo_delivery = usdToBs(pedido.costo_delivery_usd);
            pedido.total += pedido.costo_delivery_usd;
            pedido.comprobante_url = deliveryFormData.comprobante;
            const resultado = await crearPedidoTransaccional(pedido);
            if (resultado.success) {
                carrito = []; guardarCarrito(); actualizarCarritoUI(); actualizarCarritoBadge();
                document.getElementById('deliveryModal').classList.remove('active');
                window.stockCache.invalidate();
                for (const item of menuItems) await actualizarStockPlatillo(item.id);
                limpiarDatosFormulario();
            } else { mostrarToast('‚ùå Error: ' + resultado.error, 'error'); iniciarTimerFrontend('delivery', 20); }
        }
        async function confirmarPedidoReserva() {
            detenerTimer('reserva');
            const pedido = crearPedidoBase('reserva');
            pedido.fecha_reserva = document.getElementById('fechaReserva').value;
            pedido.cliente_nombre = document.getElementById('nombreReserva').value;
            pedido.referencia = getReferencia('reserva');
            pedido.comprobante_url = reservaFormData.comprobante;
            const resultado = await crearPedidoTransaccional(pedido);
            if (resultado.success) {
                carrito = []; guardarCarrito(); actualizarCarritoUI(); actualizarCarritoBadge();
                document.getElementById('reservaModal').classList.remove('active');
                window.stockCache.invalidate();
                for (const item of menuItems) await actualizarStockPlatillo(item.id);
                limpiarDatosFormulario();
            } else { mostrarToast('‚ùå Error: ' + resultado.error, 'error'); iniciarTimerFrontend('reserva', 20); }
        }
        function copiarAlPortapapeles(texto, boton) {
            navigator.clipboard.writeText(texto).then(() => {
                const icono = boton.querySelector('i'), claseOriginal = icono.className;
                icono.className = 'fas fa-check'; boton.classList.add('copied');
                setTimeout(() => { icono.className = claseOriginal; boton.classList.remove('copied'); }, 1500);
                mostrarToast('‚úÖ Copiado al portapapeles', 'success');
            }).catch(err => { console.error('Error al copiar:', err); mostrarToast('‚ùå Error al copiar', 'error'); });
        }

        function setupReferenceInputs() {
            document.querySelectorAll('.ref-digit').forEach(input => {
                input.addEventListener('input', function() {
                    const type = this.dataset.type, index = parseInt(this.dataset.index);
                    if (this.value.length === 1 && index < 5) { document.querySelector(`.ref-digit[data-type="${type}"][data-index="${index + 1}"]`).focus(); }
                    if (type === 'delivery') { validarFormularioDelivery(); guardarDatosDelivery(); }
                    else { validarFormularioReserva(); guardarDatosReserva(); }
                });
                input.addEventListener('keydown', function(e) {
                    const type = this.dataset.type, index = parseInt(this.dataset.index);
                    if (e.key === 'Backspace' && this.value.length === 0 && index > 0) { document.querySelector(`.ref-digit[data-type="${type}"][data-index="${index - 1}"]`).focus(); }
                });
            });
        }
        function setupEventListeners() {
            document.getElementById('menuToggle').addEventListener('click', toggleMenuCategorias);
            document.getElementById('closeCategoryMenu').addEventListener('click', cerrarMenuCategorias);
            document.getElementById('cartToggle').addEventListener('click', toggleCarrito);
            document.getElementById('closeCart').addEventListener('click', cerrarCarrito);
            document.getElementById('searchInput').addEventListener('input', (e) => { const cat = document.querySelector('.category-item.active')?.dataset.categoria; renderizarMenuPaginado(cat === 'todos' ? null : cat, null, e.target.value); });
            document.getElementById('notificationBell').addEventListener('click', toggleNotifications);
            document.getElementById('prevPageBtn').addEventListener('click', () => cambiarPagina(-1));
            document.getElementById('nextPageBtn').addEventListener('click', () => cambiarPagina(1));
            document.getElementById('closeCustomizeModal').addEventListener('click', () => { document.getElementById('customizeModal').classList.remove('active'); currentCustomizeItem = null; });
            document.getElementById('cancelCustomize').addEventListener('click', () => { document.getElementById('customizeModal').classList.remove('active'); currentCustomizeItem = null; });
            document.getElementById('addToCartFromModal').addEventListener('click', agregarPersonalizadoAlCarrito);
            document.getElementById('closeDeliveryModal').addEventListener('click', () => { detenerTimer('delivery'); document.getElementById('deliveryModal').classList.remove('active'); });
            document.getElementById('cancelDelivery').addEventListener('click', () => { detenerTimer('delivery'); document.getElementById('deliveryModal').classList.remove('active'); });
            document.getElementById('closeReservaModal').addEventListener('click', () => { detenerTimer('reserva'); document.getElementById('reservaModal').classList.remove('active'); });
            document.getElementById('cancelReserva').addEventListener('click', () => { detenerTimer('reserva'); document.getElementById('reservaModal').classList.remove('active'); });
            setupReferenceInputs();
            document.getElementById('direccion').addEventListener('input', actualizarContadorDireccion);
            document.getElementById('telefono').addEventListener('input', () => { validarFormularioDelivery(); guardarDatosDelivery(); });
            document.getElementById('fechaReserva').addEventListener('input', () => { validarFormularioReserva(); guardarDatosReserva(); });
            document.getElementById('nombreReserva').addEventListener('input', () => { validarFormularioReserva(); guardarDatosReserva(); });
            document.getElementById('confirmMesaOrder').addEventListener('click', confirmarPedidoMesa);
            document.getElementById('confirmDelivery').addEventListener('click', confirmarPedidoDelivery);
            document.getElementById('confirmReserva').addEventListener('click', confirmarPedidoReserva);
            document.getElementById('cancelMesaOrder').addEventListener('click', () => document.getElementById('confirmMesaModal').classList.remove('active'));
            document.getElementById('closeConfirmMesaModal').addEventListener('click', () => document.getElementById('confirmMesaModal').classList.remove('active'));
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) { if (modal.id === 'deliveryModal') detenerTimer('delivery'); if (modal.id === 'reservaModal') detenerTimer('reserva'); modal.classList.remove('active'); } });
            });
            document.getElementById('parroquiaSearch').addEventListener('input', filtrarParroquias);
            document.addEventListener('click', (e) => {
                const panel = document.getElementById('notificationsPanel'), bell = document.getElementById('notificationBell');
                if (!panel.contains(e.target) && !bell.contains(e.target) && panel.classList.contains('active')) panel.classList.remove('active');
            });
            window.addEventListener('resize', function() { if (window.innerWidth > 992) { document.getElementById('categorySidebar').classList.remove('open'); document.getElementById('cartSidebar').classList.remove('open'); document.getElementById('overlay').classList.remove('active'); } });
        }

        function resetToAllCategories() { const todosItem = document.querySelector('.category-item[data-categoria="todos"]'); if (todosItem) todosItem.click(); }
        function selectCategoria(cat) { const categoriaMap = { 'ofertas': 'ofertas' }; const categoriaReal = categoriaMap[cat] || cat; const item = document.querySelector(`.category-item[data-categoria="${categoriaReal}"]`); if (item) item.click(); }
        function mostrarToast(msg, tipo) { const toast = document.getElementById('toast'); toast.textContent = msg; toast.className = `toast show ${tipo}`; setTimeout(() => toast.classList.remove('show'), 3000); }
        function cerrarModalPersonalizacion() { document.getElementById('customizeModal').classList.remove('active'); currentCustomizeItem = null; }
        function actualizarUI() { actualizarCarritoUI(); }
    </script>
</body>
</html>